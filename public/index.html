<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åˆ—è»Šæ™‚åˆ» Live</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#151517">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' fill='%23151517'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='300' fill='%234d7f5e'%3E%F0%9F%9A%86%3C/text%3E%3C/svg%3E">
    <style>
        body { background: #000; color: #fff; font-family: -apple-system, sans-serif; padding: 10px; margin: 0; }
        .container { max-width: 500px; margin: 0 auto; padding-bottom: 80px; }
        .header { margin-bottom: 15px; background: #151517; padding: 15px; border-radius: 12px; border: 1px solid #333;}
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .app-title { font-size: 0.9rem; color: #888; letter-spacing: 1px; font-weight: bold; margin: 0; }
        .header-actions { display: flex; gap: 8px; align-items: center; }
        .tool-btn { background: none; border: 1px solid #444; color: #666; padding: 3px 8px; border-radius: 12px; font-size: 0.75rem; cursor: pointer; font-weight: bold; transition: all 0.2s; }
        .tool-btn.active { color: #4d7f5e; border-color: #4d7f5e; background: rgba(77, 127, 94, 0.1); }
        #btnInstall { display: none; background: #4d7f5e; color: white; border: none; border-radius: 8px; padding: 3px 8px; font-size: 0.75rem; font-weight: bold; cursor: pointer; }
        .menu-btn-trigger { background: #333; border: 1px solid #555; color: #fff; width: 32px; height: 32px; border-radius: 8px; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; animation: pulse-gold 3s infinite ease-in-out; }
        @keyframes pulse-gold { 0%, 100% { color: #ccc; border-color: #555; } 50% { color: hsl(40, 100%, 50%); border-color: hsl(40, 100%, 50%); } }
        .search-row { display: flex; gap: 8px; margin-bottom: 12px; }
        .search-target { flex: 1; background: #222; border: 1px solid #444; color: #ccc; border-radius: 8px; font-size: 0.85rem; padding-left: 5px; }
        .search-box { flex: 3; background: #222; border: 1px solid #444; color: #fff; padding: 8px 12px; border-radius: 8px; font-size: 0.9rem; }
        .selector-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .selector-label { width: 35px; font-size: 0.8rem; color: #888; font-weight: bold; text-align: center;}
        .region-select { flex: 2; background: #2c2c2e; color: #eee; border: 1px solid #444; padding: 8px 4px; border-radius: 8px; font-size: 0.95rem; font-weight: bold; }
        .station-select { flex: 3; background: #3a3a3c; color: #fff; border: 1px solid #555; padding: 8px 4px; border-radius: 8px; font-size: 1rem; font-weight: bold; }
        .swap-btn { font-size: 1.2rem; color: #666; background: none; border: none; padding: 10px; cursor: pointer; transform: rotate(90deg); display: block; margin: -5px auto; }
        .action-area { margin-top: 15px; display: flex; gap: 10px; }
        .btn { flex: 1; border: none; padding: 12px; border-radius: 12px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: all 0.2s; }
        .btn-search { background: #fff; color: #000; flex: 2; }
        .btn-refresh { background: #4d7f5e; color: white; }
        .btn:disabled { background: #333 !important; color: #888 !important; cursor: not-allowed; }
        .btn.error { background: #d32f2f !important; color: white !important; }
        .status-container { text-align: center; margin-top: 10px; }
        .status-msg { font-size: 0.8rem; color: #aaa; min-height: 1.2em; }
        .status-msg.warning { color: #e6b800; }
        .status-msg.alert { color: #ff4d4d; }
        .update-time { font-size: 0.75rem; color: #666; font-family: monospace; }
        .card { background: #151517; border-radius: 12px; padding: 12px 16px; margin-bottom: 10px; border-left: 5px solid #333; position: relative; transition: transform 0.1s; }
        .card:active { transform: scale(0.98); background: #222; }
        .delay-badge { position: absolute; top: 12px; right: 16px; border: 1px solid hsl(40, 100%, 50%); color: hsl(40, 100%, 50%); padding: 1px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: 600; }
        .train-info { font-size: 0.9rem; font-weight: 700; margin-bottom: 4px; }
        .main-time { display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: 700; padding: 6px 0; }
        .arrow { margin: 0 10px; color: #666; }
        .sub-time { text-align: center; color: #888; font-size: 0.75rem; }
        .card.past { opacity: 0.5; filter: grayscale(0.8); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 999; display: none; align-items: center; justify-content: center; }
        .modal-content { background: #1c1c1e; width: 85%; max-width: 400px; border-radius: 16px; padding: 25px; border: 1px solid #333; max-height: 85vh; overflow-y: auto; }
        .modal-title { font-size: 1.2rem; font-weight: bold; color: #4d7f5e; margin-bottom: 15px; }
        .menu-btn { width: 100%; padding: 15px; margin-bottom: 10px; background: #2c2c2e; border: 1px solid #444; color: #fff; border-radius: 12px; text-align: left; cursor: pointer; }
        .modal-text { font-size: 0.9rem; line-height: 1.6; color: #ccc; }
        .modal-page { display: none; }
        .modal-page.active { display: block; }
        .api-status-box { background:#111; border:1px solid #333; padding:10px; border-radius:8px; margin-bottom:15px; font-size:0.8rem;}
        .api-row { display:flex; justify-content:space-between; margin-bottom:4px; }
        .api-val.cache { color: #4d7f5e; }
        .api-val.api { color: #e6b800; }
        .report-box { width: 100%; height: 150px; background: #111; color: #0f0; font-family: monospace; font-size: 0.75rem; padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #444; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-top">
                <div class="app-title">TRAIN LIVE</div>
                <div class="header-actions">
                    <button id="btnInstall" onclick="handleInstall()">ğŸ“² å®‰è£ App</button>
                    <button id="btnShowAll" class="tool-btn" onclick="toggleShowAll()">å…¨éƒ¨</button>
                    <button id="btnTimeFormat" class="tool-btn" onclick="toggleTimeFormat()">24H</button>
                    <button class="menu-btn-trigger" onclick="openModal()">â˜°</button>
                </div>
            </div>
            <div class="search-row">
                <select id="searchTarget" class="search-target"><option value="start">è¨­ç‚ºèµ·é»</option><option value="end">è¨­ç‚ºçµ‚é»</option></select>
                <input type="text" id="searchInput" class="search-box" placeholder="ğŸ” è¼¸å…¥è»Šç«™" oninput="handleSearch()">
            </div>
            <div class="selector-row"><div class="selector-label">èµ·é»</div><select id="startRegion" class="region-select" onchange="updateStationList('start')"></select><select id="startStation" class="station-select" onchange="markAsChanged()"></select></div>
            <button class="swap-btn" onclick="swapStations()">â‡„</button>
            <div class="selector-row"><div class="selector-label">çµ‚é»</div><select id="endRegion" class="region-select" onchange="updateStationList('end')"></select><select id="endStation" class="station-select" onchange="markAsChanged()"></select></div>
            <div class="action-area"><button id="btnSearch" class="btn btn-search" onclick="doSearch()">ğŸ” æŸ¥è©¢è·¯ç·š</button><button id="btnRefresh" class="btn btn-refresh" onclick="doRefresh()">ğŸ”„ æ›´æ–°</button></div>
            <div class="status-container"><div id="statusMsg" class="status-msg"></div><div id="updateTime" class="update-time"></div></div>
        </div>
        <div id="cardList"></div>
    </div>

    <div id="aboutModal" class="modal-overlay" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div id="pageMenu" class="modal-page active">
                <div class="modal-title">é¸å–®</div>
                <button class="menu-btn" onclick="goToPage('Why')">è¨­è¨ˆç†å¿µ</button>
                <button class="menu-btn" onclick="goToPage('How')">æ“ä½œèªªæ˜</button>
                <button class="menu-btn" onclick="goToPage('Report')">ç³»çµ±è¨ºæ–· / å•é¡Œå›å ±</button>
                <button class="menu-btn" style="background:#333" onclick="closeModal()">é—œé–‰</button>
            </div>
            <div id="pageWhy" class="modal-page">
                <div class="modal-title">è¨­è¨ˆç†å¿µ</div>
                <div class="modal-text">TRAIN LIVE å°ˆæ³¨æ–¼é¡¯ç¤ºã€Œå¯¦éš›ç™¼è»Šæ™‚é–“ã€ã€‚<br><br>æˆ‘å€‘çµåˆäº†èª¤é»è£œå„Ÿè¨ˆç®—ï¼Œè®“ä½ åœ¨ç«è»Šå¤§é‡å»¶èª¤æ™‚ï¼Œä¾ç„¶èƒ½ä¸€çœ¼çœ‹å‡ºã€Œæˆ‘é‚„æœ‰å¹¾åˆ†é˜å¯ä»¥èµ°åˆ°æœˆå°ã€ï¼Œè€Œä¸å¿…åœ¨è…¦ä¸­åŠ æ¸›è¨ˆç®—ã€‚</div>
                <button class="menu-btn" style="margin-top:20px" onclick="goToPage('Menu')">è¿”å›</button>
            </div>
            <div id="pageHow" class="modal-page">
                <div class="modal-title">æ“ä½œèªªæ˜</div>
                <div class="modal-text">
                    <strong>ğŸ•¹ï¸ é›™æŒ‰éˆ•æ©Ÿåˆ¶ï¼š</strong><br>
                    1. <strong>ğŸ” æŸ¥è©¢è·¯ç·š</strong>ï¼šåˆ‡æ›è»Šç«™å¾Œä½¿ç”¨ã€‚æ¯åˆ†é˜é™æŸ¥è©¢ <strong>2 æ¬¡</strong>ã€‚<br>
                    2. <strong>ğŸ”„ æ›´æ–°</strong>ï¼šåˆ·æ–°èª¤é»ã€‚éœ€ç­‰å¾… 60 ç§’å†·å»ã€‚<br><br>
                    <strong>âœ¨ é€²éšåŠŸèƒ½ï¼š</strong><br>
                    â— <strong>åœ°åœ–å®šä½</strong>ï¼šé»æ“Šå¡ç‰‡é–‹å•Ÿå³æ™‚åœ°åœ–èˆ‡åœé ç«™ã€‚<br>
                    â— <strong>å…¨éƒ¨ç­æ¬¡</strong>ï¼šé»æ“Šã€Œå…¨éƒ¨ã€æŸ¥çœ‹å·²é§›é›¢ç­æ¬¡ã€‚<br>
                    â— <strong>å®‰è£ App</strong>ï¼šé»æ“Šä¸Šæ–¹æŒ‰éˆ•å°‡æ­¤å·¥å…·åŠ å…¥ä¸»ç•«é¢ã€‚<br><br>
                    <strong>ğŸš¦ ç‹€æ…‹ç‡ˆè™Ÿï¼š</strong><br>
                    <span style="color:#e6b800">é»ƒå­—</span>ï¼šèª¤é»è®€å–å¤±æ•— (ç³»çµ±æœƒè‡ªå‹•é‡è©¦)ã€‚<br>
                    <span style="color:#e6b800">å¿™ç¢Œ</span>ï¼šæ“ä½œéå¿« (ç³»çµ±æœƒå€’æ•¸ä¸¦è‡ªå‹•æ›´æ–°)ã€‚
                </div>
                <button class="menu-btn" style="margin-top:20px" onclick="goToPage('Menu')">è¿”å›</button>
            </div>
            <div id="pageReport" class="modal-page">
                <div class="modal-title">ç³»çµ±è¨ºæ–·</div>
                <div class="api-status-box">
                    <div class="api-row"><span>æ™‚åˆ»è¡¨ä¾†æº (V3)</span><span id="diagRoute" class="api-val">--</span></div>
                    <div class="api-row"><span>èª¤é»è³‡è¨Šä¾†æº (V2)</span><span id="diagDelay" class="api-val">--</span></div>
                </div>
                <div class="report-hint" style="font-size:0.7rem; color:#888; margin-bottom:10px;">Log å·²è‡ªå‹•è¨˜éŒ„æœ€è¿‘ 30 æ¬¡ API é€£ç·šç‹€æ…‹ã€‚</div>
                <textarea id="reportContent" class="report-box" readonly></textarea>
                <button class="menu-btn" onclick="copyReportOnly()">ğŸ“‹ è¤‡è£½å ±å‘Š</button>
                <button class="menu-btn" style="background:#333" onclick="goToPage('Menu')">è¿”å›</button>
            </div>
            <div id="pageIOS" class="modal-page">
                <div class="modal-title">å®‰è£åˆ° iPhone</div>
                <div class="modal-text">1. é»æ“Šç€è¦½å™¨ä¸‹æ–¹çš„ <span style="color:#4d7f5e">åˆ†äº«æŒ‰éˆ•</span><br>2. é¸æ“‡ <span style="color:#4d7f5e">åŠ å…¥ä¸»ç•«é¢</span><br>3. é»æ“Šå³ä¸Šè§’ã€ŒåŠ å…¥ã€å³å¯ã€‚</div>
                <button class="menu-btn" style="margin-top:20px" onclick="closeModal()">æˆ‘æ˜ç™½äº†</button>
            </div>
        </div>
    </div>

    <script>
        const STATION_DATA={"åŸºéš†/æ–°åŒ—":["åŸºéš†","ä¸‰å‘","å…«å µ","ä¸ƒå µ","ç™¾ç¦","äº”å µ","æ±æ­¢","æ±ç§‘","æ¿æ©‹","æµ®æ´²","æ¨¹æ—","å—æ¨¹æ—","å±±ä½³","é¶¯æ­Œ","ç¦éš†","è²¢å¯®","é›™æºª","ç‰¡ä¸¹","ä¸‰è²‚å¶º","å¤§è¯","ååˆ†","æœ›å¤","å¶ºè…³","å¹³æºª","èæ¡","ä¾¯ç¡","ç‘èŠ³","æµ·ç§‘é¤¨","å…«æ–—å­","æš–æš–"],"è‡ºåŒ—å¸‚":["å—æ¸¯","æ¾å±±","è‡ºåŒ—","è¬è¯"],"æ¡ƒåœ’å¸‚":["æ¡ƒåœ’","å…§å£¢","ä¸­å£¢","åŸ”å¿ƒ","æ¥Šæ¢…","å¯Œå²¡","æ–°å¯Œ"],"æ–°ç«¹ç¸£å¸‚":["åŒ—æ¹–","æ¹–å£","æ–°è±","ç«¹åŒ—","åŒ—æ–°ç«¹","æ–°ç«¹","ä¸‰å§“æ©‹","é¦™å±±","å…­å®¶","ç«¹ä¸­","ä¸Šå“¡","æ¦®è¯","ç«¹æ±","æ©«å±±","ä¹è®šé ­","åˆèˆˆ","å¯Œè²´","å…§ç£"],"è‹—æ —ç¸£":["å´é ‚","ç«¹å—","é€ æ©‹","è±å¯Œ","è‹—æ —","å—å‹¢","éŠ…é‘¼","ä¸‰ç¾©","è«‡æ–‡","å¤§å±±","å¾Œé¾","é¾æ¸¯","ç™½æ²™å±¯","æ–°åŸ”","é€šéœ„","è‹‘è£¡"],"è‡ºä¸­å¸‚":["æ³°å®‰","åé‡Œ","è±åŸ","æ —æ—","æ½­å­","é ­å®¶å","æ¾ç«¹","å¤ªåŸ","ç²¾æ­¦","è‡ºä¸­","äº”æ¬Š","å¤§æ…¶","çƒæ—¥","æ–°çƒæ—¥","æˆåŠŸ","æ—¥å—","å¤§ç”²","è‡ºä¸­æ¸¯","æ¸…æ°´","æ²™é¹¿","é¾äº•","å¤§è‚š","è¿½åˆ†"],"å½°åŒ–ç¸£":["å½°åŒ–","èŠ±å£‡","å¤§æ‘","å“¡æ—","æ°¸é–","ç¤¾é ­","ç”°ä¸­","äºŒæ°´","æºæ³‰","æ¿æ°´","é¾æ³‰","é›†é›†","æ°´é‡Œ","è»ŠåŸ•"],"é›²æ—ç¸£":["æ—å…§","çŸ³æ¦´","æ–—å…­","æ–—å—","çŸ³é¾œ"],"å˜‰ç¾©ç¸£å¸‚":["å¤§æ—","æ°‘é›„","å˜‰åŒ—","å˜‰ç¾©","æ°´ä¸Š","å—é–"],"è‡ºå—å¸‚":["å¾Œå£","æ–°ç‡Ÿ","æŸ³ç‡Ÿ","æ—é³³ç‡Ÿ","éš†ç”°","æ‹”æ—","å–„åŒ–","å—ç§‘","æ–°å¸‚","æ°¸åº·","å¤§æ©‹","è‡ºå—","ä¿å®‰","ä»å¾·","ä¸­æ´²","å¤§æ¹–","æ²™å´™"],"é«˜é›„å¸‚":["è·¯ç«¹","å²¡å±±","æ©‹é ­","æ¥ æ¢“","æ–°å·¦ç‡Ÿ","å·¦ç‡Ÿ","å…§æƒŸ","ç¾è¡“é¤¨","é¼“å±±","ä¸‰å¡Šå","é«˜é›„","æ°‘æ—","ç§‘å·¥é¤¨","æ­£ç¾©","é³³å±±","å¾Œåº„","ä¹æ›²å ‚"],"å±æ±ç¸£":["å…­å¡Šå","å±æ±","æ­¸ä¾†","éºŸæ´›","è¥¿å‹¢","ç«¹ç”°","æ½®å·","å´é ‚","å—å·","é®å®‰","æ—é‚Š","ä½³å†¬","æ±æµ·","æ‹å¯®","åŠ ç¥¿","å…§ç…","æ‹å±±"],"å®œè˜­ç¸£":["æ¼¢æœ¬","æ­¦å¡”","å—æ¾³","æ±æ¾³","æ°¸æ¨‚","è˜‡æ¾³","è˜‡æ¾³æ–°","å†¬å±±","ç¾…æ±","ä¸­é‡Œ","äºŒçµ","å®œè˜­","å››åŸ","ç¤æºª","é ‚åŸ”","é ­åŸ","å¤–æ¾³","é¾œå±±","å¤§æºª","å¤§é‡Œ","çŸ³åŸ"],"èŠ±è“®ç¸£":["å’Œå¹³","å’Œä»","å´‡å¾·","æ–°åŸ","æ™¯ç¾","åŒ—åŸ”","èŠ±è“®","å‰å®‰","å¿—å­¸","å¹³å’Œ","å£½è±","è±ç”°","æ—æ¦®æ–°å…‰","å—å¹³","é³³æ—","è¬æ¦®","å…‰å¾©","å¤§å¯Œ","å¯Œæº","ç‘ç©—","ä¸‰æ°‘","ç‰é‡Œ","æ±é‡Œ","æ±ç«¹","å¯Œé‡Œ"],"è‡ºæ±ç¸£":["æ± ä¸Š","æµ·ç«¯","é—œå±±","ç‘å’Œ","ç‘æº","é¹¿é‡","å±±é‡Œ","è‡ºæ±","åº·æ¨‚","çŸ¥æœ¬","å¤ªéº»é‡Œ","é‡‘å´™","ç€§æºª","å¤§æ­¦"]};
        const STATION_INDEX={};Object.keys(STATION_DATA).forEach(r=>{STATION_DATA[r].forEach(s=>{STATION_INDEX[s]=r;});});
        const PREF_START_R_KEY="pref_start_region";const PREF_START_S_KEY="pref_start_station";
        const PREF_END_R_KEY="pref_end_region";const PREF_END_S_KEY="pref_end_station";
        const startRegion=document.getElementById('startRegion');const startStation=document.getElementById('startStation');
        const endRegion=document.getElementById('endRegion');const endStation=document.getElementById('endStation');
        const searchInput=document.getElementById('searchInput');const btnSearch=document.getElementById('btnSearch');
        const btnRefresh=document.getElementById('btnRefresh');const statusMsg=document.getElementById('statusMsg');
        const updateTimeDiv=document.getElementById('updateTime');const list=document.getElementById('cardList');
        const btnInstall = document.getElementById('btnInstall');

        let refreshTimer=null; let retryTimer=null; let deferredPrompt;
        let systemLogs=[]; let lastDiagnostics = { route_status: "--", delay_status: "--" };
        let is24Hour = localStorage.getItem("is24H") !== 'false'; let isShowAll = false;
        let lastFetchedPair={start:"",end:""};

        // PWA å®‰è£é‚è¼¯
        const isIos = /iPhone|iPad|iPod/.test(navigator.userAgent);
        if (isIos && !window.navigator.standalone) { btnInstall.style.display = 'block'; }
        window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; btnInstall.style.display = 'block'; });
        function handleInstall() {
            if (isIos) { openModal(); goToPage('IOS'); }
            else if (deferredPrompt) { deferredPrompt.prompt(); deferredPrompt.userChoice.then(() => { btnInstall.style.display='none'; deferredPrompt=null; }); }
        }

        function logSystem(a,d){systemLogs.unshift(`[${new Date().toLocaleTimeString()}] ${a}: ${d}`);if(systemLogs.length>30)systemLogs.pop();}
        function updateToggleBtns() { document.getElementById('btnTimeFormat').innerText=is24Hour?"24H":"12H"; document.getElementById('btnShowAll').classList.toggle('active',isShowAll); }
        function toggleTimeFormat(){is24Hour=!is24Hour; localStorage.setItem("is24H",is24Hour); updateToggleBtns(); reRender();}
        function toggleShowAll(){isShowAll=!isShowAll; updateToggleBtns(); reRender();}

        function init() {
            const rOpts=Object.keys(STATION_DATA).map(r=>`<option value="${r}">${r}</option>`).join('');
            startRegion.innerHTML=rOpts; endRegion.innerHTML=rOpts;
            const sR=localStorage.getItem(PREF_START_R_KEY)||"å±æ±ç¸£"; setMenu('start',sR,localStorage.getItem(PREF_START_S_KEY)||"å±æ±");
            const eR=localStorage.getItem(PREF_END_R_KEY)||"å±æ±ç¸£"; setMenu('end',eR,localStorage.getItem(PREF_END_S_KEY)||"æ½®å·");
            updateToggleBtns(); loadDataOrFetch();
            if ('serviceWorker' in navigator) navigator.serviceWorker.register('/sw.js');
        }
        function setMenu(type,rV,sV) {
            const rSel=type==='start'?startRegion:endRegion; const sSel=type==='start'?startStation:endStation;
            rSel.value=rV; sSel.innerHTML=STATION_DATA[rV].map(s=>`<option value="${s}">${s}</option>`).join('');
            sSel.value=STATION_DATA[rV].includes(sV)?sV:STATION_DATA[rV][0];
        }
        function updateStationList(type){ setMenu(type,(type==='start'?startRegion:endRegion).value,""); markAsChanged(); }
        function swapStations(){ const sR=startRegion.value,sS=startStation.value; setMenu('start',endRegion.value,endStation.value); setMenu('end',sR,sS); markAsChanged(); }
        function handleSearch(){ const v=searchInput.value.trim(); if(!v)return; const f=Object.keys(STATION_INDEX).find(s=>s.includes(v)); if(f){ setMenu(document.getElementById('searchTarget').value,STATION_INDEX[f],f); markAsChanged(); }}
        function markAsChanged(){ localStorage.setItem(PREF_START_R_KEY,startRegion.value); localStorage.setItem(PREF_START_S_KEY,startStation.value); localStorage.setItem(PREF_END_R_KEY,endRegion.value); localStorage.setItem(PREF_END_S_KEY,endStation.value); }
        
        function getCacheKey(){return `train_${startStation.value}_${endStation.value}`;}
        function reRender(){ const c=localStorage.getItem(getCacheKey()); if(c) renderCards(JSON.parse(c).payload); }
        function loadDataOrFetch(){ const c=localStorage.getItem(getCacheKey()); if(c && Date.now()-JSON.parse(c).ts<60000) renderCards(JSON.parse(c).payload); }

        function doSearch() {
            if(startStation.value===lastFetchedPair.start && endStation.value===lastFetchedPair.end) { statusMsg.innerText="è»Šç«™æœªè®Šæ›´"; setTimeout(()=>statusMsg.innerText="",2000); doRefresh(); return; }
            const cnt=parseInt(localStorage.getItem("search_cnt")||"0"), rst=parseInt(localStorage.getItem("search_rst")||"0");
            if(Date.now()-rst>60000){ localStorage.setItem("search_cnt","1"); localStorage.setItem("search_rst",Date.now()); }
            else if(cnt>=2){ lockSearch(Math.ceil((60000-(Date.now()-rst))/1000)); return; }
            else localStorage.setItem("search_cnt",cnt+1);
            fetchData();
        }
        function doRefresh(skip=false){ if(!skip && parseInt(localStorage.getItem("ref_lock")||"0")>Date.now()) return; fetchData(); }
        function lockSearch(s){ btnSearch.disabled=true; let t=setInterval(()=>{ btnSearch.innerText=`é »ç¹æ“ä½œ (${s})`; if(s--<=0){ clearInterval(t); btnSearch.disabled=false; btnSearch.innerText="ğŸ” æŸ¥è©¢è·¯ç·š"; } },1000); }

        async function fetchData() {
            statusMsg.innerText="é€£ç·šä¸­..."; if(retryTimer){clearTimeout(retryTimer);retryTimer=null;}
            btnSearch.disabled=btnRefresh.disabled=true;
            try {
                const res=await fetch(`/api/index?start=${startStation.value}&end=${endStation.value}`);
                if(res.status===429) throw new Error("429");
                const json=await res.json();
                lastFetchedPair={start:startStation.value,end:endStation.value};
                if(json.diagnostics){
                    lastDiagnostics=json.diagnostics;
                    logSystem("API", `Route:[${json.diagnostics.route_status}], Delay:[${json.diagnostics.delay_status}]`);
                }
                localStorage.setItem(getCacheKey(),JSON.stringify({ts:Date.now(),payload:json}));
                renderCards(json); updateTimeDiv.innerText=`æ›´æ–°æ–¼: ${json.update_time}`;
                statusMsg.innerText=json.delay_failed?"èª¤é»è³‡è¨Šå¤±æ•—ï¼Œå°‡é‡è©¦":"æ›´æ–°å®Œæˆ";
                if(json.delay_failed) startRetry(60); else setTimeout(()=>statusMsg.innerText="",2000);
                localStorage.setItem("ref_lock",Date.now()+60000); lockRefresh(60);
            } catch(e){
                if(e.message==="429"){ statusMsg.innerText="ç³»çµ±å¿™ç¢Œï¼Œå³å°‡é‡è©¦"; startRetry(15); }
                else statusMsg.innerText="é€£ç·šå¤±æ•—";
            }
            btnSearch.disabled=false;
        }
        function startRetry(s){ retryTimer=setInterval(()=>{ statusMsg.innerText=`ç³»çµ±å¿™ç¢Œ (${s}s å¾Œé‡è©¦)`; if(s--<=0){ clearInterval(retryTimer); doRefresh(true); } },1000); }
        function lockRefresh(s){ let t=setInterval(()=>{ btnRefresh.innerText=`æ›´æ–° (${s})`; if(s--<=0){ clearInterval(t); btnRefresh.disabled=false; btnRefresh.innerText="ğŸ”„ æ›´æ–°"; } },1000); }

        function renderCards(data) {
            let html=data.trains.filter(t=>isShowAll || !t.is_past).map(t=>`
                <a href="https://railway.chienwen.net/taiwan/train/TRA-${t.no}/live" target="_blank">
                <div class="card" style="border-left-color:${t.color}">
                    ${t.delay>0?`<div class="delay-badge">èª¤é» ${t.delay} åˆ†</div>`:''}
                    <div class="train-info" style="color:${t.color}">${t.type} ${t.no} æ¬¡</div>
                    <div class="main-time"><span>${t.act_dep}</span><span class="arrow">â”</span><span>${t.act_arr}</span></div>
                    <div class="sub-time">åŸå®š ${t.sch_dep} â” ${t.sch_arr}</div>
                </div></a>`).join('');
            list.innerHTML=html || '<div class="message">ç›®å‰ç„¡ç­æ¬¡</div>';
        }

        function openModal(){ document.getElementById('aboutModal').style.display='flex'; goToPage('Menu'); }
        function closeModal(){ document.getElementById('aboutModal').style.display='none'; }
        function goToPage(id){
            document.querySelectorAll('.modal-page').forEach(p=>p.classList.remove('active'));
            document.getElementById('page'+id).classList.add('active');
            if(id==='Report'){
                document.getElementById('diagRoute').innerText=lastDiagnostics.route_status;
                document.getElementById('diagDelay').innerText=lastDiagnostics.delay_status;
                document.getElementById('reportContent').value=`ã€TRAIN LIVE è¨ºæ–·å ±å‘Šã€‘\næ™‚é–“: ${new Date().toLocaleString()}\nè£ç½®: ${navigator.userAgent}\nè·¯ç·š: ${startStation.value}->${endStation.value}\n\n--- Log ---\n${systemLogs.join('\n')}`;
            }
        }
        function copyReportOnly(){ const c=document.getElementById('reportContent'); c.select(); document.execCommand('copy'); }
        init();
    </script>
</body>
</html>
