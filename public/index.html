<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åˆ—è»Šæ™‚åˆ» Live</title>
    <style>
        body { background: #000; color: #fff; font-family: -apple-system, sans-serif; padding: 10px; margin: 0; }
        .container { max-width: 500px; margin: 0 auto; padding-bottom: 80px; }

        .header { margin-bottom: 15px; background: #151517; padding: 15px; border-radius: 12px; border: 1px solid #333;}
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .app-title { font-size: 0.9rem; color: #888; letter-spacing: 1px; font-weight: bold; margin: 0; }
        
        .header-actions { display: flex; gap: 8px; align-items: center; }

        .tool-btn {
            background: none; border: 1px solid #444; color: #666; 
            padding: 3px 8px; border-radius: 12px; font-size: 0.75rem; 
            cursor: pointer; font-weight: bold; transition: all 0.2s;
        }
        .tool-btn.active { color: #4d7f5e; border-color: #4d7f5e; background: rgba(77, 127, 94, 0.1); }
        .tool-btn:active { transform: scale(0.95); }

        @keyframes pulse-gold {
            0%, 100% { color: #ccc; border-color: #555; box-shadow: 0 0 0 rgba(0,0,0,0); }
            50% { color: hsl(40, 100%, 50%); border-color: hsl(40, 100%, 50%); box-shadow: 0 0 8px rgba(255, 166, 0, 0.3); }
        }

        .menu-btn-trigger { 
            background: #333; border: 1px solid #555; color: #fff; 
            width: 32px; height: 32px; border-radius: 8px; 
            font-size: 1.1rem; cursor: pointer; display: flex; 
            align-items: center; justify-content: center; font-weight: bold;
            transition: transform 0.2s;
            animation: pulse-gold 3s infinite ease-in-out;
        }
        .menu-btn-trigger:active { transform: scale(0.95); background: #444; }

        .search-row { display: flex; gap: 8px; margin-bottom: 12px; }
        .search-target { flex: 1; background: #222; border: 1px solid #444; color: #ccc; border-radius: 8px; font-size: 0.85rem; padding-left: 5px; min-width: 0; }
        .search-box { flex: 3; box-sizing: border-box; background: #222; border: 1px solid #444; color: #fff; padding: 8px 12px; border-radius: 8px; font-size: 0.9rem; text-align: left; min-width: 0; }
        .search-box:focus { border-color: #4d7f5e; outline: none; background: #000; }

        .selector-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .selector-label { width: 35px; font-size: 0.8rem; color: #888; font-weight: bold; text-align: center;}
        .select-group { flex: 1; display: flex; gap: 5px; min-width: 0; }
        .region-select { flex: 2; background: #2c2c2e; color: #eee; border: 1px solid #444; padding: 8px 4px; border-radius: 8px; font-size: 0.95rem; font-weight: bold; appearance: none; -webkit-appearance: none; text-align: center; min-width: 0; }
        .station-select { flex: 3; background: #3a3a3c; color: #fff; border: 1px solid #555; padding: 8px 4px; border-radius: 8px; font-size: 1rem; font-weight: bold; appearance: none; -webkit-appearance: none; text-align: center; min-width: 0; }
        .swap-container { display: flex; justify-content: center; margin: -4px 0 4px 0; }
        .swap-btn { font-size: 1.2rem; color: #666; background: none; border: none; padding: 0 10px; cursor: pointer; transform: rotate(90deg); }

        .action-area { margin-top: 15px; display: flex; gap: 10px; align-items: stretch; }
        .btn { border: none; padding: 12px; border-radius: 12px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { background: #333 !important; color: #888 !important; border-color: #333 !important; cursor: not-allowed; }
        .btn-search { flex: 2; background: #fff; color: #000; }
        .btn-refresh { flex: 1; background: #4d7f5e; color: white; font-size: 0.9rem; }
        .btn-half { flex: 1; font-size: 0.9rem; }
        .btn-secondary { background: #3a3a3c; color: #fff; border: 1px solid #555; }
        .btn-primary { background: #007AFF; color: white; }
        .btn.error { background: #d32f2f !important; color: white !important; }

        .status-container { text-align: center; margin-top: 10px; display: flex; flex-direction: column; gap: 4px; }
        .status-msg { font-size: 0.8rem; color: #aaa; min-height: 1.2em; }
        .status-msg.alert { color: #ff4d4d; font-weight: bold; } 
        .status-msg.warning { color: #e6b800; } 
        .status-msg.unsync { color: #4d7f5e; } 
        .update-time { font-size: 0.75rem; color: #666; font-family: monospace; min-height: 1em; }

        .click-hint { text-align: center; color: #666; font-size: 0.75rem; margin-bottom: 8px; margin-top: -5px; animation: fadeIn 0.5s; }

        .card { 
            background: #151517; border-radius: 12px; padding: 12px 16px; margin-bottom: 10px; border-left: 5px solid #333; position: relative; 
            transition: transform 0.1s ease, background-color 0.1s ease;
        }
        a { display: block; text-decoration: none; color: inherit; -webkit-tap-highlight-color: transparent; }
        .card:active { transform: scale(0.98); background-color: #222; }

        .delay-badge { position: absolute; top: 12px; right: 16px; border: 1px solid hsl(40, 100%, 50%); color: hsl(40, 100%, 50%); padding: 1px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: 600; }
        .train-info { font-size: 0.9rem; font-weight: 700; margin-bottom: 4px; }
        .main-time { display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: 700; padding: 6px 0; }
        .main-time span { white-space: nowrap; }
        .arrow { margin: 0 6px; color: #666; font-size: 0.8rem; }
        .sub-time { text-align: center; color: #888; font-size: 0.75rem; }
        
        .card.past { opacity: 0.5; filter: grayscale(0.8); }
        .card.past::after { content: 'å·²é§›é›¢'; position: absolute; bottom: 10px; right: 10px; font-size: 0.7rem; color: #fff; background: #333; padding: 2px 6px; border-radius: 4px; }

        .message { text-align: center; padding: 40px; color: #666; font-size: 0.9rem; }
        .loading { color: #4d7f5e; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 999; display: none; align-items: center; justify-content: center; }
        .modal-content { background: #1c1c1e; width: 85%; max-width: 400px; border-radius: 16px; padding: 25px; border: 1px solid #333; box-shadow: 0 10px 30px rgba(0,0,0,0.5); text-align: left; position: relative; max-height: 85vh; overflow-y: auto;}
        .modal-header-row { display: flex; align-items: center; margin-bottom: 15px; }
        .back-btn { background: none; border: none; color: #888; font-size: 1.5rem; cursor: pointer; padding: 0 10px 0 0; line-height: 1; }
        .modal-title { font-size: 1.2rem; font-weight: bold; color: #4d7f5e; flex: 1; }
        .menu-btn { display: block; width: 100%; padding: 15px; margin-bottom: 10px; background: #2c2c2e; border: 1px solid #444; color: #fff; border-radius: 12px; font-size: 1rem; cursor: pointer; text-align: left; display: flex; justify-content: space-between; align-items: center; }
        .menu-btn:active { background: #3a3a3c; }
        .menu-btn::after { content: 'â€º'; color: #666; font-size: 1.2rem; }
        .menu-btn.special { animation: pulse-gold 3s infinite ease-in-out; }
        .modal-text { font-size: 0.9rem; line-height: 1.6; color: #ccc; margin-bottom: 20px; }
        .modal-close { background: #333; color: #fff; border: none; padding: 10px 0; width: 100%; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .modal-page { display: none; }
        .modal-page.active { display: block; animation: fadeIn 0.2s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .report-box { width: 100%; height: 150px; background: #111; border: 1px solid #444; color: #0f0; font-family: monospace; font-size: 0.75rem; padding: 10px; border-radius: 8px; margin-bottom: 10px; resize: none; box-sizing: border-box;}
        .copy-btn { width: 100%; background: #007AFF; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; margin-bottom: 10px; }
        .copy-btn.copied { background: #4d7f5e; }
        .report-hint { font-size: 0.8rem; color: #888; margin-bottom: 15px; }
        .stats-dashboard { display: flex; gap: 8px; margin-bottom: 15px; }
        .stat-card { flex: 1; background: #222; border: 1px solid #444; padding: 10px 5px; border-radius: 8px; text-align: center; }
        .stat-val { font-size: 1.2rem; font-weight: bold; color: #4d7f5e; font-family: monospace;}
        .stat-label { font-size: 0.65rem; color: #888; margin-top: 2px;}
        .stat-card.danger .stat-val { color: #ff4d4d; }
        
        /* è¨ºæ–·å€å¡Šæ¨£å¼ */
        .api-status-box { background:#111; border:1px solid #333; padding:10px; border-radius:8px; margin-bottom:15px; font-size:0.8rem;}
        .api-row { display:flex; justify-content:space-between; margin-bottom:4px; }
        .api-val { font-family:monospace; font-weight:bold; }
        .api-val.cache { color: #4d7f5e; }
        .api-val.api { color: #e6b800; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-top">
                <div class="app-title">TRAIN LIVE</div>
                <div class="header-actions">
                    <button id="btnShowAll" class="tool-btn" onclick="toggleShowAll()">å…¨éƒ¨</button>
                    <button id="btnTimeFormat" class="tool-btn" onclick="toggleTimeFormat()">24H</button>
                    <button class="menu-btn-trigger" onclick="openModal()">â˜°</button>
                </div>
            </div>

            <div class="search-row">
                <select id="searchTarget" class="search-target" onchange="handleSearch()" autocomplete="off"><option value="start">è¨­ç‚ºèµ·é»</option><option value="end">è¨­ç‚ºçµ‚é»</option></select>
                <input type="text" id="searchInput" class="search-box" placeholder="ğŸ” è¼¸å…¥è»Šç«™" oninput="handleSearch()" autocomplete="off">
            </div>
            
            <div class="selector-row">
                <div class="selector-label">èµ·é»</div>
                <div class="select-group">
                    <select id="startRegion" class="region-select" onchange="updateStationList('start')" autocomplete="off"></select>
                    <select id="startStation" class="station-select" onchange="markAsChanged()" autocomplete="off"></select>
                </div>
            </div>
            <div class="swap-container"><button class="swap-btn" onclick="swapStations()">â‡„</button></div>
            <div class="selector-row">
                <div class="selector-label">çµ‚é»</div>
                <div class="select-group">
                    <select id="endRegion" class="region-select" onchange="updateStationList('end')" autocomplete="off"></select>
                    <select id="endStation" class="station-select" onchange="markAsChanged()" autocomplete="off"></select>
                </div>
            </div>

            <div class="action-area">
                <button id="btnSearch" class="btn btn-search" onclick="doSearch()">ğŸ” æŸ¥è©¢è·¯ç·š</button>
                <button id="btnRefresh" class="btn btn-refresh" onclick="doRefresh()">ğŸ”„ æ›´æ–°</button>
            </div>
            
            <div class="status-container">
                <div id="statusMsg" class="status-msg"></div>
                <div id="updateTime" class="update-time"></div>
            </div>
        </div>

        <div id="cardList"></div>
    </div>

    <div id="aboutModal" class="modal-overlay" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div id="pageMenu" class="modal-page active">
                <div class="modal-header-row"><div class="modal-title">é¸å–®</div></div>
                <button class="menu-btn special" onclick="goToPage('Why')">è¨­è¨ˆç†å¿µ</button>
                <button class="menu-btn" onclick="goToPage('How')">æ“ä½œèªªæ˜</button>
                <button class="menu-btn" onclick="goToPage('Report')">ç³»çµ±è¨ºæ–· / å•é¡Œå›å ±</button>
                <div style="height:10px"></div>
                <button class="modal-close" onclick="closeModal()">é—œé–‰</button>
            </div>
            <div id="pageWhy" class="modal-page">
                <div class="modal-header-row"><button class="back-btn" onclick="goToPage('Menu')">â€¹</button><div class="modal-title">è¨­è¨ˆç†å¿µ</div></div>
                <div class="modal-text">ç¾æœ‰çš„ç«è»Šæ™‚åˆ»è¡¨è»Ÿé«”ï¼Œé€šå¸¸åªæœƒé¡¯ç¤ºã€Œèª¤é»å¹¾åˆ†é˜ã€ï¼Œè€Œæ²’æœ‰å¹«å¿™ç®—å‡ºã€Œå¯¦éš›å¹¾é»æœƒåˆ°ã€ã€‚<br><br>ç•¶ç«è»Šå¤§é‡èª¤é»æ™‚ï¼Œæˆ‘å€‘éœ€è¦åœ¨è…¦ä¸­ä¸æ–·åŠ æ¸›è¨ˆç®—ï¼Œéå¸¸ä¸ä¾¿ã€‚<br><br><strong>TRAIN LIVE çš„è¨­è¨ˆç›®æ¨™ï¼š</strong><br>1. ç›´æ¥é¡¯ç¤º<strong>ã€Œèª¤é»å¾Œçš„å¯¦éš›æ™‚é–“ã€</strong>ã€‚<br>2. ä¾ç…§<strong>ã€Œå¯¦éš›ç™¼è»Šé †åºã€</strong>æ’åˆ—ï¼Œè€ŒéåŸå®šæ™‚åˆ»ã€‚<br>3. ä¸€çœ¼çœ‹å‡ºç¾åœ¨è©²æ­å“ªä¸€ç­è»Šã€‚<br><br>å¸Œæœ›é€™å€‹å·¥å…·èƒ½è§£æ±ºä½ çš„é€šå‹¤ç„¦æ…®ã€‚</div>
            </div>
            <div id="pageHow" class="modal-page">
                <div class="modal-header-row"><button class="back-btn" onclick="goToPage('Menu')">â€¹</button><div class="modal-title">æ“ä½œèªªæ˜</div></div>
                <div class="modal-text"><strong>é›™æŒ‰éˆ•æ©Ÿåˆ¶ï¼š</strong><br><br>1. <strong>ğŸ” æŸ¥è©¢è·¯ç·š (å·¦)ï¼š</strong><br>åˆ‡æ›è·¯ç·šå°ˆç”¨ã€‚è‹¥æ‚¨é»æ“Šæ­¤æŒ‰éˆ•ä½†<strong>è»Šç«™æœªè®Šæ›´</strong>ï¼Œç³»çµ±å°‡è¦–ç‚ºã€Œæ›´æ–°ã€è™•ç†ã€‚<br>è‹¥<strong>çœŸçš„è®Šæ›´è»Šç«™</strong>ï¼Œæ¯åˆ†é˜é™æŸ¥è©¢ 4 æ¬¡ã€‚<br><br>2. <strong>ğŸ”„ æ›´æ–° (å³)ï¼š</strong><br>åˆ·æ–°ç•¶å‰ç‹€æ…‹ã€‚æ¯æ¬¡é»æ“Šå¾Œéœ€ç­‰å¾… 60 ç§’å†·å»ã€‚<br><br><strong>ç‡ˆè™Ÿï¼š</strong><br><span style="color:#e6b800">é»ƒå­—</span>ï¼šèª¤é»è³‡æ–™å¤±æ•— (è‡ªå‹•é‡è©¦)ã€‚<br><span style="color:#ff4d4d">ç´…å­—</span>ï¼šæ“ä½œéæ–¼é »ç¹ã€‚</div>
            </div>
            <div id="pageReport" class="modal-page">
                <div class="modal-header-row"><button class="back-btn" onclick="goToPage('Menu')">â€¹</button><div class="modal-title">ç³»çµ±è¨ºæ–·</div></div>
                
                <div class="api-status-box">
                    <div class="api-row"><span>æ™‚åˆ»è¡¨ä¾†æº (V3)</span><span id="diagRoute" class="api-val">--</span></div>
                    <div class="api-row"><span>èª¤é»è³‡è¨Šä¾†æº (V2)</span><span id="diagDelay" class="api-val">--</span></div>
                </div>

                <div class="stats-dashboard">
                    <div class="stat-card" id="cardRpm"><div class="stat-val" id="statRpm">0</div><div class="stat-label">1åˆ†é˜å…§è«‹æ±‚</div></div>
                    <div class="stat-card"><div class="stat-val" id="statTotal">0</div><div class="stat-label">æœ¬æ¬¡ç¸½æ•¸</div></div>
                    <div class="stat-card"><div class="stat-val" id="statLast">--</div><div class="stat-label">è·ä¸Šæ¬¡(ç§’)</div></div>
                </div>
                <div class="report-hint">è‹¥é‡åˆ°å•é¡Œï¼Œè«‹å…ˆã€Œè¤‡è£½å ±å‘Šã€ï¼Œå†é»æ“Šå¯„ä¿¡ä¸¦è²¼ä¸Šå…§å®¹ã€‚</div>
                <textarea id="userDesc" class="search-box" style="width:100%; margin-bottom:10px; resize:none;" rows="2" placeholder="ï¼ˆé¸å¡«ï¼‰è«‹ç°¡è¿°æ‚¨é‡åˆ°çš„å•é¡Œ..."></textarea>
                <textarea id="reportContent" class="report-box" readonly></textarea>
                <div class="action-area" style="margin-top:5px;">
                    <button