<!DOCTYPE html>
<html lang="zh-TW" prefix="og: http://ogp.me/ns#">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TRAIN LIVE | åˆ—è»Šæ™‚åˆ»å³æ™‚çœ‹æ¿</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#151517">
    <link rel="apple-touch-icon" href="/icon.png">
    <link rel="icon" type="image/png" href="/icon.png">

    <style>
        /* --- åŸºç¤è¨­å®š --- */
        *, *::before, *::after { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
            outline: none; 
        }
        html { scroll-behavior: smooth; }
        body { background: #000; color: #fff; font-family: -apple-system, sans-serif; padding: 10px; margin: 0; }
        
        /* é–å®šèƒŒæ™¯æ²å‹• (è§£æ±º iOS ç©¿é€å•é¡Œ) */
        body.noscroll { overflow: hidden; }

        .container { max-width: 500px; margin: 0 auto; padding-bottom: 100px; }

        /* --- Header --- */
        .header { margin-bottom: 15px; background: #151517; border-radius: 12px; border: 1px solid #333; overflow: hidden; position: relative;}
        .header-static-part { padding: 15px 15px 15px 15px; background: #151517; position: relative; z-index: 10; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; min-height: 36px; }
        
        .app-title { 
            font-size: 1rem; color: #888; letter-spacing: 1px; font-weight: 800; margin: 0; flex: 1; 
            cursor: default; user-select: none; -webkit-user-select: none; 
        }

        .top-actions { display: flex; align-items: center; gap: 8px; }
        .install-btn-top {
            background: #4d7f5e; color: #fff; border: none; padding: 0 12px; height: 36px; border-radius: 8px; 
            font-size: 0.8rem; font-weight: bold; cursor: pointer; display: none;
            align-items: center; gap: 4px; animation: fadeIn 0.5s; white-space: nowrap;
        }
        .install-btn-top:active { transform: scale(0.95); background: #3d664b; }
        .menu-btn-trigger { background: #2c2c2e; border: 1px solid #444; color: #fff; width: 36px; height: 36px; border-radius: 8px; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .menu-btn-trigger:active { transform: scale(0.95); background: #3a3a3c; }
        @keyframes pulse-white-gold { 0%, 100% { color: #fff; border-color: #444; } 50% { color: hsl(40, 100%, 50%); border-color: hsl(40, 100%, 50%); } }
        .anim-gold-pulse { animation: pulse-white-gold 3s infinite ease-in-out !important; border-width: 1px; border-style: solid; }

        /* --- Search & Selectors --- */
        .search-row { display: flex; gap: 8px; margin-bottom: 12px; width: 100%; }
        .search-target { flex: 1; min-width: 0; background: #222; border: 1px solid #444; color: #ccc; border-radius: 8px; font-size: 0.85rem; padding-left: 5px; }
        /* [iOS å„ªåŒ–] font-size: 16px é˜²æ­¢è¼¸å…¥æ™‚ç•«é¢æ”¾å¤§ */
        .search-box { flex: 2.5; min-width: 0; background: #222; border: 1px solid #444; color: #fff; padding: 8px 10px; border-radius: 8px; font-size: 16px; }
        .search-box:focus { border-color: #4d7f5e; outline: none; background: #000; }
        
        .selector-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .selector-label { width: 35px; font-size: 0.8rem; color: #888; font-weight: bold; text-align: center;}
        .select-group { flex: 1; display: flex; gap: 5px; }
        .region-select { flex: 2; background: #2c2c2e; color: #eee; border: 1px solid #444; padding: 8px 4px; border-radius: 8px; font-size: 0.95rem; font-weight: bold; text-align: center; }
        .station-select { flex: 3; background: #3a3a3c; color: #fff; border: 1px solid #555; padding: 8px 4px; border-radius: 8px; font-size: 1rem; font-weight: bold; text-align: center; }
        .swap-container { display: flex; justify-content: center; margin: -4px 0 4px 0; }
        .swap-btn { font-size: 1.2rem; color: #666; background: none; border: none; padding: 0 10px; cursor: pointer; transform: rotate(90deg); }
        .btn-static-search {
            width: 100%; background: #eee; color: #000; border: none; 
            padding: 10px; border-radius: 10px; font-size: 1rem; font-weight: bold; 
            cursor: pointer; margin-top: 5px; display: flex; justify-content: center; align-items: center;
        }
        .btn-static-search:active { transform: scale(0.98); background: #ddd; }
        .btn-static-search:disabled { background: #333; color: #888; cursor: not-allowed; }

        /* --- Sticky Header --- */
        .header-sticky-part {
            background: #151517; 
            border-bottom-left-radius: 12px; border-bottom-right-radius: 12px;
            width: 100%; z-index: 100; will-change: transform;
            display: flex; flex-direction: column; border-top: 1px solid #222;
        }
        .header-sticky-part.is-fixed {
            position: fixed; top: 0; width: calc(100% - 20px); max-width: 500px; left: 50%;
            border-radius: 0 0 12px 12px; border: 1px solid #333; border-top: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.9);
        }
        #stickyPlaceholder { display: none; }

        /* Row 1: Quick Route */
        .sticky-row-top { 
            display: flex; align-items: center; border-bottom: 1px solid #222; min-height: 50px; 
            position: relative; 
        }
        .quick-route-scroll-container {
            flex: 1; overflow-x: auto; white-space: nowrap; padding: 5px 10px; height: 100%; display: flex; align-items: center;
            -ms-overflow-style: none; scrollbar-width: none; 
        }
        .quick-route-scroll-container::-webkit-scrollbar { display: none; }
        .scroll-hint-overlay {
            position: absolute; right: 85px; top: 0; bottom: 0; width: 40px;
            background: linear-gradient(to right, transparent, #151517);
            pointer-events: none; 
            display: flex; align-items: center; justify-content: flex-end;
            padding-right: 5px; opacity: 0; transition: opacity 0.3s;
        }
        .scroll-hint-arrow { color: #4d7f5e; font-weight: bold; font-size: 1.2rem; animation: bounce-x 1s infinite; }
        @keyframes bounce-x { 0%, 100% { transform: translateX(0); } 50% { transform: translateX(3px); } }
        .route-chip { 
            display: inline-flex; align-items: center; background: #222; border: 1px solid #444; color: #bbb; 
            padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; transition: all 0.2s; margin-right: 6px; 
            user-select: none; flex-shrink: 0;
        }
        .route-chip:active { transform: scale(0.95); background: #333; }
        .route-chip .chip-arrow { margin: 0 5px; color: #666; font-size: 0.7rem; }
        .route-chip.fav { border-color: #4d7f5e; color: #4d7f5e; background: rgba(77, 127, 94, 0.1); font-weight: bold; }
        .route-chip.hist { border-style: dashed; }
        .btn-side-container { padding: 5px 10px; border-left: 1px solid #222; height: 100%; display: flex; align-items: center; min-width: 85px; justify-content: center; z-index: 5;}
        .btn-fav-compact {
            background: #222; color: #ccc; border: 1px solid #444; padding: 4px 8px; border-radius: 8px; 
            font-size: 0.75rem; cursor: pointer; white-space: pre-wrap; line-height: 1.2; text-align: center;
            transition: all 0.1s; width: 100%;
        }
        .btn-fav-compact:active { transform: scale(0.95); background: #333; }
        .btn-fav-compact.fav-active { color: #e6b800; border-color: #e6b800; background: rgba(230,184,0,0.1); font-weight: bold; }

        /* Row 2: Tools */
        .sticky-row-tools { display: flex; gap: 8px; padding: 8px 10px; border-bottom: 1px solid #222; position: relative; }
        .toolbar-btn {
            flex: 1; background: #222; border: 1px solid #444; color: #ccc; 
            padding: 8px 0; border-radius: 8px; font-size: 0.85rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 4px; transition: all 0.1s; position: relative;
        }
        .toolbar-btn:active { transform: scale(0.96); background: #333; }
        .toolbar-btn.active { color: #4d7f5e; border-color: #4d7f5e; background: rgba(77,127,94,0.1); }
        .toolbar-btn.refresh { background: #4d7f5e; color: white; border-color: #4d7f5e; font-weight: bold; }
        .toolbar-btn.refresh:disabled { background: #333; color: #888; border-color: #333; cursor: not-allowed; }

        /* Row 3: Status */
        .sticky-row-status {
            display: flex; justify-content: space-between; align-items: center;
            padding: 6px 15px 8px 15px; background: #111; 
            border-bottom-left-radius: 12px; border-bottom-right-radius: 12px;
        }
        .status-left { font-size: 0.8rem; color: #aaa; font-weight: bold; display: flex; align-items: center; gap: 5px; min-height: 1.2em;}
        .status-left.alert { color: #ff4d4d; }
        .status-left.warning { color: #e6b800; }
        .status-right { font-size: 0.75rem; color: #666; font-family: monospace; }
        
        /* [æ–°å¢] ç‹€æ…‹åˆ—å–šé†’æç¤ºè† å›Š */
        .status-chip {
            background: #e6b800; color: #000;
            padding: 2px 8px; border-radius: 12px;
            font-size: 0.75rem; font-weight: bold;
            display: inline-flex; align-items: center; gap: 6px;
            animation: chip-bounce 2s infinite; cursor: pointer;
        }
        .status-chip .chip-close {
            font-size: 1rem; line-height: 1; opacity: 0.6; padding: 0 2px;
        }
        @keyframes chip-bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-2px); }
        }

        /* Bottom Hints */
        .fixed-footer-hints {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: #1a1a1c; border-top: 1px solid #333;
            display: none; /* JS æ§åˆ¶ */
            align-items: center; justify-content: center; gap: 20px; 
            padding: 10px 15px; font-size: 0.75rem; color: #666; 
            z-index: 200; 
            padding-bottom: max(10px, env(safe-area-inset-bottom));
            box-shadow: 0 -5px 20px rgba(0,0,0,0.8);
        }
        .fixed-footer-hints.centered { justify-content: center; } 
        .hint-group { display: flex; align-items: center; gap: 8px; }
        .hint-text-col { display: flex; flex-direction: column; line-height: 1.2; }
        .hint-text-col span { font-weight: bold; color: #ccc; }
        .hint-text-col span.sub { font-weight: normal; color: #666; font-size: 0.7rem; }
        .hint-divider { width: 1px; height: 20px; background: #333; margin: 0 5px; }

        /* LED */
        .led-dot { width: 8px; height: 8px; background-color: #4d7f5e; border-radius: 50%; opacity: 0.2; transition: opacity 0.1s; }
        body.tick-a .led-dot.top { opacity: 1; box-shadow: 0 0 6px #4d7f5e; }
        body.tick-b .led-dot.bottom { opacity: 1; box-shadow: 0 0 6px #4d7f5e; }
        .led-pair-mini { display: flex; flex-direction: column; gap: 3px; }

        /* Card */
        .card { background: #151517; border-radius: 12px; padding: 12px 16px 12px 30px; margin-bottom: 10px; border-left: 5px solid #333; position: relative; transition: transform 0.1s; }
        a { display: block; text-decoration: none; color: inherit; -webkit-tap-highlight-color: transparent; }
        .card:active { transform: scale(0.98); background-color: #222; }
        .train-info { font-size: 0.9rem; font-weight: 700; margin-bottom: 4px; }
        .main-time { display: flex; align-items: center; justify-content: center; padding: 6px 0; gap: 6px; flex-wrap: nowrap; }
        .time-group { display: flex; flex-direction: column; align-items: center; }
        .time-date-label { font-size: 0.65rem; color: #888; margin-bottom: 2px; font-family: monospace; letter-spacing: 0.5px;}
        .time-part { font-size: 1.8rem; font-weight: 700; line-height: 1; white-space: nowrap; display: flex; align-items: baseline; }
        .ampm { font-size: 1rem; margin-right: 3px; color: #aaa; font-weight: normal; }
        .arrow { font-size: 0.8rem; color: #666; margin-top: 10px; flex-shrink: 0;} 
        @media (max-width: 360px) { .time-part { font-size: 1.5rem; } .ampm { font-size: 0.85rem; } }
        .sub-time { text-align: center; color: #888; font-size: 0.75rem; }
        .card.past { opacity: 0.5; filter: grayscale(0.8); }
        .card.past::after { content: 'å·²é§›é›¢'; position: absolute; bottom: 10px; right: 10px; font-size: 0.7rem; color: #fff; background: #333; padding: 2px 6px; border-radius: 4px; }
        .message { text-align: center; padding: 40px; color: #666; font-size: 0.9rem; }
        .left-indicator { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; gap: 6px; }
        .status-badge-container { position: absolute; top: 12px; right: 16px; display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
        .status-tag { padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; display: inline-flex; align-items: center; white-space: nowrap; }
        .status-tag.departed { color: #888; border: 1px solid #555; background: #222; }
        .status-tag.delay { color: hsl(40, 100%, 50%); border: 1px solid hsl(40, 100%, 50%); }
        .card.departed-card { opacity: 0.5; filter: grayscale(1); border-left-color: #555 !important; }
        .card.departed-card:active { transform: none; background-color: #151517; }

        /* Skeleton & Modal */
        /* [ä¿®æ­£] éª¨æ¶é«˜åº¦èª¿æ•´ç‚º 110px é…åˆçœŸå¯¦å¡ç‰‡ */
        .skeleton-card { background: #1c1c1e; border-radius: 12px; padding: 12px 16px; margin-bottom: 10px; border-left: 5px solid #333; animation: pulse-loading 1.5s infinite ease-in-out; min-height: 110px; }
        @keyframes pulse-loading { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
        .sk-line { background: #333; border-radius: 4px; }
        .sk-title { height: 14px; width: 60%; margin-bottom: 12px; }
        .sk-main { height: 24px; width: 80%; margin: 0 auto 12px auto; }
        .sk-sub { height: 12px; width: 50%; margin: 0 auto; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 999; display: none; align-items: center; justify-content: center; }
        .modal-content { background: #1c1c1e; width: 85%; max-width: 400px; border-radius: 16px; padding: 25px; border: 1px solid #333; box-shadow: 0 10px 30px rgba(0,0,0,0.5); text-align: left; position: relative; max-height: 80vh; overflow-y: auto; }
        .modal-header-row { display: flex; align-items: center; margin-bottom: 15px; position: sticky; top: -25px; background: #1c1c1e; z-index: 10; padding: 10px 0; border-bottom: 1px solid #333; }
        .back-btn { background: none; border: none; color: #888; font-size: 1.5rem; cursor: pointer; padding: 0 10px 0 0; line-height: 1; }
        .modal-title { font-size: 1.2rem; font-weight: bold; color: #4d7f5e; flex: 1; }
        .menu-btn { display: flex; justify-content: space-between; align-items: center; width: 100%; padding: 15px; margin-bottom: 10px; background: #2c2c2e; border: 1px solid #444; color: #fff; border-radius: 12px; font-size: 1rem; cursor: pointer; }
        .menu-btn:active { background: #3a3a3c; }
        .menu-btn::after { content: 'â€º'; color: #666; font-size: 1.2rem; }
        .modal-text { font-size: 0.9rem; line-height: 1.6; color: #ccc; margin-bottom: 20px; }
        .modal-close { background: #333; color: #fff; border: none; padding: 10px 0; width: 100%; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .modal-page { display: none; }
        .modal-page.active { display: block; animation: fadeIn 0.2s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        /* [æ–°å¢] Start Button Active State */
        .btn-start:active { transform: scale(0.95); opacity: 0.9; }

        /* Tutorial Pointers (Vertical Layout) */
        .tutorial-container { position: relative; margin-top: 30px; margin-bottom: 15px; }
        .t-pointer { position: absolute; color: #e6b800; font-weight: bold; font-size: 0.9rem; z-index: 10; display: flex; align-items: center; gap: 5px; top: -25px; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }
        .t-pointer.led-hint { left: 5px; }
        .t-pointer.led-hint::before { content: 'ğŸ‘‡'; margin-right: 5px; }
        .t-pointer.delay-hint { right: 5px; }
        .t-pointer.delay-hint::before { content: 'ğŸ‘‡'; margin-right: 5px; }

        /* God Mode Styles */
        .dev-tabs { display: flex; border-bottom: 1px solid #333; margin-bottom: 10px; }
        .dev-tab { flex: 1; padding: 10px; text-align: center; background: #1a1a1c; color: #666; cursor: pointer; border-top-left-radius: 8px; border-top-right-radius: 8px; }
        .dev-tab.active { background: #222; color: #fff; font-weight: bold; border-bottom: 2px solid #4d7f5e; }
        .dev-panel { display: none; }
        .dev-panel.active { display: block; }
        
        .gm-container { display: flex; flex-direction: column; height: 350px; gap: 10px; }
        .gm-list { 
            height: 120px; background: #0d0d0d; border: 1px solid #333; border-radius: 8px; 
            overflow-y: auto; padding: 5px; 
        }
        .gm-list-item { 
            padding: 8px; border-bottom: 1px solid #222; font-size: 0.8rem; color: #888; 
            cursor: pointer; display: flex; justify-content: space-between; 
        }
        .gm-list-item:hover { background: #222; color: #fff; }
        .gm-list-item.active { background: #1a3320; color: #4d7f5e; border-left: 3px solid #4d7f5e; }
        
        .gm-terminal, .terminal-box, .dev-terminal {
            flex: 1; background: #000; border: 1px solid #333; border-radius: 8px;
            color: #00ff00; font-family: monospace; font-size: 0.75rem; padding: 10px;
            overflow-x: auto; white-space: pre; box-shadow: inset 0 0 10px #000;
        }
        
        /* Toggle Switch */
        .toggle-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; background: #1a1a1c; padding: 10px; border-radius: 8px; border: 1px solid #333; }
        .toggle-switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #4d7f5e; }
        input:checked + .slider:before { transform: translateX(20px); }
        /* [ä¿®æ­£] Toggle Disabled ç‹€æ…‹ */
        input:disabled + .slider { background-color: #444; cursor: not-allowed; opacity: 0.5; }

        .report-list-item { padding: 8px; border-bottom: 1px solid #333; cursor: pointer; display: flex; justify-content: space-between; color: #ccc; font-size: 0.8rem; }
        .report-list-item:hover { background: #333; }
        .report-timestamp { color: #4d7f5e; font-family: monospace; }

        .back-to-top {
            position: fixed; bottom: 85px; right: 25px; width: 50px; height: 50px;
            background: #4d7f5e; color: #fff; border-radius: 50%; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            font-size: 1.5rem; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 100;
            opacity: 0; transform: translateY(20px); transition: all 0.3s ease; pointer-events: none; 
        }
        .back-to-top.visible { opacity: 1; transform: translateY(0); pointer-events: auto; }
        .back-to-top:active { transform: scale(0.9); background: #3d664b; }

        .diag-section { margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .diag-section:last-child { border-bottom: none; }
        .diag-title { font-size: 0.85rem; color: #888; margin-bottom: 8px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
        
        .ios-instruction { text-align: center; margin-top: 10px; }
        .ios-step { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 12px; color: #ccc; font-size: 0.95rem; }
        .ios-icon { font-size: 1.4rem; color: #4d7f5e; }

        #inAppOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.92); z-index: 10000; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 40px 20px; box-sizing: border-box; backdrop-filter: blur(5px); }
        .guide-icon { font-size: 3rem; color: #4d7f5e; margin-bottom: 20px; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.8; } }
        .guide-highlight { color: #e6b800; font-weight: bold; font-size: 1.3rem; margin: 20px 0; border: 2px dashed #444; padding: 15px; border-radius: 12px; background: #222; }

        .btn-half { flex: 1; font-size: 0.9rem; }
        .btn-secondary { background: #3a3a3c; color: #fff; border: 1px solid #555; }
        .btn-primary { background: #007AFF; color: white; }
    </style>
</head>
<body class="tick-a">
    <div id="inAppOverlay" onclick="this.style.display='none'">
        <div class="guide-icon">ğŸŒ</div>
        <div style="color:#fff; font-size:1.1rem; line-height:1.6;">è«‹åˆ‡æ›è‡³ç€è¦½å™¨é–‹å•Ÿ</div>
        <div class="guide-highlight">1. é»æ“Šé¸å–® (â‹®)<br><br>2. é¸æ“‡ã€Œåœ¨ç€è¦½å™¨é–‹å•Ÿã€</div>
        <div style="font-size:0.8rem; color:#aaa; margin-top:20px;">(é»æ“Šä»»æ„è™•é—œé–‰)</div>
    </div>

    <div id="fixedFooterHints" class="fixed-footer-hints">
        <div id="hintArrival" class="hint-group">
            <div class="led-pair-mini">
                <div class="led-dot top"></div>
                <div class="led-dot bottom"></div>
            </div>
            <div class="hint-text-col">
                <span>10åˆ†é˜å…§</span>
                <span>ç™¼è»Š</span>
            </div>
        </div>
        <div id="hintDivider" class="hint-divider"></div>
        <div class="hint-group">
            <span style="font-size:1.2rem">ğŸ‘†</span>
            <div class="hint-text-col">
                <span>é»æ“Šè»Šæ¬¡å¡ç‰‡æŸ¥çœ‹</span>
                <span class="sub">å³æ™‚ä½ç½® & å®Œæ•´åœé ç«™</span>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div class="header-static-part">
                <div class="header-top">
                    <div class="app-title" onclick="handleLogoClick()">TRAIN LIVE</div>

                    <div class="top-actions">
                        <button id="btnInstall" class="install-btn-top" onclick="handleInstall()">
                            ğŸ“² åŠ åˆ°æ¡Œé¢
                        </button>
                        <button class="menu-btn-trigger anim-gold-pulse" onclick="openModal()">â˜°</button>
                    </div>
                </div>

                <div class="search-row">
                    <select id="searchTarget" class="search-target" onchange="handleSearch()"><option value="start">è¨­ç‚ºèµ·é»</option><option value="end">è¨­ç‚ºçµ‚é»</option></select>
                    <input type="text" id="searchInput" class="search-box" placeholder="ğŸ” æœå°‹è»Šç«™ (å¯æ‰“å­—è¼¸å…¥...)" oninput="handleSearch()">
                </div>

                <div class="selector-row">
                    <div class="selector-label">èµ·é»</div>
                    <div class="select-group">
                        <select id="startRegion" class="region-select" onchange="updateStationList('start')"></select>
                        <select id="startStation" class="station-select" onchange="markAsChanged()"></select>
                    </div>
                </div>
                <div class="swap-container"><button class="swap-btn" onclick="swapStations()">â‡„</button></div>
                <div class="selector-row">
                    <div class="selector-label">çµ‚é»</div>
                    <div class="select-group">
                        <select id="endRegion" class="region-select" onchange="updateStationList('end')"></select>
                        <select id="endStation" class="station-select" onchange="markAsChanged()"></select>
                    </div>
                </div>

                <button id="btnSearch" class="btn-static-search" onclick="doSearch()">ğŸ” æŸ¥è©¢è·¯ç·š</button>
            </div>

            <div id="stickyHeader" class="header-sticky-part">
                <div id="rowQuickRoute" class="sticky-row-top">
                    <div id="quickRouteArea" class="quick-route-scroll-container"></div>
                    <div id="scrollHint" class="scroll-hint-overlay">
                        <span class="scroll-hint-arrow">â€º</span>
                    </div>
                    <div class="btn-side-container">
                         <button id="btnStar" class="btn-fav-compact" onclick="toggleFavorite()">â˜…<br>å·²æ”¶è—</button>
                    </div>
                </div>

                <div id="rowTools" class="sticky-row-tools">
                    <button id="btnRefresh" class="toolbar-btn refresh" onclick="doRefresh()">ğŸ”„ æ›´æ–°</button>
                    <button id="btnShowAll" class="toolbar-btn" onclick="toggleShowAll()">ğŸ‘ï¸ å·²é§›é›¢</button>
                    <button id="btnTimeFormat" class="toolbar-btn" onclick="toggleTimeFormat()">ğŸ•’ AM/PM</button>
                </div>

                <div class="sticky-row-status">
                    <div id="statusMsg" class="status-left"></div>
                    <div id="updateTime" class="status-right"></div>
                </div>
            </div>
            <div id="stickyPlaceholder"></div>
        </div>

        <div id="cardList"></div>
    </div>

    <button id="btnBackToTop" class="back-to-top" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">
        â†‘
    </button>

    <div id="aboutModal" class="modal-overlay" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div id="pageMenu" class="modal-page active">
               <div class="modal-header-row"><div class="modal-title">é¸å–®</div></div>
               <button class="menu-btn anim-gold-pulse" onclick="goToPage('Why')">è¨­è¨ˆç†å¿µ</button>
               <button class="menu-btn" onclick="goToPage('How')">æ“ä½œèªªæ˜</button>
               <button class="menu-btn" onclick="goToPage('Report')">ç³»çµ±è¨ºæ–· / å•é¡Œå›å ±</button>
               <button class="menu-btn" onclick="goToPage('Author')">é—œæ–¼ä½œè€…</button>
               <button class="menu-btn" onclick="shareApp()">ğŸ“¤ åˆ†äº«çµ¦æœ‹å‹</button>
               <div style="height:10px"></div>
               <button class="modal-close" style="margin-top:15px;" onclick="closeModal()">é—œé–‰</button>
            </div>
            <div id="pageWhy" class="modal-page">
                <div class="modal-header-row"><button class="back-btn" onclick="goToPage('Menu')">â€¹</button><div class="modal-title">è¨­è¨ˆç†å¿µ</div></div>
                <div class="modal-text">ç¾æœ‰çš„ç«è»Šæ™‚åˆ»è¡¨è»Ÿé«”ï¼Œé€šå¸¸åªæœƒé¡¯ç¤ºã€Œèª¤é»å¹¾åˆ†é˜ã€ï¼Œè€Œæ²’æœ‰å¹«å¿™ç®—å‡ºã€Œå¯¦éš›å¹¾é»æœƒåˆ°ã€ã€‚<br><br>ç•¶ç«è»Šå¤§é‡èª¤é»æ™‚ï¼Œæˆ‘å€‘éœ€è¦åœ¨è…¦ä¸­ä¸æ–·åŠ æ¸›è¨ˆç®—ï¼Œéå¸¸ä¸ä¾¿ã€‚<br><br><strong>TRAIN LIVE çš„è¨­è¨ˆç›®æ¨™ï¼š</strong><br>1. ç›´æ¥é¡¯ç¤º<strong>ã€Œèª¤é»å¾Œçš„å¯¦éš›æ™‚é–“ã€</strong>ã€‚<br>2. ä¾ç…§<strong>ã€Œå¯¦éš›ç™¼è»Šé †åºã€</strong>æ’åˆ—ï¼Œè€ŒéåŸå®šæ™‚åˆ»ã€‚<br>3. ä¸€çœ¼çœ‹å‡ºç¾åœ¨è©²æ­å“ªä¸€ç­è»Šã€‚<br><br>å¸Œæœ›é€™å€‹å·¥å…·èƒ½è§£æ±ºä½ çš„é€šå‹¤ç„¦æ…®ã€‚</div>
            </div>
            <div id="pageHow" class="modal-page">
                <div class="modal-header-row"><button class="back-btn" onclick="goToPage('Menu')">â€¹</button><div class="modal-title">æ“ä½œèªªæ˜</div></div>
                <div class="modal-text">
                    <strong>æ“ä½œé‚è¼¯ï¼š</strong><br><br>
                    1. <strong>ä¸Šæ–¹æœå°‹åˆ—ï¼š</strong>è¼¸å…¥ç«™åå¿«é€Ÿåˆ‡æ›ã€‚<br>
                    2. <strong>å¸¸ç”¨è·¯ç·š (æ©«æ¢)ï¼š</strong>é»æ“Šå¿«é€Ÿè¼‰å…¥æ”¶è—æˆ–æ­·å²è·¯ç·šã€‚<br>
                    3. <strong>è‡ªå‹•æ›´æ–°ï¼š</strong>ç³»çµ±æ¯ 15 ç§’æœƒè‡ªå‹•æª¢æŸ¥ã€Œæ˜¯å¦é§›é›¢ã€ï¼Œä¸æ¶ˆè€—æµé‡ã€‚<br><br>
                    <strong>é‡è©¦æ©Ÿåˆ¶ï¼š</strong><br>
                    éŒ¯èª¤æˆ–ç³»çµ±å¿™ç¢Œéƒ½æœƒè‡ªå‹•é‡è©¦ï¼Œè«‹è€å¿ƒç­‰å€™ã€‚
                </div>
            </div>

            <div id="pageTutorial" class="modal-page">
                <div class="modal-header-row"><div class="modal-title">æ­¡è¿ä½¿ç”¨ TRAIN LIVE</div></div>
                <div class="modal-text" style="font-size:0.95rem;">
                    <div style="text-align:center; margin-bottom:10px; color:#ccc;">æˆ‘å€‘å·²ç¶“å¹«æ‚¨ç®—å¥½æ™‚é–“äº†ï¼</div>
                    
                    <div class="tutorial-container">
                        <div class="t-pointer led-hint">äº®ç‡ˆä»£è¡¨<br>10åˆ†é˜å…§ é€²ç«™</div>
                        <div class="card" style="border-left-color: #4d7f5e; margin:0; pointer-events:none;">
                            <div class="left-indicator">
                                <div class="led-dot top" style="opacity:1; box-shadow:0 0 6px #4d7f5e; animation: led-blink 1s infinite alternate;"></div>
                                <div class="led-dot bottom" style="opacity:1; box-shadow:0 0 6px #4d7f5e; animation: led-blink 1s infinite alternate;"></div>
                            </div>
                            <div class="train-info" style="color:#4d7f5e;">è‡ªå¼· 123 æ¬¡</div>
                            <div class="main-time">
                                <div class="time-group"><div class="time-date-label" style="color:#4d7f5e;">è‡ºåŒ—</div><div class="time-part">10:00</div></div>
                                <span class="arrow">â”</span>
                                <div class="time-group"><div class="time-date-label" style="color:#4d7f5e;">æ¿æ©‹</div><div class="time-part">10:10</div></div>
                            </div>
                            <div class="sub-time"><span style="color:#4d7f5e; font-weight:bold; letter-spacing:1px;">â— æº–é»</span></div>
                        </div>
                    </div>

                    <div class="tutorial-container">
                        <div class="t-pointer delay-hint">å¤§å­—æ˜¯ã€Œå¯¦éš›ã€<br>ç™¼è»Šæ™‚é–“ (å·²åŠ )</div>
                        <div class="card" style="border-left-color: #DF3F1F; margin:0; pointer-events:none;">
                            <div class="status-badge-container"><div class="status-tag delay">èª¤é» 15 åˆ†</div></div>
                            <div class="train-info" style="color:#DF3F1F;">è‡ªå¼· 456 æ¬¡</div>
                            <div class="main-time">
                                <div class="time-group"><div class="time-date-label" style="color:#4d7f5e;">è‡ºåŒ—</div><div class="time-part" style="color:#e6b800">10:15</div></div>
                                <span class="arrow">â”</span>
                                <div class="time-group"><div class="time-date-label" style="color:#4d7f5e;">æ¿æ©‹</div><div class="time-part" style="color:#e6b800">10:25</div></div>
                            </div>
                            <div class="sub-time">åŸå®š 10:00 â” 10:10</div>
                        </div>
                    </div>

                    <button class="menu-btn btn-start" style="text-align:center; justify-content:center; margin-top:20px; background:#4d7f5e; border-color:#4d7f5e; font-weight:bold;" onclick="closeTutorial()">é–‹å§‹ä½¿ç”¨</button>
                </div>
            </div>

            <div id="pageReport" class="modal-page">
                <div class="modal-header-row"><button class="back-btn" onclick="goToPage('Menu')">â€¹</button><div class="modal-title">ç³»çµ±è¨ºæ–·</div></div>
                
                <div style="margin-bottom:15px;">
                    <textarea id="userDesc" class="search-box" style="width:100%; resize:none; font-size:1rem; padding:10px;" rows="5" placeholder="é‡åˆ°ä»€éº¼å•é¡Œï¼Ÿ(é¸å¡«)"></textarea>
                    <button class="menu-btn" style="width:100%; text-align:center; justify-content:center; margin-top:10px;" onclick="manualUploadReport()">â˜ï¸ é€å‡ºå›å ±</button>
                    <div id="autoUploadHint" style="color:#4d7f5e; font-size:0.8rem; text-align:center; margin-top:5px; opacity:0; transition:opacity 1s;">âœ… ç³»çµ±è³‡æ–™å·²è‡ªå‹•æ­¸æª”</div>
                </div>

                <div class="diag-section" style="border:none;">
                    <div class="diag-title">ç³»çµ±ç´€éŒ„ (Log)</div>
                    <div id="terminalView" class="terminal-box"></div>
                </div>
            </div>

            <div id="pageAuthor" class="modal-page">
                <div class="modal-header-row"><button class="back-btn" onclick="goToPage('Menu')">â€¹</button><div class="modal-title">é—œæ–¼ä½œè€…</div></div>
                <div class="modal-text" style="text-align:center;">
                    <div style="font-size:0.95rem; color:#fff; font-weight:bold; margin-bottom:10px;">
                        BenjaminDai èˆ‡ Gemini
                    </div>
                    <a href="https://www.instagram.com/d16benjamin_?igsh=N2c3M25ia3M0a3c4" target="_blank" style="font-size:0.85rem; color:#4d7f5e; display:inline-block; margin-bottom:5px; text-decoration:none;">
                        @d16benjamin_
                    </a>
                    <div style="font-size:0.7rem; color:#444; margin-top:10px;">Start: 2026/1/6</div>
                </div>
            </div>
            
            <div id="pageLogin" class="modal-page">
                <div class="modal-header-row">
                    <div class="modal-title">ğŸ” èº«åˆ†é©—è­‰</div>
                    <button class="modal-close" style="width:auto; padding:5px 15px;" onclick="closeModal()">é—œé–‰</button>
                </div>
                <div class="modal-text">
                    <div style="margin-bottom:15px; color:#aaa; font-size:0.85rem;">è«‹è¼¸å…¥é–‹ç™¼è€…å¸³è™Ÿå¯†ç¢¼</div>
                    <input type="text" id="loginUser" class="search-box" placeholder="User" style="width:100%; margin-bottom:10px;" autocomplete="off">
                    <input type="password" id="loginPass" class="search-box" placeholder="Password" style="width:100%; margin-bottom:20px;" autocomplete="off">
                    <button class="menu-btn" style="text-align:center; justify-content:center;" onclick="doLogin()">ç™»å…¥</button>
                </div>
            </div>

            <div id="pageDev" class="modal-page">
                <div class="modal-header-row">
                    <div class="modal-title" style="color:#334439;">é–‹ç™¼è€…é é¢</div>
                    <button class="modal-close" style="width:auto; padding:5px 15px;" onclick="closeModal()">é—œé–‰</button>
                </div>
                
                <div class="modal-text">
                    <div class="toggle-row">
                        <span>è³‡æ–™æ”¶é›†é–‹é—œ</span>
                        <div style="display:flex; align-items:center; gap:5px;">
                            <span id="toggleStatusLabel" style="font-size:0.8rem; color:#666;">(Loading)</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="loggingToggle" disabled onchange="toggleLogging()">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>

                    <div class="dev-tabs">
                        <div class="dev-tab active" onclick="switchDevTab('sessions')">å³æ™‚ Sessions</div>
                        <div class="dev-tab" onclick="switchDevTab('reports')">æ­¸æª”å ±å‘Š</div>
                    </div>

                    <div id="panelSessions" class="dev-panel active">
                        <div class="gm-container">
                            <div id="gmSessionList" class="gm-list">Loading...</div>
                            <div id="gmLogView" class="gm-terminal">Select a user...</div>
                        </div>
                        <div style="margin-top:10px; display:flex; gap:10px;">
                            <button class="menu-btn" style="flex:1; padding:8px;" onclick="fetchSessionList()">ğŸ”„ åˆ·æ–°</button>
                            <button class="menu-btn" style="flex:1; padding:8px;" onclick="copyDevContent('session')">ğŸ“‹ è¤‡è£½ Log</button>
                            <button class="menu-btn" style="flex:1; padding:8px; background:#3a1111; border-color:#ff4d4d; color:#ff4d4d;" onclick="clearSessions()">ğŸ—‘ï¸ æ¸…ç©º</button>
                        </div>
                    </div>

                    <div id="panelReports" class="dev-panel">
                        <div style="margin-bottom:10px; display:flex; gap:10px;">
                            <button class="menu-btn" style="flex:1; padding:8px;" onclick="fetchReportList()">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
                            <button class="menu-btn" style="flex:1; padding:8px; background:#3a1111; border-color:#ff4d4d; color:#ff4d4d;" onclick="clearReports()">ğŸ—‘ï¸ æ¸…ç©ºå ±å‘Š</button>
                        </div>
                        <div id="reportListContainer" class="terminal-box" style="height:120px; margin-bottom:10px;"></div>
                        <div style="display:flex; justify-content:space-between; align-items:center; margin: 10px 0 5px 0;">
                            <div class="info-label">å ±å‘Šå…§å®¹ï¼š</div>
                            <button class="btn-fav-compact" style="width:auto; padding:2px 8px;" onclick="copyDevContent('report')">ğŸ“‹ è¤‡è£½å…§å®¹</button>
                        </div>
                        <div id="reportDetailContainer" class="dev-terminal" style="height:150px;">é»æ“Šä¸Šæ–¹åˆ—è¡¨æŸ¥çœ‹...</div>
                    </div>
                </div>
            </div>

            <div id="pageIOS" class="modal-page">
                <div class="modal-header-row"><div class="modal-title">å®‰è£æ•™å­¸ (iOS)</div><button class="modal-close" style="width:auto; padding:5px 15px;" onclick="closeModal()">é—œé–‰</button></div>
                <div class="ios-instruction">
                    <div class="ios-step">1. é»æ“Š <span class="ios-icon">â‹</span> <strong>åˆ†äº«</strong> æŒ‰éˆ•</div>
                    <div class="ios-step">2. é¸æ“‡ <span class="ios-icon">âŠ</span> <strong>åŠ å…¥ä¸»ç•«é¢</strong></div>
                    <div class="ios-step">3. é»æ“Šå³ä¸Šè§’çš„ã€ŒåŠ å…¥ã€</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ... (Station Data, Constants) ...
        const STATION_DATA = {
            "åŸºéš†å¸‚": ["åŸºéš†", "ä¸‰å‘", "å…«å µ", "ä¸ƒå µ", "ç™¾ç¦", "æš–æš–", "æµ·ç§‘é¤¨"],
            "æ–°åŒ—å¸‚": ["äº”å µ", "æ±æ­¢", "æ±ç§‘", "æ¿æ©‹", "æµ®æ´²", "æ¨¹æ—", "å—æ¨¹æ—", "å±±ä½³", "é¶¯æ­Œ", "é³³é³´", "å››è…³äº­", "ç‘èŠ³", "ä¾¯ç¡", "ä¸‰è²‚å¶º", "ç‰¡ä¸¹", "é›™æºª", "è²¢å¯®", "ç¦éš†", "å…«æ–—å­", "å¤§è¯", "ååˆ†", "æœ›å¤", "å¶ºè…³", "å¹³æºª", "èæ¡"],
            "è‡ºåŒ—å¸‚": ["å—æ¸¯", "æ¾å±±", "è‡ºåŒ—", "è¬è¯"],
            "æ¡ƒåœ’å¸‚": ["æ¡ƒåœ’", "å…§å£¢", "ä¸­å£¢", "åŸ”å¿ƒ", "æ¥Šæ¢…", "å¯Œå²¡", "æ–°å¯Œ"],
            "æ–°ç«¹ç¸£å¸‚": ["åŒ—æ¹–", "æ¹–å£", "æ–°è±", "ç«¹åŒ—", "åŒ—æ–°ç«¹", "æ–°ç«¹", "ä¸‰å§“æ©‹", "é¦™å±±", "åƒç”²", "æ–°èŠ", "å…­å®¶", "ç«¹ä¸­", "ä¸Šå“¡", "æ¦®è¯", "ç«¹æ±", "æ©«å±±", "ä¹è®šé ­", "åˆèˆˆ", "å¯Œè²´", "å…§ç£"],
            "è‹—æ —ç¸£": ["å´é ‚", "ç«¹å—", "é€ æ©‹", "è±å¯Œ", "è‹—æ —", "å—å‹¢", "éŠ…é‘¼", "ä¸‰ç¾©", "è«‡æ–‡", "å¤§å±±", "å¾Œé¾", "é¾æ¸¯", "ç™½æ²™å±¯", "æ–°åŸ”", "é€šéœ„", "è‹‘è£¡"],
            "è‡ºä¸­å¸‚": ["æ³°å®‰", "åé‡Œ", "è±åŸ", "æ —æ—", "æ½­å­", "é ­å®¶å", "æ¾ç«¹", "å¤ªåŸ", "ç²¾æ­¦", "è‡ºä¸­", "äº”æ¬Š", "å¤§æ…¶", "çƒæ—¥", "æ–°çƒæ—¥", "æˆåŠŸ", "æ—¥å—", "å¤§ç”²", "è‡ºä¸­æ¸¯", "æ¸…æ°´", "æ²™é¹¿", "é¾äº•", "å¤§è‚š", "è¿½åˆ†"],
            "å½°åŒ–ç¸£": ["å½°åŒ–", "èŠ±å£‡", "å¤§æ‘", "å“¡æ—", "æ°¸é–", "ç¤¾é ­", "ç”°ä¸­", "äºŒæ°´", "æºæ³‰"],
            "å—æŠ•ç¸£": ["æ¿æ°´", "é¾æ³‰", "é›†é›†", "æ°´é‡Œ", "è»ŠåŸ•"],
            "é›²æ—ç¸£": ["æ—å…§", "çŸ³æ¦´", "æ–—å…­", "æ–—å—", "çŸ³é¾œ"],
            "å˜‰ç¾©ç¸£å¸‚": ["å¤§æ—", "æ°‘é›„", "å˜‰åŒ—", "å˜‰ç¾©", "æ°´ä¸Š", "å—é–"],
            "è‡ºå—å¸‚": ["å¾Œå£", "æ–°ç‡Ÿ", "æŸ³ç‡Ÿ", "æ—é³³ç‡Ÿ", "éš†ç”°", "æ‹”æ—", "å–„åŒ–", "å—ç§‘", "æ–°å¸‚", "æ°¸åº·", "å¤§æ©‹", "è‡ºå—", "ä¿å®‰", "ä»å¾·", "ä¸­æ´²", "é•·æ¦®å¤§å­¸", "æ²™å´™"],
            "é«˜é›„å¸‚": ["å¤§æ¹–", "è·¯ç«¹", "å²¡å±±", "æ©‹é ­", "æ¥ æ¢“", "æ–°å·¦ç‡Ÿ", "å·¦ç‡Ÿ", "å…§æƒŸ", "ç¾è¡“é¤¨", "é¼“å±±", "ä¸‰å¡Šå", "é«˜é›„", "æ°‘æ—", "ç§‘å·¥é¤¨", "æ­£ç¾©", "é³³å±±", "å¾Œåº„", "ä¹æ›²å ‚"],
            "å±æ±ç¸£": ["å…­å¡Šå", "å±æ±", "æ­¸ä¾†", "éºŸæ´›", "è¥¿å‹¢", "ç«¹ç”°", "æ½®å·", "å´é ‚", "å—å·", "é®å®‰", "æ—é‚Š", "ä½³å†¬", "æ±æµ·", "æ‹å¯®", "åŠ ç¥¿", "å…§ç…", "æ‹å±±"],
            "å®œè˜­ç¸£": ["æ¼¢æœ¬", "æ­¦å¡”", "å—æ¾³", "æ±æ¾³", "æ°¸æ¨‚", "è˜‡æ¾³", "è˜‡æ¾³æ–°", "å†¬å±±", "ç¾…æ±", "ä¸­é‡Œ", "äºŒçµ", "å®œè˜­", "å››åŸ", "ç¤æºª", "é ‚åŸ”", "é ­åŸ", "å¤–æ¾³", "é¾œå±±", "å¤§æºª", "å¤§é‡Œ", "çŸ³åŸ"],
            "èŠ±è“®ç¸£": ["å’Œå¹³", "å’Œä»", "å´‡å¾·", "æ–°åŸ", "æ™¯ç¾", "åŒ—åŸ”", "èŠ±è“®", "å‰å®‰", "å¿—å­¸", "å¹³å’Œ", "å£½è±", "è±ç”°", "æ—æ¦®æ–°å…‰", "å—å¹³", "é³³æ—", "è¬æ¦®", "å…‰å¾©", "å¤§å¯Œ", "å¯Œæº", "ç‘ç©—", "ä¸‰æ°‘", "ç‰é‡Œ", "æ±é‡Œ", "æ±ç«¹", "å¯Œé‡Œ"],
            "è‡ºæ±ç¸£": ["æ± ä¸Š", "æµ·ç«¯", "é—œå±±", "ç‘å’Œ", "ç‘æº", "é¹¿é‡", "å±±é‡Œ", "è‡ºæ±", "åº·æ¨‚", "çŸ¥æœ¬", "å¤ªéº»é‡Œ", "é‡‘å´™", "ç€§æºª", "å¤§æ­¦"]
        };

        const STATION_INDEX={};Object.keys(STATION_DATA).forEach(r=>{STATION_DATA[r].forEach(s=>{STATION_INDEX[s]=r;});});
        const DEFAULT_STATIONS = {"åŸºéš†å¸‚": "åŸºéš†", "æ–°åŒ—å¸‚": "æ¿æ©‹", "è‡ºåŒ—å¸‚": "è‡ºåŒ—", "æ¡ƒåœ’å¸‚": "æ¡ƒåœ’", "æ–°ç«¹ç¸£å¸‚": "æ–°ç«¹", "è‹—æ —ç¸£": "è‹—æ —", "è‡ºä¸­å¸‚": "è‡ºä¸­", "å½°åŒ–ç¸£": "å½°åŒ–", "å—æŠ•ç¸£": "é›†é›†", "é›²æ—ç¸£": "æ–—å…­", "å˜‰ç¾©ç¸£å¸‚": "å˜‰ç¾©", "è‡ºå—å¸‚": "è‡ºå—", "é«˜é›„å¸‚": "é«˜é›„", "å±æ±ç¸£": "å±æ±", "å®œè˜­ç¸£": "ç¾…æ±", "èŠ±è“®ç¸£": "èŠ±è“®", "è‡ºæ±ç¸£": "è‡ºæ±"};

        const CACHE_PREFIX="train_data_v2_";
        const PREF_START_R_KEY="pref_start_region";const PREF_START_S_KEY="pref_start_station";
        const PREF_END_R_KEY="pref_end_region";const PREF_END_S_KEY="pref_end_station";
        
        // [æ–°å¢] æ–°ç‰ˆå°è¦½å·²è®€ Key
        const LS_TUTORIAL_SEEN="tl_intro_seen_v2";
        // [æ–°å¢] éª¨æ¶å±æ•¸é‡ Key
        const LS_SKELETON_COUNT="tl_skeleton_count";

        const startRegion=document.getElementById('startRegion');const startStation=document.getElementById('startStation');
        const endRegion=document.getElementById('endRegion');const endStation=document.getElementById('endStation');
        const searchInput=document.getElementById('searchInput');const searchTarget=document.getElementById('searchTarget');
        const btnSearch=document.getElementById('btnSearch');const btnRefresh=document.getElementById('btnRefresh');
        const statusMsg=document.getElementById('statusMsg');const updateTimeDiv=document.getElementById('updateTime');
        const list=document.getElementById('cardList');const btnInstall = document.getElementById('btnInstall');

        let refreshTimer=null; let searchLockTimer=null; let retryTimer=null;
        const LS_SEARCH_COUNT="tl_search_count";const LS_SEARCH_RESET="tl_search_reset_time";
        const LS_SEARCH_LOCK="tl_search_locked_until";const LS_REFRESH_LOCK="tl_refresh_locked_until";
        const LS_UI_LOCK = "tl_ui_button_locked_until"; 

        const LS_IS_24H="tl_pref_is_24h"; 

        const MAX_SEARCH_PER_MIN=3;
        let lastFetchedPair={start:"",end:""};
        let is24Hour = localStorage.getItem(LS_IS_24H) !== 'false';
        let isShowAll = false;
        let lastDiagnostics = { route_source: "--", route_quota: "--", delay_source: "--", delay_quota: "--" };
        let systemLogs=[]; let requestHistory=[];

        let isNextDayLoaded = false;
        let currentTrainData = null;
        let lastUpdateTime = 0; // ç”¨æ–¼å–šé†’æª¢æŸ¥
        let isResumeHintActive = false; // ç´€éŒ„æ˜¯å¦æ­£åœ¨é¡¯ç¤ºå–šé†’æç¤º
        
        let serverLoggingEnabled = true;

        // Session ID
        let SESSION_ID = localStorage.getItem('tl_session_v2'); 
        if (!SESSION_ID) {
            const now = new Date();
            const timeStr = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}${String(now.getSeconds()).padStart(2,'0')}`;
            SESSION_ID = `u_${timeStr}`;
            localStorage.setItem('tl_session_v2', SESSION_ID); 
        }
        let adminAuth = { u: "", p: "" }; 

        let deferredPrompt;
        const isIos = /iPhone|iPad|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        const isInStandaloneMode = ('standalone' in window.navigator) && (window.navigator.standalone) || window.matchMedia('(display-mode: standalone)').matches;
        const isInApp = /Line|Instagram|FBAN|FBAV/i.test(navigator.userAgent);

        if (!isInStandaloneMode) { btnInstall.style.display = 'flex'; }
        window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; });

        function handleInstall() {
            if (isInApp) { document.getElementById('inAppOverlay').style.display = 'flex'; return; }
            if (isIos) { document.getElementById('aboutModal').style.display = 'flex'; goToPage('IOS'); return; }
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((c) => { if(c.outcome==='accepted') btnInstall.style.display='none'; deferredPrompt=null; });
            } else {
                document.getElementById('aboutModal').style.display = 'flex';
                const page = document.getElementById('pageIOS');
                page.querySelector('.modal-title').innerText = "å®‰è£æ•™å­¸";
                page.querySelector('.ios-instruction').innerHTML = `<div class="ios-step">1. é»æ“Šç€è¦½å™¨å³ä¸Šè§’ <span class="ios-icon">â‹®</span> é¸å–®</div><div class="ios-step">2. é¸æ“‡ <span class="ios-icon">ğŸ“²</span> <strong>åŠ åˆ°ä¸»ç•«é¢</strong></div><div class="ios-step">3. é»æ“Šã€Œå®‰è£ã€æˆ–ã€Œæ–°å¢ã€</div><div style="font-size:0.8rem; color:#888; margin-top:15px;">(è‹¥ç„¡æ­¤é¸é …ï¼Œä»£è¡¨å¯èƒ½å·²å®‰è£)</div>`;
                goToPage('IOS');
            }
        }
        async function shareApp() {
            const data = { title: 'TRAIN LIVE', text: 'èª¤é»è‡ªå‹•è¨ˆç®—ï¼', url: window.location.href };
            if (navigator.share) try { await navigator.share(data); } catch(e){} else { try{await navigator.clipboard.writeText(window.location.href);alert('é€£çµå·²è¤‡è£½');}catch(e){} }
        }

        // --- God Mode Logic ---
        let logoClickCount = 0; let logoClickTimer = null;
        function handleLogoClick() {
            logoClickCount++;
            if (logoClickCount === 1) { logoClickTimer = setTimeout(() => { logoClickCount = 0; }, 1000); }
            if (logoClickCount >= 5) { clearTimeout(logoClickTimer); logoClickCount = 0; activateGodMode(); }
        }
        function activateGodMode() {
            document.getElementById('aboutModal').style.display = 'flex';
            document.body.classList.add('noscroll');
            history.pushState({modal: true}, '', '');

            if (adminAuth.u && adminAuth.p) {
                goToPage('Dev');
                fetchSessionList();
                fetchConfig(); 
            } else {
                goToPage('Login');
            }
        }
        function doLogin() {
            const u = document.getElementById('loginUser').value;
            const p = document.getElementById('loginPass').value;
            if (!u || !p) return;
            adminAuth = { u, p };
            document.getElementById('loginUser').value = "";
            document.getElementById('loginPass').value = "";
            goToPage('Dev');
            fetchSessionList();
            fetchConfig(); 
        }
        
        function switchDevTab(tab) {
            document.querySelectorAll('.dev-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.dev-panel').forEach(p => p.classList.remove('active'));
            if (tab === 'sessions') {
                document.getElementById('panelSessions').classList.add('active');
                fetchSessionList();
            } else {
                document.getElementById('panelReports').classList.add('active');
                fetchReportList();
            }
        }

        async function fetchConfig() {
            const toggle = document.getElementById('loggingToggle');
            const label = document.getElementById('toggleStatusLabel');
            try {
                toggle.disabled = true; label.innerText = "(Loading)";
                const res = await fetch(`/api/index?debug=godmode&action=get_config&u=${adminAuth.u}&p=${adminAuth.p}`);
                const json = await res.json();
                toggle.checked = (json.logging_enabled === "1");
                toggle.disabled = false; label.innerText = "";
            } catch(e) {
                label.innerText = "(Err)";
            }
        }
        async function toggleLogging() {
            const val = document.getElementById('loggingToggle').checked ? "1" : "0";
            await fetch(`/api/index?debug=godmode&action=set_config&key=logging_enabled&val=${val}&u=${adminAuth.u}&p=${adminAuth.p}`);
        }

        async function fetchSessionList() {
            const listEl = document.getElementById('gmSessionList');
            listEl.innerHTML = "Loading...";
            try {
                const res = await fetch(`/api/index?debug=godmode&action=list_sessions&u=${adminAuth.u}&p=${adminAuth.p}`);
                const json = await res.json();
                if (json.sessions && json.sessions.length > 0) {
                    let html = '';
                    json.sessions.forEach(s => {
                        const isMe = s.id === SESSION_ID ? " (Me)" : "";
                        const status = s.ttl > 86000 ? "ğŸŸ¢" : "âšª"; 
                        html += `<div class="gm-list-item" onclick="loadSessionLogs('${s.id}', this)">
                                    <span>[${s.last_active_str}] ${status} ${s.id}${isMe}</span>
                                 </div>`;
                    });
                    listEl.innerHTML = html;
                } else { listEl.innerHTML = "No active sessions."; }
            } catch (e) { listEl.innerHTML = "Error: " + e.message; }
        }

        async function clearSessions() {
            if(!confirm("ç¢ºå®šæ¸…ç©ºæ‰€æœ‰ Session ç´€éŒ„ï¼Ÿ")) return;
            await fetch(`/api/index?debug=godmode&action=clear_sessions&u=${adminAuth.u}&p=${adminAuth.p}`);
            fetchSessionList();
        }
        async function clearReports() {
            if(!confirm("ç¢ºå®šæ¸…ç©ºæ‰€æœ‰å ±å‘Šï¼Ÿ")) return;
            await fetch(`/api/index?debug=godmode&action=clear_reports&u=${adminAuth.u}&p=${adminAuth.p}`);
            fetchReportList();
        }

        async function loadSessionLogs(sid, el) {
            document.querySelectorAll('.gm-list-item').forEach(i => i.classList.remove('active'));
            if(el) el.classList.add('active');
            const logView = document.getElementById('gmLogView');
            logView.innerHTML = `Loading logs for ${sid}...`;
            try {
                const res = await fetch(`/api/index?debug=godmode&action=get_session_logs&sid=${sid}&u=${adminAuth.u}&p=${adminAuth.p}`);
                const json = await res.json();
                if (json.logs && json.logs.length > 0) { logView.innerHTML = json.logs.join('\n'); } 
                else { logView.innerHTML = "No logs found."; }
            } catch (e) { logView.innerHTML = "Error: " + e.message; }
        }

        async function fetchReportList() {
            const container = document.getElementById('reportListContainer');
            container.innerHTML = "Loading...";
            try {
                const res = await fetch(`/api/index?debug=godmode&action=list_reports&u=${adminAuth.u}&p=${adminAuth.p}`);
                const json = await res.json();
                if (json.reports && json.reports.length > 0) {
                    let html = '';
                    json.reports.forEach(key => {
                        const displayTime = key.replace('report:', '').split('_')[0] + ' ' + key.split('_')[1];
                        html += `<div class="report-list-item" onclick="loadReportDetail('${key}')">
                                    <span class="report-timestamp">${displayTime}</span>
                                    <span>ğŸ“„</span>
                                 </div>`;
                    });
                    container.innerHTML = html;
                } else { container.innerHTML = "æ²’æœ‰æ­¸æª”å ±å‘Š"; }
            } catch (e) { container.innerHTML = "Error: " + e.message; }
        }

        function formatReport(data) {
            const logs = Array.isArray(data.logs) ? data.logs.join('\n') : "No logs";
            
            return `ğŸ“… æ™‚é–“: ${data.timestamp || '--'}
ğŸ“± è£ç½®: ${data.user_agent || 'Unknown'}
ğŸ“ ç•«é¢: ${data.screen || '--'}
--------------------------------
[ç³»çµ±ç´€éŒ„]
${logs}`;
        }

        async function loadReportDetail(reportId) {
            const detailBox = document.getElementById('reportDetailContainer');
            detailBox.innerHTML = "Loading content...";
            try {
                const res = await fetch(`/api/index?debug=godmode&action=get_report&id=${reportId}&u=${adminAuth.u}&p=${adminAuth.p}`);
                const json = await res.json();
                if (json.report_content) { 
                    detailBox.innerText = formatReport(json.report_content); 
                } 
                else { detailBox.innerHTML = "Error: Not Found"; }
            } catch (e) { detailBox.innerHTML = "Fetch Error: " + e.message; }
        }
        
        function copyDevContent(type) {
            let text = "";
            if(type === 'session') {
                const el = document.getElementById('gmLogView');
                text = el ? el.innerText : "";
            } else {
                const el = document.getElementById('reportDetailContainer');
                text = el ? el.innerText : "";
            }
            if(!text || text.includes("Loading") || text.includes("Select a user")) {
                alert("æ²’æœ‰å…§å®¹å¯è¤‡è£½"); return;
            }
            navigator.clipboard.writeText(text).then(() => {
                alert("å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ âœ…");
            }).catch(err => {
                alert("è¤‡è£½å¤±æ•—: " + err);
            });
        }
        
        function startTicker() {
            setInterval(() => {
                if (document.body.classList.contains('tick-a')) {
                    document.body.classList.remove('tick-a'); document.body.classList.add('tick-b');
                } else {
                    document.body.classList.remove('tick-b'); document.body.classList.add('tick-a');
                }
            }, 500);
            setInterval(() => {
                if (currentTrainData && !document.hidden) renderCards(currentTrainData);
            }, 15000);
        }

        // [æ–°å¢] æ–·ç·šåµæ¸¬
        window.addEventListener('offline', () => { statusMsg.innerText = "âš ï¸ ç¶²è·¯å·²ä¸­æ–·"; statusMsg.className = "status-left alert"; });
        window.addEventListener('online', () => { statusMsg.innerText = "ç¶²è·¯å·²æ¢å¾©"; setTimeout(() => statusMsg.innerText="", 2000); });

        // [æ–°å¢] å–šé†’æª¢æŸ¥
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                const now = Date.now();
                // 3åˆ†é˜ = 180000ms
                if (lastUpdateTime > 0 && (now - lastUpdateTime > 180000)) {
                    showResumeHint();
                }
            }
        });

        // [æ–°å¢] é¡¯ç¤ºå–šé†’æç¤ºè† å›Š
        function showResumeHint() {
            isResumeHintActive = true;
            statusMsg.innerHTML = `<div class="status-chip" onclick="doRefresh()"><span class="chip-arrow">â¬†</span> è³‡æ–™å¯æ›´æ–° <span class="chip-close" onclick="closeResumeChip(event)">Ã—</span></div>`;
            statusMsg.className = "status-left"; 
            
            // [æ–°å¢] å¼·åˆ¶å±•é–‹å·¥å…·åˆ—
            const elTools = document.getElementById('rowTools');
            if (currentTrainData && elTools.style.display !== 'flex') {
                elTools.style.display = 'flex';
            }
        }

        function closeResumeChip(e) {
            if(e) e.stopPropagation();
            isResumeHintActive = false;
            statusMsg.innerHTML = "";
        }

        function getSearchCount(){return parseInt(localStorage.getItem(LS_SEARCH_COUNT)||"0");}
        function setSearchCount(v){localStorage.setItem(LS_SEARCH_COUNT,v);}
        function getSearchResetTime(){return parseInt(localStorage.getItem(LS_SEARCH_RESET)||"0");}
        function setSearchResetTime(v){localStorage.setItem(LS_SEARCH_RESET,v);}
        function getSearchLockedUntil(){return parseInt(localStorage.getItem(LS_SEARCH_LOCK)||"0");}
        function setSearchLockedUntil(v){localStorage.setItem(LS_SEARCH_LOCK,v);}
        function getRefreshLockedUntil(){return parseInt(localStorage.getItem(LS_REFRESH_LOCK)||"0");}
        function setRefreshLockedUntil(v){localStorage.setItem(LS_REFRESH_LOCK,v);}
        function getUiLockedUntil(){return parseInt(localStorage.getItem(LS_UI_LOCK)||"0");}
        function setUiLockedUntil(v){localStorage.setItem(LS_UI_LOCK,v);}

        function updateToggleBtns() {
            const btnTime = document.getElementById('btnTimeFormat');
            if (!is24Hour) btnTime.classList.add('active'); else btnTime.classList.remove('active');
            const btnAll = document.getElementById('btnShowAll');
            if (isShowAll) {
                btnAll.innerHTML = 'ğŸ‘ï¸ å·²é§›é›¢';
                btnAll.classList.add('active'); 
            } else {
                btnAll.innerHTML = 'ğŸ‘ï¸ å·²é§›é›¢'; 
                btnAll.classList.remove('active');
            }
        }
        function toggleTimeFormat() { is24Hour=!is24Hour; localStorage.setItem(LS_IS_24H, is24Hour); updateToggleBtns(); reRenderLocal(); scrollToFirstActive();}
        function toggleShowAll() { isShowAll=!isShowAll; updateToggleBtns(); reRenderLocal(); scrollToFirstActive();}

        function formatTime(t) {
            if(!t) return "";
            if(is24Hour) return t;
            const p = t.split(':'); if(p.length < 2) return t;
            let h = parseInt(p[0]); let suffix = "AM";
            if(h >= 12) { suffix = "PM"; if(h > 12) h -= 12; } else if(h === 0) { h = 12; }
            return `<span class="ampm">${suffix}</span> ${h}:${p[1]}`;
        }

        let lastScroll = 0; let currentTranslate = 0;
        
        const sticky = document.getElementById('stickyHeader');
        const placeholder = document.getElementById('stickyPlaceholder');
        const backToTop = document.getElementById('btnBackToTop');
        const staticPart = document.querySelector('.header-static-part');
        const headerEl = document.querySelector('.header');

        window.addEventListener('scroll', () => {
            const current = window.scrollY;
            const headerOffset = headerEl ? headerEl.offsetTop : 0;
            const threshold = staticPart ? (staticPart.offsetHeight + headerOffset) : 150;
            const stickyHeight = sticky.offsetHeight || 150;

            if(current > 300) backToTop.classList.add('visible'); else backToTop.classList.remove('visible');

            if (current <= threshold - 1) {
                sticky.classList.remove('is-fixed');
                sticky.style.transform = 'translateY(0)';
                placeholder.style.display = 'none';
                currentTranslate = 0;
            } else if (current > threshold) {
                if (!sticky.classList.contains('is-fixed')) {
                      placeholder.style.height = stickyHeight + 'px'; 
                      placeholder.style.display = 'block';
                      sticky.classList.add('is-fixed');
                }
                const diff = current - lastScroll;
                currentTranslate -= diff;
                if (currentTranslate > 0) currentTranslate = 0;
                if (currentTranslate < -stickyHeight) currentTranslate = -stickyHeight;
                if (current < threshold + stickyHeight + 10) currentTranslate = 0;
                sticky.style.transform = `translateX(-50%) translateY(${currentTranslate}px)`;
            }
            lastScroll = current <= 0 ? 0 : current;
        });

        function scrollToFirstActive() {
            setTimeout(() => {
                const el = document.getElementById("firstActive");
                if (el) {
                    el.scrollIntoView({ behavior: "smooth", block: "center" });
                }
            }, 300); 
        }

        function init() {
            logSystem("App Started"); 
            startTicker(); 
            updateToggleBtns();
            
            document.getElementById('rowTools').style.display = 'none';

            // [æ–°å¢] Cache å®‰å…¨æ€§æª¢æŸ¥
            try {
                const regions=Object.keys(STATION_DATA); const rOpts=regions.map(r=>`<option value="${r}">${r}</option>`).join('');
                const savedSR = localStorage.getItem(PREF_START_R_KEY);
                if (savedSR) {
                    startRegion.innerHTML=rOpts; endRegion.innerHTML=rOpts;
                    setMenu('start',savedSR,localStorage.getItem(PREF_START_S_KEY)||"å±æ±"); 
                    setMenu('end',localStorage.getItem(PREF_END_R_KEY)||"å±æ±ç¸£",localStorage.getItem(PREF_END_S_KEY)||"æ½®å·");
                    checkLocksOnLoad(); loadDataOrFetch();
                } else {
                    startRegion.innerHTML=`<option value="" disabled selected>é¸æ“‡ç¸£å¸‚</option>`+rOpts; 
                    endRegion.innerHTML=`<option value="" disabled selected>é¸æ“‡ç¸£å¸‚</option>`+rOpts;
                    startStation.innerHTML=endStation.innerHTML=`<option value="" disabled selected>é¸æ“‡è»Šç«™</option>`;
                    list.innerHTML='<div class="message">è«‹é¸æ“‡ èµ·é» èˆ‡ çµ‚é» è»Šç«™<br>é–‹å§‹æŸ¥è©¢</div>';
                    statusMsg.innerText="ç­‰å¾…è¼¸å…¥...";
                    checkLocksOnLoad();
                }
            } catch(e) {
                console.error("Cache corrupted, clearing...", e);
                localStorage.clear();
                window.location.reload();
            }
            
            renderQuickRoutes();
            updateStarState();
        }
        function checkLocksOnLoad() {
            const now=Date.now();
            const sL=getSearchLockedUntil(); if(sL>now) lockSearchButton(Math.ceil((sL-now)/1000));
            const uL=getUiLockedUntil(); if(uL>now) lockRefreshButton(Math.ceil((uL-now)/1000));
        }
        function setMenu(type,rV,sV) {
            const rSel=type==='start'?startRegion:endRegion; const sSel=type==='start'?startStation:endStation;
            if(!STATION_DATA[rV]) { rSel.value = ""; return; }
            rSel.value=rV; sSel.innerHTML=STATION_DATA[rV].map(s=>`<option value="${s}">${s}</option>`).join('');
            if(STATION_DATA[rV].includes(sV)) sSel.value=sV; else sSel.selectedIndex=0;
        }
        function updateStationList(type) {
            const rSel=type==='start'?startRegion:endRegion; const sSel=type==='start'?startStation:endStation;
            const rVal = rSel.value; if (!rVal) return;
            sSel.innerHTML=STATION_DATA[rVal].map(s=>`<option value="${s}">${s}</option>`).join('');
            const def=DEFAULT_STATIONS[rVal]; 
            if(def&&STATION_DATA[rVal].includes(def)) sSel.value=def; else sSel.selectedIndex=0;
            if(startStation.value&&endStation.value) markAsChanged();
        }
        function swapStations() {
            if(!startStation.value||!endStation.value) return; logSystem("Action: Swap");
            const sR=startRegion.value; const sS=startStation.value;
            setMenu('start',endRegion.value,endStation.value); setMenu('end',sR,sS);
            markAsChanged();
        }
        function handleSearch() {
            const rawVal=searchInput.value.trim(); const tgt=searchTarget.value; if(!rawVal) return;
            const val = rawVal.replace(/å°/g, 'è‡º'); // [æ–°å¢] è‡ªå‹•è½‰è‡º
            let found=STATION_INDEX[val]?val:Object.keys(STATION_INDEX).find(s=>s.includes(val));
            if(found) {
                logSystem(`Action: InputSearch\n             ${found}`); 
                setMenu(tgt,STATION_INDEX[found],found);
                searchInput.style.borderColor="#4d7f5e"; setTimeout(()=>searchInput.style.borderColor="#444",500);
                if(startStation.value&&endStation.value) markAsChanged();
            }
        }
        function markAsChanged() {
            // [æ–°å¢] åªè¦å‹•äº†é¸å–®ï¼Œç«‹åˆ»éš±è—å–šé†’æç¤º
            if (isResumeHintActive) {
                isResumeHintActive = false;
                statusMsg.innerHTML = "";
            }

            if(!startStation.value||!endStation.value) return;
            localStorage.setItem(PREF_START_R_KEY,startRegion.value); localStorage.setItem(PREF_START_S_KEY,startStation.value);
            localStorage.setItem(PREF_END_R_KEY,endRegion.value); localStorage.setItem(PREF_END_S_KEY,endStation.value);
            
            isNextDayLoaded = false;
            
            attemptLoadCache(false);
            updateStarState();
        }
        function getCacheKey(){return `${CACHE_PREFIX}${startStation.value}_${endStation.value}`;}

        function reRenderLocal() {
            if (currentTrainData) {
                renderCards(currentTrainData);
                return;
            }
            const baseKey = getCacheKey();
            const fullKey = baseKey + "_full";
            const cFull = localStorage.getItem(fullKey);
            const c = localStorage.getItem(baseKey);

            if(cFull) {
                const d = JSON.parse(cFull);
                if(Date.now()-d.timestamp < 60000) { renderCards(d.payload); isNextDayLoaded=true; return; }
            }
            if(c) renderCards(JSON.parse(c).payload); 
        }

        function attemptLoadCache(isInit) {
            if(!startStation.value||!endStation.value) return;
            
            const baseKey = getCacheKey();
            const fullKey = baseKey + "_full";
            const cFull = localStorage.getItem(fullKey);
            const c = localStorage.getItem(baseKey);
            let hitData = null;

            if (cFull) {
                const d = JSON.parse(cFull);
                if (Date.now() - d.timestamp < 60000) { hitData = d; isNextDayLoaded = true; }
            }
            if (!hitData && c) {
                const d = JSON.parse(c);
                if (Date.now() - d.timestamp < 60000) { hitData = d; }
            }

            if(hitData) {
                if(hitData.payload.diagnostics) parseDiagnostics(hitData.payload.diagnostics, false); 
                renderCards(hitData.payload); 
                setUpdateText(`æ›´æ–°æ™‚é–“ï¼š${hitData.payload.update_time}`);
                statusMsg.innerText=""; statusMsg.className="status-left"; 
                list.style.opacity="1"; 
                lastFetchedPair={start:startStation.value,end:endStation.value}; 
                scrollToFirstActive(); 
            } else {
                if(isInit) {
                    statusMsg.innerText="ç­‰å¾…æŸ¥è©¢"; list.innerHTML='<div class="message">è«‹é»æ“Šä¸Šæ–¹æŒ‰éˆ•æŸ¥è©¢ç­æ¬¡</div>';
                } else {
                    list.style.opacity="0.4"; statusMsg.innerText="è¨­å®šå·²è®Šæ›´"; statusMsg.className="status-left warning";
                }
            }
            updateButtonMode();
        }
        function loadDataOrFetch(){attemptLoadCache(true);}
        function updateButtonMode() {
            if(getSearchLockedUntil()>Date.now()) return;
            if(startStation.value!==lastFetchedPair.start||endStation.value!==lastFetchedPair.end) btnSearch.disabled=false;
        }

        function doSearch() {
            const sS=startStation.value; const eS=endStation.value;
            if(!sS||!eS) { statusMsg.innerText="è«‹å…ˆé¸æ“‡èµ·é»èˆ‡çµ‚é»"; statusMsg.className="status-left alert"; setTimeout(()=>statusMsg.innerText="",2000); return; }
            markAsChanged();
            if(sS===lastFetchedPair.start&&eS===lastFetchedPair.end) { doRefresh(); return; }
            const now=Date.now(); let cnt=getSearchCount(); let rst=getSearchResetTime();
            if(now-rst>60000) { cnt=0; setSearchCount(0); rst=now; setSearchResetTime(now); }
            if(cnt===0) { rst=now; setSearchResetTime(now); }
            if(cnt>=MAX_SEARCH_PER_MIN) {
                const w=Math.ceil((60000-(now-rst))/1000); const safeW=w>0?w:60;
                setSearchLockedUntil(now+safeW*1000); lockSearchButton(safeW); logSystem("Limit: Search Limit"); return;
            }
            addToHistory();
            cnt++; setSearchCount(cnt); 
            const spaces = "            "; 
            logSystem(`Action: Search(${cnt}/${MAX_SEARCH_PER_MIN})\n${spaces}${sS} -> ${eS}`); 
            fetchData("search");
        }
        function doRefresh(skip=false) {
            const now = Date.now();
            
            // [æ–°å¢] æŒ‰ä¸‹æ›´æ–°æ™‚ï¼Œå¦‚æœæœ‰å–šé†’æç¤ºè† å›Šï¼Œç«‹åˆ»æ¸…é™¤
            if (isResumeHintActive) {
                isResumeHintActive = false;
                statusMsg.innerHTML = "";
            }

            if(!skip) {
                const uL = getUiLockedUntil();
                if(uL > now) return; 
            }
            const rL = getRefreshLockedUntil();
            
            if(rL > now && !skip) {
                logSystem("Action: Soft Refresh (Cache)");
                
                reRenderLocal(); 
                statusMsg.innerText = "è³‡æ–™æœ‰æ•ˆä¸­ (å¿«å–)";
                statusMsg.className = "status-left";
                setTimeout(() => statusMsg.innerText="", 2000);
                setUiLockedUntil(now + 30000); 
                lockRefreshButton(30);
                return; 
            }
            const spaces = "            "; 
            logSystem(`Action: Refresh\n${spaces}${startStation.value} -> ${endStation.value}`); 
            fetchData("refresh");
        }
        
        function handleLoadNextDay() {
            logSystem("Action: Load Next Day");
            const btn = document.getElementById('btnLoadNext');
            if(btn) { btn.disabled=true; btn.innerText = "â³ è¼‰å…¥ä¸­..."; }
            fetchData("load_next_day");
        }

        async function uploadReportInternal(desc, isAuto) {
            const statusHint = document.getElementById('autoUploadHint');
            const now = Date.now();
            const rpm = requestHistory.filter(t => now - t < 60000).length;
            
            const reportData = {
                timestamp: new Date().toLocaleString(),
                user_agent: navigator.userAgent,
                screen: `${window.innerWidth}x${window.innerHeight}`,
                rpm: rpm,
                total_requests: requestHistory.length,
                diagnostics: lastDiagnostics,
                logs: systemLogs,
                user_desc: desc || "(Auto Upload on Open)"
            };

            try {
                const res = await fetch('/api/index', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(reportData)
                });
                const json = await res.json();
                
                if (json.status === 'ok') {
                    if (isAuto) {
                        statusHint.style.opacity = '1';
                        setTimeout(() => { statusHint.style.opacity = '0'; }, 3000);
                    } else {
                        alert("âœ… æ„Ÿè¬å›å ±ï¼é–‹ç™¼è€…å·²æ”¶åˆ°æ‚¨çš„è¨Šæ¯ã€‚");
                        document.getElementById('userDesc').value = ""; 
                    }
                } else {
                    if (!isAuto) alert('âŒ ä¸Šå‚³å¤±æ•—: ' + (json.error || 'Unknown'));
                }
            } catch (e) {
                if (!isAuto) alert('âŒ ä¸Šå‚³éŒ¯èª¤: ' + e.message);
            }
        }
        
        function uploadReport() {
            uploadReportInternal("", true);
        }
        
        function manualUploadReport() {
            const desc = document.getElementById('userDesc').value;
            uploadReportInternal(desc, false);
        }

        function parseDiagnostics(diag, isCdn) {
            const parseDiag = (str, isC) => {
                let source = "API"; let quota = "--";
                if (isC) source = "Vercel";
                else if (str.includes("Hit") || str.includes("Cache") || str.includes("Redis")) source = "Redis";
                else if (str.includes("API")) source = "API";
                const match = str.match(/\(å‰©:\s*(\d+)\)/); if (match) quota = match[1];
                return { source, quota };
            };
            const rInfo = parseDiag(diag.route_status, isCdn);
            const dInfo = diag.delay_status ? parseDiag(diag.delay_status, isCdn) : { source: "--", quota: "--" };
            lastDiagnostics = { route_source: rInfo.source, route_quota: rInfo.quota, delay_source: dInfo.source, delay_quota: dInfo.quota };
            return { rInfo, dInfo };
        }

        function getSkeletonHTML() {
            // [æ–°å¢] è®€å–ä¸Šæ¬¡æ•¸é‡ï¼Œå‹•æ…‹ç”Ÿæˆ
            const lastCount = parseInt(localStorage.getItem(LS_SKELETON_COUNT) || "3");
            const count = Math.min(Math.max(lastCount, 3), 10);
            let html = ''; 
            for(let i=0; i<count; i++) html += `<div class="skeleton-card"><div class="sk-line sk-title"></div><div class="sk-line sk-main"></div><div class="sk-line sk-sub"></div></div>`;
            return html;
        }

        async function fetchData(mode) {
            if(mode==="search") btnSearch.disabled=true; if(mode==="refresh") btnRefresh.disabled=true;
            
            if(mode !== "load_next_day") {
                list.innerHTML = getSkeletonHTML(); 
                list.style.opacity="1"; 
            }
            statusMsg.innerText="è¼‰å…¥ä¸­..."; 
            if(retryTimer){clearTimeout(retryTimer);retryTimer=null;}

            const s=startStation.value; const e=endStation.value; 
            
            const needNextDay = (mode === "load_next_day" || isNextDayLoaded) ? 1 : 0;
            const cacheKeySuffix = needNextDay ? "_full" : ""; 
            const cacheKey = getCacheKey() + cacheKeySuffix; 
            
            const now = Date.now();
            const rpmVal = requestHistory.filter(t => now - t < 60000).length;

            recordRequest();
            try {
                let url = `/api/index?start=${s}&end=${e}&next_day=${needNextDay}&mode=${mode}`;
                if(serverLoggingEnabled) {
                    url += `&sid=${SESSION_ID}`;
                }

                const res=await fetch(url);
                const age = res.headers.get('Age');
                const isVercelCache = age && parseInt(age) > 0;
                const json=await res.json();
                if(json.error) throw new Error(json.error);

                if(json.logging_enabled !== undefined) {
                    serverLoggingEnabled = json.logging_enabled;
                }

                lastFetchedPair={start:s,end:e};
                
                if (needNextDay) isNextDayLoaded = true;

                const { rInfo, dInfo } = parseDiagnostics(json.diagnostics, isVercelCache);
                
                localStorage.setItem(cacheKey,JSON.stringify({timestamp:Date.now(),payload:json}));
                renderCards(json);

                logSystem(`${rInfo.source}${rInfo.quota !== "--" ? `(å‰©:${rInfo.quota})` : ""} / ${dInfo.source}${dInfo.quota !== "--" ? `(å‰©:${dInfo.quota})` : ""}`);

                if(json.delay_failed) {
                    scheduleRetry("èª¤é»è³‡æ–™å¤±æ•—", "status-left warning");
                    setUpdateText(`æ›´æ–°æ™‚é–“ï¼š${json.update_time} (åƒ…æ™‚åˆ»)`);
                } else {
                    setUpdateText(`æ›´æ–°æ™‚é–“ï¼š${json.update_time}`);
                    statusMsg.innerText = "æ›´æ–°å®Œæˆ";
                    setTimeout(()=> { if(statusMsg.innerText==="æ›´æ–°å®Œæˆ") statusMsg.innerText=""; }, 2000);
                }
                
                if(mode==="search"){ 
                    setTimeout(()=>btnSearch.disabled=false,500); 
                    setRefreshLockedUntil(now+90000); 
                    setUiLockedUntil(now+30000);
                    lockRefreshButton(30);            
                }
                if(mode==="refresh"){ 
                    setRefreshLockedUntil(now+90000); 
                    setUiLockedUntil(now+30000);
                    lockRefreshButton(30);            
                }
                
                if (mode === "load_next_day") {
                    const divider = document.getElementById('tomorrow-divider');
                    if (divider) {
                        divider.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        setTimeout(() => window.scrollBy({ top: -60, behavior: 'smooth' }), 500);
                    }
                } else {
                    scrollToFirstActive(); 
                }

                lastUpdateTime = Date.now(); // è¨˜éŒ„æˆåŠŸæ›´æ–°æ™‚é–“

                // [æ–°å¢] æª¢æŸ¥ä¸¦é¡¯ç¤ºæ–°æ‰‹å°è¦½ (å¼·åˆ¶æ‰€æœ‰ç”¨æˆ¶çœ‹åˆ°)
                if (localStorage.getItem(LS_TUTORIAL_SEEN) !== '1') {
                    setTimeout(() => {
                        document.getElementById('aboutModal').style.display='flex';
                        document.body.classList.add('noscroll');
                        // åŠ å…¥ Historyï¼Œè®“æ‰‹æ©Ÿè¿”å›éµç”Ÿæ•ˆ
                        history.pushState({modal: true}, '', '');
                        goToPage('Tutorial');
                    }, 500);
                }

            } catch(err) {
                console.error(err); logSystem("API Error: " + err.message);
                scheduleRetry("é€£ç·šéŒ¯èª¤", "status-left alert");
                list.innerHTML=`<div class="message">é€£ç·šç™¼ç”Ÿå•é¡Œ âš ï¸<br><span style="font-size:0.8rem;color:#888">è«‹è¦‹ç³»çµ±è¨ºæ–·</span></div>`;
            }
        }
        
        function setUpdateText(t){updateTimeDiv.innerText=t;localStorage.setItem("last_update_text",t);}

        function scheduleRetry(msg="èª¤é»è³‡è¨Šç„¡æ³•å–å¾—", cls="status-left warning") {
            let c=30; 
            if(retryTimer) clearInterval(retryTimer);
            statusMsg.className = cls; statusMsg.innerText = `${msg} (30s)`;
            retryTimer=setInterval(()=>{
                c--; statusMsg.innerText=`${msg} (${c}s)`;
                if(c<=0){ clearInterval(retryTimer); retryTimer=null; doRefresh(true); }
            },1000);
        }

        function lockSearchButton(s) {
            if(searchLockTimer) clearInterval(searchLockTimer);
            statusMsg.innerText="è«‹å‹¿é »ç¹æ“ä½œ"; statusMsg.className="status-left alert";
            btnSearch.disabled=true; btnSearch.innerText=`é »ç¹æ“ä½œ (${s})`;
            const t=()=>{
                btnSearch.innerText=`é »ç¹æ“ä½œ (${s})`;
                if(s<=0){
                    clearInterval(searchLockTimer); btnSearch.disabled=false; btnSearch.innerText="ğŸ” æŸ¥è©¢è·¯ç·š";
                    statusMsg.innerText=""; setSearchLockedUntil(0);
                } s--;
            }; t(); searchLockTimer=setInterval(t,1000);
        }
        function lockRefreshButton(s) {
            if(refreshTimer) clearInterval(refreshTimer);
            btnRefresh.disabled=true;
            const t=()=>{
                btnRefresh.innerText=`æ›´æ–° (${s})`;
                if(s<=0){
                    clearInterval(refreshTimer); btnRefresh.disabled=false;
                    btnRefresh.innerText="ğŸ”„ æ›´æ–°"; setRefreshLockedUntil(0);
                } s--;
            }; t(); refreshTimer=setInterval(t,1000);
        }

        function getStrictDateStr(ts) {
            const d = new Date(ts * 1000);
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        }

        function renderCards(data) {
            currentTrainData = data; 
            
            // [æ–°å¢] å„²å­˜æ•¸é‡ä¾›éª¨æ¶å±ä½¿ç”¨
            if(data.trains) localStorage.setItem(LS_SKELETON_COUNT, data.trains.length);

            const elTools = document.getElementById('rowTools');
            const hasTrains = data.trains && data.trains.length > 0;
            const originalCount = (data.stats && data.stats.original_count) ? data.stats.original_count : 0;
            const showTools = hasTrains || originalCount > 0;
            elTools.style.display = showTools ? 'flex' : 'none';

            const footerHints = document.getElementById('fixedFooterHints');
            const hintArrival = document.getElementById('hintArrival');
            const hintDivider = document.getElementById('hintDivider');

            if(hasTrains) {
                footerHints.style.display = 'flex';

                let cardsHtml = '';
                let anyArriving = false; 
                let has = false;
                let hasShownNextDayDivider = false;
                let lastTrainTs = 0;
                let foundFirstActive = false;
                const nowSec = Math.floor(Date.now() / 1000);

                const now = new Date();
                const todayStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
                
                const nowHour = now.getHours();
                const isLateNight = nowHour >= 22; 

                data.trains.forEach((t, index) => {
                    const diffSec = t.sort_key - nowSec;
                    const diffMin = Math.floor(diffSec / 60);
                    let isDeparted = diffSec < 0; 
                    let isArriving = !isDeparted && diffMin <= 10;
                    if(isArriving) anyArriving = true;

                    if (!isShowAll && diffMin < -10) return;

                    const trainDate = getStrictDateStr(t.sort_key);
                    const isStrictTomorrow = trainDate > todayStr;

                    if (has && !hasShownNextDayDivider && lastTrainTs > 0) {
                        const lastTrainDate = getStrictDateStr(lastTrainTs);
                        if (trainDate !== lastTrainDate) {
                            cardsHtml += `<div id="tomorrow-divider" style="text-align:center; padding:20px 0 10px 0; color:#4d7f5e; font-size:0.9rem; font-weight:bold; border-top:1px dashed #333; margin-top:15px; scroll-margin-top: 160px;">â¬‡ æ˜æ—¥ç­æ¬¡ â¬‡</div>`;
                            hasShownNextDayDivider = true;
                        }
                    }
                    lastTrainTs = t.sort_key;
                    has = true;

                    let activeId = "";
                    if (!isDeparted && !foundFirstActive) { activeId = 'id="firstActive"'; foundFirstActive = true; }

                    let leftIndicatorHtml = '';
                    if (isArriving) {
                        leftIndicatorHtml = `
                        <div class="left-indicator">
                            <div class="led-dot top"></div>
                            <div class="led-dot bottom"></div>
                        </div>`;
                    }

                    let rightBadgesHtml = '';
                    if (isDeparted) {
                        rightBadgesHtml = `<div class="status-tag departed">å·²é§›é›¢</div>`;
                    } else {
                        if (!isStrictTomorrow && !data.delay_failed && t.delay > 0) {
                            rightBadgesHtml += `<div class="status-tag delay">èª¤é» ${t.delay} åˆ†</div>`;
                        }
                    }

                    const url = `https://railway.chienwen.net/taiwan/train/TRA-${t.no}/live`;
                    let cardClass = "card"; if (isDeparted) cardClass += " departed-card";

                    const depDateLabel = isStrictTomorrow ? `<span style="color:#e6b800; font-weight:bold;">(æ˜æ—¥)</span>` : "";
                    const arrDateLabel = isStrictTomorrow ? `<span style="color:#e6b800; font-weight:bold;">(æ˜æ—¥)</span>` : "";

                    let subTimeContent = '';
                    if (!isStrictTomorrow && !data.delay_failed && t.delay === 0) {
                        subTimeContent = `<span style="color:#4d7f5e; font-weight:bold; letter-spacing:1px;">â— æº–é»</span>`;
                    } else {
                        subTimeContent = `åŸå®š ${formatTime(t.sch_dep)} â” ${formatTime(t.sch_arr)}`;
                    }

                    // [æ–°å¢] èª¤é»æ™‚é–“è®Šè‰²é‚è¼¯
                    let delayColorStyle = "";
                    if (!isStrictTomorrow && !data.delay_failed && t.delay > 0) {
                        delayColorStyle = 'style="color:#e6b800"';
                    }

                    cardsHtml += `<a href="${url}" target="_blank" ${activeId}>
                        <div class="${cardClass}" style="border-left-color:${t.color};">
                            ${leftIndicatorHtml}
                            <div class="status-badge-container">${rightBadgesHtml}</div>
                            <div class="train-info" style="color:${isDeparted ? '#888' : t.color};">${t.type} ${t.no} æ¬¡</div>
                            <div class="main-time">
                                <div class="time-group">
                                    <div class="time-date-label" style="color:#4d7f5e;">${startStation.value} ${depDateLabel}</div>
                                    <div class="time-part" ${delayColorStyle}>${formatTime(t.act_dep)}</div>
                                </div>
                                <span class="arrow">â”</span>
                                <div class="time-group">
                                    <div class="time-date-label" style="color:#4d7f5e;">${endStation.value} ${arrDateLabel}</div>
                                    <div class="time-part" ${delayColorStyle}>${formatTime(t.act_arr)}</div>
                                </div>
                            </div>
                            <div class="sub-time">${subTimeContent}</div>
                        </div>
                    </a>`;
                });

                if (isLateNight && !isNextDayLoaded) {
                    cardsHtml += `
                        <div style="padding: 20px 0 40px 0; display: flex; justify-content: center;">
                            <button id="btnLoadNext" onclick="handleLoadNextDay()" style="
                                background: #222; color: #aaa; border: 1px solid #444; 
                                padding: 10px 20px; border-radius: 20px; font-size: 0.9rem; 
                                cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 5px;">
                                â¬‡ è¼‰å…¥æ˜æ—¥ç­æ¬¡
                            </button>
                        </div>
                    `;
                }

                if (anyArriving) {
                    hintArrival.style.display = 'flex';
                    hintDivider.style.display = 'block';
                    footerHints.classList.remove('centered'); 
                } else {
                    hintArrival.style.display = 'none';
                    hintDivider.style.display = 'none';
                    footerHints.classList.add('centered'); 
                }

                list.innerHTML = (!has && !isShowAll) ? `<div class="message">æŸ¥ç„¡ç­æ¬¡ âš ï¸</div>` : cardsHtml;
                return;
            }

            footerHints.style.display = 'none';

            if (originalCount > 0) {
                 const nowHour = new Date().getHours();
                 const isLateNight = nowHour >= 22;
                 let extraBtn = "";
                 if (isLateNight && !isNextDayLoaded) {
                     extraBtn = `<div style="padding: 20px 0; display: flex; justify-content: center;">
                            <button id="btnLoadNext" onclick="handleLoadNextDay()" style="
                                background: #222; color: #aaa; border: 1px solid #444; 
                                padding: 10px 20px; border-radius: 20px; font-size: 0.9rem; 
                                cursor: pointer; transition: all 0.2s;">
                                â¬‡ è¼‰å…¥æ˜æ—¥ç­æ¬¡
                            </button>
                        </div>`;
                 }
                 list.innerHTML = `<div class="message">ä»Šæ—¥ç­æ¬¡å·²å…¨æ•¸é§›é›¢ ğŸ‘‹<br><span style="font-size:0.8rem;color:#666">TDX æ­£å¸¸ (åŸæœ‰ ${originalCount} ç­)</span></div>` + extraBtn;
            } else {
                 list.innerHTML = `<div class="message">æŸ¥ç„¡æ­¤å€é–“ç›´é”åˆ—è»Š âš ï¸</div>`;
            }
        }

        // [æ–°å¢] é—œé–‰æ•™å­¸ä¸¦å¯«å…¥å·²è®€
        function closeTutorial() {
            localStorage.setItem(LS_TUTORIAL_SEEN, '1');
            // å¼·åˆ¶éš±è— Modal (ç¢ºä¿é—œé–‰)
            document.getElementById('aboutModal').style.display = 'none';
            document.body.classList.remove('noscroll');
        }

        // [è£œå›éºå¤±çš„è¼”åŠ©å‡½å¼]
        function logSystem(d){
            const time = new Date().toLocaleTimeString('en-GB', {hour12:false});
            systemLogs.push(`[${time}] ${d}`);
            if(systemLogs.length>30)systemLogs.shift();
        }
        function recordRequest(){requestHistory.push(Date.now());}
        
        // [ä¿®æ”¹] é–‹å•Ÿæ™‚åŠ å…¥ noscroll èˆ‡ History State
        function openModal(){
            document.getElementById('aboutModal').style.display='flex';
            document.body.classList.add('noscroll');
            history.pushState({modal: true}, '', '');
            goToPage('Menu');
        }
        
        // [ä¿®æ”¹] é—œé–‰æ™‚åŸ·è¡Œ history.back()
        function closeModal(){
            history.back();
        }

        // [æ–°å¢] ç›£è½ popstate (æ‰‹æ©Ÿè¿”å›éµ)
        window.addEventListener('popstate', () => {
            const modal = document.getElementById('aboutModal');
            if (modal.style.display === 'flex') {
                modal.style.display = 'none';
                document.body.classList.remove('noscroll');
            }
        });

        function goToPage(id){
            document.querySelectorAll('.modal-page').forEach(p=>p.classList.remove('active'));
            document.getElementById('page'+id).classList.add('active');
            if(id==='Report'){
                // [ä¿®æ”¹] åˆªé™¤èˆŠçš„è³‡æ–™ä¾†æºé¡¯ç¤ºç¨‹å¼ç¢¼ï¼Œåªä¿ç•™ Log
                document.getElementById('terminalView').innerText = systemLogs.join("\n");
                uploadReport(); 
            }
        }
        function copyReportOnly() {
            let final = document.getElementById('reportContent').value; 
        }
        function openMailClient() { }

        const LS_FAV = "tl_favorites"; const LS_HIST = "tl_history";
        const MAX_HIST = 3; const MAX_FAV = 6;
        const btnStar = document.getElementById('btnStar');
        const quickArea = document.getElementById('quickRouteArea');

        function getCurrentPair() { return { start: startStation.value, end: endStation.value }; }
        function isFavorite(s, e) {
            const favs = JSON.parse(localStorage.getItem(LS_FAV) || "[]");
            return favs.some(f => f.start === s && f.end === e);
        }
        function toggleFavorite() {
            const cur = getCurrentPair(); if (!cur.start || !cur.end) return;
            let favs = JSON.parse(localStorage.getItem(LS_FAV) || "[]");
            const idx = favs.findIndex(f => f.start === cur.start && f.end === cur.end);
            if (idx >= 0) { favs.splice(idx, 1); logSystem("Fav: Removed"); } 
            else { if (favs.length >= MAX_FAV) { alert(`å¸¸ç”¨è·¯ç·šæœ€å¤š ${MAX_FAV} çµ„`); return; } favs.unshift(cur); logSystem("Fav: Added"); }
            localStorage.setItem(LS_FAV, JSON.stringify(favs));
            updateStarState(); renderQuickRoutes();
        }
        function addToHistory() {
            const cur = getCurrentPair(); if (!cur.start || !cur.end) return;
            let hist = JSON.parse(localStorage.getItem(LS_HIST) || "[]");
            hist = hist.filter(h => !(h.start === cur.start && h.end === cur.end));
            hist.unshift(cur); if (hist.length > MAX_HIST) hist.pop();
            localStorage.setItem(LS_HIST, JSON.stringify(hist));
            renderQuickRoutes();
        }
        function updateStarState() {
            const cur = getCurrentPair();
            if (isFavorite(cur.start, cur.end)) { 
                btnStar.innerHTML = 'â˜…<br>å·²æ”¶è—'; 
                btnStar.classList.add('fav-active'); 
            } else { 
                btnStar.innerHTML = 'â˜† æ”¶è—<br>è·¯ç·š'; 
                btnStar.classList.remove('fav-active'); 
            }
        }
        function loadRoute(s, e) {
            const sR = STATION_INDEX[s]; const eR = STATION_INDEX[e];
            if (sR && eR) {
                setMenu('start', sR, s); setMenu('end', eR, e);
                markAsChanged(); doSearch(); 
            }
        }
        function renderQuickRoutes() {
            const favs = JSON.parse(localStorage.getItem(LS_FAV) || "[]");
            const hist = JSON.parse(localStorage.getItem(LS_HIST) || "[]");
            let html = '';
            favs.forEach(r => { html += `<div class="route-chip fav" onclick="loadRoute('${r.start}', '${r.end}')">${r.start}<span class="chip-arrow">â”</span>${r.end}</div>`; });
            hist.forEach(r => { if (!isFavorite(r.start, r.end)) { html += `<div class="route-chip hist" onclick="loadRoute('${r.start}', '${r.end}')">${r.start}<span class="chip-arrow">â”</span>${r.end}</div>`; } });
            quickArea.innerHTML = html || '<div style="color:#666; font-size:0.8rem; padding:4px;">(å°šç„¡å¸¸ç”¨è·¯ç·š)</div>';

            const elRow = document.getElementById('rowQuickRoute');
            if (favs.length === 0 && hist.length === 0) {
                elRow.style.display = 'none';
            } else {
                elRow.style.display = 'flex';
                setTimeout(updateScrollHint, 100);
            }
        }

        function updateScrollHint() {
            const el = document.getElementById('quickRouteArea');
            const hint = document.getElementById('scrollHint');
            if (el.scrollWidth > el.clientWidth) {
                hint.style.opacity = '1';
                el.onscroll = () => {
                    if (el.scrollLeft + el.clientWidth >= el.scrollWidth - 5) {
                        hint.style.opacity = '0';
                    } else {
                        hint.style.opacity = '1';
                    }
                };
            } else {
                hint.style.opacity = '0';
            }
        }

        init();
    </script>
</body>
</html>