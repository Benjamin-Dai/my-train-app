<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>列車時刻 Live</title>
    <style>
        body { background: #000; color: #fff; font-family: -apple-system, sans-serif; padding: 10px; margin: 0; }
        .container { max-width: 500px; margin: 0 auto; padding-bottom: 60px; }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .station-title { font-size: 1.3rem; font-weight: bold; margin: 0; }
        .sub-title { color: #666; font-size: 0.75rem; }

        .controls { display: flex; flex-direction: column; align-items: flex-end; margin-bottom: 10px; gap: 5px; }
        .controls-row { display: flex; align-items: center; gap: 10px; }
        
        .status-text { font-size: 0.75rem; color: #888; text-align: right;}
        .countdown-text { font-size: 0.75rem; color: #007AFF; font-weight: 600; }
        
        .refresh-btn {
            background: #007AFF; color: white; border: none; padding: 6px 16px; 
            border-radius: 20px; font-size: 0.85rem; font-weight: 600; cursor: pointer;
            transition: opacity 0.2s;
        }
        .refresh-btn:disabled { background: #333; color: #888; cursor: not-allowed; }
        .refresh-btn:active { transform: scale(0.95); }

        .card { background: #151517; border-radius: 12px; padding: 12px 16px; margin-bottom: 10px; border-left: 5px solid #333; position: relative; }
        .delay-badge { position: absolute; top: 12px; right: 16px; border: 1px solid hsl(40, 100%, 50%); color: hsl(40, 100%, 50%); padding: 1px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: 600; }
        .train-info { font-size: 0.9rem; font-weight: 700; margin-bottom: 4px; }
        .main-time { display: flex; align-items: center; justify-content: center; font-size: 1.8rem; font-weight: 700; padding: 6px 0; }
        .arrow { margin: 0 12px; color: #666; font-size: 0.8rem; }
        .sub-time { text-align: center; color: #888; font-size: 0.75rem; }
        a { text-decoration: none; color: inherit; -webkit-tap-highlight-color: transparent; }

        .message { text-align: center; padding: 40px; color: #666; font-size: 0.9rem; }
        .loading { color: #007AFF; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1 class="station-title">屏東 ➔ 潮州</h1>
                <div class="sub-title">V3 Live System</div>
            </div>
        </div>

        <div class="controls">
            <div class="controls-row">
                <span id="statusText" class="status-text">準備就緒</span>
                <button id="refreshBtn" class="refresh-btn" onclick="manualRefresh()">更新</button>
            </div>
            <div id="countdownText" class="countdown-text"></div>
        </div>

        <div id="cardList"></div>
    </div>

    <script>
        // ================= 設定區 =================
        const API_URL = "/api/index?start=屏東&end=潮州"; 
        const CACHE_KEY = "train_data_v1";
        const COOLDOWN_KEY = "next_refresh_time";

        // 時間單位 (毫秒)
        const MINUTE = 60 * 1000;
        const HOUR = 60 * MINUTE;
        // =========================================

        const btn = document.getElementById('refreshBtn');
        const statusText = document.getElementById('statusText');
        const countdownText = document.getElementById('countdownText');
        const list = document.getElementById('cardList');
        
        let cooldownTimer = null;    // 按鈕冷卻倒數
        let autoUpdateTimer = null;  // 自動更新倒數(每秒檢查)
        
        let lastActiveTime = Date.now(); // 最後使用者互動時間
        let nextFetchTime = 0;           // 下一次預計更新的時間點

        function init() {
            checkButtonCooldown();
            
            // 綁定頁面可見性偵測
            document.addEventListener("visibilitychange", handleVisibilityChange);

            const cached = localStorage.getItem(CACHE_KEY);
            let hasCache = false;
            if (cached) {
                const data = JSON.parse(cached);
                const now = Date.now();
                if (now - data.timestamp < 60 * 1000) {
                    console.log("使用 LocalStorage 快取");
                    renderCards(data.payload);
                    statusText.innerText = `快取於 ${data.payload.update_time}`;
                    hasCache = true;
                }
            }

            if (!hasCache) {
                fetchData();
            } else {
                scheduleNextAutoRefresh(); // 有快取也要排程下一次
            }
        }

        async function fetchData() {
            // 只要觸發更新(不論手動自動)，都視為一次活躍，重置閒置計時
            // 如果你想讓「自動更新」不算活躍(人不在)，請註解掉下面這行，只在 manualRefresh 保留
            // 但通常更新後畫面變動，視為一個活躍點較合理，這裡我先不重置，只在手動按時重置。
            
            btn.disabled = true;
            statusText.innerText = "更新中...";
            countdownText.innerText = ""; // 更新中隱藏倒數
            
            if (!list.hasChildNodes()) {
                 list.innerHTML = '<div class="message loading">正在連線 TDX...</div>';
            }

            try {
                const res = await fetch(API_URL);
                const json = await res.json();

                if (json.error) throw new Error(json.error);

                const cacheObj = { timestamp: Date.now(), payload: json };
                localStorage.setItem(CACHE_KEY, JSON.stringify(cacheObj));

                renderCards(json);
                statusText.innerText = `更新於 ${json.update_time}`;
                setButtonCooldown(60); 

            } catch (err) {
                console.error(err);
                statusText.innerText = "更新失敗";
                list.innerHTML = `<div class="message">發生錯誤：${err.message}<br>請稍後再試</div>`;
                btn.disabled = false;
            } finally {
                // 無論成功失敗，都重新排程下一次自動更新
                scheduleNextAutoRefresh();
            }
        }

        function manualRefresh() { 
            // 手動更新：重置「閒置起始時間」為現在
            lastActiveTime = Date.now();
            fetchData(); 
        }

        // --- 核心邏輯：計算下一次更新時間 ---
        function scheduleNextAutoRefresh() {
            if (autoUpdateTimer) clearInterval(autoUpdateTimer);

            const now = Date.now();
            const idleTime = now - lastActiveTime;
            let interval = 0;

            // 規則判斷
            if (idleTime < 15 * MINUTE) {
                interval = 5 * MINUTE;      // 0~15分: 每5分
            } else if (idleTime < 60 * MINUTE) {
                interval = 15 * MINUTE;     // 15~60分: 每15分
            } else if (idleTime < 2 * HOUR) {
                interval = 30 * MINUTE;     // 1~2小時: 每30分
            } else {
                interval = -1;              // 超過2小時: 停止
            }

            if (interval === -1) {
                countdownText.innerText = "已閒置過久，停止自動更新";
                console.log("停止自動更新");
                return;
            }

            nextFetchTime = now + interval;
            console.log(`下次更新預計在: ${new Date(nextFetchTime).toLocaleTimeString()} (間隔 ${interval/1000}s)`);

            // 啟動倒數計時器 (每秒更新 UI)
            autoUpdateTimer = setInterval(tickAutoUpdate, 1000);
            tickAutoUpdate(); // 立即執行一次顯示
        }

        function tickAutoUpdate() {
            // 如果網頁在背景，不執行倒數更新與 Fetch，但在回來時會補
            if (document.hidden) return;

            const now = Date.now();
            const remain = Math.ceil((nextFetchTime - now) / 1000);

            if (remain <= 0) {
                // 時間到：執行更新
                clearInterval(autoUpdateTimer);
                
                // 檢查是否還在按鈕冷卻中 (避免雙重觸發)
                if (btn.disabled && btn.innerText.includes("s")) {
                    console.log("遇到按鈕冷卻，延後 10 秒嘗試");
                    nextFetchTime = now + 10000;
                    autoUpdateTimer = setInterval(tickAutoUpdate, 1000);
                    return;
                }

                console.log("自動更新時間到，執行 Fetch");
                fetchData();
            } else {
                // 格式化倒數顯示 MM:SS
                const m = Math.floor(remain / 60);
                const s = remain % 60;
                const timeStr = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                countdownText.innerText = `下一次更新：${timeStr}`;
            }
        }

        function handleVisibilityChange() {
            if (document.hidden) {
                console.log("背景模式：暫停 UI 倒數");
            } else {
                console.log("回到前景：檢查是否過期");
                // 如果回來的瞬間，時間已經超過 nextFetchTime，立即更新
                if (nextFetchTime > 0 && Date.now() > nextFetchTime) {
                    console.log("背景期間已過期，立即更新");
                    fetchData();
                } else {
                    // 如果沒過期，UI 會在下一秒 tickAutoUpdate 自動校正
                }
            }
        }

        // --- 按鈕冷卻邏輯 (不變) ---
        function setButtonCooldown(seconds) {
            const nextTime = Date.now() + (seconds * 1000);
            localStorage.setItem(COOLDOWN_KEY, nextTime);
            checkButtonCooldown();
        }

        function checkButtonCooldown() {
            const nextTime = localStorage.getItem(COOLDOWN_KEY);
            if (!nextTime) return;

            const now = Date.now();
            const remain = Math.ceil((parseInt(nextTime) - now) / 1000);

            if (remain > 0) {
                startButtonTimer(remain);
            } else {
                localStorage.removeItem(COOLDOWN_KEY);
                btn.disabled = false;
                btn.innerText = "更新";
            }
        }

        function startButtonTimer(initialSeconds) {
            if (cooldownTimer) clearInterval(cooldownTimer);
            let sec = initialSeconds;
            btn.disabled = true;
            btn.innerText = `${sec}s`;

            cooldownTimer = setInterval(() => {
                sec--;
                btn.innerText = `${sec}s`;
                if (sec <= 0) {
                    clearInterval(cooldownTimer);
                    btn.disabled = false;
                    btn.innerText = "更新";
                    localStorage.removeItem(COOLDOWN_KEY);
                }
            }, 1000);
        }

        function renderCards(data) {
            if (!data.trains || data.trains.length === 0) {
                list.innerHTML = '<div class="message">目前無符合班次</div>';
                return;
            }

            let html = "";
            data.trains.forEach(t => {
                const delayTag = t.delay > 0 ? `<div class="delay-badge">誤點 ${t.delay} 分</div>` : "";
                const trainUrl = `https://railway.chienwen.net/taiwan/train/TRA-${t.no}/live`;

                html += `
                <a href="${trainUrl}" target="_blank">
                    <div class="card" style="border-left-color: ${t.color};">
                        ${delayTag}
                        <div class="train-info" style="color: ${t.color};">${t.type} ${t.no} 次</div>
                        <div class="main-time"><span>${t.act_dep}</span><span class="arrow">➔</span><span>${t.act_arr}</span></div>
                        <div class="sub-time">原定 ${t.sch_dep} ➔ ${t.sch_arr}</div>
                    </div>
                </a>
                `;
            });
            list.innerHTML = html;
        }

        init();
    </script>
</body>
</html>
