<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åˆ—è»Šæ™‚åˆ» Live</title>
    <style>
        body { background: #000; color: #fff; font-family: -apple-system, sans-serif; padding: 10px; margin: 0; }
        .container { max-width: 500px; margin: 0 auto; padding-bottom: 80px; }

        .header { margin-bottom: 15px; background: #151517; padding: 15px; border-radius: 12px; border: 1px solid #333;}
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .app-title { font-size: 0.9rem; color: #888; letter-spacing: 1px; font-weight: bold; margin: 0; }
        
        .header-actions { display: flex; gap: 8px; align-items: center; }

        .tool-btn {
            background: none; border: 1px solid #444; color: #666; 
            padding: 3px 8px; border-radius: 12px; font-size: 0.75rem; 
            cursor: pointer; font-weight: bold; transition: all 0.2s;
        }
        .tool-btn.active { color: #4d7f5e; border-color: #4d7f5e; background: rgba(77, 127, 94, 0.1); }
        .tool-btn:active { transform: scale(0.95); }

        @keyframes pulse-gold {
            0%, 100% { color: #ccc; border-color: #555; box-shadow: 0 0 0 rgba(0,0,0,0); }
            50% { color: hsl(40, 100%, 50%); border-color: hsl(40, 100%, 50%); box-shadow: 0 0 8px rgba(255, 166, 0, 0.3); }
        }

        .menu-btn-trigger { 
            background: #333; border: 1px solid #555; color: #fff; 
            width: 32px; height: 32px; border-radius: 8px; 
            font-size: 1.1rem; cursor: pointer; display: flex; 
            align-items: center; justify-content: center; font-weight: bold;
            transition: transform 0.2s;
            animation: pulse-gold 3s infinite ease-in-out;
        }
        .menu-btn-trigger:active { transform: scale(0.95); background: #444; }

        .search-row { display: flex; gap: 8px; margin-bottom: 12px; }
        .search-target { flex: 1; background: #222; border: 1px solid #444; color: #ccc; border-radius: 8px; font-size: 0.85rem; padding-left: 5px; min-width: 0; }
        .search-box { flex: 3; box-sizing: border-box; background: #222; border: 1px solid #444; color: #fff; padding: 8px 12px; border-radius: 8px; font-size: 0.9rem; text-align: left; min-width: 0; }
        .search-box:focus { border-color: #4d7f5e; outline: none; background: #000; }

        .selector-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .selector-label { width: 35px; font-size: 0.8rem; color: #888; font-weight: bold; text-align: center;}
        .select-group { flex: 1; display: flex; gap: 5px; min-width: 0; }
        .region-select { flex: 2; background: #2c2c2e; color: #eee; border: 1px solid #444; padding: 8px 4px; border-radius: 8px; font-size: 0.95rem; font-weight: bold; appearance: none; -webkit-appearance: none; text-align: center; min-width: 0; }
        .station-select { flex: 3; background: #3a3a3c; color: #fff; border: 1px solid #555; padding: 8px 4px; border-radius: 8px; font-size: 1rem; font-weight: bold; appearance: none; -webkit-appearance: none; text-align: center; min-width: 0; }
        .swap-container { display: flex; justify-content: center; margin: -4px 0 4px 0; }
        .swap-btn { font-size: 1.2rem; color: #666; background: none; border: none; padding: 0 10px; cursor: pointer; transform: rotate(90deg); }

        .action-area { margin-top: 15px; display: flex; gap: 10px; align-items: stretch; }
        .btn { border: none; padding: 12px; border-radius: 12px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { background: #333 !important; color: #888 !important; border-color: #333 !important; cursor: not-allowed; }
        .btn-search { flex: 2; background: #fff; color: #000; }
        .btn-refresh { flex: 1; background: #4d7f5e; color: white; font-size: 0.9rem; }
        .btn-half { flex: 1; font-size: 0.9rem; }
        .btn-secondary { background: #3a3a3c; color: #fff; border: 1px solid #555; }
        .btn-primary { background: #007AFF; color: white; }
        .btn.error { background: #d32f2f !important; color: white !important; }

        .status-container { text-align: center; margin-top: 10px; display: flex; flex-direction: column; gap: 4px; }
        .status-msg { font-size: 0.8rem; color: #aaa; min-height: 1.2em; }
        .status-msg.alert { color: #ff4d4d; font-weight: bold; } 
        .status-msg.warning { color: #e6b800; } 
        .status-msg.unsync { color: #4d7f5e; } 
        .update-time { font-size: 0.75rem; color: #666; font-family: monospace; min-height: 1em; }

        .click-hint { text-align: center; color: #666; font-size: 0.75rem; margin-bottom: 8px; margin-top: -5px; animation: fadeIn 0.5s; }

        /* === ä¿®æ­£é‡é»ï¼šå¡ç‰‡æ¨£å¼èˆ‡æŒ‰å£“å›é¥‹ === */
        .card { 
            background: #151517; 
            border-radius: 12px; 
            padding: 12px 16px; 
            margin-bottom: 10px; 
            border-left: 5px solid #333; 
            position: relative; 
            
            /* åŠ å…¥éæ¸¡æ•ˆæœ */
            transition: transform 0.1s ease, background-color 0.1s ease;
        }

        /* è®“ <a> é€£çµè®Šæˆå€å¡Šï¼Œå¡«æ»¿é»æ“Šå€åŸŸ */
        a { 
            display: block; /* è®“æ•´å¼µå¡ç‰‡éƒ½å¯ä»¥é» */
            text-decoration: none; 
            color: inherit; 
            -webkit-tap-highlight-color: transparent; 
        }

        /* ç•¶é»æ“Šå¡ç‰‡æ™‚çš„æ•ˆæœ */
        .card:active {
            transform: scale(0.98); /* ç¨å¾®ç¸®å° */
            background-color: #222; /* èƒŒæ™¯ç¨å¾®è®Šäº® */
        }
        /* ================================== */

        .delay-badge { position: absolute; top: 12px; right: 16px; border: 1px solid hsl(40, 100%, 50%); color: hsl(40, 100%, 50%); padding: 1px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: 600; }
        .train-info { font-size: 0.9rem; font-weight: 700; margin-bottom: 4px; }
        .main-time { display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: 700; padding: 6px 0; }
        .main-time span { white-space: nowrap; }
        .arrow { margin: 0 6px; color: #666; font-size: 0.8rem; }
        .sub-time { text-align: center; color: #888; font-size: 0.75rem; }
        
        .card.past { opacity: 0.5; filter: grayscale(0.8); }
        .card.past::after { content: 'å·²é§›é›¢'; position: absolute; bottom: 10px; right: 10px; font-size: 0.7rem; color: #fff; background: #333; padding: 2px 6px; border-radius: 4px; }

        .message { text-align: center; padding: 40px; color: #666; font-size: 0.9rem; }
        .loading { color: #4d7f5e; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 999; display: none; align-items: center; justify-content: center; }
        .modal-content { background: #1c1c1e; width: 85%; max-width: 400px; border-radius: 16px; padding: 25px; border: 1px solid #333; box-shadow: 0 10px 30px rgba(0,0,0,0.5); text-align: left; position: relative; max-height: 85vh; overflow-y: auto;}
        .modal-header-row { display: flex; align-items: center; margin-bottom: 15px; }
        .back-btn { background: none; border: none; color: #888; font-size: 1.5rem; cursor: pointer; padding: 0 10px 0 0; line-height: 1; }
        .modal-title { font-size: 1.2rem; font-weight: bold; color: #4d7f5e; flex: 1; }
        .menu-btn { display: block; width: 100%; padding: 15px; margin-bottom: 10px; background: #2c2c2e; border: 1px solid #444; color: #fff; border-radius: 12px; font-size: 1rem; cursor: pointer; text-align: left; display: flex; justify-content: space-between; align-items: center; }
        .menu-btn:active { background: #3a3a3c; }
        .menu-btn::after { content: 'â€º'; color: #666; font-size: 1.2rem; }
        .menu-btn.special { animation: pulse-gold 3s infinite ease-in-out; }
        .modal-text { font-size: 0.9rem; line-height: 1.6; color: #ccc; margin-bottom: 20px; }
        .modal-close { background: #333; color: #fff; border: none; padding: 10px 0; width: 100%; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .modal-page { display: none; }
        .modal-page.active { display: block; animation: fadeIn 0.2s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .report-box { width: 100%; height: 150px; background: #111; border: 1px solid #444; color: #0f0; font-family: monospace; font-size: 0.75rem; padding: 10px; border-radius: 8px; margin-bottom: 10px; resize: none; box-sizing: border-box;}
        .copy-btn { width: 100%; background: #007AFF; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; margin-bottom: 10px; }
        .copy-btn.copied { background: #4d7f5e; }
        .report-hint { font-size: 0.8rem; color: #888; margin-bottom: 15px; }
        .stats-dashboard { display: flex; gap: 8px; margin-bottom: 15px; }
        .stat-card { flex: 1; background: #222; border: 1px solid #444; padding: 10px 5px; border-radius: 8px; text-align: center; }
        .stat-val { font-size: 1.2rem; font-weight: bold; color: #4d7f5e; font-family: monospace;}
        .stat-label { font-size: 0.65rem; color: #888; margin-top: 2px;}
        .stat-card.danger .stat-val { color: #ff4d4d; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-top">
                <div class="app-title">TRAIN LIVE</div>
                <div class="header-actions">
                    <button id="btnShowAll" class="tool-btn" onclick="toggleShowAll()">å…¨éƒ¨</button>
                    <button id="btnTimeFormat" class="tool-btn" onclick="toggleTimeFormat()">24H</button>
                    <button class="menu-btn-trigger" onclick="openModal()">â˜°</button>
                </div>
            </div>

            <div class="search-row">
                <select id="searchTarget" class="search-target" onchange="handleSearch()" autocomplete="off"><option value="start">è¨­ç‚ºèµ·é»</option><option value="end">è¨­ç‚ºçµ‚é»</option></select>
                <input type="text" id="searchInput" class="search-box" placeholder="ğŸ” è¼¸å…¥è»Šç«™" oninput="handleSearch()" autocomplete="off">
            </div>
            
            <div class="selector-row">
                <div class="selector-label">èµ·é»</div>
                <div class="select-group">
                    <select id="startRegion" class="region-select" onchange="updateStationList('start')" autocomplete="off"></select>
                    <select id="startStation" class="station-select" onchange="markAsChanged()" autocomplete="off"></select>
                </div>
            </div>
            <div class="swap-container"><button class="swap-btn" onclick="swapStations()">â‡„</button></div>
            <div class="selector-row">
                <div class="selector-label">çµ‚é»</div>
                <div class="select-group">
                    <select id="endRegion" class="region-select" onchange="updateStationList('end')" autocomplete="off"></select>
                    <select id="endStation" class="station-select" onchange="markAsChanged()" autocomplete="off"></select>
                </div>
            </div>

            <div class="action-area">
                <button id="btnSearch" class="btn btn-search" onclick="doSearch()">ğŸ” æŸ¥è©¢è·¯ç·š</button>
                <button id="btnRefresh" class="btn btn-refresh" onclick="doRefresh()">ğŸ”„ æ›´æ–°</button>
            </div>
            
            <div class="status-container">
                <div id="statusMsg" class="status-msg"></div>
                <div id="updateTime" class="update-time"></div>
            </div>
        </div>

        <div id="cardList"></div>
    </div>

    <div id="aboutModal" class="modal-overlay" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div id="pageMenu" class="modal-page active">
                <div class="modal-header-row"><div class="modal-title">é¸å–®</div></div>
                <button class="menu-btn special" onclick="goToPage('Why')">è¨­è¨ˆç†å¿µ</button>
                <button class="menu-btn" onclick="goToPage('How')">æ“ä½œèªªæ˜</button>
                <button class="menu-btn" onclick="goToPage('Report')">ç³»çµ±è¨ºæ–· / å•é¡Œå›å ±</button>
                <div style="height:10px"></div>
                <button class="modal-close" onclick="closeModal()">é—œé–‰</button>
            </div>
            <div id="pageWhy" class="modal-page">
                <div class="modal-header-row"><button class="back-btn" onclick="goToPage('Menu')">â€¹</button><div class="modal-title">è¨­è¨ˆç†å¿µ</div></div>
                <div class="modal-text">ç¾æœ‰çš„ç«è»Šæ™‚åˆ»è¡¨è»Ÿé«”ï¼Œé€šå¸¸åªæœƒé¡¯ç¤ºã€Œèª¤é»å¹¾åˆ†é˜ã€ï¼Œè€Œæ²’æœ‰å¹«å¿™ç®—å‡ºã€Œå¯¦éš›å¹¾é»æœƒåˆ°ã€ã€‚<br><br>ç•¶ç«è»Šå¤§é‡èª¤é»æ™‚ï¼Œæˆ‘å€‘éœ€è¦åœ¨è…¦ä¸­ä¸æ–·åŠ æ¸›è¨ˆç®—ï¼Œéå¸¸ä¸ä¾¿ã€‚<br><br><strong>TRAIN LIVE çš„è¨­è¨ˆç›®æ¨™ï¼š</strong><br>1. ç›´æ¥é¡¯ç¤º<strong>ã€Œèª¤é»å¾Œçš„å¯¦éš›æ™‚é–“ã€</strong>ã€‚<br>2. ä¾ç…§<strong>ã€Œå¯¦éš›ç™¼è»Šé †åºã€</strong>æ’åˆ—ï¼Œè€ŒéåŸå®šæ™‚åˆ»ã€‚<br>3. ä¸€çœ¼çœ‹å‡ºç¾åœ¨è©²æ­å“ªä¸€ç­è»Šã€‚<br><br>å¸Œæœ›é€™å€‹å·¥å…·èƒ½è§£æ±ºä½ çš„é€šå‹¤ç„¦æ…®ã€‚</div>
            </div>
            <div id="pageHow" class="modal-page">
                <div class="modal-header-row"><button class="back-btn" onclick="goToPage('Menu')">â€¹</button><div class="modal-title">æ“ä½œèªªæ˜</div></div>
                <div class="modal-text"><strong>é›™æŒ‰éˆ•æ©Ÿåˆ¶ï¼š</strong><br><br>1. <strong>ğŸ” æŸ¥è©¢è·¯ç·š (å·¦)ï¼š</strong><br>åˆ‡æ›è·¯ç·šå°ˆç”¨ã€‚è‹¥æ‚¨é»æ“Šæ­¤æŒ‰éˆ•ä½†<strong>è»Šç«™æœªè®Šæ›´</strong>ï¼Œç³»çµ±å°‡è¦–ç‚ºã€Œæ›´æ–°ã€è™•ç†ã€‚<br>è‹¥<strong>çœŸçš„è®Šæ›´è»Šç«™</strong>ï¼Œæ¯åˆ†é˜é™æŸ¥è©¢ 4 æ¬¡ã€‚<br><br>2. <strong>ğŸ”„ æ›´æ–° (å³)ï¼š</strong><br>åˆ·æ–°ç•¶å‰ç‹€æ…‹ã€‚æ¯æ¬¡é»æ“Šå¾Œéœ€ç­‰å¾… 60 ç§’å†·å»ã€‚<br><br><strong>ç‡ˆè™Ÿï¼š</strong><br><span style="color:#e6b800">é»ƒå­—</span>ï¼šèª¤é»è³‡æ–™å¤±æ•— (è‡ªå‹•é‡è©¦)ã€‚<br><span style="color:#ff4d4d">ç´…å­—</span>ï¼šæ“ä½œéæ–¼é »ç¹ã€‚</div>
            </div>
            <div id="pageReport" class="modal-page">
                <div class="modal-header-row"><button class="back-btn" onclick="goToPage('Menu')">â€¹</button><div class="modal-title">ç³»çµ±è¨ºæ–·</div></div>
                <div class="stats-dashboard">
                    <div class="stat-card" id="cardRpm"><div class="stat-val" id="statRpm">0</div><div class="stat-label">1åˆ†é˜å…§è«‹æ±‚</div></div>
                    <div class="stat-card"><div class="stat-val" id="statTotal">0</div><div class="stat-label">æœ¬æ¬¡ç¸½æ•¸</div></div>
                    <div class="stat-card"><div class="stat-val" id="statLast">--</div><div class="stat-label">è·ä¸Šæ¬¡(ç§’)</div></div>
                </div>
                <div class="report-hint">è‹¥é‡åˆ°å•é¡Œï¼Œè«‹å…ˆã€Œè¤‡è£½å ±å‘Šã€ï¼Œå†é»æ“Šå¯„ä¿¡ä¸¦è²¼ä¸Šå…§å®¹ã€‚</div>
                <textarea id="userDesc" class="search-box" style="width:100%; margin-bottom:10px; resize:none;" rows="2" placeholder="ï¼ˆé¸å¡«ï¼‰è«‹ç°¡è¿°æ‚¨é‡åˆ°çš„å•é¡Œ..."></textarea>
                <textarea id="reportContent" class="report-box" readonly></textarea>
                <div class="action-area" style="margin-top:5px;">
                    <button id="btnCopyReport" class="btn btn-half btn-secondary" onclick="copyReportOnly()">ğŸ“‹ è¤‡è£½å ±å‘Š</button>
                    <button id="btnSendMail" class="btn btn-half btn-primary" onclick="openMailClient()">ğŸ“§ é–‹å•Ÿä¿¡ç®±</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const STATION_DATA={"åŸºéš†/æ–°åŒ—":["åŸºéš†","ä¸‰å‘","å…«å µ","ä¸ƒå µ","ç™¾ç¦","äº”å µ","æ±æ­¢","æ±ç§‘","æ¿æ©‹","æµ®æ´²","æ¨¹æ—","å—æ¨¹æ—","å±±ä½³","é¶¯æ­Œ","ç¦éš†","è²¢å¯®","é›™æºª","ç‰¡ä¸¹","ä¸‰è²‚å¶º","å¤§è¯","ååˆ†","æœ›å¤","å¶ºè…³","å¹³æºª","èæ¡","ä¾¯ç¡","ç‘èŠ³","æµ·ç§‘é¤¨","å…«æ–—å­","æš–æš–"],"è‡ºåŒ—å¸‚":["å—æ¸¯","æ¾å±±","è‡ºåŒ—","è¬è¯"],"æ¡ƒåœ’å¸‚":["æ¡ƒåœ’","å…§å£¢","ä¸­å£¢","åŸ”å¿ƒ","æ¥Šæ¢…","å¯Œå²¡","æ–°å¯Œ"],"æ–°ç«¹ç¸£å¸‚":["åŒ—æ¹–","æ¹–å£","æ–°è±","ç«¹åŒ—","åŒ—æ–°ç«¹","æ–°ç«¹","ä¸‰å§“æ©‹","é¦™å±±","å…­å®¶","ç«¹ä¸­","ä¸Šå“¡","æ¦®è¯","ç«¹æ±","æ©«å±±","ä¹è®šé ­","åˆèˆˆ","å¯Œè²´","å…§ç£"],"è‹—æ —ç¸£":["å´é ‚","ç«¹å—","é€ æ©‹","è±å¯Œ","è‹—æ —","å—å‹¢","éŠ…é‘¼","ä¸‰ç¾©","è«‡æ–‡","å¤§å±±","å¾Œé¾","é¾æ¸¯","ç™½æ²™å±¯","æ–°åŸ”","é€šéœ„","è‹‘è£¡"],"è‡ºä¸­å¸‚":["æ³°å®‰","åé‡Œ","è±åŸ","æ —æ—","æ½­å­","é ­å®¶å","æ¾ç«¹","å¤ªåŸ","ç²¾æ­¦","è‡ºä¸­","äº”æ¬Š","å¤§æ…¶","çƒæ—¥","æ–°çƒæ—¥","æˆåŠŸ","æ—¥å—","å¤§ç”²","è‡ºä¸­æ¸¯","æ¸…æ°´","æ²™é¹¿","é¾äº•","å¤§è‚š","è¿½åˆ†"],"å½°åŒ–ç¸£":["å½°åŒ–","èŠ±å£‡","å¤§æ‘","å“¡æ—","æ°¸é–","ç¤¾é ­","ç”°ä¸­","äºŒæ°´","æºæ³‰","æ¿æ°´","é¾æ³‰","é›†é›†","æ°´é‡Œ","è»ŠåŸ•"],"é›²æ—ç¸£":["æ—å…§","çŸ³æ¦´","æ–—å…­","æ–—å—","çŸ³é¾œ"],"å˜‰ç¾©ç¸£å¸‚":["å¤§æ—","æ°‘é›„","å˜‰åŒ—","å˜‰ç¾©","æ°´ä¸Š","å—é–"],"è‡ºå—å¸‚":["å¾Œå£","æ–°ç‡Ÿ","æŸ³ç‡Ÿ","æ—é³³ç‡Ÿ","éš†ç”°","æ‹”æ—","å–„åŒ–","å—ç§‘","æ–°å¸‚","æ°¸åº·","å¤§æ©‹","è‡ºå—","ä¿å®‰","ä»å¾·","ä¸­æ´²","å¤§æ¹–","æ²™å´™"],"é«˜é›„å¸‚":["è·¯ç«¹","å²¡å±±","æ©‹é ­","æ¥ æ¢“","æ–°å·¦ç‡Ÿ","å·¦ç‡Ÿ","å…§æƒŸ","ç¾è¡“é¤¨","é¼“å±±","ä¸‰å¡Šå","é«˜é›„","æ°‘æ—","ç§‘å·¥é¤¨","æ­£ç¾©","é³³å±±","å¾Œåº„","ä¹æ›²å ‚"],"å±æ±ç¸£":["å…­å¡Šå","å±æ±","æ­¸ä¾†","éºŸæ´›","è¥¿å‹¢","ç«¹ç”°","æ½®å·","å´é ‚","å—å·","é®å®‰","æ—é‚Š","ä½³å†¬","æ±æµ·","æ‹å¯®","åŠ ç¥¿","å…§ç…","æ‹å±±"],"å®œè˜­ç¸£":["æ¼¢æœ¬","æ­¦å¡”","å—æ¾³","æ±æ¾³","æ°¸æ¨‚","è˜‡æ¾³","è˜‡æ¾³æ–°","å†¬å±±","ç¾…æ±","ä¸­é‡Œ","äºŒçµ","å®œè˜­","å››åŸ","ç¤æºª","é ‚åŸ”","é ­åŸ","å¤–æ¾³","é¾œå±±","å¤§æºª","å¤§é‡Œ","çŸ³åŸ"],"èŠ±è“®ç¸£":["å’Œå¹³","å’Œä»","å´‡å¾·","æ–°åŸ","æ™¯ç¾","åŒ—åŸ”","èŠ±è“®","å‰å®‰","å¿—å­¸","å¹³å’Œ","å£½è±","è±ç”°","æ—æ¦®æ–°å…‰","å—å¹³","é³³æ—","è¬æ¦®","å…‰å¾©","å¤§å¯Œ","å¯Œæº","ç‘ç©—","ä¸‰æ°‘","ç‰é‡Œ","æ±é‡Œ","æ±ç«¹","å¯Œé‡Œ"],"è‡ºæ±ç¸£":["æ± ä¸Š","æµ·ç«¯","é—œå±±","ç‘å’Œ","ç‘æº","é¹¿é‡","å±±é‡Œ","è‡ºæ±","åº·æ¨‚","çŸ¥æœ¬","å¤ªéº»é‡Œ","é‡‘å´™","ç€§æºª","å¤§æ­¦"]};
        const STATION_INDEX={};Object.keys(STATION_DATA).forEach(r=>{STATION_DATA[r].forEach(s=>{STATION_INDEX[s]=r;});});

        const CACHE_PREFIX="train_data_v2_";
        const PREF_START_R_KEY="pref_start_region";const PREF_START_S_KEY="pref_start_station";
        const PREF_END_R_KEY="pref_end_region";const PREF_END_S_KEY="pref_end_station";
        
        const startRegion=document.getElementById('startRegion');const startStation=document.getElementById('startStation');
        const endRegion=document.getElementById('endRegion');const endStation=document.getElementById('endStation');
        const searchInput=document.getElementById('searchInput');const searchTarget=document.getElementById('searchTarget');
        const btnSearch=document.getElementById('btnSearch');const btnRefresh=document.getElementById('btnRefresh');
        const btnTimeFormat=document.getElementById('btnTimeFormat'); const btnShowAll=document.getElementById('btnShowAll');
        const statusMsg=document.getElementById('statusMsg');const updateTimeDiv=document.getElementById('updateTime');
        const list=document.getElementById('cardList');const modal=document.getElementById('aboutModal');

        let refreshTimer=null; let searchLockTimer=null; let retryTimer=null;
        const LS_SEARCH_COUNT="tl_search_count";const LS_SEARCH_RESET="tl_search_reset_time";
        const LS_SEARCH_LOCK="tl_search_locked_until";const LS_REFRESH_LOCK="tl_refresh_locked_until";
        const LS_IS_24H="tl_pref_is_24h"; 
        
        const MAX_SEARCH_PER_MIN=4;
        let lastFetchedPair={start:"",end:""};
        let is24Hour = localStorage.getItem(LS_IS_24H) !== 'false';
        let isShowAll = false;

        function getSearchCount(){return parseInt(localStorage.getItem(LS_SEARCH_COUNT)||"0");}
        function setSearchCount(v){localStorage.setItem(LS_SEARCH_COUNT,v);}
        function getSearchResetTime(){return parseInt(localStorage.getItem(LS_SEARCH_RESET)||"0");}
        function setSearchResetTime(v){localStorage.setItem(LS_SEARCH_RESET,v);}
        function getSearchLockedUntil(){return parseInt(localStorage.getItem(LS_SEARCH_LOCK)||"0");}
        function setSearchLockedUntil(v){localStorage.setItem(LS_SEARCH_LOCK,v);}
        function getRefreshLockedUntil(){return parseInt(localStorage.getItem(LS_REFRESH_LOCK)||"0");}
        function setRefreshLockedUntil(v){localStorage.setItem(LS_REFRESH_LOCK,v);}

        function updateToggleBtns() {
            btnTimeFormat.innerText = is24Hour ? "24H" : "12H";
            if (isShowAll) btnShowAll.classList.add('active');
            else btnShowAll.classList.remove('active');
        }

        function toggleTimeFormat() {
            is24Hour = !is24Hour;
            localStorage.setItem(LS_IS_24H, is24Hour);
            updateToggleBtns();
            reRenderLocal(); 
        }

        function toggleShowAll() {
            isShowAll = !isShowAll;
            updateToggleBtns();
            reRenderLocal(); 
        }

        function formatTime(t) {
            if(!t) return "";
            if(is24Hour) return t;
            const p=t.split(':'); if(p.length<2) return t;
            let h=parseInt(p[0]); const m=p[1];
            let suffix="ä¸Šåˆ";
            if(h>=12){ suffix="ä¸‹åˆ"; if(h>12) h-=12; } else if(h===0) h=12;
            return `${suffix} ${h}:${m}`;
        }

        function init() {
            logSystem("Init","App Started");
            updateToggleBtns();
            const regions=Object.keys(STATION_DATA);
            const rOpts=regions.map(r=>`<option value="${r}">${r}</option>`).join('');
            
            const savedSR = localStorage.getItem(PREF_START_R_KEY);

            if (savedSR) {
                startRegion.innerHTML=rOpts; endRegion.innerHTML=rOpts;
                const sS=localStorage.getItem(PREF_START_S_KEY)||"å±æ±";
                const eR=localStorage.getItem(PREF_END_R_KEY)||"å±æ±ç¸£"; const eS=localStorage.getItem(PREF_END_S_KEY)||"æ½®å·";
                setMenu('start',savedSR,sS); setMenu('end',eR,eS);
                checkLocksOnLoad();
                loadDataOrFetch();
            } else {
                const ph = `<option value="" disabled selected>é¸æ“‡ç¸£å¸‚</option>`;
                startRegion.innerHTML=ph+rOpts; endRegion.innerHTML=ph+rOpts;
                startStation.innerHTML=`<option value="" disabled selected>é¸æ“‡è»Šç«™</option>`;
                endStation.innerHTML=`<option value="" disabled selected>é¸æ“‡è»Šç«™</option>`;
                list.innerHTML='<div class="message">è«‹é¸æ“‡ èµ·é» èˆ‡ çµ‚é» è»Šç«™<br>é–‹å§‹æŸ¥è©¢</div>';
                statusMsg.innerText = "ç­‰å¾…è¼¸å…¥...";
                checkLocksOnLoad();
            }
        }

        function checkLocksOnLoad() {
            const now=Date.now();
            const sL=getSearchLockedUntil(); if(sL>now) lockSearchButton(Math.ceil((sL-now)/1000));
            const rL=getRefreshLockedUntil(); if(rL>now) lockRefreshButton(Math.ceil((rL-now)/1000));
        }

        function setMenu(type,rV,sV) {
            const rSel=type==='start'?startRegion:endRegion; const sSel=type==='start'?startStation:endStation;
            if(!STATION_DATA[rV]) { rSel.value = ""; return; }
            rSel.value=rV;
            sSel.innerHTML=STATION_DATA[rV].map(s=>`<option value="${s}">${s}</option>`).join('');
            if(STATION_DATA[rV].includes(sV)) sSel.value=sV; else sSel.selectedIndex=0;
        }

        function updateStationList(type) {
            const rSel=type==='start'?startRegion:endRegion; const sSel=type==='start'?startStation:endStation;
            const rVal = rSel.value;
            if (!rVal) return;
            sSel.innerHTML=STATION_DATA[rVal].map(s=>`<option value="${s}">${s}</option>`).join('');
            sSel.selectedIndex=0; 
            if (startStation.value && endStation.value) markAsChanged();
        }

        function swapStations() {
            if (!startStation.value || !endStation.value) return;
            logSystem("UI","Swap");
            const sR=startRegion.value; const sS=startStation.value;
            setMenu('start',endRegion.value,endStation.value); setMenu('end',sR,sS);
            markAsChanged();
        }

        function handleSearch() {
            const val=searchInput.value.trim(); const tgt=searchTarget.value;
            if(!val) return;
            let found=STATION_INDEX[val]?val:Object.keys(STATION_INDEX).find(s=>s.includes(val));
            if(found) {
                logSystem("UI",`Search: ${found}`);
                setMenu(tgt,STATION_INDEX[found],found);
                searchInput.style.borderColor="#4d7f5e"; setTimeout(()=>searchInput.style.borderColor="#444",500);
                if (startStation.value && endStation.value) markAsChanged();
            }
        }

        function markAsChanged() {
            if (!startStation.value || !endStation.value) return;
            localStorage.setItem(PREF_START_R_KEY,startRegion.value); localStorage.setItem(PREF_START_S_KEY,startStation.value);
            localStorage.setItem(PREF_END_R_KEY,endRegion.value); localStorage.setItem(PREF_END_S_KEY,endStation.value);
            attemptLoadCache(false);
        }

        function savePrefs() { markAsChanged(); } 

        function getCacheKey(){return `${CACHE_PREFIX}${startStation.value}_${endStation.value}`;}

        function reRenderLocal() {
            const c=localStorage.getItem(getCacheKey());
            if(c) {
                const d=JSON.parse(c);
                renderCards(d.payload);
            } else {
                if (startStation.value && endStation.value) attemptLoadCache(false);
            }
        }

        function attemptLoadCache(isInit) {
            if (!startStation.value || !endStation.value) return;
            const c=localStorage.getItem(getCacheKey());
            let hit=false;
            if(c) {
                const d=JSON.parse(c);
                if(Date.now()-d.timestamp<60000) {
                    renderCards(d.payload);
                    setUpdateText(`æ›´æ–°æ–¼(å¿«å–): ${d.payload.update_time}`);
                    statusMsg.innerText=""; statusMsg.className="status-msg";
                    list.style.opacity="1"; lastFetchedPair={start:startStation.value,end:endStation.value};
                    hit=true;
                }
            }
            if(!hit) {
                if(isInit) {
                    statusMsg.innerText="è«‹æŒ‰ã€ŒæŸ¥è©¢ã€é–‹å§‹ä½¿ç”¨"; statusMsg.className="status-msg";
                    updateTimeDiv.innerText="";
                    list.innerHTML='<div class="message">è«‹é»æ“Šä¸Šæ–¹æŒ‰éˆ•æŸ¥è©¢ç­æ¬¡</div>';
                } else {
                    list.style.opacity="0.4";
                    statusMsg.innerText="è¨­å®šå·²è®Šæ›´ï¼Œè«‹æŒ‰ã€ŒæŸ¥è©¢ã€"; statusMsg.className="status-msg unsync";
                    updateTimeDiv.innerText="";
                }
            }
            updateButtonMode();
        }

        function loadDataOrFetch(){attemptLoadCache(true);}

        function updateButtonMode() {
            const sL=getSearchLockedUntil(); if(sL>Date.now()) return;
            if(startStation.value!==lastFetchedPair.start || endStation.value!==lastFetchedPair.end) btnSearch.disabled=false;
        }

        function doSearch() {
            const sS=startStation.value; const eS=endStation.value;
            if (!sS || !eS) {
                statusMsg.innerText = "è«‹å…ˆé¸æ“‡èµ·é»èˆ‡çµ‚é»";
                statusMsg.className = "status-msg alert";
                setTimeout(()=>statusMsg.innerText="", 2000);
                return;
            }
            savePrefs();
            if(sS===lastFetchedPair.start && eS===lastFetchedPair.end) {
                statusMsg.innerText="è»Šç«™æœªè®Šæ›´ï¼ŒåŸ·è¡Œæ›´æ–°"; setTimeout(()=>{if(!statusMsg.classList.contains("alert"))statusMsg.innerText="";},2000);
                doRefresh(); return;
            }
            const now=Date.now();
            let cnt=getSearchCount(); let rst=getSearchResetTime();
            if(now-rst>60000) { cnt=0; setSearchCount(0); rst=now; setSearchResetTime(now); }
            if(cnt===0) { rst=now; setSearchResetTime(now); }
            
            if(cnt>=MAX_SEARCH_PER_MIN) {
                const w=Math.ceil((60000-(now-rst))/1000);
                const safeW=w>0?w:60;
                setSearchLockedUntil(now+safeW*1000); lockSearchButton(safeW);
                logSystem("Limit","Search Limit"); return;
            }
            cnt++; setSearchCount(cnt);
            logSystem("Action",`Search(${cnt}/${MAX_SEARCH_PER_MIN})`);
            fetchData("search");
        }

        function doRefresh(skip=false) {
            if(!skip) {
                const now=Date.now(); const rL=getRefreshLockedUntil();
                if(rL>now) { lockRefreshButton(Math.ceil((rL-now)/1000)); return; }
            }
            logSystem("Action","Refresh"); fetchData("refresh");
        }

        async function fetchData(mode) {
            statusMsg.innerText="é€£ç·šä¸­..."; statusMsg.className="status-msg"; list.style.opacity="1";
            if(retryTimer){clearTimeout(retryTimer);retryTimer=null;}
            if(mode==="search") btnSearch.disabled=true; if(mode==="refresh") btnRefresh.disabled=true;
            const s=startStation.value; const e=endStation.value; recordRequest();
            try {
                const res=await fetch(`/api/index?start=${s}&end=${e}`);
                const json=await res.json();
                if(json.error) throw new Error(json.error);
                lastFetchedPair={start:s,end:e};
                localStorage.setItem(getCacheKey(),JSON.stringify({timestamp:Date.now(),payload:json}));
                renderCards(json);
                logSystem("API",`DelayFailed:${json.delay_failed}`);
                
                if(json.delay_failed) {
                    statusMsg.innerText="èª¤é»è³‡è¨Šç„¡æ³•å–å¾— (60s å¾Œè‡ªå‹•é‡è©¦)"; statusMsg.className="status-msg warning";
                    scheduleRetry(); setUpdateText(`æ›´æ–°æ–¼: ${json.update_time} (åƒ…æ™‚åˆ»è¡¨)`);
                } else {
                    statusMsg.innerText="æ›´æ–°å®Œæˆ"; statusMsg.className="status-msg";
                    setTimeout(()=>{if(statusMsg.innerText==="æ›´æ–°å®Œæˆ")statusMsg.innerText="";},2000);
                    setUpdateText(`æ›´æ–°æ–¼: ${json.update_time}`);
                }
                const now=Date.now();
                if(mode==="search"){ setTimeout(()=>btnSearch.disabled=false,500); setRefreshLockedUntil(now+60000); lockRefreshButton(60); }
                if(mode==="refresh"){ setRefreshLockedUntil(now+60000); lockRefreshButton(60); }
            } catch(err) {
                console.error(err); logSystem("API Error",err.message);
                statusMsg.innerText="é€£ç·šç™¼ç”Ÿå•é¡Œ"; statusMsg.className="status-msg alert";
                list.innerHTML=`<div class="message">é€£ç·šç™¼ç”Ÿå•é¡Œ âš ï¸<br><span style="font-size:0.8rem;color:#888">è«‹è¦‹ç³»çµ±è¨ºæ–·</span></div>`;
                if(mode==="search") setTimeout(()=>btnSearch.disabled=false,2000);
                if(mode==="refresh") setTimeout(()=>btnRefresh.disabled=false,2000);
            }
        }

        function setUpdateText(t){updateTimeDiv.innerText=t;localStorage.setItem("last_update_text",t);}
        function scheduleRetry() {
            let c=60; retryTimer=setInterval(()=>{
                c--; statusMsg.innerText=`èª¤é»è³‡è¨Šç„¡æ³•å–å¾— (${c}s å¾Œè‡ªå‹•é‡è©¦)`;
                if(c<=0){clearInterval(retryTimer);retryTimer=null;doRefresh(true);}
            },1000);
        }

        function lockSearchButton(s) {
            if(searchLockTimer) clearInterval(searchLockTimer);
            statusMsg.innerText="è«‹å‹¿é »ç¹æ“ä½œ"; statusMsg.className="status-msg alert";
            btnSearch.classList.add('error'); btnSearch.disabled=true;
            const t=()=>{
                btnSearch.innerText=`é »ç¹æ“ä½œ (${s})`;
                if(s<=0){
                    clearInterval(searchLockTimer); btnSearch.disabled=false;
                    btnSearch.classList.remove('error'); btnSearch.innerText="ğŸ” æŸ¥è©¢è·¯ç·š";
                    statusMsg.innerText=""; setSearchLockedUntil(0);
                }
                s--;
            }; t(); searchLockTimer=setInterval(t,1000);
        }

        function lockRefreshButton(s) {
            if(refreshTimer) clearInterval(refreshTimer);
            btnRefresh.disabled=true;
            const t=()=>{
                btnRefresh.innerText=`æ›´æ–° (${s})`;
                if(s<=0){
                    clearInterval(refreshTimer); btnRefresh.disabled=false;
                    btnRefresh.innerText="ğŸ”„ æ›´æ–°"; setRefreshLockedUntil(0);
                }
                s--;
            }; t(); refreshTimer=setInterval(t,1000);
        }

        function renderCards(data) {
            if(data.trains&&data.trains.length>0) {
                let html=`<div class="click-hint">ğŸ‘† é»æ“Šå¡ç‰‡æŸ¥çœ‹ã€Œåˆ—è»Šå³æ™‚ä½ç½®ã€èˆ‡ã€Œå®Œæ•´åœé ç«™ã€</div>`;
                let hasVisibleTrains = false;
                data.trains.forEach(t=>{
                    if (!isShowAll && t.is_past) return;
                    hasVisibleTrains = true;
                    let delayTag="";
                    if(!data.delay_failed && t.delay>0) delayTag=`<div class="delay-badge">èª¤é» ${t.delay} åˆ†</div>`;
                    const url=`https://railway.chienwen.net/taiwan/train/TRA-${t.no}/live`;
                    const pastClass = t.is_past ? 'past' : '';
                    html+=`<a href="${url}" target="_blank">
                        <div class="card ${pastClass}" style="border-left-color:${t.color};">
                            ${delayTag}
                            <div class="train-info" style="color:${t.color};">${t.type} ${t.no} æ¬¡</div>
                            <div class="main-time"><span>${formatTime(t.act_dep)}</span><span class="arrow">â”</span><span>${formatTime(t.act_arr)}</span></div>
                            <div class="sub-time">åŸå®š ${formatTime(t.sch_dep)} â” ${formatTime(t.sch_arr)}</div>
                        </div></a>`;
                });
                
                if (!hasVisibleTrains && !isShowAll) {
                    list.innerHTML = `<div class="message">å¾ŒçºŒå·²ç„¡ç­æ¬¡ ğŸ‘‹<br><span style="font-size:0.8rem;color:#666">é»æ“Šä¸Šæ–¹ã€Œå…¨éƒ¨ã€æŸ¥çœ‹æ•´æ—¥ç­è¡¨</span></div>`;
                } else {
                    list.innerHTML=html;
                }
                return;
            }
            const orig=data.stats?data.stats.original_count:0;
            if(orig>0) list.innerHTML=`<div class="message">ä»Šæ—¥ç­æ¬¡å·²å…¨æ•¸é§›é›¢ ğŸ‘‹<br><span style="font-size:0.8rem;color:#666">TDX æ­£å¸¸ (åŸæœ‰ ${orig} ç­)</span></div>`;
            else list.innerHTML=`<div class="message">æŸ¥ç„¡æ­¤å€é–“ç›´é”åˆ—è»Š âš ï¸</div>`;
        }

        // System
        let systemLogs=[]; let requestHistory=[];
        function logSystem(a,d){systemLogs.push(`[${new Date().toLocaleTimeString()}] ${a}: ${d}`);if(systemLogs.length>30)systemLogs.shift();}
        function recordRequest(){requestHistory.push(Date.now());}
        function openModal(){document.getElementById('aboutModal').style.display='flex';goToPage('Menu');}
        function closeModal(){document.getElementById('aboutModal').style.display='none';}
        function goToPage(id){
            document.querySelectorAll('.modal-page').forEach(p=>p.classList.remove('active'));
            document.getElementById('page'+id).classList.add('active');
            if(id==='Report'){
                const now=Date.now(); const rpm=requestHistory.filter(t=>now-t<60000).length;
                document.getElementById('statRpm').innerText=rpm;
                if(rpm>=5)document.getElementById('cardRpm').classList.add('danger');
                else document.getElementById('cardRpm').classList.remove('danger');
                document.getElementById('statTotal').innerText=requestHistory.length;
                const last=requestHistory[requestHistory.length-1];
                document.getElementById('statLast').innerText=last?Math.floor((now-last)/1000):"--";
                
                let r=`ã€TRAIN LIVE è¨ºæ–·å ±å‘Šã€‘\næ™‚é–“: ${new Date().toLocaleString()}\nè£ç½®: ${navigator.userAgent}\nè·¯ç·š: ${startStation.value} -> ${endStation.value}\næµé‡: RPM=${rpm}, Total=${requestHistory.length}\n--- Log ---\n${systemLogs.join("\n")}`;
                const u=document.getElementById('userDesc').value; if(u) r+=`\n\nUser: ${u}`;
                document.getElementById('reportContent').value=r;
            }
        }
        
        function copyReportOnly() {
            const b=document.getElementById('reportContent'); b.select(); document.execCommand('copy');
            const btn=document.getElementById('btnCopyReport'); 
            const originalText = btn.innerText;
            btn.innerText = "å·²è¤‡è£½ï¼"; 
            setTimeout(()=>{ btn.innerText = originalText; }, 2000);
        }

        function openMailClient() {
            const subject = encodeURIComponent("TRAIN LIVE ç³»çµ±è¨ºæ–·å›å ±");
            const body = encodeURIComponent("ï¼ˆè«‹é•·æŒ‰è²¼ä¸Šå‰›å‰›è¤‡è£½çš„è¨ºæ–·å ±å‘Šï¼‰\n\næˆ‘çš„å•é¡Œæè¿°ï¼š\n");
            window.location.href = `mailto:d96benjamin@gmail.com?subject=${subject}&body=${body}`;
        }

        init();
    </script>
</body>
</html>