<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åˆ—è»Šæ™‚åˆ» Live</title>
    <style>
        body { background: #000; color: #fff; font-family: -apple-system, sans-serif; padding: 10px; margin: 0; }
        .container { max-width: 500px; margin: 0 auto; padding-bottom: 80px; }

        /* é ‚éƒ¨å€åŸŸ */
        .header { margin-bottom: 15px; background: #151517; padding: 15px; border-radius: 12px; border: 1px solid #333;}
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .app-title { font-size: 0.9rem; color: #888; letter-spacing: 1px; font-weight: bold; margin: 0; }
        
        @keyframes pulse-gold {
            0%, 100% { color: #888; border-color: #444; box-shadow: 0 0 0 rgba(255, 166, 0, 0); }
            50% { color: hsl(40, 100%, 50%); border-color: hsl(40, 100%, 50%); box-shadow: 0 0 8px rgba(255, 166, 0, 0.3); }
        }
        .about-btn { 
            background: none; border: 1px solid #444; color: #888; width: 24px; height: 24px; 
            border-radius: 50%; font-size: 0.8rem; cursor: pointer; display: flex; 
            align-items: center; justify-content: center; font-weight: bold;
            animation: pulse-gold 3s infinite ease-in-out;
        }

        /* æœå°‹åˆ— */
        .search-row { display: flex; gap: 8px; margin-bottom: 12px; }
        .search-target { flex: 1; background: #222; border: 1px solid #444; color: #ccc; border-radius: 8px; font-size: 0.85rem; padding-left: 5px; }
        .search-box { flex: 3; box-sizing: border-box; background: #222; border: 1px solid #444; color: #fff; padding: 8px 12px; border-radius: 8px; font-size: 0.9rem; text-align: left; }
        .search-box:focus { border-color: #4d7f5e; outline: none; background: #000; }

        /* é¸å–®å€åŸŸ */
        .selector-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .selector-label { width: 35px; font-size: 0.8rem; color: #888; font-weight: bold; text-align: center;}
        .select-group { flex: 1; display: flex; gap: 5px; }
        .region-select { flex: 2; background: #2c2c2e; color: #eee; border: 1px solid #444; padding: 8px 4px; border-radius: 8px; font-size: 0.95rem; font-weight: bold; appearance: none; -webkit-appearance: none; text-align: center; }
        .station-select { flex: 3; background: #3a3a3c; color: #fff; border: 1px solid #555; padding: 8px 4px; border-radius: 8px; font-size: 1rem; font-weight: bold; appearance: none; -webkit-appearance: none; text-align: center; }
        .swap-container { display: flex; justify-content: center; margin: -4px 0 4px 0; }
        .swap-btn { font-size: 1.2rem; color: #666; background: none; border: none; padding: 0 10px; cursor: pointer; transform: rotate(90deg); }

        /* æŒ‰éˆ•å€åŸŸ */
        .action-area { margin-top: 15px; display: flex; gap: 10px; align-items: stretch; }
        .btn { border: none; padding: 12px; border-radius: 12px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { background: #333 !important; color: #888 !important; border-color: #333 !important; cursor: not-allowed; }
        .btn-search { flex: 2; background: #fff; color: #000; }
        .btn-refresh { flex: 1; background: #4d7f5e; color: white; font-size: 0.9rem; }
        .btn.error { background: #d32f2f !important; color: white !important; }

        /* ç‹€æ…‹æ–‡å­—å€ */
        .status-container { text-align: center; margin-top: 10px; display: flex; flex-direction: column; gap: 4px; }
        .status-msg { font-size: 0.8rem; color: #aaa; min-height: 1.2em; }
        .status-msg.alert { color: #ff4d4d; font-weight: bold; } 
        .status-msg.warning { color: #e6b800; } 
        .status-msg.unsync { color: #4d7f5e; } 
        .update-time { font-size: 0.75rem; color: #666; font-family: monospace; }

        /* å¡ç‰‡ */
        .card { background: #151517; border-radius: 12px; padding: 12px 16px; margin-bottom: 10px; border-left: 5px solid #333; position: relative; }
        .delay-badge { position: absolute; top: 12px; right: 16px; border: 1px solid hsl(40, 100%, 50%); color: hsl(40, 100%, 50%); padding: 1px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: 600; }
        .train-info { font-size: 0.9rem; font-weight: 700; margin-bottom: 4px; }
        .main-time { display: flex; align-items: center; justify-content: center; font-size: 1.8rem; font-weight: 700; padding: 6px 0; }
        .arrow { margin: 0 12px; color: #666; font-size: 0.8rem; }
        .sub-time { text-align: center; color: #888; font-size: 0.75rem; }
        a { text-decoration: none; color: inherit; -webkit-tap-highlight-color: transparent; }

        .message { text-align: center; padding: 40px; color: #666; font-size: 0.9rem; }
        .loading { color: #4d7f5e; }

        /* Modal (é—œæ–¼è¦–çª—) */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 999; display: none; align-items: center; justify-content: center; }
        .modal-content { background: #1c1c1e; width: 85%; max-width: 400px; border-radius: 16px; padding: 25px; border: 1px solid #333; box-shadow: 0 10px 30px rgba(0,0,0,0.5); text-align: left; position: relative; max-height: 85vh; overflow-y: auto;}
        
        .modal-header-row { display: flex; align-items: center; margin-bottom: 15px; }
        .back-btn { background: none; border: none; color: #888; font-size: 1.5rem; cursor: pointer; padding: 0 10px 0 0; line-height: 1; }
        .modal-title { font-size: 1.2rem; font-weight: bold; color: #4d7f5e; flex: 1; }
        
        .menu-btn { 
            display: block; width: 100%; padding: 15px; margin-bottom: 10px; 
            background: #2c2c2e; border: 1px solid #444; color: #fff; 
            border-radius: 12px; font-size: 1rem; cursor: pointer; text-align: left;
            display: flex; justify-content: space-between; align-items: center;
        }
        .menu-btn:active { background: #3a3a3c; }
        .menu-btn::after { content: 'â€º'; color: #666; font-size: 1.2rem; }

        .modal-text { font-size: 0.9rem; line-height: 1.6; color: #ccc; margin-bottom: 20px; }
        .modal-close { background: #333; color: #fff; border: none; padding: 10px 0; width: 100%; border-radius: 8px; font-weight: bold; cursor: pointer; }
        
        .modal-page { display: none; }
        .modal-page.active { display: block; animation: fadeIn 0.2s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* ç³»çµ±è¨ºæ–·é é¢æ¨£å¼ */
        .report-box { width: 100%; height: 150px; background: #111; border: 1px solid #444; color: #0f0; font-family: monospace; font-size: 0.75rem; padding: 10px; border-radius: 8px; margin-bottom: 10px; resize: none; box-sizing: border-box;}
        .copy-btn { width: 100%; background: #007AFF; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; margin-bottom: 10px; }
        .copy-btn.copied { background: #4d7f5e; }
        .report-hint { font-size: 0.8rem; color: #888; margin-bottom: 15px; }
        
        .stats-dashboard { display: flex; gap: 8px; margin-bottom: 15px; }
        .stat-card { flex: 1; background: #222; border: 1px solid #444; padding: 10px 5px; border-radius: 8px; text-align: center; }
        .stat-val { font-size: 1.2rem; font-weight: bold; color: #4d7f5e; font-family: monospace;}
        .stat-label { font-size: 0.65rem; color: #888; margin-top: 2px;}
        .stat-card.danger .stat-val { color: #ff4d4d; }
        .contact-info { background: #222; padding: 10px; border-radius: 8px; font-size: 0.85rem; color: #ccc; margin-bottom: 15px; text-align: center; border: 1px solid #333;}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-top">
                <div class="app-title">TRAIN LIVE</div>
                <button class="about-btn" onclick="openModal()">?</button>
            </div>

            <div class="search-row">
                <select id="searchTarget" class="search-target" onchange="handleSearch()"><option value="start">è¨­ç‚ºèµ·é»</option><option value="end">è¨­ç‚ºçµ‚é»</option></select>
                <input type="text" id="searchInput" class="search-box" placeholder="ğŸ” è¼¸å…¥è»Šç«™" oninput="handleSearch()">
            </div>
            
            <div class="selector-row">
                <div class="selector-label">èµ·é»</div>
                <div class="select-group"><select id="startRegion" class="region-select" onchange="updateStationList('start')"></select><select id="startStation" class="station-select" onchange="handleSelectionChange()"></select></div>
            </div>
            <div class="swap-container"><button class="swap-btn" onclick="swapStations()">â‡„</button></div>
            <div class="selector-row">
                <div class="selector-label">çµ‚é»</div>
                <div class="select-group"><select id="endRegion" class="region-select" onchange="updateStationList('end')"></select><select id="endStation" class="station-select" onchange="handleSelectionChange()"></select></div>
            </div>

            <div class="action-area">
                <button id="btnSearch" class="btn btn-search" onclick="doSearch()">ğŸ” æŸ¥è©¢è·¯ç·š</button>
                <button id="btnRefresh" class="btn btn-refresh" onclick="doRefresh()">ğŸ”„ æ›´æ–°</button>
            </div>
            
            <div class="status-container">
                <div id="statusMsg" class="status-msg">æº–å‚™å°±ç·’</div>
                <div id="updateTime" class="update-time"></div>
            </div>
        </div>

        <div id="cardList"></div>
    </div>

    <div id="aboutModal" class="modal-overlay" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            
            <div id="pageMenu" class="modal-page active">
                <div class="modal-header-row">
                    <div class="modal-title">é¸å–®</div>
                </div>
                <button class="menu-btn" onclick="goToPage('Why')">ç‚ºä»€éº¼è¦åšé€™å€‹ï¼Ÿ</button>
                <button class="menu-btn" onclick="goToPage('How')">æ“ä½œèªªæ˜</button>
                <button class="menu-btn" onclick="goToPage('Report')">ç³»çµ±è¨ºæ–· / å•é¡Œå›å ±</button>
                <div style="height:10px"></div>
                <button class="modal-close" onclick="closeModal()">é—œé–‰</button>
            </div>

            <div id="pageWhy" class="modal-page">
                <div class="modal-header-row">
                    <button class="back-btn" onclick="goToPage('Menu')">â€¹</button>
                    <div class="modal-title">è¨­è¨ˆåˆè¡·</div>
                </div>
                <div class="modal-text">
                    ç¾æœ‰çš„ç«è»Šæ™‚åˆ»è¡¨è»Ÿé«”ï¼Œé€šå¸¸åªæœƒé¡¯ç¤ºã€Œèª¤é»å¹¾åˆ†é˜ã€ï¼Œè€Œæ²’æœ‰å¹«å¿™ç®—å‡ºã€Œå¯¦éš›å¹¾é»æœƒåˆ°ã€ã€‚<br><br>
                    ç•¶ç«è»Šå¤§é‡èª¤é»æ™‚ï¼Œæˆ‘å€‘éœ€è¦åœ¨è…¦ä¸­ä¸æ–·åŠ æ¸›è¨ˆç®—ï¼Œéå¸¸ä¸ä¾¿ã€‚<br><br>
                    <strong>TRAIN LIVE çš„è¨­è¨ˆç›®æ¨™ï¼š</strong><br>
                    1. ç›´æ¥é¡¯ç¤º<strong>ã€Œèª¤é»å¾Œçš„å¯¦éš›æ™‚é–“ã€</strong>ã€‚<br>
                    2. ä¾ç…§<strong>ã€Œå¯¦éš›ç™¼è»Šé †åºã€</strong>æ’åˆ—ï¼Œè€ŒéåŸå®šæ™‚åˆ»ã€‚<br>
                    3. ä¸€çœ¼çœ‹å‡ºç¾åœ¨è©²æ­å“ªä¸€ç­è»Šã€‚<br><br>
                    å¸Œæœ›é€™å€‹å·¥å…·èƒ½è§£æ±ºä½ çš„é€šå‹¤ç„¦æ…®ã€‚
                </div>
            </div>

            <div id="pageHow" class="modal-page">
                <div class="modal-header-row">
                    <button class="back-btn" onclick="goToPage('Menu')">â€¹</button>
                    <div class="modal-title">æ“ä½œèªªæ˜</div>
                </div>
                <div class="modal-text">
                    <strong>é›™æŒ‰éˆ•æ©Ÿåˆ¶ï¼š</strong><br><br>
                    1. <strong>ğŸ” æŸ¥è©¢è·¯ç·š (å·¦)ï¼š</strong><br>
                    åˆ‡æ›è·¯ç·šå°ˆç”¨ã€‚è‹¥æ‚¨é»æ“Šæ­¤æŒ‰éˆ•ä½†<strong>è»Šç«™æœªè®Šæ›´</strong>ï¼Œç³»çµ±å°‡è¦–ç‚ºã€Œæ›´æ–°ã€è™•ç†ã€‚<br>
                    è‹¥<strong>çœŸçš„è®Šæ›´è»Šç«™</strong>ï¼Œæ¯åˆ†é˜é™æŸ¥è©¢ 3 æ¬¡ã€‚<br><br>
                    2. <strong>ğŸ”„ æ›´æ–° (å³)ï¼š</strong><br>
                    åˆ·æ–°ç•¶å‰ç‹€æ…‹ã€‚æ¯æ¬¡é»æ“Šå¾Œéœ€ç­‰å¾… 90 ç§’å†·å»ã€‚<br><br>
                    <strong>ç‡ˆè™Ÿï¼š</strong><br>
                    <span style="color:#e6b800">é»ƒå­—</span>ï¼šèª¤é»è³‡æ–™å¤±æ•— (è‡ªå‹•é‡è©¦)ã€‚<br>
                    <span style="color:#ff4d4d">ç´…å­—</span>ï¼šæ“ä½œéæ–¼é »ç¹ã€‚
                </div>
            </div>

            <div id="pageReport" class="modal-page">
                <div class="modal-header-row">
                    <button class="back-btn" onclick="goToPage('Menu')">â€¹</button>
                    <div class="modal-title">ç³»çµ±è¨ºæ–·</div>
                </div>
                
                <div class="contact-info">
                    é–‹ç™¼è€…è¯çµ¡è³‡è¨Š<br>
                    <strong>d96benjamin@gmail.com</strong>
                </div>

                <div class="stats-dashboard">
                    <div class="stat-card" id="cardRpm">
                        <div class="stat-val" id="statRpm">0</div>
                        <div class="stat-label">1åˆ†é˜å…§è«‹æ±‚</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-val" id="statTotal">0</div>
                        <div class="stat-label">æœ¬æ¬¡ç¸½æ•¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-val" id="statLast">--</div>
                        <div class="stat-label">è·ä¸Šæ¬¡(ç§’)</div>
                    </div>
                </div>

                <div class="report-hint">
                    è‹¥é‡åˆ°å•é¡Œï¼Œè«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•è¤‡è£½å ±å‘Šï¼Œä¸¦å‚³é€éƒµä»¶çµ¦é–‹ç™¼è€…ã€‚
                </div>
                <textarea id="userDesc" class="search-box" style="width:100%; margin-bottom:10px; resize:none;" rows="2" placeholder="ï¼ˆé¸å¡«ï¼‰è«‹ç°¡è¿°æ‚¨é‡åˆ°çš„å•é¡Œ..."></textarea>
                <textarea id="reportContent" class="report-box" readonly></textarea>
                <button id="btnCopy" class="copy-btn" onclick="sendReport()">è¤‡è£½å ±å‘Šä¸¦å¯„ä¿¡</button>
            </div>

        </div>
    </div>

    <script>
        // ================= è³‡æ–™çµæ§‹å€ (ä¿æŒä¸è®Š) =================
        const STATION_DATA = {
            "åŸºéš†/æ–°åŒ—": ["åŸºéš†","ä¸‰å‘","å…«å µ","ä¸ƒå µ","ç™¾ç¦","äº”å µ","æ±æ­¢","æ±ç§‘","æ¿æ©‹","æµ®æ´²","æ¨¹æ—","å—æ¨¹æ—","å±±ä½³","é¶¯æ­Œ","ç¦éš†","è²¢å¯®","é›™æºª","ç‰¡ä¸¹","ä¸‰è²‚å¶º","å¤§è¯","ååˆ†","æœ›å¤","å¶ºè…³","å¹³æºª","èæ¡","ä¾¯ç¡","ç‘èŠ³","æµ·ç§‘é¤¨","å…«æ–—å­","æš–æš–"],
            "è‡ºåŒ—å¸‚": ["å—æ¸¯","æ¾å±±","è‡ºåŒ—","è¬è¯"],
            "æ¡ƒåœ’å¸‚": ["æ¡ƒåœ’","å…§å£¢","ä¸­å£¢","åŸ”å¿ƒ","æ¥Šæ¢…","å¯Œå²¡","æ–°å¯Œ"],
            "æ–°ç«¹ç¸£å¸‚": ["åŒ—æ¹–","æ¹–å£","æ–°è±","ç«¹åŒ—","åŒ—æ–°ç«¹","æ–°ç«¹","ä¸‰å§“æ©‹","é¦™å±±","å…­å®¶","ç«¹ä¸­","ä¸Šå“¡","æ¦®è¯","ç«¹æ±","æ©«å±±","ä¹è®šé ­","åˆèˆˆ","å¯Œè²´","å…§ç£"],
            "è‹—æ —ç¸£": ["å´é ‚","ç«¹å—","é€ æ©‹","è±å¯Œ","è‹—æ —","å—å‹¢","éŠ…é‘¼","ä¸‰ç¾©","è«‡æ–‡","å¤§å±±","å¾Œé¾","é¾æ¸¯","ç™½æ²™å±¯","æ–°åŸ”","é€šéœ„","è‹‘è£¡"],
            "è‡ºä¸­å¸‚": ["æ³°å®‰","åé‡Œ","è±åŸ","æ —æ—","æ½­å­","é ­å®¶å","æ¾ç«¹","å¤ªåŸ","ç²¾æ­¦","è‡ºä¸­","äº”æ¬Š","å¤§æ…¶","çƒæ—¥","æ–°çƒæ—¥","æˆåŠŸ","æ—¥å—","å¤§ç”²","è‡ºä¸­æ¸¯","æ¸…æ°´","æ²™é¹¿","é¾äº•","å¤§è‚š","è¿½åˆ†"],
            "å½°åŒ–ç¸£": ["å½°åŒ–","èŠ±å£‡","å¤§æ‘","å“¡æ—","æ°¸é–","ç¤¾é ­","ç”°ä¸­","äºŒæ°´","æºæ³‰","æ¿æ°´","é¾æ³‰","é›†é›†","æ°´é‡Œ","è»ŠåŸ•"],
            "é›²æ—ç¸£": ["æ—å…§","çŸ³æ¦´","æ–—å…­","æ–—å—","çŸ³é¾œ"],
            "å˜‰ç¾©ç¸£å¸‚": ["å¤§æ—","æ°‘é›„","å˜‰åŒ—","å˜‰ç¾©","æ°´ä¸Š","å—é–"],
            "è‡ºå—å¸‚": ["å¾Œå£","æ–°ç‡Ÿ","æŸ³ç‡Ÿ","æ—é³³ç‡Ÿ","éš†ç”°","æ‹”æ—","å–„åŒ–","å—ç§‘","æ–°å¸‚","æ°¸åº·","å¤§æ©‹","è‡ºå—","ä¿å®‰","ä»å¾·","ä¸­æ´²","å¤§æ¹–","æ²™å´™"],
            "é«˜é›„å¸‚": ["è·¯ç«¹","å²¡å±±","æ©‹é ­","æ¥ æ¢“","æ–°å·¦ç‡Ÿ","å·¦ç‡Ÿ","å…§æƒŸ","ç¾è¡“é¤¨","é¼“å±±","ä¸‰å¡Šå","é«˜é›„","æ°‘æ—","ç§‘å·¥é¤¨","æ­£ç¾©","é³³å±±","å¾Œåº„","ä¹æ›²å ‚"],
            "å±æ±ç¸£": ["å…­å¡Šå","å±æ±","æ­¸ä¾†","éºŸæ´›","è¥¿å‹¢","ç«¹ç”°","æ½®å·","å´é ‚","å—å·","é®å®‰","æ—é‚Š","ä½³å†¬","æ±æµ·","æ‹å¯®","åŠ ç¥¿","å…§ç…","æ‹å±±"],
            "å®œè˜­ç¸£": ["æ¼¢æœ¬","æ­¦å¡”","å—æ¾³","æ±æ¾³","æ°¸æ¨‚","è˜‡æ¾³","è˜‡æ¾³æ–°","å†¬å±±","ç¾…æ±","ä¸­é‡Œ","äºŒçµ","å®œè˜­","å››åŸ","ç¤æºª","é ‚åŸ”","é ­åŸ","å¤–æ¾³","é¾œå±±","å¤§æºª","å¤§é‡Œ","çŸ³åŸ"],
            "èŠ±è“®ç¸£": ["å’Œå¹³","å’Œä»","å´‡å¾·","æ–°åŸ","æ™¯ç¾","åŒ—åŸ”","èŠ±è“®","å‰å®‰","å¿—å­¸","å¹³å’Œ","å£½è±","è±ç”°","æ—æ¦®æ–°å…‰","å—å¹³","é³³æ—","è¬æ¦®","å…‰å¾©","å¤§å¯Œ","å¯Œæº","ç‘ç©—","ä¸‰æ°‘","ç‰é‡Œ","æ±é‡Œ","æ±ç«¹","å¯Œé‡Œ"],
            "è‡ºæ±ç¸£": ["æ± ä¸Š","æµ·ç«¯","é—œå±±","ç‘å’Œ","ç‘æº","é¹¿é‡","å±±é‡Œ","è‡ºæ±","åº·æ¨‚","çŸ¥æœ¬","å¤ªéº»é‡Œ","é‡‘å´™","ç€§æºª","å¤§æ­¦"]
        };
        const STATION_INDEX = {};
        Object.keys(STATION_DATA).forEach(region => { STATION_DATA[region].forEach(station => { STATION_INDEX[station] = region; }); });

        const CACHE_PREFIX = "train_data_v2_"; 
        const PREF_START_R_KEY = "pref_start_region"; const PREF_START_S_KEY = "pref_start_station";
        const PREF_END_R_KEY = "pref_end_region"; const PREF_END_S_KEY = "pref_end_station";
        
        // --- DOM Elements ---
        const startRegion = document.getElementById('startRegion');
        const startStation = document.getElementById('startStation');
        const endRegion = document.getElementById('endRegion');
        const endStation = document.getElementById('endStation');
        const searchInput = document.getElementById('searchInput');
        const searchTarget = document.getElementById('searchTarget'); 
        
        const btnSearch = document.getElementById('btnSearch');
        const btnRefresh = document.getElementById('btnRefresh');
        
        const statusMsg = document.getElementById('statusMsg');
        const updateTimeDiv = document.getElementById('updateTime');
        const list = document.getElementById('cardList');
        const modal = document.getElementById('aboutModal');

        // --- è¨ºæ–·èˆ‡ç›£æ§ç³»çµ± ---
        let systemLogs = []; 
        let requestHistory = [];

        function logSystem(action, detail) {
            const time = new Date().toLocaleTimeString();
            const logEntry = `[${time}] ${action}: ${detail}`;
            systemLogs.push(logEntry);
            if (systemLogs.length > 30) systemLogs.shift(); 
        }

        function recordRequest() {
            requestHistory.push(Date.now());
        }

        function updateDashboard() {
            const now = Date.now();
            const recentReqs = requestHistory.filter(t => now - t < 60000);
            const rpm = recentReqs.length;
            
            document.getElementById('statRpm').innerText = rpm;
            if(rpm >= 5) document.getElementById('cardRpm').classList.add('danger');
            else document.getElementById('cardRpm').classList.remove('danger');

            document.getElementById('statTotal').innerText = requestHistory.length;

            if(requestHistory.length > 0) {
                const last = requestHistory[requestHistory.length - 1];
                const diff = Math.floor((now - last) / 1000);
                document.getElementById('statLast').innerText = diff;
            } else {
                document.getElementById('statLast').innerText = "--";
            }
        }

        // --- è®Šæ•¸ç®¡ç† ---
        let refreshTimer = null; 
        let searchLockTimer = null; 
        let retryTimer = null; 
        let searchCount = 0;
        let searchResetTime = Date.now();
        const MAX_SEARCH_PER_MIN = 3;
        let lastRefreshTime = 0; 
        let lastFetchedPair = { start: "", end: "" };
        let lockedUntil = 0;

        function init() {
            logSystem("Init", "App Started");
            const regions = Object.keys(STATION_DATA);
            const regionOptions = regions.map(r => `<option value="${r}">${r}</option>`).join('');
            startRegion.innerHTML = regionOptions; endRegion.innerHTML = regionOptions;

            const savedStartR = localStorage.getItem(PREF_START_R_KEY) || "å±æ±ç¸£";
            const savedStartS = localStorage.getItem(PREF_START_S_KEY) || "å±æ±";
            const savedEndR = localStorage.getItem(PREF_END_R_KEY) || "å±æ±ç¸£";
            const savedEndS = localStorage.getItem(PREF_END_S_KEY) || "æ½®å·";

            setMenu('start', savedStartR, savedStartS); setMenu('end', savedEndR, savedEndS);
            
            const savedUpdateText = localStorage.getItem("last_update_text");
            if(savedUpdateText) updateTimeDiv.innerText = savedUpdateText;

            loadDataOrFetch();
        }

        function setMenu(type, regionVal, stationVal) {
            const rSelect = type === 'start' ? startRegion : endRegion;
            const sSelect = type === 'start' ? startStation : endStation;
            if (!STATION_DATA[regionVal]) regionVal = "å±æ±ç¸£";
            rSelect.value = regionVal;
            const stations = STATION_DATA[regionVal];
            sSelect.innerHTML = stations.map(s => `<option value="${s}">${s}</option>`).join('');
            if (stations.includes(stationVal)) sSelect.value = stationVal; else sSelect.selectedIndex = 0;
        }

        function updateStationList(type) {
            const rSelect = type === 'start' ? startRegion : endRegion;
            const sSelect = type === 'start' ? startStation : endStation;
            const region = rSelect.value;
            const stations = STATION_DATA[region];
            sSelect.innerHTML = stations.map(s => `<option value="${s}">${s}</option>`).join('');
            sSelect.selectedIndex = 0;
            markAsChanged();
        }

        function swapStations() {
            logSystem("UI", "Swap Stations");
            const sR = startRegion.value; const sS = startStation.value;
            const eR = endRegion.value; const eS = endStation.value;
            setMenu('start', eR, eS); setMenu('end', sR, sS);
            markAsChanged();
        }

        function handleSearch() {
            const input = searchInput.value.trim();
            const target = searchTarget.value;
            if (!input) return;
            let found = null;
            if (STATION_INDEX[input]) found = input;
            else { const allStations = Object.keys(STATION_INDEX); found = allStations.find(s => s.includes(input)); }
            if (found) {
                logSystem("UI", `Search Found: ${found}`);
                const region = STATION_INDEX[found];
                setMenu(target, region, found); 
                searchInput.style.borderColor = "#4d7f5e"; setTimeout(() => searchInput.style.borderColor = "#444", 500);
                markAsChanged();
            }
        }

        function markAsChanged() {
            localStorage.setItem(PREF_START_R_KEY, startRegion.value); localStorage.setItem(PREF_START_S_KEY, startStation.value);
            localStorage.setItem(PREF_END_R_KEY, endRegion.value); localStorage.setItem(PREF_END_S_KEY, endStation.value);
            attemptLoadCache(false); 
        }

        function getCacheKey() { return `${CACHE_PREFIX}${startStation.value}_${endStation.value}`; }

        function attemptLoadCache(isInit) {
            const key = getCacheKey();
            const cached = localStorage.getItem(key);
            let hit = false;
            
            if (cached) {
                const data = JSON.parse(cached);
                const now = Date.now();
                if (now - data.timestamp < 60 * 1000) {
                    console.log("å¿«å–å‘½ä¸­");
                    renderCards(data.payload);
                    setUpdateText(`æ›´æ–°æ–¼(å¿«å–): ${data.payload.update_time}`);
                    statusMsg.innerText = "æº–å‚™å°±ç·’";
                    statusMsg.className = "status-msg";
                    list.style.opacity = "1";
                    lastFetchedPair = { start: startStation.value, end: endStation.value };
                    hit = true;
                }
            }

            if (!hit) {
                if (isInit) {
                    doRefresh(true);
                } else {
                    list.style.opacity = "0.4";
                    statusMsg.innerText = "è¨­å®šå·²è®Šæ›´ï¼Œè«‹æŒ‰ã€ŒæŸ¥è©¢ã€";
                    statusMsg.className = "status-msg unsync";
                }
            }
            updateButtonMode();
        }

        function loadDataOrFetch() { attemptLoadCache(true); }

        function updateButtonMode() {
            const currentStart = startStation.value;
            const currentEnd = endStation.value;
            const isChanged = (currentStart !== lastFetchedPair.start || currentEnd !== lastFetchedPair.end);

            if (lockedUntil > Date.now()) return;

            if (isChanged) {
                btnSearch.disabled = false;
            }
        }

        function doSearch() {
            const currentStart = startStation.value;
            const currentEnd = endStation.value;

            if (currentStart === lastFetchedPair.start && currentEnd === lastFetchedPair.end) {
                statusMsg.innerText = "è»Šç«™æœªè®Šæ›´ï¼ŒåŸ·è¡Œæ›´æ–°";
                setTimeout(() => { if(!statusMsg.classList.contains("alert")) statusMsg.innerText = "æº–å‚™å°±ç·’"; }, 2000);
                doRefresh(); 
                return;
            }

            const now = Date.now();
            if (now - searchResetTime > 60000) {
                searchCount = 0;
                searchResetTime = now;
            }

            if (searchCount >= MAX_SEARCH_PER_MIN) {
                const waitTime = Math.ceil((60000 - (now - searchResetTime)) / 1000);
                lockSearchButton(waitTime);
                logSystem("Limit", "Search Limit Reached");
                return;
            }

            searchCount++;
            logSystem("Action", `Search (${searchCount}/3): ${currentStart}->${currentEnd}`);
            fetchData("search"); 
        }

        function doRefresh(skipCheck = false) {
            if (!skipCheck) {
                const now = Date.now();
                const elapsed = now - lastRefreshTime;
                if (elapsed < 90000) {
                    const wait = Math.ceil((90000 - elapsed) / 1000);
                    lockRefreshButton(wait);
                    logSystem("Limit", "Refresh Cooldown");
                    return;
                }
            }
            logSystem("Action", "Refresh");
            fetchData("refresh");
        }

        async function fetchData(mode) {
            statusMsg.innerText = "é€£ç·šä¸­...";
            statusMsg.className = "status-msg";
            list.style.opacity = "1";
            
            if (retryTimer) { clearTimeout(retryTimer); retryTimer = null; }

            if (mode === "search") btnSearch.disabled = true;
            if (mode === "refresh") btnRefresh.disabled = true;

            const s = startStation.value;
            const e = endStation.value;
            const url = `/api/index?start=${s}&end=${e}`;

            recordRequest();

            try {
                const res = await fetch(url);
                const json = await res.json();

                if (json.error) throw new Error(json.error);

                lastFetchedPair = { start: s, end: e };
                const cacheObj = { timestamp: Date.now(), payload: json };
                localStorage.setItem(getCacheKey(), JSON.stringify(cacheObj));

                renderCards(json);
                
                logSystem("API Success", `DelayFailed: ${json.delay_failed}`);

                if (json.delay_failed) {
                    statusMsg.innerText = `ç„¡æ³•å–å¾—èª¤é»è³‡è¨Šï¼Œ60s å¾Œè‡ªå‹•é‡è©¦`;
                    statusMsg.className = "status-msg warning";
                    scheduleRetry(); 
                    setUpdateText(`æ›´æ–°æ–¼: ${json.update_time} (åƒ…æ™‚åˆ»è¡¨)`);
                } else {
                    statusMsg.innerText = "æ›´æ–°å®Œæˆ";
                    statusMsg.className = "status-msg";
                    setUpdateText(`æ›´æ–°æ–¼: ${json.update_time}`);
                }

                if (mode === "search") {
                    setTimeout(() => btnSearch.disabled = false, 500);
                    lastRefreshTime = Date.now();
                    lockRefreshButton(90);
                }

                if (mode === "refresh") {
                    lastRefreshTime = Date.now();
                    lockRefreshButton(90);
                }

            } catch (err) {
                console.error(err);
                logSystem("API Error", err.message);
                
                // === ä¿®æ­£ï¼šä¸»é é¢ä¸é¡¯ç¤ºå¯æ€•éŒ¯èª¤ï¼Œåªå¼•å°è¨ºæ–· ===
                statusMsg.innerText = "é€£ç·šç™¼ç”ŸéŒ¯èª¤";
                statusMsg.className = "status-msg alert";
                list.innerHTML = `<div class="message">é€£ç·šç™¼ç”Ÿå•é¡Œ âš ï¸<br><span style="font-size:0.8rem; color:#888">è«‹é»æ“Šå³ä¸Šè§’ã€Œ?ã€é€²å…¥ç³»çµ±è¨ºæ–·</span></div>`;
                
                if (mode === "search") setTimeout(() => btnSearch.disabled = false, 2000);
                if (mode === "refresh") setTimeout(() => btnRefresh.disabled = false, 2000);
            }
        }

        function setUpdateText(text) {
            updateTimeDiv.innerText = text;
            localStorage.setItem("last_update_text", text);
        }

        function scheduleRetry() {
            let count = 60;
            retryTimer = setInterval(() => {
                count--;
                statusMsg.innerText = `èª¤é»è³‡è¨Šç„¡æ³•å–å¾—ï¼Œ${count}s å¾Œé‡è©¦...`; // ä¿®æ”¹æ–‡å­—æ›´æº«å’Œ
                statusMsg.className = "status-msg warning";
                if (count <= 0) {
                    clearInterval(retryTimer);
                    retryTimer = null;
                    doRefresh(true); 
                }
            }, 1000);
        }

        function lockSearchButton(seconds) {
            if (searchLockTimer) clearInterval(searchLockTimer);
            lockedUntil = Date.now() + (seconds * 1000);
            
            statusMsg.innerText = "è«‹å‹¿é »ç¹æ“ä½œ";
            statusMsg.className = "status-msg alert";
            btnSearch.classList.add('error');
            btnSearch.disabled = true;

            const tick = () => {
                btnSearch.innerText = `é »ç¹æ“ä½œ (${seconds})`;
                if (seconds <= 0) {
                    clearInterval(searchLockTimer);
                    btnSearch.disabled = false;
                    btnSearch.classList.remove('error');
                    btnSearch.innerText = "ğŸ” æŸ¥è©¢è·¯ç·š";
                    statusMsg.innerText = "æº–å‚™å°±ç·’";
                    statusMsg.className = "status-msg";
                    lockedUntil = 0;
                }
                seconds--;
            };
            tick();
            searchLockTimer = setInterval(tick, 1000);
        }

        function lockRefreshButton(seconds) {
            if (refreshTimer) clearInterval(refreshTimer);
            btnRefresh.disabled = true;
            const tick = () => {
                btnRefresh.innerText = `æ›´æ–° (${seconds})`;
                if (seconds <= 0) {
                    clearInterval(refreshTimer);
                    btnRefresh.disabled = false;
                    btnRefresh.innerText = "ğŸ”„ æ›´æ–°";
                }
                seconds--;
            };
            tick();
            refreshTimer = setInterval(tick, 1000);
        }

        function renderCards(data) {
            if (data.trains && data.trains.length > 0) {
                let html = "";
                data.trains.forEach(t => {
                    let delayTag = "";
                    if (!data.delay_failed && t.delay > 0) delayTag = `<div class="delay-badge">èª¤é» ${t.delay} åˆ†</div>`;
                    const trainUrl = `https://railway.chienwen.net/taiwan/train/TRA-${t.no}/live`;
                    html += `
                    <a href="${trainUrl}" target="_blank">
                        <div class="card" style="border-left-color: ${t.color};">
                            ${delayTag}
                            <div class="train-info" style="color: ${t.color};">${t.type} ${t.no} æ¬¡</div>
                            <div class="main-time"><span>${t.act_dep}</span><span class="arrow">â”</span><span>${t.act_arr}</span></div>
                            <div class="sub-time">åŸå®š ${t.sch_dep} â” ${t.sch_arr}</div>
                        </div>
                    </a>`;
                });
                list.innerHTML = html;
                return;
            }
            const original = data.stats ? data.stats.original_count : 0;
            if (original > 0) list.innerHTML = `<div class="message">ä»Šæ—¥ç­æ¬¡å·²å…¨æ•¸é§›é›¢ ğŸ‘‹<br><span style="font-size:0.8rem; color:#666">TDX æ­£å¸¸é€£ç·š (åŸæœ‰ ${original} ç­)</span></div>`;
            else list.innerHTML = `<div class="message">æŸ¥ç„¡æ­¤å€é–“ç›´é”åˆ—è»Š âš ï¸<br><span style="font-size:0.8rem; color:#666">TDX å›å‚³ç„¡è³‡æ–™</span></div>`;
        }

        // --- Report System (Modified) ---
        function openModal() { document.getElementById('aboutModal').style.display = 'flex'; goToPage('Menu'); }
        function closeModal() { document.getElementById('aboutModal').style.display = 'none'; }
        
        function goToPage(pageId) {
            document.querySelectorAll('.modal-page').forEach(p => p.classList.remove('active'));
            document.getElementById('page' + pageId).classList.add('active');
            
            if(pageId === 'Report') {
                updateDashboard();
                generateReport();
            }
        }

        function generateReport() {
            const box = document.getElementById('reportContent');
            const userText = document.getElementById('userDesc').value;
            
            let report = "ã€TRAIN LIVE è¨ºæ–·å ±å‘Šã€‘\n";
            report += `æ™‚é–“: ${new Date().toLocaleString()}\n`;
            report += `è£ç½®: ${navigator.userAgent}\n`;
            report += `è·¯ç·š: ${startStation.value} -> ${endStation.value}\n`;
            
            const now = Date.now();
            const recentReqs = requestHistory.filter(t => now - t < 60000);
            report += `æµé‡ç›£æ§: RPM=${recentReqs.length}, Total=${requestHistory.length}\n`;

            report += "--- æ“ä½œç´€éŒ„ ---\n";
            report += systemLogs.join("\n");
            
            if(userText) {
                report += "\n\n--- ä½¿ç”¨è€…æè¿° ---\n" + userText;
            }
            
            box.value = report;
        }

        function sendReport() {
            // 1. Copy to Clipboard
            const box = document.getElementById('reportContent');
            generateReport();
            box.select();
            document.execCommand('copy');
            
            // 2. UI Feedback
            const btn = document.getElementById('btnCopy');
            btn.innerText = "å·²è¤‡è£½ï¼æ­£åœ¨é–‹å•Ÿéƒµä»¶...";
            btn.classList.add('copied');
            
            // 3. Open Email
            setTimeout(() => {
                const subject = encodeURIComponent("TRAIN LIVE ç³»çµ±è¨ºæ–·å›å ±");
                // é€™è£¡çš„ body æ•…æ„ç•™ç©ºæˆ–åªçµ¦æç¤ºï¼Œå› ç‚º log å¯èƒ½å¤ªé•·æœƒè¢«æˆªæ–·ï¼Œè®“ä½¿ç”¨è€…è‡ªå·±è²¼ä¸Šæœ€å®‰å…¨
                const body = encodeURIComponent("ï¼ˆè«‹åœ¨æ­¤è™•é•·æŒ‰è²¼ä¸Šå‰›å‰›è¤‡è£½çš„è¨ºæ–·å ±å‘Šï¼‰\n\næˆ‘çš„å•é¡Œæè¿°ï¼š\n");
                
                window.location.href = `mailto:d96benjamin@gmail.com?subject=${subject}&body=${body}`;
                
                // Reset button
                setTimeout(() => {
                    btn.innerText = "è¤‡è£½å ±å‘Šä¸¦å¯„ä¿¡";
                    btn.classList.remove('copied');
                }, 2000);
            }, 1000);
        }

        init();
    </script>
</body>
</html>
