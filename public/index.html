<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TRAIN LIVE | åˆ—è»Šæ™‚åˆ»å³æ™‚çœ‹æ¿</title>
    <meta name="description" content="ä¸åªæ˜¯èª¤é»å¹¾åˆ†é˜ï¼Œç›´æ¥å‘Šè¨´ä½ å¯¦éš›å¹¾é»åˆ°ã€‚">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#151517">
    <link rel="apple-touch-icon" href="/icon.png">
    <link rel="icon" type="image/png" href="/icon.png">

    <style>
        /* --- åŸºç¤è¨­å®š --- */
        *, *::before, *::after { box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body { background: #000; color: #fff; font-family: -apple-system, sans-serif; padding: 10px; margin: 0; }
        .container { max-width: 500px; margin: 0 auto; padding-bottom: 100px; position: relative; }

        /* --- Header --- */
        .header { margin-bottom: 15px; background: #151517; border-radius: 12px; border: 1px solid #333; position: relative;}
        .header-static-part { padding: 15px; background: #151517; position: relative; z-index: 10; border-top-left-radius: 12px; border-top-right-radius: 12px;}
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; min-height: 36px; }
        .app-title { font-size: 1rem; color: #888; letter-spacing: 1px; font-weight: 800; margin: 0; flex: 1; }

        .top-actions { display: flex; align-items: center; gap: 8px; }
        .install-btn-top {
            background: #4d7f5e; color: #fff; border: none; padding: 0 12px; height: 36px; border-radius: 8px; 
            font-size: 0.8rem; font-weight: bold; cursor: pointer; display: none;
            align-items: center; gap: 4px; animation: fadeIn 0.5s; white-space: nowrap;
        }
        .menu-btn-trigger { background: #2c2c2e; border: 1px solid #444; color: #fff; width: 36px; height: 36px; border-radius: 8px; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* --- Search & Selectors --- */
        .search-row { display: flex; gap: 8px; margin-bottom: 12px; width: 100%; }
        .search-target { flex: 1; min-width: 0; background: #222; border: 1px solid #444; color: #ccc; border-radius: 8px; font-size: 0.85rem; padding-left: 5px; }
        .search-box { flex: 2.5; min-width: 0; background: #222; border: 1px solid #444; color: #fff; padding: 8px 10px; border-radius: 8px; font-size: 0.9rem; }
        .search-box:focus { border-color: #4d7f5e; outline: none; background: #000; }
        .selector-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .selector-label { width: 35px; font-size: 0.8rem; color: #888; font-weight: bold; text-align: center;}
        .select-group { flex: 1; display: flex; gap: 5px; }
        .region-select { flex: 2; background: #2c2c2e; color: #eee; border: 1px solid #444; padding: 8px 4px; border-radius: 8px; font-size: 0.95rem; font-weight: bold; text-align: center; }
        .station-select { flex: 3; background: #3a3a3c; color: #fff; border: 1px solid #555; padding: 8px 4px; border-radius: 8px; font-size: 1rem; font-weight: bold; text-align: center; }
        .swap-container { display: flex; justify-content: center; margin: -4px 0 4px 0; }
        .swap-btn { font-size: 1.2rem; color: #666; background: none; border: none; padding: 0 10px; cursor: pointer; transform: rotate(90deg); }
        .btn-static-search {
            width: 100%; background: #eee; color: #000; border: none; 
            padding: 10px; border-radius: 10px; font-size: 1rem; font-weight: bold; 
            cursor: pointer; margin-top: 5px; display: flex; justify-content: center; align-items: center;
        }
        .btn-static-search:disabled { background: #333; color: #888; cursor: not-allowed; }

        /* --- Sticky Header (å‹•æ…‹æ¬„) --- */
        .header-sticky-part {
            background: #151517; 
            border-bottom-left-radius: 12px; border-bottom-right-radius: 12px;
            width: 100%; z-index: 100; will-change: transform;
            display: flex; flex-direction: column; border-top: 1px solid #222;
            transition: transform 0.3s ease, height 0.3s ease;
        }
        .header-sticky-part.is-fixed {
            position: fixed; top: 0; width: calc(100% - 20px); max-width: 500px; left: 50%;
            border-radius: 0 0 12px 12px; border: 1px solid #333; border-top: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.9); transform: translateX(-50%);
        }
        /* æ”¶åˆç‹€æ…‹ */
        .header-sticky-part.collapsed .sticky-content { display: none; }
        .header-sticky-part.collapsed { border-bottom: 1px solid #333; border-radius: 12px; }

        #stickyPlaceholder { display: none; }

        /* æ”¶åˆæŒ‰éˆ• */
        .toggle-sticky-btn {
            position: absolute; bottom: -20px; right: 10px;
            width: 40px; height: 20px; background: #151517; 
            border: 1px solid #333; border-top: none;
            border-bottom-left-radius: 8px; border-bottom-right-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; color: #666; cursor: pointer; z-index: 90;
            line-height: 1; padding-bottom: 3px;
        }
        .header-sticky-part.is-fixed .toggle-sticky-btn { display: flex; }
        .toggle-sticky-btn { display: none; } /* éå›ºå®šæ™‚ä¸é¡¯ç¤º */

        /* æ›´æ–°æç¤ºæ°£æ³¡ */
        .refresh-tooltip {
            position: absolute; top: 55px; left: 10px; z-index: 200;
            background: #4d7f5e; color: #fff; padding: 10px 15px;
            border-radius: 8px; font-size: 0.9rem; font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            display: none; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .refresh-tooltip::before {
            content: ''; position: absolute; top: -6px; left: 20px;
            width: 0; height: 0; border-left: 6px solid transparent;
            border-right: 6px solid transparent; border-bottom: 6px solid #4d7f5e;
        }
        .refresh-tooltip-close { margin-left: 10px; color: rgba(255,255,255,0.7); cursor: pointer; border:1px solid rgba(255,255,255,0.4); border-radius: 50%; width: 18px; height: 18px; display: inline-flex; align-items: center; justify-content: center; font-size: 0.7rem; line-height: 1;}
        @keyframes popIn { from { transform: scale(0.8) translateY(10px); opacity: 0; } to { transform: scale(1) translateY(0); opacity: 1; } }

        /* Row 1: Quick Route + Fav */
        .sticky-row-top { display: flex; align-items: center; border-bottom: 1px solid #222; min-height: 50px; position: relative; }
        .quick-route-scroll-container { flex: 1; overflow-x: auto; white-space: nowrap; padding: 5px 10px; height: 100%; display: flex; align-items: center; scrollbar-width: none; }
        .quick-route-scroll-container::-webkit-scrollbar { display: none; }
        .route-chip { display: inline-flex; align-items: center; background: #222; border: 1px solid #444; color: #bbb; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; margin-right: 6px; user-select: none; flex-shrink: 0; }
        .route-chip.fav { border-color: #4d7f5e; color: #4d7f5e; background: rgba(77, 127, 94, 0.1); font-weight: bold; }
        .route-chip.hist { border-style: dashed; }
        .chip-arrow { margin: 0 5px; color: #666; font-size: 0.7rem; }
        .btn-side-container { padding: 5px 10px; border-left: 1px solid #222; height: 100%; display: flex; align-items: center; min-width: 85px; justify-content: center; }
        .btn-fav-compact { background: #222; color: #ccc; border: 1px solid #444; padding: 4px 8px; border-radius: 8px; font-size: 0.75rem; cursor: pointer; width: 100%; text-align: center; }
        .btn-fav-compact.fav-active { color: #e6b800; border-color: #e6b800; background: rgba(230,184,0,0.1); font-weight: bold; }

        /* Row 2: Tools */
        .sticky-row-tools { display: flex; gap: 8px; padding: 8px 10px; border-bottom: 1px solid #222; }
        .toolbar-btn { flex: 1; background: #222; border: 1px solid #444; color: #ccc; padding: 8px 0; border-radius: 8px; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 4px; }
        .toolbar-btn.active { color: #4d7f5e; border-color: #4d7f5e; background: rgba(77,127,94,0.1); }
        .toolbar-btn.refresh { background: #4d7f5e; color: white; border-color: #4d7f5e; font-weight: bold; }
        .toolbar-btn:disabled { background: #333; color: #888; border-color: #333; cursor: not-allowed; }

        /* Row 3: Status */
        .sticky-row-status { display: flex; justify-content: space-between; align-items: center; padding: 6px 15px 8px 15px; background: #111; border-bottom-left-radius: 12px; border-bottom-right-radius: 12px; }
        .status-left { font-size: 0.8rem; color: #aaa; font-weight: bold; display: flex; align-items: center; gap: 5px; min-height: 1.2em;}
        .status-left.alert { color: #ff4d4d; }
        .status-left.warning { color: #e6b800; }
        .status-right { font-size: 0.75rem; color: #666; font-family: monospace; }

        /* Footer Hints */
        .fixed-footer-hints { position: fixed; bottom: 0; left: 0; width: 100%; background: #1a1a1c; border-top: 1px solid #333; display: none; align-items: center; justify-content: center; gap: 20px; padding: 10px 15px; font-size: 0.75rem; color: #666; z-index: 200; padding-bottom: max(10px, env(safe-area-inset-bottom)); box-shadow: 0 -5px 20px rgba(0,0,0,0.8); }
        .fixed-footer-hints.centered { justify-content: center; } 
        .hint-group { display: flex; align-items: center; gap: 8px; }
        .hint-text-col { display: flex; flex-direction: column; line-height: 1.2; }
        .hint-text-col span { font-weight: bold; color: #ccc; }
        .hint-text-col span.sub { font-weight: normal; color: #666; font-size: 0.7rem; }
        .hint-divider { width: 1px; height: 20px; background: #333; margin: 0 5px; }

        /* Card & LED */
        .led-dot { width: 8px; height: 8px; background-color: #4d7f5e; border-radius: 50%; opacity: 0.2; transition: opacity 0.1s; }
        body.tick-a .led-dot.top { opacity: 1; box-shadow: 0 0 6px #4d7f5e; }
        body.tick-b .led-dot.bottom { opacity: 1; box-shadow: 0 0 6px #4d7f5e; }
        .led-pair-mini { display: flex; flex-direction: column; gap: 3px; }
        .card { background: #151517; border-radius: 12px; padding: 12px 16px 12px 30px; margin-bottom: 10px; border-left: 5px solid #333; position: relative; transition: transform 0.1s; }
        a { display: block; text-decoration: none; color: inherit; -webkit-tap-highlight-color: transparent; }
        .card:active { transform: scale(0.98); background-color: #222; }
        .train-info { font-size: 0.9rem; font-weight: 700; margin-bottom: 4px; }
        .main-time { display: flex; align-items: center; justify-content: center; padding: 6px 0; gap: 6px; }
        .time-group { display: flex; flex-direction: column; align-items: center; }
        .time-date-label { font-size: 0.65rem; color: #888; margin-bottom: 2px; font-family: monospace; letter-spacing: 0.5px;}
        .time-part { font-size: 1.8rem; font-weight: 700; line-height: 1; white-space: nowrap; display: flex; align-items: baseline; }
        .ampm { font-size: 1rem; margin-right: 3px; color: #aaa; font-weight: normal; }
        .arrow { font-size: 0.8rem; color: #666; margin-top: 10px; flex-shrink: 0;} 
        .sub-time { text-align: center; color: #888; font-size: 0.75rem; }
        .card.departed-card { opacity: 0.5; filter: grayscale(1); border-left-color: #555 !important; }
        .status-badge-container { position: absolute; top: 12px; right: 16px; display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
        .status-tag { padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; display: inline-flex; align-items: center; white-space: nowrap; }
        .status-tag.departed { color: #888; border: 1px solid #555; background: #222; }
        .status-tag.delay { color: hsl(40, 100%, 50%); border: 1px solid hsl(40, 100%, 50%); }
        .left-indicator { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; gap: 6px; }

        /* Others */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 999; display: none; align-items: center; justify-content: center; }
        .modal-content { background: #1c1c1e; width: 85%; max-width: 400px; border-radius: 16px; padding: 25px; border: 1px solid #333; box-shadow: 0 10px 30px rgba(0,0,0,0.5); text-align: left; position: relative; max-height: 80vh; overflow-y: auto; }
        .modal-header-row { display: flex; align-items: center; margin-bottom: 15px; position: sticky; top: -25px; background: #1c1c1e; z-index: 10; padding: 10px 0; border-bottom: 1px solid #333; }
        .back-btn { background: none; border: none; color: #888; font-size: 1.5rem; cursor: pointer; padding: 0 10px 0 0; line-height: 1; }
        .modal-title { font-size: 1.2rem; font-weight: bold; color: #4d7f5e; flex: 1; }
        .menu-btn { display: flex; justify-content: space-between; align-items: center; width: 100%; padding: 15px; margin-bottom: 10px; background: #2c2c2e; border: 1px solid #444; color: #fff; border-radius: 12px; font-size: 1rem; cursor: pointer; }
        .modal-text { font-size: 0.9rem; line-height: 1.6; color: #ccc; margin-bottom: 20px; }
        .modal-close { background: #333; color: #fff; border: none; padding: 10px 0; width: 100%; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .modal-page { display: none; }
        .modal-page.active { display: block; animation: fadeIn 0.2s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .btn-load-next { width: 100%; background: #222; color: #888; border: 1px dashed #444; padding: 15px; border-radius: 12px; margin-top: 15px; cursor: pointer; font-size: 0.9rem; font-weight: bold; transition: all 0.2s; }
        .btn-load-next:active { background: #333; color: #fff; transform: scale(0.98); }

        .back-to-top { position: fixed; bottom: 85px; right: 25px; width: 50px; height: 50px; background: #4d7f5e; color: #fff; border-radius: 50%; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.5); font-size: 1.5rem; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 100; opacity: 0; transform: translateY(20px); transition: all 0.3s ease; pointer-events: none; }
        .back-to-top.visible { opacity: 1; transform: translateY(0); pointer-events: auto; }

        /* Version History Style */
        .ver-item { margin-bottom: 15px; border-left: 2px solid #4d7f5e; padding-left: 10px; }
        .ver-date { font-size: 0.8rem; color: #4d7f5e; font-weight: bold; margin-bottom: 4px; }
        .ver-content { font-size: 0.85rem; color: #bbb; line-height: 1.4; }

        #inAppOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.92); z-index: 10000; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 40px 20px; box-sizing: border-box; backdrop-filter: blur(5px); }
    </style>
</head>
<body class="tick-a">
    <div id="inAppOverlay" onclick="this.style.display='none'">
        <div style="font-size:3rem; color:#4d7f5e; margin-bottom:20px;">ğŸŒ</div>
        <div style="color:#fff; font-size:1.1rem; line-height:1.6;">è«‹åˆ‡æ›è‡³ç€è¦½å™¨é–‹å•Ÿ</div>
        <div style="color:#e6b800; font-weight:bold; font-size:1.3rem; margin:20px 0; border:2px dashed #444; padding:15px; border-radius:12px; background:#222;">1. é»æ“Šé¸å–® (â‹®)<br><br>2. é¸æ“‡ã€Œåœ¨ç€è¦½å™¨é–‹å•Ÿã€</div>
    </div>

    <div id="fixedFooterHints" class="fixed-footer-hints">
        <div id="hintArrival" class="hint-group">
            <div class="led-pair-mini"><div class="led-dot top"></div><div class="led-dot bottom"></div></div>
            <div class="hint-text-col"><span>10åˆ†é˜å…§</span><span>ç™¼è»Š</span></div>
        </div>
        <div id="hintDivider" class="hint-divider"></div>
        <div class="hint-group"><span style="font-size:1.2rem">ğŸ‘†</span><div class="hint-text-col"><span>é»æ“Šè»Šæ¬¡å¡ç‰‡æŸ¥çœ‹</span><span class="sub">å³æ™‚ä½ç½® & å®Œæ•´åœé ç«™</span></div></div>
    </div>

    <div class="container">
        <div class="header">
            <div class="header-static-part">
                <div class="header-top">
                    <div class="app-title">TRAIN LIVE</div>
                    <div class="top-actions">
                        <button id="btnInstall" class="install-btn-top" onclick="handleInstall()">ğŸ“² åŠ åˆ°æ¡Œé¢</button>
                        <button class="menu-btn-trigger" onclick="openModal()">â˜°</button>
                    </div>
                </div>

                <div class="search-row">
                    <select id="searchTarget" class="search-target" onchange="handleSearch()"><option value="start">è¨­ç‚ºèµ·é»</option><option value="end">è¨­ç‚ºçµ‚é»</option></select>
                    <input type="text" id="searchInput" class="search-box" placeholder="ğŸ” æœå°‹ (å°=è‡º)" oninput="handleSearch()">
                </div>

                <div class="selector-row">
                    <div class="selector-label">èµ·é»</div>
                    <div class="select-group">
                        <select id="startRegion" class="region-select" onchange="updateStationList('start')"></select>
                        <select id="startStation" class="station-select" onchange="markAsChanged()"></select>
                    </div>
                </div>
                <div class="swap-container"><button class="swap-btn" onclick="swapStations()">â‡„</button></div>
                <div class="selector-row">
                    <div class="selector-label">çµ‚é»</div>
                    <div class="select-group">
                        <select id="endRegion" class="region-select" onchange="updateStationList('end')"></select>
                        <select id="endStation" class="station-select" onchange="markAsChanged()"></select>
                    </div>
                </div>

                <button id="btnSearch" class="btn-static-search" onclick="doSearch()">ğŸ” æŸ¥è©¢è·¯ç·š</button>
            </div>

            <div id="stickyHeader" class="header-sticky-part">
                <div id="refreshTooltip" class="refresh-tooltip">
                    é»æ“Šæ›´æ–°ä»¥å–å¾—æœ€æ–°è³‡æ–™
                    <span class="refresh-tooltip-close" onclick="closeRefreshTooltip()">âœ•</span>
                </div>
                
                <div class="sticky-content">
                    <div id="rowQuickRoute" class="sticky-row-top">
                        <div id="quickRouteArea" class="quick-route-scroll-container"></div>
                        <div class="btn-side-container">
                             <button id="btnStar" class="btn-fav-compact" onclick="toggleFavorite()">â˜…<br>å·²æ”¶è—</button>
                        </div>
                    </div>

                    <div id="rowTools" class="sticky-row-tools">
                        <button id="btnRefresh" class="toolbar-btn refresh" onclick="doRefresh()">ğŸ”„ æ›´æ–°</button>
                        <button id="btnShowAll" class="toolbar-btn" onclick="toggleShowAll()">ğŸ‘ï¸ å·²é§›é›¢</button>
                        <button id="btnTimeFormat" class="toolbar-btn" onclick="toggleTimeFormat()">ğŸ•’ AM/PM</button>
                    </div>

                    <div class="sticky-row-status">
                        <div id="statusMsg" class="status-left"></div>
                        <div id="updateTime" class="status-right"></div>
                    </div>
                </div>
                
                <div id="toggleStickyBtn" class="toggle-sticky-btn" onclick="toggleStickyHeader()">âŒƒ</div>
            </div>
            <div id="stickyPlaceholder"></div>
        </div>

        <div id="cardList"></div>
    </div>

    <button id="btnBackToTop" class="back-to-top" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">â†‘</button>

    <div id="aboutModal" class="modal-overlay" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div id="pageMenu" class="modal-page active">
                <div class="modal-header-row"><div class="modal-title">é¸å–®</div></div>
                <button class="menu-btn" onclick="goToPage('Why')">è¨­è¨ˆç†å¿µ</button>
                <button class="menu-btn" onclick="goToPage('How')">æ“ä½œèªªæ˜</button>
                <button class="menu-btn" onclick="goToPage('Report')">ç³»çµ±è¨ºæ–· / å•é¡Œå›å ±</button>
                <button class="menu-btn" onclick="goToPage('Author')">é—œæ–¼ä½œè€…</button>
                <button class="menu-btn" onclick="shareApp()">ğŸ“¤ åˆ†äº«çµ¦æœ‹å‹</button>
                <button class="modal-close" style="margin-top:15px;" onclick="closeModal()">é—œé–‰</button>
            </div>
            <div id="pageWhy" class="modal-page">
                <div class="modal-header-row"><button class="back-btn" onclick="goToPage('Menu')">â€¹</button><div class="modal-title">è¨­è¨ˆç†å¿µ</div></div>
                <div class="modal-text">ç›´æ¥é¡¯ç¤ºã€Œèª¤é»å¾Œçš„å¯¦éš›æ™‚é–“ã€ï¼Œä¸¦ä¾ã€Œå¯¦éš›ç™¼è»Šé †åºã€æ’åˆ—ã€‚</div>
            </div>
            <div id="pageHow" class="modal-page">
                <div class="modal-header-row"><button class="back-btn" onclick="goToPage('Menu')">â€¹</button><div class="modal-title">æ“ä½œèªªæ˜</div></div>
                <div class="modal-text">
                    <strong>1. è·¯ç·šæœå°‹é™åˆ¶ï¼š</strong><br>
                    ç‚ºä¿è­·ä¼ºæœå™¨è³‡æºï¼Œæ¯åˆ†é˜æœå°‹æ¬¡æ•¸è¨­æœ‰ä¸Šé™ (3æ¬¡)ã€‚<br><br>
                    <strong>2. æ›´æ–°å†·å»ï¼š</strong><br>
                    æ¯æ¬¡æ›´æ–°å¾Œéœ€ç­‰å¾… 30 ç§’æ‰èƒ½å†æ¬¡é‡æ–°æ•´ç†ï¼Œé¿å…é »ç¹è«‹æ±‚ã€‚<br><br>
                    <strong>3. è‡ªå‹•é‡è©¦ï¼š</strong><br>
                    è‹¥é‡åˆ°ç³»çµ±å¿™ç¢Œæˆ–é€£ç·šéŒ¯èª¤ï¼Œç³»çµ±æœƒè‡ªå‹•å€’æ•¸ä¸¦é‡è©¦ï¼Œè«‹è€å¿ƒç­‰å€™ã€‚
                </div>
            </div>
            <div id="pageReport" class="modal-page">
                <div class="modal-header-row"><button class="back-btn" onclick="goToPage('Menu')">â€¹</button><div class="modal-title">ç³»çµ±è¨ºæ–·</div></div>
                <div class="modal-text">
                    <div style="margin-bottom:10px; font-size:0.8rem; color:#888;">è«‹é•·æŒ‰è¤‡è£½å ±å‘Šå¾Œå¯„é€ã€‚</div>
                    <textarea id="reportContent" style="width:100%; height:100px; background:#222; color:#fff; border:1px solid #444; padding:5px; font-size:0.7rem;" readonly></textarea>
                    <div style="margin-top:10px; display:flex; gap:10px;">
                        <button onclick="copyReportOnly()" class="menu-btn" style="flex:1; margin:0; justify-content:center;">è¤‡è£½</button>
                        <button onclick="openMailClient()" class="menu-btn" style="flex:1; margin:0; justify-content:center; background:#007AFF;">å¯„ä¿¡</button>
                    </div>
                </div>
            </div>
            <div id="pageAuthor" class="modal-page">
                <div class="modal-header-row"><button class="back-btn" onclick="goToPage('Menu')">â€¹</button><div class="modal-title">é—œæ–¼ä½œè€…</div></div>
                <div class="modal-text">
                    <div style="text-align:center; font-weight:bold; margin-bottom:15px; color:#fff;">BenjaminDai èˆ‡ Gemini</div>
                    <div style="font-size:0.85rem; color:#888; margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:10px;">ç‰ˆæœ¬ç´€éŒ„</div>
                    
                    <div class="ver-item">
                        <div class="ver-date">2026/1/11</div>
                        <div class="ver-content">å‹•æ…‹ç¶²ç«™æ¶è¨­ã€åŸºæœ¬æœå°‹åˆ—è»Šè·¯ç·šã€TDX APIå–å¾—å„ªåŒ–ã€æ“ä½œä»‹é¢å„ªåŒ–ï¼Œå·²å®Œæˆä»¥ä¸Šäº‹é …è®“ç¶²ç«™åŠŸèƒ½æ­£å¸¸é‹ä½œã€‚</div>
                    </div>

                    <div style="text-align:center; margin-top:20px;">
                        <a href="https://www.instagram.com/d16benjamin_?igsh=N2c3M25ia3M0a3c4" target="_blank" style="color:#4d7f5e; text-decoration:none;">@d16benjamin_</a>
                    </div>
                </div>
            </div>
            <div id="pageIOS" class="modal-page">
                <div class="modal-header-row"><div class="modal-title">å®‰è£æ•™å­¸</div><button class="modal-close" style="width:auto; padding:5px 15px;" onclick="closeModal()">é—œé–‰</button></div>
                <div style="text-align:center; color:#ccc; line-height:2;">
                    1. é»æ“Šç€è¦½å™¨ <span style="font-size:1.4rem">â‹</span> åˆ†äº«<br>2. é¸æ“‡ <span style="font-size:1.4rem">âŠ</span> åŠ å…¥ä¸»ç•«é¢
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- ç«™é»è³‡æ–™ (ä¿æŒä¸è®Š) ---
        const STATION_DATA = {
            "åŸºéš†å¸‚": ["åŸºéš†", "ä¸‰å‘", "å…«å µ", "ä¸ƒå µ", "ç™¾ç¦", "æš–æš–", "æµ·ç§‘é¤¨"],
            "æ–°åŒ—å¸‚": ["äº”å µ", "æ±æ­¢", "æ±ç§‘", "æ¿æ©‹", "æµ®æ´²", "æ¨¹æ—", "å—æ¨¹æ—", "å±±ä½³", "é¶¯æ­Œ", "é³³é³´", "å››è…³äº­", "ç‘èŠ³", "ä¾¯ç¡", "ä¸‰è²‚å¶º", "ç‰¡ä¸¹", "é›™æºª", "è²¢å¯®", "ç¦éš†", "å…«æ–—å­", "å¤§è¯", "ååˆ†", "æœ›å¤", "å¶ºè…³", "å¹³æºª", "èæ¡"],
            "è‡ºåŒ—å¸‚": ["å—æ¸¯", "æ¾å±±", "è‡ºåŒ—", "è¬è¯"],
            "æ¡ƒåœ’å¸‚": ["æ¡ƒåœ’", "å…§å£¢", "ä¸­å£¢", "åŸ”å¿ƒ", "æ¥Šæ¢…", "å¯Œå²¡", "æ–°å¯Œ"],
            "æ–°ç«¹ç¸£å¸‚": ["åŒ—æ¹–", "æ¹–å£", "æ–°è±", "ç«¹åŒ—", "åŒ—æ–°ç«¹", "æ–°ç«¹", "ä¸‰å§“æ©‹", "é¦™å±±", "åƒç”²", "æ–°èŠ", "å…­å®¶", "ç«¹ä¸­", "ä¸Šå“¡", "æ¦®è¯", "ç«¹æ±", "æ©«å±±", "ä¹è®šé ­", "åˆèˆˆ", "å¯Œè²´", "å…§ç£"],
            "è‹—æ —ç¸£": ["å´é ‚", "ç«¹å—", "é€ æ©‹", "è±å¯Œ", "è‹—æ —", "å—å‹¢", "éŠ…é‘¼", "ä¸‰ç¾©", "è«‡æ–‡", "å¤§å±±", "å¾Œé¾", "é¾æ¸¯", "ç™½æ²™å±¯", "æ–°åŸ”", "é€šéœ„", "è‹‘è£¡"],
            "è‡ºä¸­å¸‚": ["æ³°å®‰", "åé‡Œ", "è±åŸ", "æ —æ—", "æ½­å­", "é ­å®¶å", "æ¾ç«¹", "å¤ªåŸ", "ç²¾æ­¦", "è‡ºä¸­", "äº”æ¬Š", "å¤§æ…¶", "çƒæ—¥", "æ–°çƒæ—¥", "æˆåŠŸ", "æ—¥å—", "å¤§ç”²", "è‡ºä¸­æ¸¯", "æ¸…æ°´", "æ²™é¹¿", "é¾äº•", "å¤§è‚š", "è¿½åˆ†"],
            "å½°åŒ–ç¸£": ["å½°åŒ–", "èŠ±å£‡", "å¤§æ‘", "å“¡æ—", "æ°¸é–", "ç¤¾é ­", "ç”°ä¸­", "äºŒæ°´", "æºæ³‰"],
            "å—æŠ•ç¸£": ["æ¿æ°´", "é¾æ³‰", "é›†é›†", "æ°´é‡Œ", "è»ŠåŸ•"],
            "é›²æ—ç¸£": ["æ—å…§", "çŸ³æ¦´", "æ–—å…­", "æ–—å—", "çŸ³é¾œ"],
            "å˜‰ç¾©ç¸£å¸‚": ["å¤§æ—", "æ°‘é›„", "å˜‰åŒ—", "å˜‰ç¾©", "æ°´ä¸Š", "å—é–"],
            "è‡ºå—å¸‚": ["å¾Œå£", "æ–°ç‡Ÿ", "æŸ³ç‡Ÿ", "æ—é³³ç‡Ÿ", "éš†ç”°", "æ‹”æ—", "å–„åŒ–", "å—ç§‘", "æ–°å¸‚", "æ°¸åº·", "å¤§æ©‹", "è‡ºå—", "ä¿å®‰", "ä»å¾·", "ä¸­æ´²", "é•·æ¦®å¤§å­¸", "æ²™å´™"],
            "é«˜é›„å¸‚": ["å¤§æ¹–", "è·¯ç«¹", "å²¡å±±", "æ©‹é ­", "æ¥ æ¢“", "æ–°å·¦ç‡Ÿ", "å·¦ç‡Ÿ", "å…§æƒŸ", "ç¾è¡“é¤¨", "é¼“å±±", "ä¸‰å¡Šå", "é«˜é›„", "æ°‘æ—", "ç§‘å·¥é¤¨", "æ­£ç¾©", "é³³å±±", "å¾Œåº„", "ä¹æ›²å ‚"],
            "å±æ±ç¸£": ["å…­å¡Šå", "å±æ±", "æ­¸ä¾†", "éºŸæ´›", "è¥¿å‹¢", "ç«¹ç”°", "æ½®å·", "å´é ‚", "å—å·", "é®å®‰", "æ—é‚Š", "ä½³å†¬", "æ±æµ·", "æ‹å¯®", "åŠ ç¥¿", "å…§ç…", "æ‹å±±"],
            "å®œè˜­ç¸£": ["æ¼¢æœ¬", "æ­¦å¡”", "å—æ¾³", "æ±æ¾³", "æ°¸æ¨‚", "è˜‡æ¾³", "è˜‡æ¾³æ–°", "å†¬å±±", "ç¾…æ±", "ä¸­é‡Œ", "äºŒçµ", "å®œè˜­", "å››åŸ", "ç¤æºª", "é ‚åŸ”", "é ­åŸ", "å¤–æ¾³", "é¾œå±±", "å¤§æºª", "å¤§é‡Œ", "çŸ³åŸ"],
            "èŠ±è“®ç¸£": ["å’Œå¹³", "å’Œä»", "å´‡å¾·", "æ–°åŸ", "æ™¯ç¾", "åŒ—åŸ”", "èŠ±è“®", "å‰å®‰", "å¿—å­¸", "å¹³å’Œ", "å£½è±", "è±ç”°", "æ—æ¦®æ–°å…‰", "å—å¹³", "é³³æ—", "è¬æ¦®", "å…‰å¾©", "å¤§å¯Œ", "å¯Œæº", "ç‘ç©—", "ä¸‰æ°‘", "ç‰é‡Œ", "æ±é‡Œ", "æ±ç«¹", "å¯Œé‡Œ"],
            "è‡ºæ±ç¸£": ["æ± ä¸Š", "æµ·ç«¯", "é—œå±±", "ç‘å’Œ", "ç‘æº", "é¹¿é‡", "å±±é‡Œ", "è‡ºæ±", "åº·æ¨‚", "çŸ¥æœ¬", "å¤ªéº»é‡Œ", "é‡‘å´™", "ç€§æºª", "å¤§æ­¦"]
        };

        const STATION_INDEX={};Object.keys(STATION_DATA).forEach(r=>{STATION_DATA[r].forEach(s=>{STATION_INDEX[s]=r;});});
        const DEFAULT_STATIONS = {"åŸºéš†å¸‚": "åŸºéš†", "æ–°åŒ—å¸‚": "æ¿æ©‹", "è‡ºåŒ—å¸‚": "è‡ºåŒ—", "æ¡ƒåœ’å¸‚": "æ¡ƒåœ’", "æ–°ç«¹ç¸£å¸‚": "æ–°ç«¹", "è‹—æ —ç¸£": "è‹—æ —", "è‡ºä¸­å¸‚": "è‡ºä¸­", "å½°åŒ–ç¸£": "å½°åŒ–", "å—æŠ•ç¸£": "é›†é›†", "é›²æ—ç¸£": "æ–—å…­", "å˜‰ç¾©ç¸£å¸‚": "å˜‰ç¾©", "è‡ºå—å¸‚": "è‡ºå—", "é«˜é›„å¸‚": "é«˜é›„", "å±æ±ç¸£": "å±æ±", "å®œè˜­ç¸£": "ç¾…æ±", "èŠ±è“®ç¸£": "èŠ±è“®", "è‡ºæ±ç¸£": "è‡ºæ±"};

        const CACHE_PREFIX="train_data_v2_";
        const PREF_START_R_KEY="pref_start_region";const PREF_START_S_KEY="pref_start_station";
        const PREF_END_R_KEY="pref_end_region";const PREF_END_S_KEY="pref_end_station";
        const LS_FAV = "tl_favorites"; const LS_HIST = "tl_history";
        const MAX_SEARCH_PER_MIN=3;

        const startRegion=document.getElementById('startRegion');const startStation=document.getElementById('startStation');
        const endRegion=document.getElementById('endRegion');const endStation=document.getElementById('endStation');
        const searchInput=document.getElementById('searchInput');const searchTarget=document.getElementById('searchTarget');
        const btnSearch=document.getElementById('btnSearch');const btnRefresh=document.getElementById('btnRefresh');
        const statusMsg=document.getElementById('statusMsg');const updateTimeDiv=document.getElementById('updateTime');
        const list=document.getElementById('cardList');const btnInstall = document.getElementById('btnInstall');
        const sticky = document.getElementById('stickyHeader'); const placeholder = document.getElementById('stickyPlaceholder');
        const toggleStickyBtn = document.getElementById('toggleStickyBtn');

        let refreshTimer=null; let searchLockTimer=null; let retryTimer=null; let staleDataTimer=null;
        let lastFetchedPair={start:"",end:""}; let currentTrainData = null;
        let is24Hour = localStorage.getItem("tl_pref_is_24h") !== 'false';
        let isShowAll = false;
        let isManuallyCollapsed = false; // å‹•æ…‹æ¬„æ‰‹å‹•æ”¶åˆç‹€æ…‹
        let currentNextDate = ""; let isFetchingNext = false;
        let deferredPrompt;

        // --- PWA & UI Init ---
        const isIos = /iPhone|iPad|iPod/.test(navigator.userAgent);
        const isInApp = /Line|Instagram|FBAN|FBAV/i.test(navigator.userAgent);
        if (!('standalone' in window.navigator) && !window.matchMedia('(display-mode: standalone)').matches) btnInstall.style.display = 'flex';
        window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; });

        function handleInstall() {
            if (isInApp) { document.getElementById('inAppOverlay').style.display = 'flex'; return; }
            if (isIos) { document.getElementById('aboutModal').style.display = 'flex'; goToPage('IOS'); return; }
            if (deferredPrompt) deferredPrompt.prompt().then(res => { if(res.outcome==='accepted') btnInstall.style.display='none'; deferredPrompt=null; });
        }
        function startTicker() {
            setInterval(() => {
                document.body.classList.toggle('tick-a'); document.body.classList.toggle('tick-b');
            }, 500);
            setInterval(() => { if (currentTrainData && !document.hidden) renderCards(currentTrainData); }, 15000);
        }

        // --- Helper Functions ---
        function getSearchCount(){return parseInt(localStorage.getItem("tl_search_count")||"0");}
        function setSearchCount(v){localStorage.setItem("tl_search_count",v);}
        function getSearchResetTime(){return parseInt(localStorage.getItem("tl_search_reset")||"0");}
        function setSearchResetTime(v){localStorage.setItem("tl_search_reset",v);}
        function getSearchLockedUntil(){return parseInt(localStorage.getItem("tl_search_lock")||"0");}
        function setSearchLockedUntil(v){localStorage.setItem("tl_search_lock",v);}
        function getRefreshLockedUntil(){return parseInt(localStorage.getItem("tl_refresh_lock")||"0");}
        function setRefreshLockedUntil(v){localStorage.setItem("tl_refresh_lock",v);}

        function updateToggleBtns() {
            document.getElementById('btnTimeFormat').classList.toggle('active', !is24Hour);
            document.getElementById('btnShowAll').classList.toggle('active', isShowAll);
        }
        function toggleTimeFormat() { is24Hour=!is24Hour; localStorage.setItem("tl_pref_is_24h", is24Hour); updateToggleBtns(); reRenderLocal(); scrollToFirstActive();}
        function toggleShowAll() { isShowAll=!isShowAll; updateToggleBtns(); reRenderLocal(); scrollToFirstActive();}
        function formatTime(t) {
            if(!t) return ""; if(is24Hour) return t;
            const p = t.split(':'); if(p.length < 2) return t;
            let h = parseInt(p[0]); let suffix = "AM";
            if(h >= 12) { suffix = "PM"; if(h > 12) h -= 12; } else if(h === 0) { h = 12; }
            return `<span class="ampm">${suffix}</span> ${h}:${p[1]}`;
        }

        // --- Sticky Header & Collapse Logic ---
        function toggleStickyHeader() {
            isManuallyCollapsed = !isManuallyCollapsed;
            sticky.classList.toggle('collapsed', isManuallyCollapsed);
            toggleStickyBtn.innerText = isManuallyCollapsed ? 'âŒ„' : 'âŒƒ';
        }
        
        window.addEventListener('scroll', () => {
            // å¦‚æœæœ‰è·³å‡ºæ›´æ–°æé†’ï¼Œå¼·åˆ¶å±•é–‹
            if (document.getElementById('refreshTooltip').style.display === 'block') {
                 // å¼·åˆ¶å±•é–‹
                 if (!sticky.classList.contains('is-fixed')) {
                    placeholder.style.display = 'block'; placeholder.style.height = sticky.offsetHeight + 'px';
                    sticky.classList.add('is-fixed');
                 }
                 return; 
            }

            const threshold = 150;
            const current = window.scrollY;
            
            if (current > threshold) {
                if (!sticky.classList.contains('is-fixed')) {
                    placeholder.style.display = 'block'; placeholder.style.height = sticky.offsetHeight + 'px';
                    sticky.classList.add('is-fixed');
                }
            } else {
                sticky.classList.remove('is-fixed');
                placeholder.style.display = 'none';
                // ç•¶å›åˆ°é ‚éƒ¨ï¼Œè‡ªå‹•å±•é–‹ (Reset collapse state)
                isManuallyCollapsed = false;
                sticky.classList.remove('collapsed');
                toggleStickyBtn.innerText = 'âŒƒ';
            }
        });

        function scrollToFirstActive() { setTimeout(() => { const el = document.getElementById("firstActive"); if (el) el.scrollIntoView({ behavior: "smooth", block: "center" }); }, 300); }

        // --- Init & Data ---
        function init() {
            startTicker(); updateToggleBtns();
            document.getElementById('rowTools').style.display = 'none';
            
            const regions=Object.keys(STATION_DATA); const rOpts=regions.map(r=>`<option value="${r}">${r}</option>`).join('');
            startRegion.innerHTML=rOpts; endRegion.innerHTML=rOpts;

            const savedSR = localStorage.getItem(PREF_START_R_KEY);
            if (savedSR) {
                setMenu('start',savedSR,localStorage.getItem(PREF_START_S_KEY)||"å±æ±"); 
                setMenu('end',localStorage.getItem(PREF_END_R_KEY)||"å±æ±ç¸£",localStorage.getItem(PREF_END_S_KEY)||"æ½®å·");
                checkLocksOnLoad(); attemptLoadCache(true);
            } else {
                startRegion.innerHTML=`<option value="" disabled selected>é¸æ“‡ç¸£å¸‚</option>`+rOpts; 
                endRegion.innerHTML=`<option value="" disabled selected>é¸æ“‡ç¸£å¸‚</option>`+rOpts;
                startStation.innerHTML=endStation.innerHTML=`<option value="" disabled selected>é¸æ“‡è»Šç«™</option>`;
                list.innerHTML='<div class="message">è«‹é¸æ“‡ èµ·é» èˆ‡ çµ‚é» è»Šç«™<br>é–‹å§‹æŸ¥è©¢</div>';
                statusMsg.innerText="ç­‰å¾…è¼¸å…¥...";
                checkLocksOnLoad();
            }
            renderQuickRoutes(); updateStarState();
        }

        function checkLocksOnLoad() {
            const now=Date.now();
            const sL=getSearchLockedUntil(); if(sL>now) lockSearchButton(Math.ceil((sL-now)/1000));
            const rL=getRefreshLockedUntil(); if(rL>now) lockRefreshButton(Math.ceil((rL-now)/1000));
        }
        function setMenu(type,rV,sV) {
            const rSel=type==='start'?startRegion:endRegion; const sSel=type==='start'?startStation:endStation;
            if(!STATION_DATA[rV]) { rSel.value = ""; return; }
            rSel.value=rV; sSel.innerHTML=STATION_DATA[rV].map(s=>`<option value="${s}">${s}</option>`).join('');
            if(STATION_DATA[rV].includes(sV)) sSel.value=sV; else sSel.selectedIndex=0;
        }
        function updateStationList(type) {
            const rSel=type==='start'?startRegion:endRegion; const sSel=type==='start'?startStation:endStation;
            const rVal = rSel.value; if (!rVal) return;
            sSel.innerHTML=STATION_DATA[rVal].map(s=>`<option value="${s}">${s}</option>`).join('');
            const def=DEFAULT_STATIONS[rVal]; 
            if(def&&STATION_DATA[rVal].includes(def)) sSel.value=def; else sSel.selectedIndex=0;
            if(startStation.value&&endStation.value) markAsChanged();
        }
        function swapStations() {
            if(!startStation.value||!endStation.value) return;
            const sR=startRegion.value; const sS=startStation.value;
            setMenu('start',endRegion.value,endStation.value); setMenu('end',sR,sS);
            markAsChanged();
        }
        
        // [ä¿®æ”¹] handleSearch: æ”¯æ´ã€Œå°ã€è½‰ã€Œè‡ºã€
        function handleSearch() {
            let val=searchInput.value.trim(); 
            const tgt=searchTarget.value; 
            if(!val) return;
            
            // è‡ªå‹•è½‰æ› å°->è‡º
            val = val.replace(/å°/g, 'è‡º');

            let found=STATION_INDEX[val]?val:Object.keys(STATION_INDEX).find(s=>s.includes(val));
            if(found) {
                setMenu(tgt,STATION_INDEX[found],found);
                searchInput.style.borderColor="#4d7f5e"; setTimeout(()=>searchInput.style.borderColor="#444",500);
                if(startStation.value&&endStation.value) markAsChanged();
            }
        }
        
        function markAsChanged() {
            if(!startStation.value||!endStation.value) return;
            localStorage.setItem(PREF_START_R_KEY,startRegion.value); localStorage.setItem(PREF_START_S_KEY,startStation.value);
            localStorage.setItem(PREF_END_R_KEY,endRegion.value); localStorage.setItem(PREF_END_S_KEY,endStation.value);
            attemptLoadCache(false); updateStarState();
        }
        function getCacheKey(){return `${CACHE_PREFIX}${startStation.value}_${endStation.value}`;}

        function reRenderLocal() {
            if (currentTrainData) { renderCards(currentTrainData); return; }
            const c=localStorage.getItem(getCacheKey()); if(c) renderCards(JSON.parse(c).payload.trains); 
        }

        function attemptLoadCache(isInit) {
            if(!startStation.value||!endStation.value) return;
            const c=localStorage.getItem(getCacheKey()); let hit=false;
            if(c) {
                const d=JSON.parse(c);
                if(Date.now()-d.timestamp < 60000) {
                    renderCards(d.payload.trains); 
                    setUpdateText(`æ›´æ–°æ™‚é–“ï¼š${d.payload.update_time} (å¿«å–)`);
                    statusMsg.innerText=""; statusMsg.className="status-left"; 
                    lastFetchedPair={start:startStation.value,end:endStation.value}; hit=true;
                    scrollToFirstActive(); 
                }
            }
            if(!hit) {
                if(isInit) { statusMsg.innerText="ç­‰å¾…æŸ¥è©¢"; list.innerHTML='<div class="message">è«‹é»æ“Šä¸Šæ–¹æŒ‰éˆ•æŸ¥è©¢ç­æ¬¡</div>'; }
                else { list.style.opacity="0.4"; statusMsg.innerText="è¨­å®šå·²è®Šæ›´"; statusMsg.className="status-left warning"; }
            }
            updateButtonMode();
        }
        function updateButtonMode() {
            if(getSearchLockedUntil()>Date.now()) return;
            if(startStation.value!==lastFetchedPair.start||endStation.value!==lastFetchedPair.end) btnSearch.disabled=false;
        }

        function doSearch() {
            const sS=startStation.value; const eS=endStation.value;
            if(!sS||!eS) { statusMsg.innerText="è«‹å…ˆé¸æ“‡èµ·é»èˆ‡çµ‚é»"; statusMsg.className="status-left alert"; setTimeout(()=>statusMsg.innerText="",2000); return; }
            markAsChanged();
            if(sS===lastFetchedPair.start&&eS===lastFetchedPair.end) { doRefresh(); return; }
            const now=Date.now(); let cnt=getSearchCount(); let rst=getSearchResetTime();
            if(now-rst>60000) { cnt=0; setSearchCount(0); rst=now; setSearchResetTime(now); }
            if(cnt===0) { rst=now; setSearchResetTime(now); }
            if(cnt>=MAX_SEARCH_PER_MIN) {
                const w=Math.ceil((60000-(now-rst))/1000); 
                setSearchLockedUntil(now+(w>0?w:60)*1000); lockSearchButton(w); return;
            }
            addToHistory(); cnt++; setSearchCount(cnt); 
            fetchData("search", false);
        }

        function doRefresh(skip=false) {
            if(!skip) {
                const now=Date.now(); const rL=getRefreshLockedUntil();
                if(rL>now) { lockRefreshButton(Math.ceil((rL-now)/1000)); return; }
            }
            fetchData("refresh", false);
        }

        function loadNextDay() { if(isFetchingNext || !currentNextDate) return; fetchData("append", true); }

        async function fetchData(mode, isNext) {
            if(isFetchingNext && mode === 'append') return;
            const s=startStation.value; const e=endStation.value; const now = Date.now();

            if(mode==="search") { btnSearch.disabled=true; list.innerHTML = getSkeletonHTML(); list.style.opacity="1"; statusMsg.innerText="è¼‰å…¥ä¸­..."; }
            if(mode==="refresh") { btnRefresh.disabled=true; statusMsg.innerText="æ›´æ–°ä¸­..."; }
            if(mode==="append") { isFetchingNext = true; const btn = document.getElementById('btnLoadNext'); if(btn) btn.innerText = "è¼‰å…¥ä¸­..."; }
            if(retryTimer){clearTimeout(retryTimer);retryTimer=null;}

            // æ¸…é™¤ä¹‹å‰çš„æé†’è¨ˆæ™‚å™¨èˆ‡æç¤ºæ¡†
            if(staleDataTimer) clearTimeout(staleDataTimer);
            closeRefreshTooltip();
            // é‡ç½®å‹•æ…‹æ¬„æ”¶åˆç‹€æ…‹ (å¦‚æœæœ‰è³‡æ–™æ›´æ–°)
            if(mode !== 'append') {
                isManuallyCollapsed = false;
                sticky.classList.remove('collapsed');
                toggleStickyBtn.innerText = 'âŒƒ';
            }

            let url = `/api/index?start=${s}&end=${e}`;
            if (isNext && currentNextDate) url += `&date=${currentNextDate}`;

            try {
                const res = await fetch(url);
                const json = await res.json();
                if(json.error) throw new Error(json.error);

                if (mode === 'append') {
                    appendCards(json.trains); isFetchingNext = false;
                } else {
                    lastFetchedPair={start:s,end:e};
                    currentNextDate = json.next_date;
                    localStorage.setItem(getCacheKey(),JSON.stringify({timestamp:Date.now(),payload:json}));
                    renderCards(json.trains);
                    setUpdateText(`æ›´æ–°æ™‚é–“ï¼š${json.update_time}`);
                    if(json.delay_failed) scheduleRetry("èª¤é»è³‡æ–™å¤±æ•—");
                    else statusMsg.innerText = "æ›´æ–°å®Œæˆ";
                    setTimeout(()=>{ if(statusMsg.innerText==="æ›´æ–°å®Œæˆ") statusMsg.innerText=""; }, 2000);
                    
                    // [ä¿®æ”¹] è¨­å®š 5 åˆ†é˜ (300000ms) å¾Œæé†’æ›´æ–°
                    staleDataTimer = setTimeout(showRefreshHint, 300000);
                }

                if(mode==="search"){ setTimeout(()=>btnSearch.disabled=false,500); setRefreshLockedUntil(now+30000); lockRefreshButton(30); scrollToFirstActive(); }
                if(mode==="refresh"){ setRefreshLockedUntil(now+30000); lockRefreshButton(30); }

            } catch(err) {
                console.error(err);
                if(mode === 'append') { isFetchingNext = false; const btn = document.getElementById('btnLoadNext'); if(btn) btn.innerText = "è¼‰å…¥å¤±æ•—ï¼Œé»æ“Šé‡è©¦"; } 
                else { list.innerHTML=`<div class="message">é€£ç·šç™¼ç”Ÿå•é¡Œ âš ï¸</div>`; scheduleRetry("é€£ç·šéŒ¯èª¤", "status-left alert"); }
            }
        }

        // [æ–°å¢] é¡¯ç¤ºæ›´æ–°æé†’æ°£æ³¡
        function showRefreshHint() {
            // 1. å¼·åˆ¶å±•é–‹å‹•æ…‹æ¬„
            if (!sticky.classList.contains('is-fixed')) {
                 placeholder.style.display = 'block'; placeholder.style.height = sticky.offsetHeight + 'px';
                 sticky.classList.add('is-fixed');
            }
            sticky.classList.remove('collapsed'); 
            isManuallyCollapsed = false;
            toggleStickyBtn.innerText = 'âŒƒ';

            // 2. é¡¯ç¤ºæ°£æ³¡
            const tt = document.getElementById('refreshTooltip');
            tt.style.display = 'block';
        }
        function closeRefreshTooltip() {
            document.getElementById('refreshTooltip').style.display = 'none';
        }

        function setUpdateText(t){updateTimeDiv.innerText=t;}

        // [ä¿®æ”¹] scheduleRetry: é¡¯ç¤ºæ˜ç¢ºçš„å€’æ•¸
        function scheduleRetry(msg="èª¤é»è³‡è¨Šç„¡æ³•å–å¾—", cls="status-left warning") {
            let c=30; 
            if(retryTimer) clearInterval(retryTimer);
            statusMsg.className = cls; 
            // ç«‹å³é¡¯ç¤º
            statusMsg.innerText = `${msg} (è‡ªå‹•é‡è©¦ ${c}s)`;
            retryTimer=setInterval(()=>{
                c--; 
                statusMsg.innerText=`${msg} (è‡ªå‹•é‡è©¦ ${c}s)`;
                if(c<=0){ clearInterval(retryTimer); retryTimer=null; doRefresh(true); }
            },1000);
        }

        function lockSearchButton(s) {
            if(searchLockTimer) clearInterval(searchLockTimer);
            statusMsg.innerText="è«‹å‹¿é »ç¹æ“ä½œ"; statusMsg.className="status-left alert";
            btnSearch.disabled=true; btnSearch.innerText=`é »ç¹æ“ä½œ (${s})`;
            const t=()=>{
                btnSearch.innerText=`é »ç¹æ“ä½œ (${s})`;
                if(s<=0){ clearInterval(searchLockTimer); btnSearch.disabled=false; btnSearch.innerText="ğŸ” æŸ¥è©¢è·¯ç·š"; statusMsg.innerText=""; setSearchLockedUntil(0); } s--;
            }; t(); searchLockTimer=setInterval(t,1000);
        }
        function lockRefreshButton(s) {
            if(refreshTimer) clearInterval(refreshTimer);
            btnRefresh.disabled=true;
            const t=()=>{
                btnRefresh.innerText=`æ›´æ–° (${s})`;
                if(s<=0){ clearInterval(refreshTimer); btnRefresh.disabled=false; btnRefresh.innerText="ğŸ”„ æ›´æ–°"; setRefreshLockedUntil(0); } s--;
            }; t(); refreshTimer=setInterval(t,1000);
        }
        
        function getSkeletonHTML() { let h=''; for(let i=0;i<3;i++) h+=`<div class="skeleton-card" style="background:#1c1c1e;border-radius:12px;padding:12px 16px;margin-bottom:10px;border-left:5px solid #333;animation:pulse 1.5s infinite;"><div style="height:14px;width:60%;margin-bottom:12px;background:#333;"></div><div style="height:24px;width:80%;margin:0 auto 12px auto;background:#333;"></div><div style="height:12px;width:50%;margin:0 auto;background:#333;"></div></div>`; return h; }
        document.head.insertAdjacentHTML("beforeend", `<style>@keyframes pulse {0%{opacity:0.6;}50%{opacity:1;}100%{opacity:0.6;}}</style>`)

        function renderCards(data) {
            currentTrainData = data; 
            const elTools = document.getElementById('rowTools');
            const hasTrains = data && data.length > 0;
            elTools.style.display = 'flex';
            const footerHints = document.getElementById('fixedFooterHints');
            
            if(hasTrains) {
                footerHints.style.display = 'flex';
                let html = ''; let anyArriving = false; let lastDate = "";
                data.forEach(t => {
                    const diffSec = t.sort_key - Date.now()/1000;
                    const isArriving = !t.is_past && diffSec <= 600;
                    if(isArriving) anyArriving = true;
                    if (!isShowAll && t.is_past && diffSec < -600) return;

                    if (lastDate && t.dep_date !== lastDate) {
                        html += `<div style="text-align:center; padding:10px 0; color:#4d7f5e; font-size:0.8rem; font-weight:bold; border-top:1px dashed #333; margin-top:15px;">â¬‡ ${t.dep_date} ç­æ¬¡ â¬‡</div>`;
                    }
                    html += generateCardHTML(t);
                    lastDate = t.dep_date;
                });

                if (anyArriving) { document.getElementById('hintArrival').style.display='flex'; document.getElementById('hintDivider').style.display='block'; footerHints.classList.remove('centered'); } 
                else { document.getElementById('hintArrival').style.display='none'; document.getElementById('hintDivider').style.display='none'; footerHints.classList.add('centered'); }
                
                html += `<button id="btnLoadNext" class="btn-load-next" onclick="loadNextDay()">â¬‡ è¼‰å…¥æ›´å¤šç­æ¬¡ (${currentNextDate})</button>`;
                list.innerHTML = (!html.includes('card')) ? `<div class="message">ç›®å‰æ™‚æ®µæŸ¥ç„¡ç­æ¬¡ âš ï¸</div>` : html;
            } else {
                footerHints.style.display = 'none';
                list.innerHTML = `<div class="message">æŸ¥ç„¡æ­¤å€é–“ç›´é”åˆ—è»Š âš ï¸</div>`;
            }
        }

        function appendCards(newTrains) {
            if (!newTrains || newTrains.length === 0) { const btn = document.getElementById('btnLoadNext'); if(btn) { btn.innerText = "å·²ç„¡æ›´å¤šç­æ¬¡"; btn.disabled = true; btn.style.border = "none"; } return; }
            const oldBtn = document.getElementById('btnLoadNext'); if(oldBtn) oldBtn.remove();
            let html = `<div style="text-align:center; padding:10px 0; color:#4d7f5e; font-size:0.8rem; font-weight:bold; border-top:1px dashed #333; margin-top:15px;">â¬‡ ${newTrains[0].dep_date} ç­æ¬¡ â¬‡</div>`;
            newTrains.forEach(t => { html += generateCardHTML(t); });
            html += `<button id="btnLoadNext" class="btn-load-next" onclick="loadNextDay()">â¬‡ è¼‰å…¥æ›´å¤šç­æ¬¡ (${currentNextDate})</button>`;
            list.insertAdjacentHTML('beforeend', html);
            if(currentTrainData) currentTrainData = currentTrainData.concat(newTrains);
        }

        function generateCardHTML(t) {
            const isDeparted = t.is_past; 
            const isArriving = !isDeparted && (t.sort_key - Date.now()/1000) < 600;
            let cardClass = "card"; if(isDeparted) cardClass += " departed-card";
            
            let badge = "";
            if(isDeparted) badge = `<div class="status-tag departed">å·²é§›é›¢</div>`;
            else if(t.delay > 0) badge = `<div class="status-tag delay">èª¤é» ${t.delay} åˆ†</div>`;

            let subTime = "";
            if(!t.is_past && t.delay === 0) subTime = `<span style="color:#4d7f5e; font-weight:bold;">â— æº–é»</span>`;
            else subTime = `åŸå®š ${formatTime(t.sch_dep)} â” ${formatTime(t.sch_arr)}`;

            return `<a href="https://railway.chienwen.net/taiwan/train/TRA-${t.no}/live" target="_blank" ${(!isDeparted)?'id="firstActive"':''}>
                <div class="${cardClass}" style="border-left-color:${t.color};">
                    ${isArriving ? '<div class="left-indicator"><div class="led-dot top"></div><div class="led-dot bottom"></div></div>' : ''}
                    <div class="status-badge-container">${badge}</div>
                    <div class="train-info" style="color:${isDeparted ? '#888' : t.color};">${t.type} ${t.no} æ¬¡</div>
                    <div class="main-time">
                        <div class="time-group"><div class="time-date-label" style="color:#4d7f5e;">${startStation.value}</div><div class="time-part">${formatTime(t.act_dep)}</div></div>
                        <span class="arrow">â”</span>
                        <div class="time-group"><div class="time-date-label" style="color:#4d7f5e;">${endStation.value}</div><div class="time-part">${formatTime(t.act_arr)}</div></div>
                    </div>
                    <div class="sub-time">${subTime}</div>
                </div>
            </a>`;
        }

        // --- Modal & Share ---
        function openModal(){document.getElementById('aboutModal').style.display='flex';goToPage('Menu');}
        function closeModal(){document.getElementById('aboutModal').style.display='none';}
        function goToPage(id){ document.querySelectorAll('.modal-page').forEach(p=>p.classList.remove('active')); document.getElementById('page'+id).classList.add('active'); 
            if(id==='Report') {
                const r = `ã€ç³»çµ±å ±å‘Šã€‘\næ™‚é–“: ${new Date().toLocaleString()}\nUA: ${navigator.userAgent}\nRoute: ${startStation.value}->${endStation.value}`;
                document.getElementById('reportContent').value = r;
            }
        }
        async function shareApp() { const data={title:'TRAIN LIVE',text:'èª¤é»è‡ªå‹•è¨ˆç®—ï¼',url:window.location.href}; if(navigator.share)try{await navigator.share(data)}catch(e){}else{try{await navigator.clipboard.writeText(window.location.href);alert('é€£çµå·²è¤‡è£½');}catch(e){}} }
        function copyReportOnly() { navigator.clipboard.writeText(document.getElementById('reportContent').value).then(()=>alert("å·²è¤‡è£½")); }
        function openMailClient() { window.location.href = `mailto:d96benjamin@gmail.com?subject=TRAIN LIVE Report&body=${encodeURIComponent(document.getElementById('reportContent').value)}`; }

        // --- Favorites ---
        function toggleFavorite() {
            const cur = { start: startStation.value, end: endStation.value }; if (!cur.start || !cur.end) return;
            let favs = JSON.parse(localStorage.getItem(LS_FAV) || "[]");
            const idx = favs.findIndex(f => f.start === cur.start && f.end === cur.end);
            if (idx >= 0) favs.splice(idx, 1); else { if (favs.length >= 6) { alert(`æœ€å¤š 6 çµ„`); return; } favs.unshift(cur); }
            localStorage.setItem(LS_FAV, JSON.stringify(favs)); updateStarState(); renderQuickRoutes();
        }
        function addToHistory() {
            const cur = { start: startStation.value, end: endStation.value }; if (!cur.start || !cur.end) return;
            let hist = JSON.parse(localStorage.getItem(LS_HIST) || "[]");
            hist = hist.filter(h => !(h.start === cur.start && h.end === cur.end));
            hist.unshift(cur); if (hist.length > 3) hist.pop();
            localStorage.setItem(LS_HIST, JSON.stringify(hist)); renderQuickRoutes();
        }
        function updateStarState() {
            const favs = JSON.parse(localStorage.getItem(LS_FAV) || "[]");
            const isFav = favs.some(f => f.start === startStation.value && f.end === endStation.value);
            btnStar.innerHTML = isFav ? 'â˜…<br>å·²æ”¶è—' : 'â˜† æ”¶è—<br>è·¯ç·š';
            btnStar.classList.toggle('fav-active', isFav);
        }
        function loadRoute(s, e) { setMenu('start', STATION_INDEX[s], s); setMenu('end', STATION_INDEX[e], e); markAsChanged(); doSearch(); }
        function renderQuickRoutes() {
            const favs = JSON.parse(localStorage.getItem(LS_FAV) || "[]");
            const hist = JSON.parse(localStorage.getItem(LS_HIST) || "[]");
            let html = '';
            favs.forEach(r => { html += `<div class="route-chip fav" onclick="loadRoute('${r.start}', '${r.end}')">${r.start}<span class="chip-arrow">â”</span>${r.end}</div>`; });
            hist.forEach(r => { if (!favs.some(f=>f.start===r.start&&f.end===r.end)) { html += `<div class="route-chip hist" onclick="loadRoute('${r.start}', '${r.end}')">${r.start}<span class="chip-arrow">â”</span>${r.end}</div>`; } });
            document.getElementById('quickRouteArea').innerHTML = html || '<div style="color:#666; font-size:0.8rem; padding:4px;">(å°šç„¡å¸¸ç”¨è·¯ç·š)</div>';
        }

        init();
    </script>
</body>
</html>