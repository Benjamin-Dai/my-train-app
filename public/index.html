<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åˆ—è»Šæ™‚åˆ» Live</title>
    <style>
        body { background: #000; color: #fff; font-family: -apple-system, sans-serif; padding: 10px; margin: 0; }
        .container { max-width: 500px; margin: 0 auto; padding-bottom: 80px; }

        /* é ‚éƒ¨å€åŸŸ */
        .header { margin-bottom: 15px; background: #151517; padding: 15px; border-radius: 12px; border: 1px solid #333;}
        .app-title { font-size: 0.8rem; color: #888; margin-bottom: 10px; text-align: center; letter-spacing: 1px; font-weight: bold;}
        
        /* æœå°‹æ¡† */
        .search-box { 
            width: 100%; box-sizing: border-box; background: #222; border: 1px solid #444; 
            color: #fff; padding: 8px 12px; border-radius: 8px; margin-bottom: 12px;
            font-size: 0.9rem; text-align: center;
        }
        .search-box:focus { border-color: #4d7f5e; outline: none; background: #000; }

        /* é¸æ“‡å™¨å€åŸŸ */
        .selector-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .selector-label { width: 35px; font-size: 0.8rem; color: #888; font-weight: bold; text-align: center;}
        
        .select-group { flex: 1; display: flex; gap: 5px; }
        /* ç¸£å¸‚é¸å–® (è¼ƒçª„) */
        .region-select { 
            flex: 2; background: #2c2c2e; color: #eee; border: 1px solid #444; 
            padding: 8px 4px; border-radius: 8px; font-size: 0.95rem; font-weight: bold;
            appearance: none; -webkit-appearance: none; text-align: center;
        }
        /* è»Šç«™é¸å–® (è¼ƒå¯¬) */
        .station-select { 
            flex: 3; background: #3a3a3c; color: #fff; border: 1px solid #555; 
            padding: 8px 4px; border-radius: 8px; font-size: 1rem; font-weight: bold;
            appearance: none; -webkit-appearance: none; text-align: center;
        }

        .swap-container { display: flex; justify-content: center; margin: -4px 0 4px 0; }
        .swap-btn { font-size: 1.2rem; color: #666; background: none; border: none; padding: 0 10px; cursor: pointer; transform: rotate(90deg); }

        /* æ§åˆ¶åˆ— */
        .controls { display: flex; flex-direction: column; align-items: flex-end; margin-bottom: 10px; gap: 5px; margin-top: 15px;}
        .controls-row { display: flex; align-items: center; gap: 10px; }
        .status-text { font-size: 0.75rem; color: #888; text-align: right;}
        
        .refresh-btn {
            background: #4d7f5e; color: white; border: none; padding: 6px 16px; 
            border-radius: 20px; font-size: 0.85rem; font-weight: 600; cursor: pointer;
            transition: opacity 0.2s;
        }
        .refresh-btn:disabled { background: #333; color: #888; cursor: not-allowed; }
        
        /* å¡ç‰‡æ¨£å¼ */
        .card { background: #151517; border-radius: 12px; padding: 12px 16px; margin-bottom: 10px; border-left: 5px solid #333; position: relative; }
        .delay-badge { position: absolute; top: 12px; right: 16px; border: 1px solid hsl(40, 100%, 50%); color: hsl(40, 100%, 50%); padding: 1px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: 600; }
        .train-info { font-size: 0.9rem; font-weight: 700; margin-bottom: 4px; }
        .main-time { display: flex; align-items: center; justify-content: center; font-size: 1.8rem; font-weight: 700; padding: 6px 0; }
        .arrow { margin: 0 12px; color: #666; font-size: 0.8rem; }
        .sub-time { text-align: center; color: #888; font-size: 0.75rem; }
        a { text-decoration: none; color: inherit; -webkit-tap-highlight-color: transparent; }

        .message { text-align: center; padding: 40px; color: #666; font-size: 0.9rem; }
        .loading { color: #4d7f5e; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="app-title">TRAIN LIVE V3</div>
            
            <input type="text" id="searchInput" class="search-box" placeholder="ğŸ” è¼¸å…¥è»Šç«™ (å¦‚: è‡ºåŒ—, Zuoying)" oninput="handleSearch()">

            <div class="selector-row">
                <div class="selector-label">èµ·é»</div>
                <div class="select-group">
                    <select id="startRegion" class="region-select" onchange="updateStationList('start')"></select>
                    <select id="startStation" class="station-select" onchange="handleStationChange()"></select>
                </div>
            </div>

            <div class="swap-container">
                <button class="swap-btn" onclick="swapStations()">â‡„</button>
            </div>

            <div class="selector-row">
                <div class="selector-label">çµ‚é»</div>
                <div class="select-group">
                    <select id="endRegion" class="region-select" onchange="updateStationList('end')"></select>
                    <select id="endStation" class="station-select" onchange="handleStationChange()"></select>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="controls-row">
                <span id="statusText" class="status-text">æº–å‚™å°±ç·’</span>
                <button id="refreshBtn" class="refresh-btn" onclick="manualRefresh()">æ›´æ–°</button>
            </div>
        </div>

        <div id="cardList"></div>
    </div>

    <script>
        // ================= è³‡æ–™çµæ§‹å€ =================
        const STATION_DATA = {
            "åŸºéš†/æ–°åŒ—": ["åŸºéš†","ä¸‰å‘","å…«å µ","ä¸ƒå µ","ç™¾ç¦","äº”å µ","æ±æ­¢","æ±ç§‘","æ¿æ©‹","æµ®æ´²","æ¨¹æ—","å—æ¨¹æ—","å±±ä½³","é¶¯æ­Œ","ç¦éš†","è²¢å¯®","é›™æºª","ç‰¡ä¸¹","ä¸‰è²‚å¶º","å¤§è¯","ååˆ†","æœ›å¤","å¶ºè…³","å¹³æºª","èæ¡","ä¾¯ç¡","ç‘èŠ³","æµ·ç§‘é¤¨","å…«æ–—å­","æš–æš–"],
            "è‡ºåŒ—å¸‚": ["å—æ¸¯","æ¾å±±","è‡ºåŒ—","è¬è¯"],
            "æ¡ƒåœ’å¸‚": ["æ¡ƒåœ’","å…§å£¢","ä¸­å£¢","åŸ”å¿ƒ","æ¥Šæ¢…","å¯Œå²¡","æ–°å¯Œ"],
            "æ–°ç«¹ç¸£å¸‚": ["åŒ—æ¹–","æ¹–å£","æ–°è±","ç«¹åŒ—","åŒ—æ–°ç«¹","æ–°ç«¹","ä¸‰å§“æ©‹","é¦™å±±","å…­å®¶","ç«¹ä¸­","ä¸Šå“¡","æ¦®è¯","ç«¹æ±","æ©«å±±","ä¹è®šé ­","åˆèˆˆ","å¯Œè²´","å…§ç£"],
            "è‹—æ —ç¸£": ["å´é ‚","ç«¹å—","é€ æ©‹","è±å¯Œ","è‹—æ —","å—å‹¢","éŠ…é‘¼","ä¸‰ç¾©","è«‡æ–‡","å¤§å±±","å¾Œé¾","é¾æ¸¯","ç™½æ²™å±¯","æ–°åŸ”","é€šéœ„","è‹‘è£¡"],
            "è‡ºä¸­å¸‚": ["æ³°å®‰","åé‡Œ","è±åŸ","æ —æ—","æ½­å­","é ­å®¶å","æ¾ç«¹","å¤ªåŸ","ç²¾æ­¦","è‡ºä¸­","äº”æ¬Š","å¤§æ…¶","çƒæ—¥","æ–°çƒæ—¥","æˆåŠŸ","æ—¥å—","å¤§ç”²","è‡ºä¸­æ¸¯","æ¸…æ°´","æ²™é¹¿","é¾äº•","å¤§è‚š","è¿½åˆ†"],
            "å½°åŒ–ç¸£": ["å½°åŒ–","èŠ±å£‡","å¤§æ‘","å“¡æ—","æ°¸é–","ç¤¾é ­","ç”°ä¸­","äºŒæ°´","æºæ³‰","æ¿æ°´","é¾æ³‰","é›†é›†","æ°´é‡Œ","è»ŠåŸ•"],
            "é›²æ—ç¸£": ["æ—å…§","çŸ³æ¦´","æ–—å…­","æ–—å—","çŸ³é¾œ"],
            "å˜‰ç¾©ç¸£å¸‚": ["å¤§æ—","æ°‘é›„","å˜‰åŒ—","å˜‰ç¾©","æ°´ä¸Š","å—é–"],
            "è‡ºå—å¸‚": ["å¾Œå£","æ–°ç‡Ÿ","æŸ³ç‡Ÿ","æ—é³³ç‡Ÿ","éš†ç”°","æ‹”æ—","å–„åŒ–","å—ç§‘","æ–°å¸‚","æ°¸åº·","å¤§æ©‹","è‡ºå—","ä¿å®‰","ä»å¾·","ä¸­æ´²","å¤§æ¹–","æ²™å´™"],
            "é«˜é›„å¸‚": ["è·¯ç«¹","å²¡å±±","æ©‹é ­","æ¥ æ¢“","æ–°å·¦ç‡Ÿ","å·¦ç‡Ÿ","å…§æƒŸ","ç¾è¡“é¤¨","é¼“å±±","ä¸‰å¡Šå","é«˜é›„","æ°‘æ—","ç§‘å·¥é¤¨","æ­£ç¾©","é³³å±±","å¾Œåº„","ä¹æ›²å ‚"],
            "å±æ±ç¸£": ["å…­å¡Šå","å±æ±","æ­¸ä¾†","éºŸæ´›","è¥¿å‹¢","ç«¹ç”°","æ½®å·","å´é ‚","å—å·","é®å®‰","æ—é‚Š","ä½³å†¬","æ±æµ·","æ‹å¯®","åŠ ç¥¿","å…§ç…","æ‹å±±"],
            "å®œè˜­ç¸£": ["æ¼¢æœ¬","æ­¦å¡”","å—æ¾³","æ±æ¾³","æ°¸æ¨‚","è˜‡æ¾³","è˜‡æ¾³æ–°","å†¬å±±","ç¾…æ±","ä¸­é‡Œ","äºŒçµ","å®œè˜­","å››åŸ","ç¤æºª","é ‚åŸ”","é ­åŸ","å¤–æ¾³","é¾œå±±","å¤§æºª","å¤§é‡Œ","çŸ³åŸ"],
            "èŠ±è“®ç¸£": ["å’Œå¹³","å’Œä»","å´‡å¾·","æ–°åŸ","æ™¯ç¾","åŒ—åŸ”","èŠ±è“®","å‰å®‰","å¿—å­¸","å¹³å’Œ","å£½è±","è±ç”°","æ—æ¦®æ–°å…‰","å—å¹³","é³³æ—","è¬æ¦®","å…‰å¾©","å¤§å¯Œ","å¯Œæº","ç‘ç©—","ä¸‰æ°‘","ç‰é‡Œ","æ±é‡Œ","æ±ç«¹","å¯Œé‡Œ"],
            "è‡ºæ±ç¸£": ["æ± ä¸Š","æµ·ç«¯","é—œå±±","ç‘å’Œ","ç‘æº","é¹¿é‡","å±±é‡Œ","è‡ºæ±","åº·æ¨‚","çŸ¥æœ¬","å¤ªéº»é‡Œ","é‡‘å´™","ç€§æºª","å¤§æ­¦"]
        };

        const STATION_INDEX = {};
        Object.keys(STATION_DATA).forEach(region => {
            STATION_DATA[region].forEach(station => {
                STATION_INDEX[station] = region;
            });
        });

        // ================= è¨­å®šå€ =================
        const CACHE_PREFIX = "train_data_v2_"; 
        const PREF_START_R_KEY = "pref_start_region";
        const PREF_START_S_KEY = "pref_start_station";
        const PREF_END_R_KEY = "pref_end_region";
        const PREF_END_S_KEY = "pref_end_station";
        
        const MINUTE = 60 * 1000;
        const HOUR = 60 * MINUTE;
        // =========================================

        const startRegion = document.getElementById('startRegion');
        const startStation = document.getElementById('startStation');
        const endRegion = document.getElementById('endRegion');
        const endStation = document.getElementById('endStation');
        const searchInput = document.getElementById('searchInput');

        const btn = document.getElementById('refreshBtn');
        const statusText = document.getElementById('statusText');
        const list = document.getElementById('cardList');
        
        let cooldownTimer = null;
        let autoUpdateTimer = null;
        let lastActiveTime = Date.now();
        let nextFetchTime = 0;

        function init() {
            const regions = Object.keys(STATION_DATA);
            const regionOptions = regions.map(r => `<option value="${r}">${r}</option>`).join('');
            startRegion.innerHTML = regionOptions;
            endRegion.innerHTML = regionOptions;

            const savedStartR = localStorage.getItem(PREF_START_R_KEY) || "å±æ±ç¸£";
            const savedStartS = localStorage.getItem(PREF_START_S_KEY) || "å±æ±";
            const savedEndR = localStorage.getItem(PREF_END_R_KEY) || "å±æ±ç¸£";
            const savedEndS = localStorage.getItem(PREF_END_S_KEY) || "æ½®å·";

            setMenu('start', savedStartR, savedStartS);
            setMenu('end', savedEndR, savedEndS);

            checkButtonCooldown();
            document.addEventListener("visibilitychange", handleVisibilityChange);

            loadDataOrFetch();
        }

        function setMenu(type, regionVal, stationVal) {
            const rSelect = type === 'start' ? startRegion : endRegion;
            const sSelect = type === 'start' ? startStation : endStation;

            if (!STATION_DATA[regionVal]) regionVal = "å±æ±ç¸£";
            rSelect.value = regionVal;
            
            const stations = STATION_DATA[regionVal];
            sSelect.innerHTML = stations.map(s => `<option value="${s}">${s}</option>`).join('');
            
            if (stations.includes(stationVal)) {
                sSelect.value = stationVal;
            } else {
                sSelect.selectedIndex = 0;
            }
        }

        function updateStationList(type) {
            const rSelect = type === 'start' ? startRegion : endRegion;
            const sSelect = type === 'start' ? startStation : endStation;
            
            const region = rSelect.value;
            const stations = STATION_DATA[region];
            
            sSelect.innerHTML = stations.map(s => `<option value="${s}">${s}</option>`).join('');
            sSelect.selectedIndex = 0;
            
            handleStationChange(); 
        }

        function swapStations() {
            const sR = startRegion.value;
            const sS = startStation.value;
            const eR = endRegion.value;
            const eS = endStation.value;

            setMenu('start', eR, eS);
            setMenu('end', sR, sS);

            handleStationChange();
        }

        function handleSearch() {
            const input = searchInput.value.trim();
            if (!input) return;
            
            let found = null;
            if (STATION_INDEX[input]) {
                found = input;
            } else {
                const allStations = Object.keys(STATION_INDEX);
                found = allStations.find(s => s.includes(input));
            }

            if (found) {
                const region = STATION_INDEX[found];
                setMenu('start', region, found);
                handleStationChange();
                searchInput.style.borderColor = "#4d7f5e";
                setTimeout(() => searchInput.style.borderColor = "#444", 500);
            }
        }

        function handleStationChange() {
            localStorage.setItem(PREF_START_R_KEY, startRegion.value);
            localStorage.setItem(PREF_START_S_KEY, startStation.value);
            localStorage.setItem(PREF_END_R_KEY, endRegion.value);
            localStorage.setItem(PREF_END_S_KEY, endStation.value);
            
            lastActiveTime = Date.now();
            list.innerHTML = ""; 
            statusText.innerText = "åˆ‡æ›è·¯ç·šä¸­...";
            fetchData();
        }

        function getCacheKey() {
            return `${CACHE_PREFIX}${startStation.value}_${endStation.value}`;
        }

        function loadDataOrFetch() {
            const key = getCacheKey();
            const cached = localStorage.getItem(key);
            let hasCache = false;

            if (cached) {
                const data = JSON.parse(cached);
                const now = Date.now();
                if (now - data.timestamp < 60 * 1000) {
                    console.log("ä½¿ç”¨ LocalStorage å¿«å–");
                    renderCards(data.payload);
                    statusText.innerText = `æ›´æ–°æ–¼(å¿«å–): ${data.payload.update_time}`;
                    hasCache = true;
                }
            }

            if (!hasCache) {
                fetchData();
            } else {
                scheduleNextAutoRefresh();
            }
        }

        async function fetchData() {
            btn.disabled = true;
            statusText.innerText = "æ›´æ–°ä¸­...";
            
            if (!list.hasChildNodes()) {
                 list.innerHTML = '<div class="message loading">æ­£åœ¨é€£ç·š TDX...</div>';
            }

            const s = startStation.value;
            const e = endStation.value;
            const url = `/api/index?start=${s}&end=${e}`;

            try {
                const res = await fetch(url);
                const json = await res.json();

                if (json.error) throw new Error(json.error);

                const cacheObj = { timestamp: Date.now(), payload: json };
                localStorage.setItem(getCacheKey(), JSON.stringify(cacheObj));

                renderCards(json);
                statusText.innerText = `æ›´æ–°æ–¼ ${json.update_time}`;
                setButtonCooldown(60); 

            } catch (err) {
                console.error(err);
                statusText.innerText = "æ›´æ–°å¤±æ•—";
                list.innerHTML = `<div class="message">ç™¼ç”ŸéŒ¯èª¤ï¼š${err.message}<br>è«‹ç¨å¾Œå†è©¦</div>`;
                btn.disabled = false;
            } finally {
                scheduleNextAutoRefresh();
            }
        }

        function manualRefresh() { 
            lastActiveTime = Date.now();
            fetchData(); 
        }

        // --- æ ¸å¿ƒæ›´æ–°é‚è¼¯ (ä¸é¡¯ç¤ºå€’æ•¸æ–‡å­—) ---
        function scheduleNextAutoRefresh() {
            if (autoUpdateTimer) clearInterval(autoUpdateTimer);

            const now = Date.now();
            const idleTime = now - lastActiveTime;
            let interval = 0;

            if (idleTime < 15 * MINUTE) interval = 5 * MINUTE;
            else if (idleTime < 60 * MINUTE) interval = 15 * MINUTE;
            else if (idleTime < 2 * HOUR) interval = 30 * MINUTE;
            else interval = -1;

            if (interval === -1) {
                statusText.innerText = "è‡ªå‹•æ›´æ–°å·²æš«åœ (é–’ç½®)";
                return;
            }

            nextFetchTime = now + interval;
            autoUpdateTimer = setInterval(tickAutoUpdate, 1000);
            // ä¸å†åŸ·è¡Œ tickAutoUpdate æ›´æ–° UIï¼Œåªåœ¨å¾Œå°è·‘
        }

        function tickAutoUpdate() {
            if (document.hidden) return;
            const now = Date.now();
            const remain = Math.ceil((nextFetchTime - now) / 1000);

            if (remain <= 0) {
                clearInterval(autoUpdateTimer);
                if (btn.disabled && btn.innerText.includes("s")) {
                    nextFetchTime = now + 10000;
                    autoUpdateTimer = setInterval(tickAutoUpdate, 1000);
                    return;
                }
                fetchData();
            }
        }

        function handleVisibilityChange() {
            if (!document.hidden && nextFetchTime > 0 && Date.now() > nextFetchTime) {
                fetchData();
            }
        }

        const COOLDOWN_KEY = "next_refresh_time";
        function setButtonCooldown(seconds) {
            const nextTime = Date.now() + (seconds * 1000);
            localStorage.setItem(COOLDOWN_KEY, nextTime);
            checkButtonCooldown();
        }

        function checkButtonCooldown() {
            const nextTime = localStorage.getItem(COOLDOWN_KEY);
            if (!nextTime) return;
            const remain = Math.ceil((parseInt(nextTime) - Date.now()) / 1000);
            if (remain > 0) startButtonTimer(remain);
            else {
                localStorage.removeItem(COOLDOWN_KEY);
                btn.disabled = false;
                btn.innerText = "æ›´æ–°";
            }
        }

        function startButtonTimer(sec) {
            if (cooldownTimer) clearInterval(cooldownTimer);
            btn.disabled = true;
            btn.innerText = `${sec}s`;
            cooldownTimer = setInterval(() => {
                sec--;
                btn.innerText = `${sec}s`;
                if (sec <= 0) {
                    clearInterval(cooldownTimer);
                    btn.disabled = false;
                    btn.innerText = "æ›´æ–°";
                    localStorage.removeItem(COOLDOWN_KEY);
                }
            }, 1000);
        }

        function renderCards(data) {
            if (!data.trains || data.trains.length === 0) {
                list.innerHTML = '<div class="message">ç›®å‰ç„¡ç¬¦åˆç­æ¬¡</div>';
                return;
            }
            let html = "";
            data.trains.forEach(t => {
                const delayTag = t.delay > 0 ? `<div class="delay-badge">èª¤é» ${t.delay} åˆ†</div>` : "";
                const trainUrl = `https://railway.chienwen.net/taiwan/train/TRA-${t.no}/live`;
                html += `
                <a href="${trainUrl}" target="_blank">
                    <div class="card" style="border-left-color: ${t.color};">
                        ${delayTag}
                        <div class="train-info" style="color: ${t.color};">${t.type} ${t.no} æ¬¡</div>
                        <div class="main-time"><span>${t.act_dep}</span><span class="arrow">â”</span><span>${t.act_arr}</span></div>
                        <div class="sub-time">åŸå®š ${t.sch_dep} â” ${t.sch_arr}</div>
                    </div>
                </a>`;
            });
            list.innerHTML = html;
        }

        init();
    </script>
</body>
</html>
