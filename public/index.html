<!DOCTYPE html>
<html lang="zh-TW" prefix="og: http://ogp.me/ns#">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
Â  Â  <title>TRAIN LIVE | åˆ—è»Šæ™‚åˆ»å³æ™‚çœ‹æ¿</title>
Â  Â  <meta name="description" content="ä¸åªæ˜¯èª¤é»å¹¾åˆ†é˜ï¼Œç›´æ¥å‘Šè¨´ä½ å¯¦éš›å¹¾é»åˆ°ã€‚å°ˆç‚ºé€šå‹¤æ—è¨­è¨ˆçš„æ¥µç°¡ã€å³æ™‚ç«è»Šæ™‚åˆ»è¡¨ Web Appã€‚">

Â  Â  <link rel="manifest" href="/manifest.json">
Â  Â  <meta name="theme-color" content="#151517">
Â  Â  <link rel="apple-touch-icon" href="/icon.png">
Â  Â  <link rel="icon" type="image/png" href="/icon.png">

Â  Â  <style>
Â  Â  Â  Â  /* é˜²æ­¢å¯¬åº¦è¨ˆç®—è¶…å‡ºè¢å¹• */
Â  Â  Â  Â  *, *::before, *::after { box-sizing: border-box; }

Â  Â  Â  Â  /* å¹³æ»‘æ²å‹• */
Â  Â  Â  Â  html { scroll-behavior: smooth; }

Â  Â  Â  Â  body { background: #000; color: #fff; font-family: -apple-system, sans-serif; padding: 10px; margin: 0; }
Â  Â  Â  Â  .container { max-width: 500px; margin: 0 auto; padding-bottom: 80px; position: relative; }

Â  Â  Â  Â  /* Header åŸºç¤æ¨£å¼ */
Â  Â  Â  Â  .header { margin-bottom: 15px; background: #151517; border-radius: 12px; border: 1px solid #333; position: relative; overflow: visible; }

Â  Â  Â  Â  /* å€å¡Š A: éœæ…‹å€ */
Â  Â  Â  Â  .header-static-part {
Â  Â  Â  Â  Â  Â  padding: 15px 15px 5px 15px;Â 
Â  Â  Â  Â  Â  Â  background: #151517;
Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  Â  Â  z-index: 10;
Â  Â  Â  Â  Â  Â  border-top-left-radius: 12px;
Â  Â  Â  Â  Â  Â  border-top-right-radius: 12px;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* å€å¡Š B: æ‡¸æµ®å€ */
Â  Â  Â  Â  .header-sticky-part {
Â  Â  Â  Â  Â  Â  padding: 5px 15px 10px 15px;
Â  Â  Â  Â  Â  Â  background: #151517;Â 
Â  Â  Â  Â  Â  Â  border-bottom-left-radius: 12px;
Â  Â  Â  Â  Â  Â  border-bottom-right-radius: 12px;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  z-index: 100;
Â  Â  Â  Â  Â  Â  position: relative; /* é è¨­éœæ…‹ */
Â  Â  Â  Â  Â  Â  will-change: transform;Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  /* ç‹€æ…‹äºŒï¼šæ‡¸æµ®æ¨¡å¼ (Fixed) */
Â  Â  Â  Â  .header-sticky-part.is-fixed {
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  top: 0;Â 
Â  Â  Â  Â  Â  Â  /* å¯¬åº¦è¨ˆç®—ï¼š100% - Body Padding(20px) */
Â  Â  Â  Â  Â  Â  width: calc(100% - 20px);Â 
Â  Â  Â  Â  Â  Â  max-width: 500px;Â 
Â  Â  Â  Â  Â  Â  left: 50%;Â 
Â  Â  Â  Â  Â  Â  /* æ³¨æ„ï¼štransform ç”± JS æ§åˆ¶ï¼Œé€™è£¡åªè¨­åˆå§‹å€¼ */
Â  Â  Â  Â  Â  Â  transform: translateX(-50%);Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  border-radius: 0 0 12px 12px;Â 
Â  Â  Â  Â  Â  Â  border: 1px solid #333;
Â  Â  Â  Â  Â  Â  border-top: none;
Â  Â  Â  Â  Â  Â  box-shadow: 0 10px 30px rgba(0,0,0,0.9);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  padding-top: 10px;Â 
Â  Â  Â  Â  Â  Â  padding-bottom: 8px;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* æ‡¸æµ®æ™‚ï¼šéš±è—å¤§æŒ‰éˆ•å€ */
Â  Â  Â  Â  .header-sticky-part.is-fixed .action-area { display: none; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* æ‡¸æµ®æ™‚ï¼šé¡¯ç¤ºæ•´åˆç‰ˆæ›´æ–°éˆ• */
Â  Â  Â  Â  .btn-refresh-sticky-wrapper { display: none; flex: 0 0 auto; min-width: 80px; }
Â  Â  Â  Â  .header-sticky-part.is-fixed .btn-refresh-sticky-wrapper { display: block; }

Â  Â  Â  Â  .header-sticky-part.is-fixed .click-hint { margin-top: 6px; padding-top: 6px; }

Â  Â  Â  Â  /* ä½”ä½ç¬¦ */
Â  Â  Â  Â  #stickyPlaceholder { display: none; }

Â  Â  Â  Â  /* æç¤ºå€å¡Š */
Â  Â  Â  Â  .click-hint {
Â  Â  Â  Â  Â  Â  display: flex; flex-direction: row; align-items: center; justify-content: center;
Â  Â  Â  Â  Â  Â  gap: 12px; padding: 10px 0 0 0; color: #888; font-size: 0.8rem;
Â  Â  Â  Â  Â  Â  border-top: 1px solid #2c2c2e; margin-top: 10px;
Â  Â  Â  Â  Â  Â  opacity: 0; transition: opacity 0.3s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .click-hint.visible { opacity: 1; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .hint-text-group { display: flex; flex-direction: column; align-items: flex-end; line-height: 1.2; }
Â  Â  Â  Â  .hint-text-group.only-text { align-items: center; }

Â  Â  Â  Â  .hint-text { color: #4d7f5e; font-weight: bold; font-size: 0.85rem; }
Â  Â  Â  Â  .click-hint-sub { font-size: 0.75rem; opacity: 0.8; font-weight: normal; color: #888; }

Â  Â  Â  Â  .hint-divider { width: 1px; height: 20px; background: #444; }

Â  Â  Â  Â  .legend-row {
Â  Â  Â  Â  Â  Â  display: flex; align-items: center; gap: 6px;
Â  Â  Â  Â  Â  Â  background: rgba(255, 255, 255, 0.05); padding: 3px 8px;
Â  Â  Â  Â  Â  Â  border-radius: 12px; font-size: 0.75rem; color: #ccc;
Â  Â  Â  Â  Â  Â  /* ç§»é™¤ animation é¿å…é‡ç¹ªé–ƒçˆ */
Â  Â  Â  Â  }
Â  Â  Â  Â  .legend-icon { display: flex; flex-direction: column; gap: 4px; }Â 

Â  Â  Â  Â  /* Back to Top */
Â  Â  Â  Â  .back-to-top {
Â  Â  Â  Â  Â  Â  position: fixed; bottom: 25px; right: 25px;
Â  Â  Â  Â  Â  Â  width: 50px; height: 50px; background: #4d7f5e; color: #fff;
Â  Â  Â  Â  Â  Â  border-radius: 50%; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
Â  Â  Â  Â  Â  Â  font-size: 1.5rem; display: flex; align-items: center; justify-content: center;
Â  Â  Â  Â  Â  Â  cursor: pointer; z-index: 90; opacity: 0;
Â  Â  Â  Â  Â  Â  transform: translateY(20px); transition: all 0.3s ease; pointer-events: none;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .back-to-top.visible { opacity: 1; transform: translateY(0); pointer-events: auto; }
Â  Â  Â  Â  .back-to-top:active { transform: scale(0.9); background: #3d664b; }

Â  Â  Â  Â  .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; min-height: 36px; }
Â  Â  Â  Â  .app-title { font-size: 1rem; color: #888; letter-spacing: 1px; font-weight: 800; margin: 0; flex: 1; }

Â  Â  Â  Â  .install-btn-top {
Â  Â  Â  Â  Â  Â  background: #4d7f5e; color: #fff; border: none; padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; cursor: pointer; display: none; align-items: center; gap: 4px; margin-right: 8px; animation: fadeIn 0.5s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .install-btn-top:active { transform: scale(0.95); background: #3d664b; }

Â  Â  Â  Â  @keyframes pulse-white-gold {
Â  Â  Â  Â  Â  Â  0%, 100% { color: #fff; border-color: #444; }
Â  Â  Â  Â  Â  Â  50% { color: hsl(40, 100%, 50%); border-color: hsl(40, 100%, 50%); }
Â  Â  Â  Â  }
Â  Â  Â  Â  .anim-gold-pulse { animation: pulse-white-gold 3s infinite ease-in-out !important; border-width: 1px; border-style: solid; }

Â  Â  Â  Â  .menu-btn-trigger { background: #2c2c2e; border: 1px solid #444; color: #fff; width: 36px; height: 36px; border-radius: 8px; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
Â  Â  Â  Â  .menu-btn-trigger:active { transform: scale(0.95); background: #3a3a3c; }

Â  Â  Â  Â  .search-row { display: flex; gap: 8px; margin-bottom: 12px; width: 100%; }
Â  Â  Â  Â  .search-target { flex: 1; min-width: 0; background: #222; border: 1px solid #444; color: #ccc; border-radius: 8px; font-size: 0.85rem; padding-left: 5px; }
Â  Â  Â  Â  .search-box { flex: 2.5; min-width: 0; background: #222; border: 1px solid #444; color: #fff; padding: 8px 10px; border-radius: 8px; font-size: 0.9rem; }
Â  Â  Â  Â  .search-box:focus { border-color: #4d7f5e; outline: none; background: #000; }

Â  Â  Â  Â  .selector-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
Â  Â  Â  Â  .selector-label { width: 35px; font-size: 0.8rem; color: #888; font-weight: bold; text-align: center;}
Â  Â  Â  Â  .select-group { flex: 1; display: flex; gap: 5px; }
Â  Â  Â  Â  .region-select { flex: 2; background: #2c2c2e; color: #eee; border: 1px solid #444; padding: 8px 4px; border-radius: 8px; font-size: 0.95rem; font-weight: bold; text-align: center; }
Â  Â  Â  Â  .station-select { flex: 3; background: #3a3a3c; color: #fff; border: 1px solid #555; padding: 8px 4px; border-radius: 8px; font-size: 1rem; font-weight: bold; text-align: center; }
Â  Â  Â  Â  .swap-container { display: flex; justify-content: center; margin: -4px 0 4px 0; }
Â  Â  Â  Â  .swap-btn { font-size: 1.2rem; color: #666; background: none; border: none; padding: 0 10px; cursor: pointer; transform: rotate(90deg); }

Â  Â  Â  Â  /* æ©«å‘æ²å‹• Chips */
Â  Â  Â  Â  .quick-route-area {Â 
Â  Â  Â  Â  Â  Â  margin: 5px 0 10px 0;Â 
Â  Â  Â  Â  Â  Â  display: flex; flex-wrap: nowrap; gap: 8px;Â 
Â  Â  Â  Â  Â  Â  min-height: 0; overflow-x: auto; -webkit-overflow-scrolling: touch;
Â  Â  Â  Â  Â  Â  padding-right: 20px; scrollbar-width: none;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .quick-route-area::-webkit-scrollbar { display: none; }

Â  Â  Â  Â  .route-chip {Â 
Â  Â  Â  Â  Â  Â  display: inline-flex; align-items: center; background: #222; border: 1px solid #444; color: #bbb;Â 
Â  Â  Â  Â  Â  Â  padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; transition: all 0.2s;Â 
Â  Â  Â  Â  Â  Â  user-select: none; white-space: nowrap; flex: 0 0 auto;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .route-chip:active { transform: scale(0.95); background: #333; }
Â  Â  Â  Â  .route-chip .chip-arrow { margin: 0 5px; color: #666; font-size: 0.7rem; }
Â  Â  Â  Â  .route-chip.fav { border-color: #4d7f5e; color: #4d7f5e; background: rgba(77, 127, 94, 0.1); font-weight: bold; }
Â  Â  Â  Â  .route-chip.hist { border-style: dashed; }

Â  Â  Â  Â  .action-area { margin-top: 5px; display: flex; gap: 8px; }
Â  Â  Â  Â  .btn { border: none; padding: 10px; border-radius: 10px; font-size: 0.95rem; font-weight: bold; cursor: pointer; flex: 1; display: flex; justify-content: center; align-items: center; }
Â  Â  Â  Â  .btn:active { transform: scale(0.98); }
Â  Â  Â  Â  .btn:disabled { background: #333 !important; color: #888 !important; border-color: #333 !important; cursor: not-allowed; }
Â  Â  Â  Â  .btn-search { flex: 2; background: #fff; color: #000; }
Â  Â  Â  Â  .btn-refresh { flex: 1; background: #4d7f5e; color: white; }
Â  Â  Â  Â  .btn.error { background: #d32f2f !important; color: white !important; }

Â  Â  Â  Â  /* å·¥å…·åˆ—æ©«å‘æ²å‹•è¨­å®š */
Â  Â  Â  Â  .view-toolbar {Â 
Â  Â  Â  Â  Â  Â  display: flex; gap: 8px; margin-top: 12px; border-top: 1px solid #333; padding-top: 12px;Â 
Â  Â  Â  Â  Â  Â  overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; scrollbar-width: none;
Â  Â  Â  Â  }
Â  Â  Â  Â  .view-toolbar::-webkit-scrollbar { display: none; }

Â  Â  Â  Â  .toggle-btn {Â 
Â  Â  Â  Â  Â  Â  flex: 0 0 auto; /* ç¦æ­¢å£“ç¸® */
Â  Â  Â  Â  Â  Â  background: #222; border: 1px solid #444; color: #888;Â 
Â  Â  Â  Â  Â  Â  padding: 8px 12px; border-radius: 8px; font-size: 0.8rem; cursor: pointer;Â 
Â  Â  Â  Â  Â  Â  display: flex; align-items: center; justify-content: center; gap: 4px; transition: all 0.2s;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .toggle-btn.active { background: rgba(77, 127, 94, 0.15); color: #4d7f5e; border-color: #4d7f5e; font-weight: bold; }
Â  Â  Â  Â  .toggle-btn.fav-active { background: rgba(230, 184, 0, 0.15); color: #e6b800; border-color: #e6b800; font-weight: bold; }
Â  Â  Â  Â  .toggle-btn:active { transform: scale(0.98); }
Â  Â  Â  Â  .toggle-icon { font-size: 1rem; line-height: 1; }

Â  Â  Â  Â  .btn-sticky-refresh {
Â  Â  Â  Â  Â  Â  width: 100%; height: 100%; background: #4d7f5e; color: #fff;
Â  Â  Â  Â  Â  Â  border: 1px solid #4d7f5e; padding: 8px 12px; border-radius: 8px; font-size: 0.8rem; cursor: pointer;
Â  Â  Â  Â  Â  Â  display: flex; align-items: center; justify-content: center; gap: 4px; transition: all 0.2s; font-weight: bold; white-space: nowrap;
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-sticky-refresh:disabled { background: #333 !important; color: #888 !important; border-color: #333 !important; cursor: not-allowed; }
Â  Â  Â  Â  .btn-sticky-refresh:active { transform: scale(0.98); }

Â  Â  Â  Â  .status-container { text-align: center; margin-top: 8px; display: flex; flex-direction: column; gap: 2px; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .status-msg { display: none; font-size: 0.85rem; font-weight: bold; color: #aaa; margin-bottom: 2px; }
Â  Â  Â  Â  .status-msg.alert { display: block; color: #ff4d4d; animation: fadeIn 0.5s; }Â 
Â  Â  Â  Â  .status-msg.warning { display: block; color: #e6b800; animation: fadeIn 0.5s; }Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  .update-time { font-size: 0.7rem; color: #555; font-family: monospace; min-height: 1em; }

Â  Â  Â  Â  .card { background: #151517; border-radius: 12px; padding: 12px 16px 12px 30px; margin-bottom: 10px; border-left: 5px solid #333; position: relative; transition: transform 0.1s, opacity 0.5s; }
Â  Â  Â  Â  a { display: block; text-decoration: none; color: inherit; -webkit-tap-highlight-color: transparent; }
Â  Â  Â  Â  .card:active { transform: scale(0.98); background-color: #222; }

Â  Â  Â  Â  .train-info { font-size: 0.9rem; font-weight: 700; margin-bottom: 4px; }

Â  Â  Â  Â  .main-time { display: flex; align-items: center; justify-content: center; padding: 6px 0; gap: 6px; flex-wrap: nowrap; }
Â  Â  Â  Â  .time-group { display: flex; flex-direction: column; align-items: center; }
Â  Â  Â  Â  .time-date-label { font-size: 0.65rem; color: #888; margin-bottom: 2px; font-family: monospace; letter-spacing: 0.5px;}

Â  Â  Â  Â  .time-part {Â 
Â  Â  Â  Â  Â  Â  font-size: 1.8rem; font-weight: 700; line-height: 1; white-space: nowrap; display: flex; align-items: baseline;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .ampm {Â 
Â  Â  Â  Â  Â  Â  font-size: 1rem; margin-right: 3px; color: #aaa; font-weight: normal;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .arrow { font-size: 0.8rem; color: #666; margin-top: 10px; flex-shrink: 0;}Â 

Â  Â  Â  Â  @media (max-width: 360px) { .time-part { font-size: 1.5rem; } .ampm { font-size: 0.85rem; } }

Â  Â  Â  Â  .sub-time { text-align: center; color: #888; font-size: 0.75rem; }
Â  Â  Â  Â  .card.past { opacity: 0.5; filter: grayscale(0.8); }
Â  Â  Â  Â  .card.past::after { content: 'å·²é§›é›¢'; position: absolute; bottom: 10px; right: 10px; font-size: 0.7rem; color: #fff; background: #333; padding: 2px 6px; border-radius: 4px; }
Â  Â  Â  Â  .message { text-align: center; padding: 40px; color: #666; font-size: 0.9rem; }

Â  Â  Â  Â  .skeleton-card { background: #1c1c1e; border-radius: 12px; padding: 12px 16px; margin-bottom: 10px; border-left: 5px solid #333; animation: pulse-loading 1.5s infinite ease-in-out; }
Â  Â  Â  Â  @keyframes pulse-loading { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
Â  Â  Â  Â  .sk-line { background: #333; border-radius: 4px; }
Â  Â  Â  Â  .sk-title { height: 14px; width: 60%; margin-bottom: 12px; }
Â  Â  Â  Â  .sk-main { height: 24px; width: 80%; margin: 0 auto 12px auto; }
Â  Â  Â  Â  .sk-sub { height: 12px; width: 50%; margin: 0 auto; }

Â  Â  Â  Â  /* å…¨åŸŸ LED ç³»çµ± */
Â  Â  Â  Â  .left-indicator {Â 
Â  Â  Â  Â  Â  Â  position: absolute; left: 12px; top: 50%; transform: translateY(-50%);Â 
Â  Â  Â  Â  Â  Â  display: flex; flex-direction: column; gap: 6px;Â 
Â  Â  Â  Â  Â  Â  opacity: 0; transition: opacity 0.5s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .card.is-arriving .left-indicator { opacity: 1; }

Â  Â  Â  Â  .led-dot {Â 
Â  Â  Â  Â  Â  Â  width: 10px; height: 10px; background-color: #4d7f5e; border-radius: 50%;Â 
Â  Â  Â  Â  Â  Â  transition: opacity 0.1s, box-shadow 0.1s;Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  body.led-phase-0 .led-dot.top,
Â  Â  Â  Â  body.led-phase-1 .led-dot.bottom { opacity: 1; box-shadow: 0 0 8px #4d7f5e; }

Â  Â  Â  Â  body.led-phase-0 .led-dot.bottom,
Â  Â  Â  Â  body.led-phase-1 .led-dot.top { opacity: 0.2; box-shadow: none; }

Â  Â  Â  Â  .status-badge-container { position: absolute; top: 12px; right: 16px; display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
Â  Â  Â  Â  .status-tag { padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; display: inline-flex; align-items: center; white-space: nowrap; }
Â  Â  Â  Â  .status-tag.departed { color: #888; border: 1px solid #555; background: #222; }
Â  Â  Â  Â  .status-tag.delay { color: hsl(40, 100%, 50%); border: 1px solid hsl(40, 100%, 50%); }
Â  Â  Â  Â  .card.departed-card { opacity: 0.5; filter: grayscale(1); border-left-color: #555 !important; }
Â  Â  Â  Â  .card.departed-card:active { transform: none; background-color: #151517; }

Â  Â  Â  Â  /* Modal Styles */
Â  Â  Â  Â  .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 999; display: none; align-items: center; justify-content: center; }
Â  Â  Â  Â  .modal-content { background: #1c1c1e; width: 85%; max-width: 400px; border-radius: 16px; padding: 25px; border: 1px solid #333; box-shadow: 0 10px 30px rgba(0,0,0,0.5); text-align: left; position: relative; max-height: 80vh; overflow-y: auto; }
Â  Â  Â  Â  .modal-header-row { display: flex; align-items: center; margin-bottom: 15px; position: sticky; top: -25px; background: #1c1c1e; z-index: 10; padding: 10px 0; border-bottom: 1px solid #333; }
Â  Â  Â  Â  .back-btn { background: none; border: none; color: #888; font-size: 1.5rem; cursor: pointer; padding: 0 10px 0 0; line-height: 1; }
Â  Â  Â  Â  .modal-title { font-size: 1.2rem; font-weight: bold; color: #4d7f5e; flex: 1; }
Â  Â  Â  Â  .menu-btn { display: flex; justify-content: space-between; align-items: center; width: 100%; padding: 15px; margin-bottom: 10px; background: #2c2c2e; border: 1px solid #444; color: #fff; border-radius: 12px; font-size: 1rem; cursor: pointer; }
Â  Â  Â  Â  .menu-btn:active { background: #3a3a3c; }
Â  Â  Â  Â  .menu-btn::after { content: 'â€º'; color: #666; font-size: 1.2rem; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .modal-text { font-size: 0.9rem; line-height: 1.6; color: #ccc; margin-bottom: 20px; }
Â  Â  Â  Â  .modal-close { background: #333; color: #fff; border: none; padding: 10px 0; width: 100%; border-radius: 8px; font-weight: bold; cursor: pointer; }
Â  Â  Â  Â  .modal-page { display: none; }
Â  Â  Â  Â  .modal-page.active { display: block; animation: fadeIn 0.2s; }
Â  Â  Â  Â  @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

Â  Â  Â  Â  .stats-dashboard { display: flex; gap: 8px; margin-bottom: 15px; }
Â  Â  Â  Â  .stat-card { flex: 1; background: #222; border: 1px solid #444; padding: 10px 5px; border-radius: 8px; text-align: center; }
Â  Â  Â  Â  .stat-val { font-size: 1.2rem; font-weight: bold; color: #4d7f5e; font-family: monospace;}
Â  Â  Â  Â  .stat-label { font-size: 0.65rem; color: #888; margin-top: 2px;}
Â  Â  Â  Â  .stat-card.danger .stat-val { color: #ff4d4d; }
Â  Â  Â  Â  .diag-section { margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 15px; }
Â  Â  Â  Â  .diag-section:last-child { border-bottom: none; }
Â  Â  Â  Â  .diag-title { font-size: 0.85rem; color: #888; margin-bottom: 8px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
Â  Â  Â  Â  .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
Â  Â  Â  Â  .info-item { background: #222; padding: 10px; border-radius: 8px; border: 1px solid #333; }
Â  Â  Â  Â  .info-label { font-size: 0.7rem; color: #666; margin-bottom: 4px; }
Â  Â  Â  Â  .info-value { font-size: 0.85rem; color: #fff; font-family: monospace; font-weight: bold; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
Â  Â  Â  Â  .badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
Â  Â  Â  Â  .badge.green { background: rgba(77, 127, 94, 0.2); color: #4d7f5e; border: 1px solid #4d7f5e; }
Â  Â  Â  Â  .badge.yellow { background: rgba(230, 184, 0, 0.2); color: #e6b800; border: 1px solid #e6b800; }
Â  Â  Â  Â  .badge.red { background: rgba(255, 77, 77, 0.2); color: #ff4d4d; border: 1px solid #ff4d4d; }
Â  Â  Â  Â  .terminal-box { background: #0d0d0d; border: 1px solid #333; border-radius: 8px; color: #0f0; font-family: 'Consolas', monospace; font-size: 0.7rem; padding: 10px; height: 120px; overflow-y: auto; white-space: pre-wrap; box-shadow: inset 0 0 10px #000; }
Â  Â  Â  Â  .ios-instruction { text-align: center; margin-top: 10px; }
Â  Â  Â  Â  .ios-step { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 12px; color: #ccc; font-size: 0.95rem; }
Â  Â  Â  Â  .ios-icon { font-size: 1.4rem; color: #4d7f5e; }

Â  Â  Â  Â  #inAppOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.92); z-index: 10000; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 40px 20px; box-sizing: border-box; backdrop-filter: blur(5px); }
Â  Â  Â  Â  .guide-icon { font-size: 3rem; color: #4d7f5e; margin-bottom: 20px; animation: pulse 2s infinite; }
Â  Â  Â  Â  @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.8; } }
Â  Â  Â  Â  .guide-highlight { color: #e6b800; font-weight: bold; font-size: 1.3rem; margin: 20px 0; border: 2px dashed #444; padding: 15px; border-radius: 12px; background: #222; }

Â  Â  Â  Â  .btn-half { flex: 1; font-size: 0.9rem; }
Â  Â  Â  Â  .btn-secondary { background: #3a3a3c; color: #fff; border: 1px solid #555; }
Â  Â  Â  Â  .btn-primary { background: #007AFF; color: white; }
Â  Â  </style>
</head>
<body>
Â  Â  <div id="inAppOverlay" onclick="this.style.display='none'">
Â  Â  Â  Â  <div class="guide-icon">ğŸŒ</div>
Â  Â  Â  Â  <div style="color:#fff; font-size:1.1rem; line-height:1.6;">è«‹åˆ‡æ›è‡³ç€è¦½å™¨é–‹å•Ÿ</div>
Â  Â  Â  Â  <div class="guide-highlight">1. é»æ“Šé¸å–® (â‹®)<br><br>2. é¸æ“‡ã€Œåœ¨ç€è¦½å™¨é–‹å•Ÿã€</div>
Â  Â  Â  Â  <div style="font-size:0.8rem; color:#aaa; margin-top:20px;">(é»æ“Šä»»æ„è™•é—œé–‰)</div>
Â  Â  </div>

Â  Â  <div class="container">
Â  Â  Â  Â  <div id="stickyPlaceholder"></div>

Â  Â  Â  Â  <div class="header">
Â  Â  Â  Â  Â  Â  <div class="header-static-part">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="header-top">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="app-title">TRAIN LIVE</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="btnInstall" class="install-btn-top" onclick="handleInstall()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ğŸ“² åŠ åˆ°æ¡Œé¢
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="menu-btn-trigger anim-gold-pulse" onclick="openModal()">â˜°</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="search-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="searchTarget" class="search-target" onchange="handleSearch()"><option value="start">è¨­ç‚ºèµ·é»</option><option value="end">è¨­ç‚ºçµ‚é»</option></select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="searchInput" class="search-box" placeholder="ğŸ” æœå°‹è»Šç«™..." oninput="handleSearch()">
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="selector-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="selector-label">èµ·é»</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="select-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="startRegion" class="region-select" onchange="updateStationList('start')"></select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="startStation" class="station-select" onchange="markAsChanged()"></select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="swap-container"><button class="swap-btn" onclick="swapStations()">â‡„</button></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="selector-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="selector-label">çµ‚é»</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="select-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="endRegion" class="region-select" onchange="updateStationList('end')"></select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="endStation" class="station-select" onchange="markAsChanged()"></select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div id="stickyHeader" class="header-sticky-part">
Â  Â  Â  Â  Â  Â  Â  Â  <div id="quickRouteArea" class="quick-route-area"></div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="action-area">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="btnSearch" class="btn btn-search" onclick="doSearch()">ğŸ” æŸ¥è©¢è·¯ç·š</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="btnRefresh" class="btn btn-refresh btn-refresh-sync" onclick="doRefresh()">ğŸ”„ æ›´æ–°</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="view-toolbar">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="btn-refresh-sticky-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-sticky-refresh btn-refresh-sync" onclick="doRefresh()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="toggle-icon">ğŸ”„</span> æ›´æ–°
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="btnStar" class="toggle-btn" onclick="toggleFavorite()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="toggle-icon">â˜†</span> æ”¶è—
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="btnShowAll" class="toggle-btn" onclick="toggleShowAll()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  å·²é§›é›¢
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="btnTimeFormat" class="toggle-btn" onclick="toggleTimeFormat()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  AM/PM
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="status-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="statusMsg" class="status-msg"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="updateTime" class="update-time"></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div id="hintContainer"></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="cardList"></div>
Â  Â  </div>

Â  Â  <button id="btnBackToTop" class="back-to-top" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">
Â  Â  Â  Â  â†‘
Â  Â  </button>

Â  Â  <div id="aboutModal" class="modal-overlay" onclick="closeModal()">
Â  Â  Â  Â  <div class="modal-content" onclick="event.stopPropagation()">
Â  Â  Â  Â  Â  Â  <div id="pageMenu" class="modal-page active">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="modal-header-row"><div class="modal-title">é¸å–®</div></div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <button class="menu-btn anim-gold-pulse" onclick="goToPage('Why')">è¨­è¨ˆç†å¿µ</button>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <button class="menu-btn" onclick="goToPage('How')">æ“ä½œèªªæ˜</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="menu-btn" onclick="goToPage('Report')">ç³»çµ±è¨ºæ–· / å•é¡Œå›å ±</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="menu-btn" onclick="shareApp()">ğŸ“¤ åˆ†äº«çµ¦æœ‹å‹</button>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="height:10px"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="modal-close" onclick="closeModal()">é—œé–‰</button>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div id="pageWhy" class="modal-page">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="modal-header-row"><button class="back-btn" onclick="goToPage('Menu')">â€¹</button><div class="modal-title">è¨­è¨ˆç†å¿µ</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="modal-text">ç¾æœ‰çš„ç«è»Šæ™‚åˆ»è¡¨è»Ÿé«”ï¼Œé€šå¸¸åªæœƒé¡¯ç¤ºã€Œèª¤é»å¹¾åˆ†é˜ã€ï¼Œè€Œæ²’æœ‰å¹«å¿™ç®—å‡ºã€Œå¯¦éš›å¹¾é»æœƒåˆ°ã€ã€‚<br><br>ç•¶ç«è»Šå¤§é‡èª¤é»æ™‚ï¼Œæˆ‘å€‘éœ€è¦åœ¨è…¦ä¸­ä¸æ–·åŠ æ¸›è¨ˆç®—ï¼Œéå¸¸ä¸ä¾¿ã€‚<br><br><strong>TRAIN LIVE çš„è¨­è¨ˆç›®æ¨™ï¼š</strong><br>1. ç›´æ¥é¡¯ç¤º<strong>ã€Œèª¤é»å¾Œçš„å¯¦éš›æ™‚é–“ã€</strong>ã€‚<br>2. ä¾ç…§<strong>ã€Œå¯¦éš›ç™¼è»Šé †åºã€</strong>æ’åˆ—ï¼Œè€ŒéåŸå®šæ™‚åˆ»ã€‚<br>3. ä¸€çœ¼çœ‹å‡ºç¾åœ¨è©²æ­å“ªä¸€ç­è»Šã€‚<br><br>å¸Œæœ›é€™å€‹å·¥å…·èƒ½è§£æ±ºä½ çš„é€šå‹¤ç„¦æ…®ã€‚</div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div id="pageHow" class="modal-page">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="modal-header-row"><button class="back-btn" onclick="goToPage('Menu')">â€¹</button><div class="modal-title">æ“ä½œèªªæ˜</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="modal-text">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>é›™æŒ‰éˆ•æ©Ÿåˆ¶ï¼š</strong><br><br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  1. <strong>ğŸ” æŸ¥è©¢è·¯ç·š (å·¦)ï¼š</strong><br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  åˆ‡æ›è·¯ç·šå°ˆç”¨ã€‚è‹¥æ‚¨é»æ“Šæ­¤æŒ‰éˆ•ä½†<strong>è»Šç«™æœªè®Šæ›´</strong>ï¼Œç³»çµ±å°‡è¦–ç‚ºã€Œæ›´æ–°ã€è™•ç†ã€‚<br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  è‹¥<strong>çœŸçš„è®Šæ›´è»Šç«™</strong>ï¼Œæ¯åˆ†é˜é™æŸ¥è©¢ 3 æ¬¡ã€‚<br><br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  2. <strong>ğŸ”„ æ›´æ–° (å³)ï¼š</strong><br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  åˆ·æ–°ç•¶å‰ç‹€æ…‹ã€‚æ¯æ¬¡é»æ“Šå¾Œéœ€ç­‰å¾… 30 ç§’å†·å»ã€‚<br><br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>è‡ªå‹•é‡è©¦æ©Ÿåˆ¶ï¼š</strong><br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  éŒ¯èª¤æˆ–ç³»çµ±å¿™ç¢Œéƒ½æœƒè‡ªå‹•é‡è©¦ï¼Œè«‹è€å¿ƒç­‰å€™ã€‚
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div id="pageReport" class="modal-page">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="modal-header-row"><button class="back-btn" onclick="goToPage('Menu')">â€¹</button><div class="modal-title">ç³»çµ±è¨ºæ–·</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="diag-section">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="diag-title">è³‡æ–™ä¾†æº / å‰©é¤˜é¡åº¦</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="info-grid">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="info-item"><div class="info-label">API ç‹€æ…‹ (V3 / V2)</div><div id="diagStatus" class="info-value">-- / --</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="info-item"><div class="info-label">å‰©é¤˜é¡åº¦</div><div id="diagQuota" class="info-value">--</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="diag-section">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="diag-title">æµé‡ç›£æ§</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stats-dashboard">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card" id="cardRpm"><div class="stat-val" id="statRpm">0</div><div class="stat-label">1åˆ†å…§è«‹æ±‚</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card"><div class="stat-val" id="statTotal">0</div><div class="stat-label">æœ¬æ¬¡ç¸½æ•¸</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card"><div class="stat-val" id="statLast">--</div><div class="stat-label">è·ä¸Šæ¬¡(s)</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="diag-section" style="border:none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="diag-title">ç³»çµ±ç´€éŒ„ (Log)</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="report-hint" style="color:#888; font-size:0.8rem; margin-bottom:10px;">è‹¥é‡åˆ°å•é¡Œï¼Œè«‹å…ˆã€Œè¤‡è£½å ±å‘Šã€ï¼Œå†é»æ“Šå¯„ä¿¡ã€‚</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="userDesc" class="search-box" style="width:100%; margin-bottom:10px; resize:none;" rows="2" placeholder="ï¼ˆé¸å¡«ï¼‰å•é¡Œæè¿°..."></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="reportContent" style="display:none;"></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="terminalView" class="terminal-box"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="action-area" style="margin-top:10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="btnCopyReport" class="btn btn-half btn-secondary" onclick="copyReportOnly()">ğŸ“‹ è¤‡è£½å ±å‘Š</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="btnSendMail" class="btn btn-half btn-primary" onclick="openMailClient()">ğŸ“§ é–‹å•Ÿä¿¡ç®±</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="pageIOS" class="modal-page">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="modal-header-row"><div class="modal-title">å®‰è£æ•™å­¸ (iOS)</div><button class="modal-close" style="width:auto; padding:5px 15px;" onclick="closeModal()">é—œé–‰</button></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-instruction">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-step">1. é»æ“Š <span class="ios-icon">â‹</span> <strong>åˆ†äº«</strong> æŒ‰éˆ•</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-step">2. é¸æ“‡ <span class="ios-icon">âŠ</span> <strong>åŠ å…¥ä¸»ç•«é¢</strong></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-step">3. é»æ“Šå³ä¸Šè§’çš„ã€ŒåŠ å…¥ã€</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <script>
Â  Â  Â  Â  const STATION_DATA = {
Â  Â  Â  Â  Â  Â  "åŸºéš†å¸‚": ["åŸºéš†", "ä¸‰å‘", "å…«å µ", "ä¸ƒå µ", "ç™¾ç¦", "æš–æš–", "æµ·ç§‘é¤¨"],
Â  Â  Â  Â  Â  Â  "æ–°åŒ—å¸‚": ["äº”å µ", "æ±æ­¢", "æ±ç§‘", "æ¿æ©‹", "æµ®æ´²", "æ¨¹æ—", "å—æ¨¹æ—", "å±±ä½³", "é¶¯æ­Œ", "é³³é³´", "å››è…³äº­", "ç‘èŠ³", "ä¾¯ç¡", "ä¸‰è²‚å¶º", "ç‰¡ä¸¹", "é›™æºª", "è²¢å¯®", "ç¦éš†", "å…«æ–—å­", "å¤§è¯", "ååˆ†", "æœ›å¤", "å¶ºè…³", "å¹³æºª", "èæ¡"],
Â  Â  Â  Â  Â  Â  "è‡ºåŒ—å¸‚": ["å—æ¸¯", "æ¾å±±", "è‡ºåŒ—", "è¬è¯"],
Â  Â  Â  Â  Â  Â  "æ¡ƒåœ’å¸‚": ["æ¡ƒåœ’", "å…§å£¢", "ä¸­å£¢", "åŸ”å¿ƒ", "æ¥Šæ¢…", "å¯Œå²¡", "æ–°å¯Œ"],
Â  Â  Â  Â  Â  Â  "æ–°ç«¹ç¸£å¸‚": ["åŒ—æ¹–", "æ¹–å£", "æ–°è±", "ç«¹åŒ—", "åŒ—æ–°ç«¹", "æ–°ç«¹", "ä¸‰å§“æ©‹", "é¦™å±±", "åƒç”²", "æ–°èŠ", "å…­å®¶", "ç«¹ä¸­", "ä¸Šå“¡", "æ¦®è¯", "ç«¹æ±", "æ©«å±±", "ä¹è®šé ­", "åˆèˆˆ", "å¯Œè²´", "å…§ç£"],
Â  Â  Â  Â  Â  Â  "è‹—æ —ç¸£": ["å´é ‚", "ç«¹å—", "é€ æ©‹", "è±å¯Œ", "è‹—æ —", "å—å‹¢", "éŠ…é‘¼", "ä¸‰ç¾©", "è«‡æ–‡", "å¤§å±±", "å¾Œé¾", "é¾æ¸¯", "ç™½æ²™å±¯", "æ–°åŸ”", "é€šéœ„", "è‹‘è£¡"],
Â  Â  Â  Â  Â  Â  "è‡ºä¸­å¸‚": ["æ³°å®‰", "åé‡Œ", "è±åŸ", "æ —æ—", "æ½­å­", "é ­å®¶å", "æ¾ç«¹", "å¤ªåŸ", "ç²¾æ­¦", "è‡ºä¸­", "äº”æ¬Š", "å¤§æ…¶", "çƒæ—¥", "æ–°çƒæ—¥", "æˆåŠŸ", "æ—¥å—", "å¤§ç”²", "è‡ºä¸­æ¸¯", "æ¸…æ°´", "æ²™é¹¿", "é¾äº•", "å¤§è‚š", "è¿½åˆ†"],
Â  Â  Â  Â  Â  Â  "å½°åŒ–ç¸£": ["å½°åŒ–", "èŠ±å£‡", "å¤§æ‘", "å“¡æ—", "æ°¸é–", "ç¤¾é ­", "ç”°ä¸­", "äºŒæ°´", "æºæ³‰"],
Â  Â  Â  Â  Â  Â  "å—æŠ•ç¸£": ["æ¿æ°´", "é¾æ³‰", "é›†é›†", "æ°´é‡Œ", "è»ŠåŸ•"],
Â  Â  Â  Â  Â  Â  "é›²æ—ç¸£": ["æ—å…§", "çŸ³æ¦´", "æ–—å…­", "æ–—å—", "çŸ³é¾œ"],
Â  Â  Â  Â  Â  Â  "å˜‰ç¾©ç¸£å¸‚": ["å¤§æ—", "æ°‘é›„", "å˜‰åŒ—", "å˜‰ç¾©", "æ°´ä¸Š", "å—é–"],
Â  Â  Â  Â  Â  Â  "è‡ºå—å¸‚": ["å¾Œå£", "æ–°ç‡Ÿ", "æŸ³ç‡Ÿ", "æ—é³³ç‡Ÿ", "éš†ç”°", "æ‹”æ—", "å–„åŒ–", "å—ç§‘", "æ–°å¸‚", "æ°¸åº·", "å¤§æ©‹", "è‡ºå—", "ä¿å®‰", "ä»å¾·", "ä¸­æ´²", "é•·æ¦®å¤§å­¸", "æ²™å´™"],
Â  Â  Â  Â  Â  Â  "é«˜é›„å¸‚": ["å¤§æ¹–", "è·¯ç«¹", "å²¡å±±", "æ©‹é ­", "æ¥ æ¢“", "æ–°å·¦ç‡Ÿ", "å·¦ç‡Ÿ", "å…§æƒŸ", "ç¾è¡“é¤¨", "é¼“å±±", "ä¸‰å¡Šå", "é«˜é›„", "æ°‘æ—", "ç§‘å·¥é¤¨", "æ­£ç¾©", "é³³å±±", "å¾Œåº„", "ä¹æ›²å ‚"],
Â  Â  Â  Â  Â  Â  "å±æ±ç¸£": ["å…­å¡Šå", "å±æ±", "æ­¸ä¾†", "éºŸæ´›", "è¥¿å‹¢", "ç«¹ç”°", "æ½®å·", "å´é ‚", "å—å·", "é®å®‰", "æ—é‚Š", "ä½³å†¬", "æ±æµ·", "æ‹å¯®", "åŠ ç¥¿", "å…§ç…", "æ‹å±±"],
Â  Â  Â  Â  Â  Â  "å®œè˜­ç¸£": ["æ¼¢æœ¬", "æ­¦å¡”", "å—æ¾³", "æ±æ¾³", "æ°¸æ¨‚", "è˜‡æ¾³", "è˜‡æ¾³æ–°", "å†¬å±±", "ç¾…æ±", "ä¸­é‡Œ", "äºŒçµ", "å®œè˜­", "å››åŸ", "ç¤æºª", "é ‚åŸ”", "é ­åŸ", "å¤–æ¾³", "é¾œå±±", "å¤§æºª", "å¤§é‡Œ", "çŸ³åŸ"],
Â  Â  Â  Â  Â  Â  "èŠ±è“®ç¸£": ["å’Œå¹³", "å’Œä»", "å´‡å¾·", "æ–°åŸ", "æ™¯ç¾", "åŒ—åŸ”", "èŠ±è“®", "å‰å®‰", "å¿—å­¸", "å¹³å’Œ", "å£½è±", "è±ç”°", "æ—æ¦®æ–°å…‰", "å—å¹³", "é³³æ—", "è¬æ¦®", "å…‰å¾©", "å¤§å¯Œ", "å¯Œæº", "ç‘ç©—", "ä¸‰æ°‘", "ç‰é‡Œ", "æ±é‡Œ", "æ±ç«¹", "å¯Œé‡Œ"],
Â  Â  Â  Â  Â  Â  "è‡ºæ±ç¸£": ["æ± ä¸Š", "æµ·ç«¯", "é—œå±±", "ç‘å’Œ", "ç‘æº", "é¹¿é‡", "å±±é‡Œ", "è‡ºæ±", "åº·æ¨‚", "çŸ¥æœ¬", "å¤ªéº»é‡Œ", "é‡‘å´™", "ç€§æºª", "å¤§æ­¦"]
Â  Â  Â  Â  };

Â  Â  Â  Â  const STATION_INDEX={};Object.keys(STATION_DATA).forEach(r=>{STATION_DATA[r].forEach(s=>{STATION_INDEX[s]=r;});});
Â  Â  Â  Â  const DEFAULT_STATIONS = {"åŸºéš†å¸‚": "åŸºéš†", "æ–°åŒ—å¸‚": "æ¿æ©‹", "è‡ºåŒ—å¸‚": "è‡ºåŒ—", "æ¡ƒåœ’å¸‚": "æ¡ƒåœ’", "æ–°ç«¹ç¸£å¸‚": "æ–°ç«¹", "è‹—æ —ç¸£": "è‹—æ —", "è‡ºä¸­å¸‚": "è‡ºä¸­", "å½°åŒ–ç¸£": "å½°åŒ–", "å—æŠ•ç¸£": "é›†é›†", "é›²æ—ç¸£": "æ–—å…­", "å˜‰ç¾©ç¸£å¸‚": "å˜‰ç¾©", "è‡ºå—å¸‚": "è‡ºå—", "é«˜é›„å¸‚": "é«˜é›„", "å±æ±ç¸£": "å±æ±", "å®œè˜­ç¸£": "ç¾…æ±", "èŠ±è“®ç¸£": "èŠ±è“®", "è‡ºæ±ç¸£": "è‡ºæ±"};

Â  Â  Â  Â  const CACHE_PREFIX="train_data_v2_";
Â  Â  Â  Â  const PREF_START_R_KEY="pref_start_region";const PREF_START_S_KEY="pref_start_station";
Â  Â  Â  Â  const PREF_END_R_KEY="pref_end_region";const PREF_END_S_KEY="pref_end_station";

Â  Â  Â  Â  const startRegion=document.getElementById('startRegion');const startStation=document.getElementById('startStation');
Â  Â  Â  Â  const endRegion=document.getElementById('endRegion');const endStation=document.getElementById('endStation');
Â  Â  Â  Â  const searchInput=document.getElementById('searchInput');const searchTarget=document.getElementById('searchTarget');
Â  Â  Â  Â  const btnSearch=document.getElementById('btnSearch');const btnRefresh=document.getElementById('btnRefresh');
Â  Â  Â  Â  const btnTimeFormat=document.getElementById('btnTimeFormat'); const btnShowAll=document.getElementById('btnShowAll');
Â  Â  Â  Â  const statusMsg=document.getElementById('statusMsg');const updateTimeDiv=document.getElementById('updateTime');
Â  Â  Â  Â  const list=document.getElementById('cardList');const btnInstall = document.getElementById('btnInstall');
Â  Â  Â  Â  const hintContainer = document.getElementById('hintContainer');

Â  Â  Â  Â  let refreshTimer=null; let searchLockTimer=null; let retryTimer=null;
Â  Â  Â  Â  let statusTimer = null;Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  let isAutoScrolling = false;

Â  Â  Â  Â  const LS_SEARCH_COUNT="tl_search_count";const LS_SEARCH_RESET="tl_search_reset_time";
Â  Â  Â  Â  const LS_SEARCH_LOCK="tl_search_locked_until";const LS_REFRESH_LOCK="tl_refresh_locked_until";
Â  Â  Â  Â  const LS_IS_24H="tl_pref_is_24h";Â 

Â  Â  Â  Â  const MAX_SEARCH_PER_MIN=3;
Â  Â  Â  Â  let lastFetchedPair={start:"",end:""};
Â  Â  Â  Â  let is24Hour = localStorage.getItem(LS_IS_24H) !== 'false';
Â  Â  Â  Â  let isShowAll = false;
Â  Â  Â  Â  let lastDiagnostics = { route_source: "--", route_quota: "--", delay_source: "--", delay_quota: "--" };
Â  Â  Â  Â  let systemLogs=[]; let requestHistory=[];

Â  Â  Â  Â  let deferredPrompt;
Â  Â  Â  Â  const isIos = /iPhone|iPad|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
Â  Â  Â  Â  const isInStandaloneMode = ('standalone' in window.navigator) && (window.navigator.standalone);
Â  Â  Â  Â  const isInApp = /Line|Instagram|FBAN|FBAV/i.test(navigator.userAgent);

Â  Â  Â  Â  if ((isIos && !isInStandaloneMode) || isInApp) {
Â  Â  Â  Â  Â  Â  btnInstall.style.display = 'flex';Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  window.addEventListener('beforeinstallprompt', (e) => {
Â  Â  Â  Â  Â  Â  e.preventDefault(); deferredPrompt = e;
Â  Â  Â  Â  Â  Â  btnInstall.style.display = 'flex';Â 
Â  Â  Â  Â  });

Â  Â  Â  Â  function handleInstall() {
Â  Â  Â  Â  Â  Â  if (isInApp) { document.getElementById('inAppOverlay').style.display = 'flex'; return; }
Â  Â  Â  Â  Â  Â  if (isIos) { document.getElementById('aboutModal').style.display = 'flex'; goToPage('IOS'); return; }
Â  Â  Â  Â  Â  Â  if (deferredPrompt) { deferredPrompt.prompt(); deferredPrompt.userChoice.then((c) => { if(c.outcome==='accepted') btnInstall.style.display='none'; deferredPrompt=null; }); }
Â  Â  Â  Â  }
Â  Â  Â  Â  async function shareApp() {
Â  Â  Â  Â  Â  Â  const data = { title: 'TRAIN LIVE', text: 'èª¤é»è‡ªå‹•è¨ˆç®—ï¼', url: window.location.href };
Â  Â  Â  Â  Â  Â  if (navigator.share) try { await navigator.share(data); } catch(e){} else { try{await navigator.clipboard.writeText(window.location.href);alert('é€£çµå·²è¤‡è£½');}catch(e){} }
Â  Â  Â  Â  }

Â  Â  Â  Â  function getSearchCount(){return parseInt(localStorage.getItem(LS_SEARCH_COUNT)||"0");}
Â  Â  Â  Â  function setSearchCount(v){localStorage.setItem(LS_SEARCH_COUNT,v);}
Â  Â  Â  Â  function getSearchResetTime(){return parseInt(localStorage.getItem(LS_SEARCH_RESET)||"0");}
Â  Â  Â  Â  function setSearchResetTime(v){localStorage.setItem(LS_SEARCH_RESET,v);}
Â  Â  Â  Â  function getSearchLockedUntil(){return parseInt(localStorage.getItem(LS_SEARCH_LOCK)||"0");}
Â  Â  Â  Â  function setSearchLockedUntil(v){localStorage.setItem(LS_SEARCH_LOCK,v);}
Â  Â  Â  Â  function getRefreshLockedUntil(){return parseInt(localStorage.getItem(LS_REFRESH_LOCK)||"0");}
Â  Â  Â  Â  function setRefreshLockedUntil(v){localStorage.setItem(LS_REFRESH_LOCK,v);}

Â  Â  Â  Â  function updateToggleBtns() {
Â  Â  Â  Â  Â  Â  const btnTime = document.getElementById('btnTimeFormat');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  btnTime.innerHTML = '<span class="toggle-icon">ğŸ•’</span> AM/PM';
Â  Â  Â  Â  Â  Â  if (!is24Hour) {
Â  Â  Â  Â  Â  Â  Â  Â  btnTime.classList.add('active');Â 
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  btnTime.classList.remove('active');Â 
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const btnAll = document.getElementById('btnShowAll');
Â  Â  Â  Â  Â  Â  if (isShowAll) {
Â  Â  Â  Â  Â  Â  Â  Â  btnAll.innerHTML = '<span class="toggle-icon">ğŸ‘ï¸</span> å·²é§›é›¢';
Â  Â  Â  Â  Â  Â  Â  Â  btnAll.classList.add('active');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  btnAll.innerHTML = 'å·²é§›é›¢';
Â  Â  Â  Â  Â  Â  Â  Â  btnAll.classList.remove('active');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  function toggleTimeFormat() { is24Hour=!is24Hour; localStorage.setItem(LS_IS_24H, is24Hour); updateToggleBtns(); reRenderLocal(); }
Â  Â  Â  Â  function toggleShowAll() { isShowAll=!isShowAll; updateToggleBtns(); reRenderLocal(); }

Â  Â  Â  Â  function formatTime(t) {
Â  Â  Â  Â  Â  Â  if(!t) return "";
Â  Â  Â  Â  Â  Â  if(is24Hour) return t;

Â  Â  Â  Â  Â  Â  const p = t.split(':');
Â  Â  Â  Â  Â  Â  if(p.length < 2) return t;

Â  Â  Â  Â  Â  Â  let h = parseInt(p[0]);
Â  Â  Â  Â  Â  Â  let suffix = "ä¸Šåˆ";

Â  Â  Â  Â  Â  Â  if(h >= 12) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  suffix = "ä¸‹åˆ";Â 
Â  Â  Â  Â  Â  Â  Â  Â  if(h > 12) h -= 12;Â 
Â  Â  Â  Â  Â  Â  } else if(h === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  h = 12;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  return `<span class="ampm">${suffix}</span> ${h}:${p[1]}`;
Â  Â  Â  Â  }

Â  Â  Â  Â  let lastScroll = 0;
Â  Â  Â  Â  let currentTranslate = 0;Â 

Â  Â  Â  Â  // [é—œéµä¿®æ”¹] çµ±ä¸€ç®¡ç†å‹•æ…‹æ¬„ç‹€æ…‹ï¼Œä¿®å¾©å·¦å´éŒ¯ä½èˆ‡é¬¼å½±
Â  Â  Â  Â  function setStickyState(isFixed, translate = 0) {
Â  Â  Â  Â  Â  Â  const sticky = document.getElementById('stickyHeader');
Â  Â  Â  Â  Â  Â  const placeholder = document.getElementById('stickyPlaceholder');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (isFixed) {
Â  Â  Â  Â  Â  Â  Â  Â  if (!sticky.classList.contains('is-fixed')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  placeholder.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  placeholder.style.height = (sticky.offsetHeight || 150) + 'px';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sticky.classList.add('is-fixed');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  // [ä¿®å¾©] å¼·åˆ¶åŠ ä¸Š translateX(-50%)ï¼Œé˜²æ­¢å·¦å
Â  Â  Â  Â  Â  Â  Â  Â  sticky.style.transform = `translateX(-50%) translateY(${translate}px)`;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  sticky.classList.remove('is-fixed');
Â  Â  Â  Â  Â  Â  Â  Â  // [ä¿®å¾©] éœæ…‹æ™‚æ¸…é™¤æ‰€æœ‰ transform
Â  Â  Â  Â  Â  Â  Â  Â  sticky.style.transform = 'none';Â 
Â  Â  Â  Â  Â  Â  Â  Â  placeholder.style.display = 'none';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  window.addEventListener('scroll', () => {
Â  Â  Â  Â  Â  Â  if (isAutoScrolling) return; // è‡ªå‹•æ²å‹•æ™‚ï¼Œäº¤çµ¦ scrollToActiveCard æ§åˆ¶

Â  Â  Â  Â  Â  Â  const current = window.scrollY;
Â  Â  Â  Â  Â  Â  const sticky = document.getElementById('stickyHeader');
Â  Â  Â  Â  Â  Â  const backToTop = document.getElementById('btnBackToTop');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const staticPart = document.querySelector('.header-static-part');
Â  Â  Â  Â  Â  Â  const threshold = staticPart ? staticPart.offsetHeight : 150;
Â  Â  Â  Â  Â  Â  const stickyHeight = sticky.offsetHeight || 150;

Â  Â  Â  Â  Â  Â  if(current > 300) {
Â  Â  Â  Â  Â  Â  Â  Â  backToTop.classList.add('visible');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  backToTop.classList.remove('visible');
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // [ä¿è­·å€]ï¼šåªè¦éœæ…‹å€é‚„åœ¨ç•«é¢ä¸Šï¼Œå¼·åˆ¶ Reset
Â  Â  Â  Â  Â  Â  if (current <= threshold) {
Â  Â  Â  Â  Â  Â  Â  Â  setStickyState(false);
Â  Â  Â  Â  Â  Â  Â  Â  currentTranslate = 0;Â 
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // è¨ˆç®—æ»‘å‹•å·®å€¼
Â  Â  Â  Â  Â  Â  Â  Â  const diff = current - lastScroll;
Â  Â  Â  Â  Â  Â  Â  Â  currentTranslate -= diff;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Clamp
Â  Â  Â  Â  Â  Â  Â  Â  if (currentTranslate > 0) currentTranslate = 0;
Â  Â  Â  Â  Â  Â  Â  Â  if (currentTranslate < -stickyHeight) currentTranslate = -stickyHeight;

Â  Â  Â  Â  Â  Â  Â  Â  // å®‰å…¨é–
Â  Â  Â  Â  Â  Â  Â  Â  if (current < threshold + stickyHeight + 10) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentTranslate = 0;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  setStickyState(true, currentTranslate);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  lastScroll = current <= 0 ? 0 : current;
Â  Â  Â  Â  });

Â  Â  Â  Â  // [å„ªåŒ–] è‡ªå‹•æ²å‹•ï¼šé–‹å•Ÿç„¡æ•µæ¨¡å¼ + å¼·åˆ¶æ­¸ä½
Â  Â  Â  Â  function scrollToActiveCard() {
Â  Â  Â  Â  Â  Â  const el = document.getElementById("firstActive");
Â  Â  Â  Â  Â  Â  if (!el) return;

Â  Â  Â  Â  Â  Â  isAutoScrolling = true;

Â  Â  Â  Â  Â  Â  // å¼·åˆ¶å®Œå…¨å±•é–‹
Â  Â  Â  Â  Â  Â  setStickyState(true, 0);
Â  Â  Â  Â  Â  Â  currentTranslate = 0;

Â  Â  Â  Â  Â  Â  const sticky = document.getElementById('stickyHeader');
Â  Â  Â  Â  Â  Â  const headerHeight = sticky.offsetHeight || 150;
Â  Â  Â  Â  Â  Â  const elementPosition = el.getBoundingClientRect().top + window.scrollY;
Â  Â  Â  Â  Â  Â  const offsetPosition = elementPosition - headerHeight - 10;Â 

Â  Â  Â  Â  Â  Â  window.scrollTo({
Â  Â  Â  Â  Â  Â  Â  Â  top: offsetPosition,
Â  Â  Â  Â  Â  Â  Â  Â  behavior: "smooth"
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // é–å®šç¨é•·æ™‚é–“ï¼Œé˜²æ­¢æ…£æ€§æ»¾å‹•å¹²æ“¾
Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  isAutoScrolling = false;
Â  Â  Â  Â  Â  Â  Â  Â  lastScroll = window.scrollY;Â 
Â  Â  Â  Â  Â  Â  }, 800);
Â  Â  Â  Â  }

Â  Â  Â  Â  // [å„ªåŒ–] é‡ç½®å‹•æ…‹æ¬„ (æœå°‹/åˆ‡æ›æ™‚ä½¿ç”¨)
Â  Â  Â  Â  function resetStickyState() {
Â  Â  Â  Â  Â  Â  setStickyState(false);
Â  Â  Â  Â  Â  Â  currentTranslate = 0;
Â  Â  Â  Â  Â  Â  isAutoScrolling = false;
Â  Â  Â  Â  }

Â  Â  Â  Â  function init() {
Â  Â  Â  Â  Â  Â  logSystem("Init","App Started"); updateToggleBtns();
Â  Â  Â  Â  Â  Â  const regions=Object.keys(STATION_DATA); const rOpts=regions.map(r=>`<option value="${r}">${r}</option>`).join('');
Â  Â  Â  Â  Â  Â  const savedSR = localStorage.getItem(PREF_START_R_KEY);
Â  Â  Â  Â  Â  Â  if (savedSR) {
Â  Â  Â  Â  Â  Â  Â  Â  startRegion.innerHTML=rOpts; endRegion.innerHTML=rOpts;
Â  Â  Â  Â  Â  Â  Â  Â  setMenu('start',savedSR,localStorage.getItem(PREF_START_S_KEY)||"å±æ±");Â 
Â  Â  Â  Â  Â  Â  Â  Â  setMenu('end',localStorage.getItem(PREF_END_R_KEY)||"å±æ±ç¸£",localStorage.getItem(PREF_END_S_KEY)||"æ½®å·");
Â  Â  Â  Â  Â  Â  Â  Â  checkLocksOnLoad(); loadDataOrFetch();
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  startRegion.innerHTML=`<option value="" disabled selected>é¸æ“‡ç¸£å¸‚</option>`+rOpts;Â 
Â  Â  Â  Â  Â  Â  Â  Â  endRegion.innerHTML=`<option value="" disabled selected>é¸æ“‡ç¸£å¸‚</option>`+rOpts;
Â  Â  Â  Â  Â  Â  Â  Â  startStation.innerHTML=endStation.innerHTML=`<option value="" disabled selected>é¸æ“‡è»Šç«™</option>`;
Â  Â  Â  Â  Â  Â  Â  Â  list.innerHTML='<div class="message">è«‹é¸æ“‡ èµ·é» èˆ‡ çµ‚é» è»Šç«™<br>é–‹å§‹æŸ¥è©¢</div>';
Â  Â  Â  Â  Â  Â  Â  Â  statusMsg.innerText="ç­‰å¾…è¼¸å…¥...";
Â  Â  Â  Â  Â  Â  Â  Â  checkLocksOnLoad();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  renderQuickRoutes();
Â  Â  Â  Â  Â  Â  updateStarState();
Â  Â  Â  Â  Â  Â  startStatusTimer();Â 
Â  Â  Â  Â  Â  Â  initGlobalLedSync();Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  function startStatusTimer() {
Â  Â  Â  Â  Â  Â  if (statusTimer) clearInterval(statusTimer);
Â  Â  Â  Â  Â  Â  statusTimer = setInterval(() => {
Â  Â  Â  Â  Â  Â  Â  Â  updateRealtimeStatus();
Â  Â  Â  Â  Â  Â  }, 10000);
Â  Â  Â  Â  }

Â  Â  Â  Â  function initGlobalLedSync() {
Â  Â  Â  Â  Â  Â  const loop = () => {
Â  Â  Â  Â  Â  Â  Â  Â  const now = Date.now();
Â  Â  Â  Â  Â  Â  Â  Â  const phase = Math.floor((now % 1000) / 500);Â 
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (phase === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.body.classList.add('led-phase-0');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.body.classList.remove('led-phase-1');
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.body.classList.add('led-phase-1');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.body.classList.remove('led-phase-0');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  requestAnimationFrame(loop);
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  requestAnimationFrame(loop);
Â  Â  Â  Â  }

Â  Â  Â  Â  function updateRealtimeStatus() {
Â  Â  Â  Â  Â  Â  const cards = document.querySelectorAll('#cardList .card-link');
Â  Â  Â  Â  Â  Â  if (cards.length === 0) return;

Â  Â  Â  Â  Â  Â  const nowSec = Math.floor(Date.now() / 1000);
Â  Â  Â  Â  Â  Â  let anyArriving = false;

Â  Â  Â  Â  Â  Â  cards.forEach(link => {
Â  Â  Â  Â  Â  Â  Â  Â  const ts = parseInt(link.getAttribute('data-ts') || 0);
Â  Â  Â  Â  Â  Â  Â  Â  if (!ts) return;

Â  Â  Â  Â  Â  Â  Â  Â  const diffSec = ts - nowSec;
Â  Â  Â  Â  Â  Â  Â  Â  const diffMin = Math.floor(diffSec / 60);
Â  Â  Â  Â  Â  Â  Â  Â  const isDeparted = diffSec < 0;
Â  Â  Â  Â  Â  Â  Â  Â  const isArriving = !isDeparted && diffMin <= 10;

Â  Â  Â  Â  Â  Â  Â  Â  const cardDiv = link.querySelector('.card');
Â  Â  Â  Â  Â  Â  Â  Â  const rightBadgeContainer = link.querySelector('.status-badge-container');
Â  Â  Â  Â  Â  Â  Â  Â  const infoDiv = link.querySelector('.train-info');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (isDeparted) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!cardDiv.classList.contains('departed-card')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cardDiv.classList.add('departed-card', 'past');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(infoDiv) infoDiv.style.color = '#888';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!rightBadgeContainer.querySelector('.status-tag.departed')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  rightBadgeContainer.innerHTML = '<div class="status-tag departed">å·²é§›é›¢</div>';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (cardDiv.classList.contains('departed-card')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â cardDiv.classList.remove('departed-card', 'past');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isArriving) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!cardDiv.classList.contains('is-arriving')) cardDiv.classList.add('is-arriving');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  anyArriving = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (cardDiv.classList.contains('is-arriving')) cardDiv.classList.remove('is-arriving');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // [ä¿®æ”¹] åªæœ‰ç•¶ç‹€æ…‹çœŸçš„æ”¹è®Šæ™‚æ‰æ›´æ–° Hint UIï¼Œé¿å…é–ƒçˆ
Â  Â  Â  Â  Â  Â  const currentHintState = hintContainer.getAttribute('data-arriving') === 'true';
Â  Â  Â  Â  Â  Â  if (currentHintState !== anyArriving) {
Â  Â  Â  Â  Â  Â  Â  Â  updateHintUI(anyArriving);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function checkLocksOnLoad() {
Â  Â  Â  Â  Â  Â  const now=Date.now();
Â  Â  Â  Â  Â  Â  const sL=getSearchLockedUntil(); if(sL>now) lockSearchButton(Math.ceil((sL-now)/1000));
Â  Â  Â  Â  Â  Â  const rL=getRefreshLockedUntil(); if(rL>now) lockRefreshButton(Math.ceil((rL-now)/1000));
Â  Â  Â  Â  }
Â  Â  Â  Â  function setMenu(type,rV,sV) {
Â  Â  Â  Â  Â  Â  const rSel=type==='start'?startRegion:endRegion; const sSel=type==='start'?startStation:endStation;
Â  Â  Â  Â  Â  Â  if(!STATION_DATA[rV]) { rSel.value = ""; return; }
Â  Â  Â  Â  Â  Â  rSel.value=rV; sSel.innerHTML=STATION_DATA[rV].map(s=>`<option value="${s}">${s}</option>`).join('');
Â  Â  Â  Â  Â  Â  if(STATION_DATA[rV].includes(sV)) sSel.value=sV; else sSel.selectedIndex=0;
Â  Â  Â  Â  }
Â  Â  Â  Â  function updateStationList(type) {
Â  Â  Â  Â  Â  Â  const rSel=type==='start'?startRegion:endRegion; const sSel=type==='start'?startStation:endStation;
Â  Â  Â  Â  Â  Â  const rVal = rSel.value; if (!rVal) return;
Â  Â  Â  Â  Â  Â  sSel.innerHTML=STATION_DATA[rVal].map(s=>`<option value="${s}">${s}</option>`).join('');
Â  Â  Â  Â  Â  Â  const def=DEFAULT_STATIONS[rVal];Â 
Â  Â  Â  Â  Â  Â  if(def&&STATION_DATA[rVal].includes(def)) sSel.value=def; else sSel.selectedIndex=0;
Â  Â  Â  Â  Â  Â  if(startStation.value&&endStation.value) markAsChanged();
Â  Â  Â  Â  }
Â  Â  Â  Â  function swapStations() {
Â  Â  Â  Â  Â  Â  if(!startStation.value||!endStation.value) return; logSystem("UI","Swap");
Â  Â  Â  Â  Â  Â  const sR=startRegion.value; const sS=startStation.value;
Â  Â  Â  Â  Â  Â  setMenu('start',endRegion.value,endStation.value); setMenu('end',sR,sS);
Â  Â  Â  Â  Â  Â  markAsChanged();
Â  Â  Â  Â  }
Â  Â  Â  Â  function handleSearch() {
Â  Â  Â  Â  Â  Â  const val=searchInput.value.trim(); const tgt=searchTarget.value; if(!val) return;
Â  Â  Â  Â  Â  Â  let found=STATION_INDEX[val]?val:Object.keys(STATION_INDEX).find(s=>s.includes(val));
Â  Â  Â  Â  Â  Â  if(found) {
Â  Â  Â  Â  Â  Â  Â  Â  logSystem("UI",`Search: ${found}`); setMenu(tgt,STATION_INDEX[found],found);
Â  Â  Â  Â  Â  Â  Â  Â  searchInput.style.borderColor="#4d7f5e"; setTimeout(()=>searchInput.style.borderColor="#444",500);
Â  Â  Â  Â  Â  Â  Â  Â  if(startStation.value&&endStation.value) markAsChanged();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  function markAsChanged() {
Â  Â  Â  Â  Â  Â  if(!startStation.value||!endStation.value) return;
Â  Â  Â  Â  Â  Â  localStorage.setItem(PREF_START_R_KEY,startRegion.value); localStorage.setItem(PREF_START_S_KEY,startStation.value);
Â  Â  Â  Â  Â  Â  localStorage.setItem(PREF_END_R_KEY,endRegion.value); localStorage.setItem(PREF_END_S_KEY,endStation.value);
Â  Â  Â  Â  Â  Â  attemptLoadCache(false);
Â  Â  Â  Â  Â  Â  updateStarState();
Â  Â  Â  Â  }
Â  Â  Â  Â  function getCacheKey(){return `${CACHE_PREFIX}${startStation.value}_${endStation.value}`;}
Â  Â  Â  Â Â 
Â  Â  Â  Â  // åªæœ‰ç•¶æœ‰è³‡æ–™æ™‚æ‰é‡æ–°æ¸²æŸ“
Â  Â  Â  Â  function reRenderLocal() {
Â  Â  Â  Â  Â  Â  const c=localStorage.getItem(getCacheKey());
Â  Â  Â  Â  Â  Â  if(c) {
Â  Â  Â  Â  Â  Â  Â  Â  renderCards(JSON.parse(c).payload);Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function attemptLoadCache(isInit) {
Â  Â  Â  Â  Â  Â  if(!startStation.value||!endStation.value) return;
Â  Â  Â  Â  Â  Â  const c=localStorage.getItem(getCacheKey()); let hit=false;
Â  Â  Â  Â  Â  Â  if(c) {
Â  Â  Â  Â  Â  Â  Â  Â  const d=JSON.parse(c);
Â  Â  Â  Â  Â  Â  Â  Â  if(Date.now()-d.timestamp < 60000) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(d.payload.diagnostics) parseDiagnostics(d.payload.diagnostics, false);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderCards(d.payload); setUpdateText(`æ›´æ–°æ–¼(å¿«å–): ${d.payload.update_time}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusMsg.className="status-msg"; list.style.opacity="1";Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lastFetchedPair={start:startStation.value,end:endStation.value}; hit=true;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if(!hit) {
Â  Â  Â  Â  Â  Â  Â  Â  if(isInit) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusMsg.innerText="è«‹æŒ‰ã€ŒæŸ¥è©¢ã€é–‹å§‹ä½¿ç”¨"; statusMsg.className="status-msg warning";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  list.innerHTML='<div class="message">è«‹é»æ“Šä¸Šæ–¹æŒ‰éˆ•æŸ¥è©¢ç­æ¬¡</div>';
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  list.style.opacity="0.4"; statusMsg.innerText="è¨­å®šå·²è®Šæ›´ï¼Œè«‹æŒ‰ã€ŒæŸ¥è©¢ã€"; statusMsg.className="status-msg warning";
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  updateButtonMode();
Â  Â  Â  Â  }
Â  Â  Â  Â  function loadDataOrFetch(){attemptLoadCache(true);}
Â  Â  Â  Â  function updateButtonMode() {
Â  Â  Â  Â  Â  Â  if(getSearchLockedUntil()>Date.now()) return;
Â  Â  Â  Â  Â  Â  if(startStation.value!==lastFetchedPair.start||endStation.value!==lastFetchedPair.end) btnSearch.disabled=false;
Â  Â  Â  Â  }

Â  Â  Â  Â  function doSearch() {
Â  Â  Â  Â  Â  Â  const sS=startStation.value; const eS=endStation.value;
Â  Â  Â  Â  Â  Â  if(!sS||!eS) { statusMsg.innerText="è«‹å…ˆé¸æ“‡èµ·é»èˆ‡çµ‚é»"; statusMsg.className="status-msg alert"; setTimeout(()=>statusMsg.innerText="",2000); return; }
Â  Â  Â  Â  Â  Â  markAsChanged();
Â  Â  Â  Â  Â  Â  if(sS===lastFetchedPair.start&&eS===lastFetchedPair.end) { doRefresh(); return; }
Â  Â  Â  Â  Â  Â  const now=Date.now(); let cnt=getSearchCount(); let rst=getSearchResetTime();
Â  Â  Â  Â  Â  Â  if(now-rst>60000) { cnt=0; setSearchCount(0); rst=now; setSearchResetTime(now); }
Â  Â  Â  Â  Â  Â  if(cnt===0) { rst=now; setSearchResetTime(now); }
Â  Â  Â  Â  Â  Â  if(cnt>=MAX_SEARCH_PER_MIN) {
Â  Â  Â  Â  Â  Â  Â  Â  const w=Math.ceil((60000-(now-rst))/1000); const safeW=w>0?w:60;
Â  Â  Â  Â  Â  Â  Â  Â  setSearchLockedUntil(now+safeW*1000); lockSearchButton(safeW); logSystem("Limit","Search Limit"); return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  addToHistory();
Â  Â  Â  Â  Â  Â  cnt++; setSearchCount(cnt);Â 
Â  Â  Â  Â  Â  Â  logSystem("Action",`Search(${cnt}/${MAX_SEARCH_PER_MIN}) ${sS}â†’${eS}`);Â 
Â  Â  Â  Â  Â  Â  fetchData("search");
Â  Â  Â  Â  }
Â  Â  Â  Â  function doRefresh(skip=false) {
Â  Â  Â  Â  Â  Â  if(!skip) {
Â  Â  Â  Â  Â  Â  Â  Â  const now=Date.now(); const rL=getRefreshLockedUntil();
Â  Â  Â  Â  Â  Â  Â  Â  if(rL>now) { lockRefreshButton(Math.ceil((rL-now)/1000)); return; }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  logSystem("Action",`Refresh ${startStation.value}â†’${endStation.value}`);Â 
Â  Â  Â  Â  Â  Â  fetchData("refresh");
Â  Â  Â  Â  }

Â  Â  Â  Â  function parseDiag(str, isCdn) {
Â  Â  Â  Â  Â  Â  let source = "TDX API"; let quota = "--";
Â  Â  Â  Â  Â  Â  if (isCdn) source = "Vercel CDN";
Â  Â  Â  Â  Â  Â  else if (str.includes("Hit") || str.includes("Cache")) source = "Redis DB";
Â  Â  Â  Â  Â  Â  else if (str.includes("API")) source = "TDX API";
Â  Â  Â  Â  Â  Â  else source = "Unknown";
Â  Â  Â  Â  Â  Â  const match = str.match(/\(å‰©:\s*(\d+)\)/);
Â  Â  Â  Â  Â  Â  if (match) quota = match[1];
Â  Â  Â  Â  Â  Â  return { source, quota };
Â  Â  Â  Â  }

Â  Â  Â  Â  function parseDiagnostics(diag, isCdn) {
Â  Â  Â  Â  Â  Â  const rInfo = parseDiag(diag.route_status, isCdn);
Â  Â  Â  Â  Â  Â  const dInfo = diag.delay_status ? parseDiag(diag.delay_status, isCdn) : { source: "--", quota: "--" };
Â  Â  Â  Â  Â  Â  lastDiagnostics = { route_source: rInfo.source, route_quota: rInfo.quota, delay_source: dInfo.source, delay_quota: dInfo.quota };
Â  Â  Â  Â  Â  Â  return { rInfo, dInfo };
Â  Â  Â  Â  }

Â  Â  Â  Â  function getSkeletonHTML() {
Â  Â  Â  Â  Â  Â  let html = '';
Â  Â  Â  Â  Â  Â  for(let i=0; i<3; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  html += `<div class="skeleton-card"><div class="sk-line sk-title"></div><div class="sk-line sk-main"></div><div class="sk-line sk-sub"></div></div>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return html;
Â  Â  Â  Â  }

Â  Â  Â  Â  async function fetchData(mode) {
Â  Â  Â  Â  Â  Â  if(mode==="search") btnSearch.disabled=true; if(mode==="refresh") btnRefresh.disabled=true;

Â  Â  Â  Â  Â  Â  resetStickyState();

Â  Â  Â  Â  Â  Â  list.innerHTML = getSkeletonHTML();
Â  Â  Â  Â  Â  Â  list.style.opacity="1";
Â  Â  Â  Â  Â  Â  statusMsg.innerText="";Â 
Â  Â  Â  Â  Â  Â  statusMsg.className = "status-msg"; // Reset class
Â  Â  Â  Â  Â  Â  hintContainer.innerHTML = "";Â 

Â  Â  Â  Â  Â  Â  if(retryTimer){clearTimeout(retryTimer);retryTimer=null;}
Â  Â  Â  Â  Â  Â  const s=startStation.value; const e=endStation.value;Â 

Â  Â  Â  Â  Â  Â  const cacheKey = getCacheKey();
Â  Â  Â  Â  Â  Â  const cached = localStorage.getItem(cacheKey);

Â  Â  Â  Â  Â  Â  if (cached) {
Â  Â  Â  Â  Â  Â  Â  Â  const d = JSON.parse(cached);
Â  Â  Â  Â  Â  Â  Â  Â  if (Date.now() - d.timestamp < 60000) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await new Promise(r => setTimeout(r, 200));Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(d.payload.diagnostics) parseDiagnostics(d.payload.diagnostics, false);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderCards(d.payload);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setUpdateText(`æ›´æ–°æ–¼: ${d.payload.update_time} (è³‡æ–™æœªéæœŸ)`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lastFetchedPair={start:s,end:e};
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  logSystem("Cache", "Hit local (Age < 60s)");

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const now = Date.now();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(mode==="search"){ setTimeout(()=>btnSearch.disabled=false, 500); setRefreshLockedUntil(now+30000); lockRefreshButton(30); }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(mode==="refresh"){ setRefreshLockedUntil(now+30000); lockRefreshButton(30); }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  recordRequest();
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const res=await fetch(`/api/index?start=${s}&end=${e}`);
Â  Â  Â  Â  Â  Â  Â  Â  const age = res.headers.get('Age');
Â  Â  Â  Â  Â  Â  Â  Â  const isVercelCache = age && parseInt(age) > 0;

Â  Â  Â  Â  Â  Â  Â  Â  if (res.status === 429) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error("ç³»çµ±å¿™ç¢Œ");
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  const json=await res.json();
Â  Â  Â  Â  Â  Â  Â  Â  if(json.error) throw new Error(json.error);
Â  Â  Â  Â  Â  Â  Â  Â  lastFetchedPair={start:s,end:e};

Â  Â  Â  Â  Â  Â  Â  Â  const { rInfo, dInfo } = parseDiagnostics(json.diagnostics, isVercelCache);
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem(getCacheKey(),JSON.stringify({timestamp:Date.now(),payload:json}));
Â  Â  Â  Â  Â  Â  Â  Â  renderCards(json);

Â  Â  Â  Â  Â  Â  Â  Â  const displayQuota = (rInfo.quota !== "--") ? rInfo.quota : dInfo.quota;
Â  Â  Â  Â  Â  Â  Â  Â  logSystem("Status", `ç‹€æ…‹: ${rInfo.source} / ${dInfo.source} (å‰©: ${displayQuota})`);

Â  Â  Â  Â  Â  Â  Â  Â  if(json.delay_failed) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  scheduleRetry("èª¤é»è³‡è¨Šç„¡æ³•å–å¾—", "status-msg warning");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setUpdateText(`æ›´æ–°æ–¼: ${json.update_time} (åƒ…æ™‚åˆ»è¡¨)`);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setUpdateText(`æ›´æ–°æ–¼: ${json.update_time}`);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  const now=Date.now();
Â  Â  Â  Â  Â  Â  Â  Â  if(mode==="search"){ setTimeout(()=>btnSearch.disabled=false,500); setRefreshLockedUntil(now+30000); lockRefreshButton(30); }
Â  Â  Â  Â  Â  Â  Â  Â  if(mode==="refresh"){ setRefreshLockedUntil(now+30000); lockRefreshButton(30); }
Â  Â  Â  Â  Â  Â  } catch(err) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error(err); logSystem("API Error",err.message);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const errorMsg = err.message.includes("ç³»çµ±å¿™ç¢Œ") ? "ç³»çµ±å¿™ç¢Œ" : "é€£ç·šç™¼ç”Ÿå•é¡Œ";
Â  Â  Â  Â  Â  Â  Â  Â  scheduleRetry(errorMsg, "status-msg alert");
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  list.innerHTML=`<div class="message">${errorMsg} âš ï¸<br><span style="font-size:0.8rem;color:#888">è«‹ç¨å¾Œå†è©¦</span></div>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function setUpdateText(t){
Â  Â  Â  Â  Â  Â  updateTimeDiv.innerText=t;
Â  Â  Â  Â  Â  Â  localStorage.setItem("last_update_text",t);
Â  Â  Â  Â  }

Â  Â  Â  Â  function scheduleRetry(msg="èª¤é»è³‡è¨Šç„¡æ³•å–å¾—", cls="status-msg warning") {
Â  Â  Â  Â  Â  Â  let c=30;Â 
Â  Â  Â  Â  Â  Â  if(retryTimer) clearInterval(retryTimer);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  statusMsg.className = cls;Â 
Â  Â  Â  Â  Â  Â  statusMsg.innerText = `${msg} (30s å¾Œé‡è©¦)`;

Â  Â  Â  Â  Â  Â  retryTimer=setInterval(()=>{
Â  Â  Â  Â  Â  Â  Â  Â  c--;Â 
Â  Â  Â  Â  Â  Â  Â  Â  statusMsg.innerText=`${msg} (${c}s å¾Œé‡è©¦)`;
Â  Â  Â  Â  Â  Â  Â  Â  if(c<=0){
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clearInterval(retryTimer);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  retryTimer=null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doRefresh(true);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  },1000);
Â  Â  Â  Â  }

Â  Â  Â  Â  function lockSearchButton(s) {
Â  Â  Â  Â  Â  Â  if(searchLockTimer) clearInterval(searchLockTimer);
Â  Â  Â  Â  Â  Â  statusMsg.innerText="è«‹å‹¿é »ç¹æ“ä½œ"; statusMsg.className="status-msg alert";
Â  Â  Â  Â  Â  Â  btnSearch.classList.add('error'); btnSearch.disabled=true;
Â  Â  Â  Â  Â  Â  const t=()=>{
Â  Â  Â  Â  Â  Â  Â  Â  btnSearch.innerText=`é »ç¹æ“ä½œ (${s})`;
Â  Â  Â  Â  Â  Â  Â  Â  if(s<=0){
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clearInterval(searchLockTimer); btnSearch.disabled=false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btnSearch.classList.remove('error'); btnSearch.innerText="ğŸ” æŸ¥è©¢è·¯ç·š";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusMsg.innerText=""; statusMsg.className="status-msg"; // Reset
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setSearchLockedUntil(0);
Â  Â  Â  Â  Â  Â  Â  Â  } s--;
Â  Â  Â  Â  Â  Â  }; t(); searchLockTimer=setInterval(t,1000);
Â  Â  Â  Â  }
Â  Â  Â  Â  function lockRefreshButton(s) {
Â  Â  Â  Â  Â  Â  if(refreshTimer) clearInterval(refreshTimer);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const btns = document.querySelectorAll('.btn-refresh-sync');
Â  Â  Â  Â  Â  Â  btns.forEach(b => b.disabled = true);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const t=()=>{
Â  Â  Â  Â  Â  Â  Â  Â  btns.forEach(b => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const icon = b.querySelector('.toggle-icon') ? '<span class="toggle-icon">ğŸ”„</span> ' : '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  b.innerHTML = `${icon}æ›´æ–° (${s})`;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if(s<=0){
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clearInterval(refreshTimer);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btns.forEach(b => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  b.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const icon = b.querySelector('.toggle-icon') ? '<span class="toggle-icon">ğŸ”„</span> ' : '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  b.innerHTML = `${icon}æ›´æ–°`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setRefreshLockedUntil(0);
Â  Â  Â  Â  Â  Â  Â  Â  } s--;
Â  Â  Â  Â  Â  Â  }; t(); refreshTimer=setInterval(t,1000);
Â  Â  Â  Â  }

Â  Â  Â  Â  function updateHintUI(anyArriving) {
Â  Â  Â  Â  Â  Â  let hintHtml = `<div class="click-hint visible">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="hint-text-group ${anyArriving ? '' : 'only-text'}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="hint-text">ğŸ‘† é»æ“Šå¡ç‰‡æŸ¥çœ‹</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="click-hint-sub">å³æ™‚ä½ç½® & å®Œæ•´åœé ç«™</span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (anyArriving) {
Â  Â  Â  Â  Â  Â  Â  Â  hintHtml += `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="hint-divider"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="legend-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="legend-icon">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="led-dot top"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="led-dot bottom"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>10åˆ†é˜å…§é€²ç«™</span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  hintHtml += `</div>`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if(hintContainer) hintContainer.innerHTML = hintHtml;
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderCards(data) {
Â  Â  Â  Â  Â  Â  if(data.trains && data.trains.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  let cardsHtml = '';
Â  Â  Â  Â  Â  Â  Â  Â  let anyArriving = false;Â 

Â  Â  Â  Â  Â  Â  Â  Â  let has = false;
Â  Â  Â  Â  Â  Â  Â  Â  let hasShownNextDayDivider = false;
Â  Â  Â  Â  Â  Â  Â  Â  let lastTrainTs = 0;
Â  Â  Â  Â  Â  Â  Â  Â  let foundFirstActive = false;

Â  Â  Â  Â  Â  Â  Â  Â  const nowSec = Math.floor(Date.now() / 1000);

Â  Â  Â  Â  Â  Â  Â  Â  data.trains.forEach((t, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const diffSec = t.sort_key - nowSec;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const diffMin = Math.floor(diffSec / 60);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let isDeparted = diffSec < 0;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let isArriving = !isDeparted && diffMin <= 10;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(isArriving) anyArriving = true;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!isShowAll && diffMin < -10) return;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (has && !hasShownNextDayDivider && lastTrainTs > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const thisDate = new Date(t.sort_key * 1000);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const lastDate = new Date(lastTrainTs * 1000);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (thisDate.getDate() !== lastDate.getDate()) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â cardsHtml += `<div style="text-align:center; padding:10px 0; color:#4d7f5e; font-size:0.8rem; font-weight:bold; border-top:1px dashed #333; margin-top:10px;">â¬‡ æ¬¡æ—¥ç­æ¬¡ â¬‡</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â hasShownNextDayDivider = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lastTrainTs = t.sort_key;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  has = true;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let activeId = "";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!isDeparted && !foundFirstActive) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  activeId = 'id="firstActive"';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  foundFirstActive = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let leftIndicatorHtml = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="left-indicator">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="led-dot top"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="led-dot bottom"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>`;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let rightBadgesHtml = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isDeparted) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  rightBadgesHtml = `<div class="status-tag departed">å·²é§›é›¢</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!data.delay_failed && t.delay > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  rightBadgesHtml += `<div class="status-tag delay">èª¤é» ${t.delay} åˆ†</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const url = `https://railway.chienwen.net/taiwan/train/TRA-${t.no}/live`;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let cardClass = "card";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isDeparted) cardClass += " departed-card past";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isArriving) cardClass += " is-arriving";

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cardsHtml += `<a href="${url}" target="_blank" class="card-link" data-ts="${t.sort_key}" ${activeId}>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="${cardClass}" style="border-left-color:${t.color};">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${leftIndicatorHtml}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="status-badge-container">${rightBadgesHtml}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="train-info" style="color:${isDeparted ? '#888' : t.color};">${t.type} ${t.no} æ¬¡</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="main-time">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="time-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="time-date-label">${t.dep_date}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="time-part">${formatTime(t.act_dep)}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="arrow">â”</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="time-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="time-date-label">${t.arr_date}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="time-part">${formatTime(t.act_arr)}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="sub-time">åŸå®š ${formatTime(t.sch_dep)} â” ${formatTime(t.sch_arr)}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </a>`;
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  updateHintUI(anyArriving);

Â  Â  Â  Â  Â  Â  Â  Â  list.innerHTML = (!has && !isShowAll) ? `<div class="message">æŸ¥ç„¡ç­æ¬¡ âš ï¸</div>` : cardsHtml;

Â  Â  Â  Â  Â  Â  Â  Â  // å‘¼å«è‡ªå‹•æ²å‹•é‚è¼¯ (æœƒè§¸ç™¼ isAutoScrolling é–å®š)
Â  Â  Â  Â  Â  Â  Â  Â  scrollToActiveCard();

Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const orig = data.stats ? data.stats.original_count : 0;
Â  Â  Â  Â  Â  Â  list.innerHTML = orig > 0 ?Â 
Â  Â  Â  Â  Â  Â  Â  Â  `<div class="message">ä»Šæ—¥ç­æ¬¡å·²å…¨æ•¸é§›é›¢ ğŸ‘‹<br><span style="font-size:0.8rem;color:#666">TDX æ­£å¸¸ (åŸæœ‰ ${orig} ç­)</span></div>` :Â 
Â  Â  Â  Â  Â  Â  Â  Â  `<div class="message">æŸ¥ç„¡æ­¤å€é–“ç›´é”åˆ—è»Š âš ï¸</div>`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  updateHintUI(false);Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  function logSystem(a,d){systemLogs.push(`[${new Date().toLocaleTimeString()}] ${a}: ${d}`);if(systemLogs.length>30)systemLogs.shift();}
Â  Â  Â  Â  function recordRequest(){requestHistory.push(Date.now());}
Â  Â  Â  Â  function openModal(){document.getElementById('aboutModal').style.display='flex';goToPage('Menu');}
Â  Â  Â  Â  function closeModal(){document.getElementById('aboutModal').style.display='none';}

Â  Â  Â  Â  function goToPage(id){
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.modal-page').forEach(p=>p.classList.remove('active'));
Â  Â  Â  Â  Â  Â  document.getElementById('page'+id).classList.add('active');

Â  Â  Â  Â  Â  Â  if(id==='Report'){
Â  Â  Â  Â  Â  Â  Â  Â  const now=Date.now(); const rpm=requestHistory.filter(t=>now-t<60000).length;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('statRpm').innerText=rpm;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('cardRpm').classList.toggle('danger', rpm>=5);
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('statTotal').innerText=requestHistory.length;
Â  Â  Â  Â  Â  Â  Â  Â  const last=requestHistory[requestHistory.length-1];
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('statLast').innerText=last?Math.floor((now-last)/1000):"--";

Â  Â  Â  Â  Â  Â  Â  Â  const getColor = (src) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(src.includes("Vercel")||src.includes("Redis")) return "green";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(src.includes("API")) return "yellow";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return "red";
Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  const displayQuota = (lastDiagnostics.route_quota !== "--") ? lastDiagnostics.route_quota : lastDiagnostics.delay_quota;

Â  Â  Â  Â  Â  Â  Â  Â  const elStatus = document.getElementById('diagStatus');
Â  Â  Â  Â  Â  Â  Â  Â  elStatus.innerHTML = `<span class="badge ${getColor(lastDiagnostics.route_source)}">${lastDiagnostics.route_source}</span> / <span class="badge ${getColor(lastDiagnostics.delay_source)}">${lastDiagnostics.delay_source}</span>`;

Â  Â  Â  Â  Â  Â  Â  Â  const elQuota = document.getElementById('diagQuota');
Â  Â  Â  Â  Â  Â  Â  Â  elQuota.innerHTML = `<span style="font-size:1.1rem; color:#fff;">${displayQuota}</span>`;

Â  Â  Â  Â  Â  Â  Â  Â  const isStandalone = ('standalone' in window.navigator) && (window.navigator.standalone) || window.matchMedia('(display-mode: standalone)').matches;
Â  Â  Â  Â  Â  Â  Â  Â  let r=`ã€TRAIN LIVE è¨ºæ–·å ±å‘Šã€‘\næ™‚é–“: ${new Date().toLocaleString()}\n`;
Â  Â  Â  Â  Â  Â  Â  Â  r += `è£ç½®: ${navigator.userAgent}\nç•«é¢: ${window.innerWidth}x${window.innerHeight} (PWA: ${isStandalone})\n`;
Â  Â  Â  Â  Â  Â  Â  Â  r += `è·¯ç·š: ${startStation.value} -> ${endStation.value}\næµé‡: RPM=${rpm}, Total=${requestHistory.length}\n`;
Â  Â  Â  Â  Â  Â  Â  Â  r += `ç‹€æ…‹: [${lastDiagnostics.route_source}] / [${lastDiagnostics.delay_source}]\nå‰©é¤˜: ${displayQuota}\n`;
Â  Â  Â  Â  Â  Â  Â  Â  r += `--- Log ---\n${systemLogs.join("\n")}`;

Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('reportContent').value = r;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('terminalView').innerText = systemLogs.join("\n");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  function copyReportOnly() {
Â  Â  Â  Â  Â  Â  let final = document.getElementById('reportContent').value;
Â  Â  Â  Â  Â  Â  const uDesc = document.getElementById('userDesc').value; if(uDesc) final += `\n\nUser: ${uDesc}`;
Â  Â  Â  Â  Â  Â  navigator.clipboard.writeText(final).then(() => {
Â  Â  Â  Â  Â  Â  Â  Â  const btn=document.getElementById('btnCopyReport'); const original = btn.innerText;
Â  Â  Â  Â  Â  Â  Â  Â  btn.innerText = "âœ… å·²è¤‡è£½"; btn.style.background = "#4d7f5e";
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(()=>{ btn.innerText = original; btn.style.background = ""; }, 2000);
Â  Â  Â  Â  Â  Â  }).catch(e=>{alert('è¤‡è£½å¤±æ•—');});
Â  Â  Â  Â  }
Â  Â  Â  Â  function openMailClient() {
Â  Â  Â  Â  Â  Â  const subject = encodeURIComponent("TRAIN LIVE è¨ºæ–·å›å ±");
Â  Â  Â  Â  Â  Â  const body = encodeURIComponent("ï¼ˆè«‹é•·æŒ‰è²¼ä¸Šè¨ºæ–·å ±å‘Šï¼‰\n\nå•é¡Œï¼š\n");
Â  Â  Â  Â  Â  Â  window.location.href = `mailto:d96benjamin@gmail.com?subject=${subject}&body=${body}`;
Â  Â  Â  Â  }

Â  Â  Â  Â  // === å¸¸ç”¨è·¯ç·šèˆ‡æ­·å²ç´€éŒ„é‚è¼¯ ===
Â  Â  Â  Â  const LS_FAV = "tl_favorites";
Â  Â  Â  Â  const LS_HIST = "tl_history";
Â  Â  Â  Â  const MAX_HIST = 3;
Â  Â  Â  Â  const MAX_FAV = 6;
Â  Â  Â  Â  const btnStar = document.getElementById('btnStar');
Â  Â  Â  Â  const quickArea = document.getElementById('quickRouteArea');

Â  Â  Â  Â  function getCurrentPair() { return { start: startStation.value, end: endStation.value }; }

Â  Â  Â  Â  function isFavorite(s, e) {
Â  Â  Â  Â  Â  Â  const favs = JSON.parse(localStorage.getItem(LS_FAV) || "[]");
Â  Â  Â  Â  Â  Â  return favs.some(f => f.start === s && f.end === e);
Â  Â  Â  Â  }

Â  Â  Â  Â  function toggleFavorite() {
Â  Â  Â  Â  Â  Â  const cur = getCurrentPair();
Â  Â  Â  Â  Â  Â  if (!cur.start || !cur.end) return;

Â  Â  Â  Â  Â  Â  let favs = JSON.parse(localStorage.getItem(LS_FAV) || "[]");
Â  Â  Â  Â  Â  Â  const idx = favs.findIndex(f => f.start === cur.start && f.end === cur.end);

Â  Â  Â  Â  Â  Â  if (idx >= 0) {
Â  Â  Â  Â  Â  Â  Â  Â  favs.splice(idx, 1);Â 
Â  Â  Â  Â  Â  Â  Â  Â  logSystem("Fav", "Removed");
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  if (favs.length >= MAX_FAV) { alert(`å¸¸ç”¨è·¯ç·šæœ€å¤šå„²å­˜ ${MAX_FAV} çµ„`); return; }
Â  Â  Â  Â  Â  Â  Â  Â  favs.unshift(cur);Â 
Â  Â  Â  Â  Â  Â  Â  Â  logSystem("Fav", "Added");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  localStorage.setItem(LS_FAV, JSON.stringify(favs));
Â  Â  Â  Â  Â  Â  updateStarState();
Â  Â  Â  Â  Â  Â  renderQuickRoutes();
Â  Â  Â  Â  }

Â  Â  Â  Â  function addToHistory() {
Â  Â  Â  Â  Â  Â  const cur = getCurrentPair();
Â  Â  Â  Â  Â  Â  if (!cur.start || !cur.end) return;

Â  Â  Â  Â  Â  Â  let hist = JSON.parse(localStorage.getItem(LS_HIST) || "[]");
Â  Â  Â  Â  Â  Â  hist = hist.filter(h => !(h.start === cur.start && h.end === cur.end));
Â  Â  Â  Â  Â  Â  hist.unshift(cur);
Â  Â  Â  Â  Â  Â  if (hist.length > MAX_HIST) hist.pop();

Â  Â  Â  Â  Â  Â  localStorage.setItem(LS_HIST, JSON.stringify(hist));
Â  Â  Â  Â  Â  Â  renderQuickRoutes();
Â  Â  Â  Â  }

Â  Â  Â  Â  function updateStarState() {
Â  Â  Â  Â  Â  Â  const cur = getCurrentPair();
Â  Â  Â  Â  Â  Â  const btn = document.getElementById('btnStar');
Â  Â  Â  Â  Â  Â  if (isFavorite(cur.start, cur.end)) {
Â  Â  Â  Â  Â  Â  Â  Â  btn.innerHTML = '<span class="toggle-icon">â˜…</span> æ”¶è—';
Â  Â  Â  Â  Â  Â  Â  Â  btn.classList.add('fav-active');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  btn.innerHTML = '<span class="toggle-icon">â˜†</span> æ”¶è—';
Â  Â  Â  Â  Â  Â  Â  Â  btn.classList.remove('fav-active');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function loadRoute(s, e) {
Â  Â  Â  Â  Â  Â  const sR = STATION_INDEX[s];
Â  Â  Â  Â  Â  Â  const eR = STATION_INDEX[e];
Â  Â  Â  Â  Â  Â  if (sR && eR) {
Â  Â  Â  Â  Â  Â  Â  Â  setMenu('start', sR, s);
Â  Â  Â  Â  Â  Â  Â  Â  setMenu('end', eR, e);
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem(PREF_START_R_KEY, startRegion.value);
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem(PREF_START_S_KEY, startStation.value);
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem(PREF_END_R_KEY, endRegion.value);
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem(PREF_END_S_KEY, endStation.value);
Â  Â  Â  Â  Â  Â  Â  Â  updateStarState();
Â  Â  Â  Â  Â  Â  Â  Â  doSearch();Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderQuickRoutes() {
Â  Â  Â  Â  Â  Â  const favs = JSON.parse(localStorage.getItem(LS_FAV) || "[]");
Â  Â  Â  Â  Â  Â  const hist = JSON.parse(localStorage.getItem(LS_HIST) || "[]");

Â  Â  Â  Â  Â  Â  let html = '';
Â  Â  Â  Â  Â  Â  favs.forEach(r => {
Â  Â  Â  Â  Â  Â  Â  Â  html += `<div class="route-chip fav" onclick="loadRoute('${r.start}', '${r.end}')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${r.start}<span class="chip-arrow">â”</span>${r.end}
Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  hist.forEach(r => {
Â  Â  Â  Â  Â  Â  Â  Â  if (!isFavorite(r.start, r.end)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<div class="route-chip hist" onclick="loadRoute('${r.start}', '${r.end}')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${r.start}<span class="chip-arrow">â”</span>${r.end}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if (html === '') {
Â  Â  Â  Â  Â  Â  Â  Â  quickArea.style.display = 'none';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  quickArea.style.display = 'flex';
Â  Â  Â  Â  Â  Â  Â  Â  quickArea.innerHTML = html;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  init();
Â  Â  </script>
</body>
</html>